<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Instructor Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, query, where, addDoc, updateDoc, deleteDoc, getDocs, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // IMPORTANT: These global variables are provided by the canvas environment.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = {
  apiKey: "AIzaSyBX96xDY5ThDAZn-SckmsnfynMnQjvUc2I",
  authDomain: "helprequest-469c0.firebaseapp.com",
  projectId: "helprequest-469c0",
  storageBucket: "helprequest-469c0.firebasestorage.app",
  messagingSenderId: "1092775554304",
  appId: "1:1092775554304:web:e771c3ebac1e6ba4f597e5"
};
        setLogLevel('debug');

        let auth, db;
        let state = {
            periods: [],
            selectedPeriodId: null,
            students: [],
            assignments: [],
            requests: [],
            selectedStudent: null,
            sortOption: 'seatOrder',
            loading: true,
            isDragging: false,
            draggedId: null,
            draggedIndex: null,
        };

        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);

        // Sign in anonymously to get a user ID for private data access
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                await startDataListeners();
                state.loading = false;
                renderUI();
            } else {
                await signInAnonymously(auth);
            }
        });

        // Function to start real-time listeners for all data
        const startDataListeners = async () => {
            const publicDataPath = `artifacts/${appId}/public/data`;

            // Listen for periods
            onSnapshot(collection(db, `${publicDataPath}/periods`), (snapshot) => {
                state.periods = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (!state.selectedPeriodId && state.periods.length > 0) {
                    state.selectedPeriodId = state.periods[0].id;
                }
                renderUI();
            });

            // Listen for students and sort
            onSnapshot(collection(db, `${publicDataPath}/students`), (snapshot) => {
                state.students = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                sortStudents();
                renderUI();
            });
            
            // Listen for assignments
            onSnapshot(collection(db, `${publicDataPath}/assignments`), (snapshot) => {
                state.assignments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderUI();
            });

            // Listen for requests
            onSnapshot(collection(db, `${publicDataPath}/requests`), (snapshot) => {
                state.requests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderUI();
            });
        };

        const sortStudents = () => {
            const filteredStudents = state.students.filter(s => s.periodId === state.selectedPeriodId);
            if (state.sortOption === 'seatOrder') {
                state.students = filteredStudents.sort((a, b) => (a.seatOrder || 0) - (b.seatOrder || 0));
            } else if (state.sortOption === 'firstName') {
                state.students = filteredStudents.sort((a, b) => (a.firstName || '').localeCompare(b.firstName || ''));
            } else if (state.sortOption === 'lastName') {
                state.students = filteredStudents.sort((a, b) => (a.lastName || '').localeCompare(b.lastName || ''));
            } else {
                state.students = filteredStudents;
            }
        };

        const renderUI = () => {
            const app = document.getElementById('app');
            if (state.loading) {
                app.innerHTML = `<div class="flex items-center justify-center h-screen"><div class="text-xl font-semibold">Loading...</div></div>`;
                return;
            }

            app.innerHTML = `
                <div class="min-h-screen bg-gray-100 p-4 font-sans">
                    <div class="max-w-7xl mx-auto bg-white p-6 rounded-xl shadow-lg">
                        <!-- Header -->
                        <div class="flex justify-between items-center mb-6">
                            <h1 class="text-4xl font-extrabold text-gray-800 tracking-tight">Assignment Tracker</h1>
                            <div class="flex items-center space-x-2">
                                <span class="text-sm text-gray-500">${auth.currentUser?.uid}</span>
                            </div>
                        </div>

                        <!-- Period Management -->
                        <div class="bg-gray-50 p-4 rounded-lg shadow-inner mb-6">
                            <h2 class="text-xl font-bold text-gray-700 mb-4">Period Management</h2>
                            <div class="flex flex-col md:flex-row md:items-center md:space-x-4 mb-4">
                                <div class="flex-1 mb-4 md:mb-0">
                                    <label for="period-select" class="block text-sm font-medium text-gray-700">Select Period:</label>
                                    <select id="period-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 rounded-md">
                                        ${state.periods.map(p => `<option value="${p.id}" ${p.id === state.selectedPeriodId ? 'selected' : ''}>${p.name}</option>`).join('')}
                                    </select>
                                </div>
                                <div class="flex-1 flex flex-col space-y-2">
                                    <input type="text" id="new-period-name" placeholder="New Period Name" class="px-3 py-2 border rounded-lg">
                                    <div class="flex space-x-2">
                                        <button id="add-period-btn" class="flex-1 bg-green-500 text-white font-bold py-2 rounded-lg hover:bg-green-600 transition-colors duration-200">
                                            Add Period
                                        </button>
                                        <button id="delete-period-btn" class="flex-1 bg-red-500 text-white font-bold py-2 rounded-lg hover:bg-red-600 transition-colors duration-200">
                                            Delete Selected Period
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Main Content -->
                        <div class="flex flex-col lg:flex-row lg:space-x-6">
                            <!-- Left Sidebar -->
                            <div class="w-full lg:w-1/4 space-y-6 mb-6 lg:mb-0">
                                <!-- Add Assignments Section -->
                                <div class="bg-gray-50 p-4 rounded-lg shadow-inner">
                                    <h2 class="text-xl font-bold text-gray-700 mb-2">Assignments</h2>
                                    <textarea id="new-assignment-titles" rows="4" placeholder="Paste assignment titles here (one per line)" class="w-full px-3 py-2 border rounded-lg mb-2"></textarea>
                                    <div class="flex space-x-2">
                                        <input type="date" id="assignment-due-date" class="flex-1 px-3 py-2 border rounded-lg">
                                        <button id="add-assignments-btn" class="flex-1 bg-blue-500 text-white font-bold py-2 rounded-lg hover:bg-blue-600 transition-colors duration-200">
                                            Add Assignments
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Add Students Section -->
                                <div class="bg-gray-50 p-4 rounded-lg shadow-inner">
                                    <h2 class="text-xl font-bold text-gray-700 mb-2">Add Students & Seats</h2>
                                    <textarea id="student-roster" rows="6" placeholder="Paste student roster (one per line, e.g., First Last, ID#)" class="w-full px-3 py-2 border rounded-lg mb-2"></textarea>
                                    <div class="flex space-x-2">
                                        <button id="add-students-btn" class="flex-1 bg-blue-500 text-white font-bold py-2 rounded-lg hover:bg-blue-600 transition-colors duration-200">
                                            Add Students
                                        </button>
                                        <button id="add-empty-seat-btn" class="flex-1 bg-gray-500 text-white font-bold py-2 rounded-lg hover:bg-gray-600 transition-colors duration-200">
                                            Add Empty Seat
                                        </button>
                                    </div>
                                    <button id="delete-all-students-btn" class="w-full mt-2 bg-red-500 text-white font-bold py-2 rounded-lg hover:bg-red-600 transition-colors duration-200">
                                        Delete All Students in Period
                                    </button>
                                    <button id="clear-all-data-btn" class="w-full mt-2 bg-red-700 text-white font-bold py-2 rounded-lg hover:bg-red-800 transition-colors duration-200">
                                        Clear All Data
                                    </button>
                                </div>

                                <!-- Queue Display -->
                                <div class="bg-gray-50 p-4 rounded-lg shadow-inner">
                                    <h2 class="text-xl font-bold text-gray-700 mb-2">Help & Check Queue</h2>
                                    <div class="space-y-2">
                                        <div class="bg-red-100 p-2 rounded-md">
                                            <h3 class="font-semibold text-gray-700">Help Queue</h3>
                                            <ul id="help-queue-list" class="list-disc list-inside text-gray-600">
                                                ${state.requests.filter(r => r.type === 'help').sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp)).map((r, i) => {
                                                    const student = state.students.find(s => s.id === r.studentId);
                                                    const assignment = state.assignments.find(a => a.id === r.assignmentId);
                                                    if (!student) return '';
                                                    return `<li class="cursor-pointer hover:text-red-500 transition-colors" data-student-id="${student.id}">${i + 1}. ${student.name} - ${assignment ? assignment.title : 'N/A'}</li>`;
                                                }).join('')}
                                            </ul>
                                        </div>
                                        <div class="bg-blue-100 p-2 rounded-md">
                                            <h3 class="font-semibold text-gray-700">Check Queue</h3>
                                            <ul id="check-queue-list" class="list-disc list-inside text-gray-600">
                                                ${state.requests.filter(r => r.type === 'check').sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp)).map((r, i) => {
                                                    const student = state.students.find(s => s.id === r.studentId);
                                                    const assignment = state.assignments.find(a => a.id === r.assignmentId);
                                                    if (!student) return '';
                                                    return `<li class="cursor-pointer hover:text-blue-500 transition-colors" data-student-id="${student.id}">${i + 1}. ${student.name} - ${assignment ? assignment.title : 'N/A'}</li>`;
                                                }).join('')}
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Main Content Area -->
                            <div class="w-full lg:w-3/4 space-y-6">
                                <!-- Sort and Class Layout -->
                                <div class="bg-gray-50 p-4 rounded-lg shadow-inner">
                                    <div class="flex items-center space-x-4 mb-4">
                                        <span class="text-sm font-medium text-gray-700">Sort By:</span>
                                        <div class="flex space-x-2">
                                            <label class="inline-flex items-center">
                                                <input type="radio" name="sort-option" value="seatOrder" class="form-radio" ${state.sortOption === 'seatOrder' ? 'checked' : ''}>
                                                <span class="ml-2 text-gray-700">Assigned Seat</span>
                                            </label>
                                            <label class="inline-flex items-center">
                                                <input type="radio" name="sort-option" value="firstName" class="form-radio" ${state.sortOption === 'firstName' ? 'checked' : ''}>
                                                <span class="ml-2 text-gray-700">First Name</span>
                                            </label>
                                            <label class="inline-flex items-center">
                                                <input type="radio" name="sort-option" value="lastName" class="form-radio" ${state.sortOption === 'lastName' ? 'checked' : ''}>
                                                <span class="ml-2 text-gray-700">Last Name</span>
                                            </label>
                                        </div>
                                    </div>
                                    <div id="class-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4">
                                        ${state.students.filter(s => s.periodId === state.selectedPeriodId).map(s => {
                                            const hasHelpRequest = state.requests.some(r => r.studentId === s.id && r.type === 'help');
                                            const hasCheckRequest = state.requests.some(r => r.studentId === s.id && r.type === 'check' && !hasHelpRequest);
                                            const backgroundColor = hasHelpRequest ? 'bg-red-400' : hasCheckRequest ? 'bg-blue-400' : 'bg-gray-200';
                                            const textColor = hasHelpRequest || hasCheckRequest ? 'text-white' : 'text-gray-800';
                                            const selectedClass = state.selectedStudent && state.selectedStudent.id === s.id ? 'ring-4 ring-blue-500' : '';

                                            return `
                                                <div id="student-card-${s.id}" draggable="${state.sortOption === 'seatOrder'}"
                                                    class="student-card p-4 rounded-lg shadow cursor-pointer transition-colors duration-200
                                                    ${s.isPlaceholder ? 'border-2 border-dashed border-gray-400' : backgroundColor} ${textColor}
                                                    ${selectedClass}"
                                                    data-id="${s.id}" data-seat-order="${s.seatOrder}">
                                                    <div class="flex justify-between items-center mb-2">
                                                        <h3 class="font-bold">${s.isPlaceholder ? 'Empty Seat' : s.name}</h3>
                                                        ${s.isPlaceholder ? '' : `<button onclick="deleteStudent('${s.id}')" class="text-gray-600 hover:text-red-500 transition-colors ml-2">
                                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor">
                                                                    <path d="M18.3 5.71a.996.996 0 0 0-1.41 0L12 10.59 7.11 5.7A.996.996 0 1 0 5.7 7.11L10.59 12 5.7 16.89A.996.996 0 1 0 7.11 18.3L12 13.41l4.89 4.89a.996.996 0 1 0 1.41-1.41L13.41 12l4.89-4.89a.996.996 0 0 0 0-1.4z"/>
                                                                </svg>
                                                            </button>`}
                                                    </div>
                                                    <p class="text-sm">ID: ${s.studentId}</p>
                                                    ${hasHelpRequest ? `<span class="text-sm font-semibold">Help Queue: #${state.requests.filter(r => r.type === 'help').sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp)).findIndex(r => r.studentId === s.id) + 1}</span>` : ''}
                                                    ${hasCheckRequest ? `<span class="text-sm font-semibold">Check Queue: #${state.requests.filter(r => r.type === 'check').sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp)).findIndex(r => r.studentId === s.id) + 1}</span>` : ''}
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>
                                
                                <!-- Student Details -->
                                <div id="student-details" class="bg-gray-50 p-4 rounded-lg shadow-inner ${state.selectedStudent ? '' : 'hidden'}">
                                    <div class="flex justify-between items-center mb-4">
                                        <h2 class="text-xl font-bold text-gray-700">Assignments for ${state.selectedStudent ? state.selectedStudent.name : ''}</h2>
                                        <button id="copy-link-btn" class="text-sm bg-gray-300 px-3 py-1 rounded-lg hover:bg-gray-400">Share Student Link</button>
                                    </div>
                                    <div id="student-assignments" class="space-y-4">
                                        <!-- Assignments will be rendered here -->
                                    </div>
                                    <div class="mt-4">
                                        <h3 class="font-bold text-lg mb-2">Active Requests</h3>
                                        <ul id="active-requests-list" class="space-y-2">
                                            <!-- Requests will be rendered here -->
                                        </ul>
                                    </div>
                                    <button id="clear-all-requests-btn" class="mt-4 w-full bg-red-500 text-white font-bold py-2 rounded-lg hover:bg-red-600 transition-colors duration-200">
                                        Clear All Requests
                                    </button>
                                    <button id="clear-student-data-btn" class="mt-4 w-full bg-red-500 text-white font-bold py-2 rounded-lg hover:bg-red-600 transition-colors duration-200">
                                        Clear All Student Data
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Re-attach event listeners
            document.getElementById('period-select').addEventListener('change', (e) => {
                state.selectedPeriodId = e.target.value;
                sortStudents();
                renderUI();
            });
            document.getElementById('add-period-btn').addEventListener('click', handleAddPeriod);
            document.getElementById('delete-period-btn').addEventListener('click', handleDeletePeriod);
            document.getElementById('add-assignments-btn').addEventListener('click', handleAddAssignments);
            document.getElementById('add-students-btn').addEventListener('click', handleAddStudents);
            document.getElementById('add-empty-seat-btn').addEventListener('click', handleAddEmptySeat);
            document.getElementById('delete-all-students-btn').addEventListener('click', handleDeleteAllStudents);
            document.getElementById('clear-all-data-btn').addEventListener('click', handleClearAllData);

            document.querySelectorAll('input[name="sort-option"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    state.sortOption = e.target.value;
                    sortStudents();
                    renderUI();
                });
            });

            document.querySelectorAll('.student-card').forEach(card => {
                card.addEventListener('click', handleStudentSelect);
            });
            
            document.querySelectorAll('#help-queue-list li, #check-queue-list li').forEach(item => {
                item.addEventListener('click', handleQueueItemClick);
            });

            if (state.selectedStudent) {
                renderStudentDetails();
                document.getElementById('copy-link-btn').addEventListener('click', handleCopyLink);
                document.getElementById('clear-all-requests-btn').addEventListener('click', handleClearAllRequests);
                document.getElementById('clear-student-data-btn').addEventListener('click', handleClearStudentData);
            }

            if (state.sortOption === 'seatOrder') {
                setupDragAndDrop();
            }
        };
        
        const handleClearAllData = async () => {
            const confirmClear = confirm("Are you sure you want to clear all data? This will delete all periods, students, assignments, and requests from the database. This action cannot be undone.");
            if (confirmClear) {
                await runTransaction(db, async (transaction) => {
                    // Delete periods
                    const periodsSnapshot = await getDocs(collection(db, `artifacts/${appId}/public/data/periods`));
                    periodsSnapshot.forEach(doc => transaction.delete(doc.ref));

                    // Delete students
                    const studentsSnapshot = await getDocs(collection(db, `artifacts/${appId}/public/data/students`));
                    studentsSnapshot.forEach(doc => transaction.delete(doc.ref));

                    // Delete assignments
                    const assignmentsSnapshot = await getDocs(collection(db, `artifacts/${appId}/public/data/assignments`));
                    assignmentsSnapshot.forEach(doc => transaction.delete(doc.ref));

                    // Delete requests
                    const requestsSnapshot = await getDocs(collection(db, `artifacts/${appId}/public/data/requests`));
                    requestsSnapshot.forEach(doc => transaction.delete(doc.ref));
                });
            }
        };

        const handleAddPeriod = async () => {
            const name = document.getElementById('new-period-name').value.trim();
            if (name) {
                const periodsRef = collection(db, `artifacts/${appId}/public/data/periods`);
                await addDoc(periodsRef, { name, timestamp: new Date().toISOString() });
                document.getElementById('new-period-name').value = '';
            }
        };
        
        const handleDeletePeriod = async () => {
            if (state.selectedPeriodId) {
                const confirmDelete = confirm("Are you sure you want to delete this period and all its students?");
                if (confirmDelete) {
                    await runTransaction(db, async (transaction) => {
                        const studentsRef = collection(db, `artifacts/${appId}/public/data/students`);
                        const q = query(studentsRef, where('periodId', '==', state.selectedPeriodId));
                        const studentsSnapshot = await getDocs(q);
                        studentsSnapshot.forEach(doc => {
                            transaction.delete(doc.ref);
                        });
                        const periodRef = doc(db, `artifacts/${appId}/public/data/periods`, state.selectedPeriodId);
                        transaction.delete(periodRef);
                    });
                }
            }
        };

        const handleAddAssignments = async () => {
            const titles = document.getElementById('new-assignment-titles').value.split('\n').map(t => t.trim()).filter(t => t);
            const dueDate = document.getElementById('assignment-due-date').value;
            if (!titles.length || !state.selectedPeriodId) return;
            
            for (const title of titles) {
                const assignmentsRef = collection(db, `artifacts/${appId}/public/data/assignments`);
                await addDoc(assignmentsRef, {
                    periodId: state.selectedPeriodId,
                    title,
                    dueDate,
                    completions: []
                });
            }
            document.getElementById('new-assignment-titles').value = '';
        };

        const handleAddStudents = async () => {
            const rosterText = document.getElementById('student-roster').value.trim();
            if (!rosterText || !state.selectedPeriodId) return;
            
            const lines = rosterText.split('\n').map(line => line.trim()).filter(line => line);
            const studentsRef = collection(db, `artifacts/${appId}/public/data/students`);
            
            const existingStudentsCount = state.students.filter(s => s.periodId === state.selectedPeriodId && !s.isPlaceholder).length;
            const existingEmptySeatsCount = state.students.filter(s => s.periodId === state.selectedPeriodId && s.isPlaceholder).length;

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                const parts = line.split(',');
                const studentId = parts.pop().trim();
                const name = parts.join(',').trim();
                
                if (name && studentId) {
                    await addDoc(studentsRef, {
                        periodId: state.selectedPeriodId,
                        name,
                        firstName: name.split(' ')[0],
                        lastName: name.split(' ').slice(-1)[0],
                        studentId,
                        seatOrder: existingStudentsCount + existingEmptySeatsCount + i,
                        isPlaceholder: false
                    });
                }
            }
            document.getElementById('student-roster').value = '';
        };

        const handleAddEmptySeat = async () => {
            if (!state.selectedPeriodId) return;
            const studentsRef = collection(db, `artifacts/${appId}/public/data/students`);
            const existingStudentsCount = state.students.filter(s => s.periodId === state.selectedPeriodId).length;
            await addDoc(studentsRef, {
                periodId: state.selectedPeriodId,
                name: "Empty Seat",
                studentId: `empty-${Date.now()}`,
                seatOrder: existingStudentsCount,
                isPlaceholder: true,
                firstName: "",
                lastName: ""
            });
        };

        const handleDeleteAllStudents = async () => {
            if (!state.selectedPeriodId) return;
            const confirmDelete = confirm("Are you sure you want to delete all students and empty seats in this period?");
            if (confirmDelete) {
                const studentsRef = collection(db, `artifacts/${appId}/public/data/students`);
                const q = query(studentsRef, where('periodId', '==', state.selectedPeriodId));
                const studentsSnapshot = await getDocs(q);
                studentsSnapshot.forEach(async (doc) => {
                    await deleteDoc(doc.ref);
                });
            }
        };

        const deleteStudent = async (studentId) => {
            const studentRef = doc(db, `artifacts/${appId}/public/data/students`, studentId);
            await deleteDoc(studentRef);
            if (state.selectedStudent && state.selectedStudent.id === studentId) {
                state.selectedStudent = null;
                renderUI();
            }
        };
        window.deleteStudent = deleteStudent;

        const handleStudentSelect = (e) => {
            const studentCard = e.currentTarget;
            const studentId = studentCard.dataset.id;
            state.selectedStudent = state.students.find(s => s.id === studentId);
            renderUI();
        };

        const renderStudentDetails = () => {
            const detailsSection = document.getElementById('student-details');
            if (!detailsSection || !state.selectedStudent) return;
            
            const studentAssignmentsList = document.getElementById('student-assignments');
            studentAssignmentsList.innerHTML = state.assignments
                .filter(a => a.periodId === state.selectedStudent.periodId)
                .map(a => {
                    const completion = a.completions.find(c => c.studentId === state.selectedStudent.id);
                    const isExcused = completion ? completion.isExcused : false;
                    const score = completion ? completion.score : 0;
                    
                    return `
                        <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                            <div class="flex justify-between items-center">
                                <span contenteditable="true" onblur="handleAssignmentEdit('${a.id}', this.innerText)" class="text-lg font-semibold text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-md p-1">${a.title}</span>
                                <button onclick="handleDeleteAssignment('${a.id}')" class="text-gray-600 hover:text-red-500 transition-colors ml-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M18.3 5.71a.996.996 0 0 0-1.41 0L12 10.59 7.11 5.7A.996.996 0 1 0 5.7 7.11L10.59 12 5.7 16.89A.996.996 0 1 0 7.11 18.3L12 13.41l4.89 4.89a.996.996 0 1 0 1.41-1.41L13.41 12l4.89-4.89a.996.996 0 0 0 0-1.4z"/>
                                    </svg>
                                </button>
                            </div>
                            <p class="text-sm text-gray-500 mb-2">Due: ${a.dueDate ? new Date(a.dueDate).toLocaleDateString() : 'N/A'}</p>
                            <div class="flex items-center space-x-4">
                                <div class="flex items-center space-x-1">
                                    ${[1, 2, 3, 4].map(s => `
                                        <input type="checkbox" id="score-${a.id}-${s}" 
                                            class="form-checkbox text-blue-600 rounded" 
                                            data-score="${s}"
                                            ${score >= s ? 'checked' : ''}
                                            onclick="handleScoreChange('${a.id}', ${s}, event)"
                                        >
                                        <label for="score-${a.id}-${s}" class="text-gray-700">${s}</label>
                                    `).join('')}
                                </div>
                                <label class="inline-flex items-center space-x-2 cursor-pointer">
                                    <input type="checkbox" id="excused-${a.id}" class="form-checkbox text-purple-600 rounded"
                                        ${isExcused ? 'checked' : ''}
                                        onclick="handleExcusedToggle('${a.id}', event)">
                                    <span class="${isExcused ? 'text-purple-600 font-semibold' : ''}">Excused</span>
                                </label>
                                <button onclick="clearCompletion('${a.id}')" class="text-gray-500 hover:text-red-500 transition-colors">Clear</button>
                            </div>
                        </div>
                    `;
                }).join('');

            const requestsList = document.getElementById('active-requests-list');
            if (requestsList) {
                const studentRequests = state.requests.filter(r => r.studentId === state.selectedStudent.id);
                requestsList.innerHTML = studentRequests.length > 0 ? studentRequests.map(r => {
                    const assignment = state.assignments.find(a => a.id === r.assignmentId);
                    const type = r.type === 'help' ? 'Help' : 'Check';
                    return `
                        <li class="flex justify-between items-center p-2 rounded-md ${r.type === 'help' ? 'bg-red-100' : 'bg-blue-100'}">
                            <span>${type} on: ${assignment ? assignment.title : 'N/A'}</span>
                            <button onclick="clearSpecificRequest('${r.id}')" class="text-gray-500 hover:text-red-500">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M18.3 5.71a.996.996 0 0 0-1.41 0L12 10.59 7.11 5.7A.996.996 0 1 0 5.7 7.11L10.59 12 5.7 16.89A.996.996 0 1 0 7.11 18.3L12 13.41l4.89 4.89a.996.996 0 1 0 1.41-1.41L13.41 12l4.89-4.89a.996.996 0 0 0 0-1.4z"/>
                                </svg>
                            </button>
                        </li>
                    `;
                }).join('') : `<p class="text-gray-500">No active requests.</p>`;
            }
        };

        const handleAssignmentEdit = async (assignmentId, newTitle) => {
            const assignmentRef = doc(db, `artifacts/${appId}/public/data/assignments`, assignmentId);
            await updateDoc(assignmentRef, { title: newTitle });
        };
        window.handleAssignmentEdit = handleAssignmentEdit;

        const handleDeleteAssignment = async (assignmentId) => {
            const confirmDelete = confirm("Are you sure you want to delete this assignment?");
            if (confirmDelete) {
                const assignmentRef = doc(db, `artifacts/${appId}/public/data/assignments`, assignmentId);
                await deleteDoc(assignmentRef);
            }
        };
        window.handleDeleteAssignment = handleDeleteAssignment;

        const handleScoreChange = async (assignmentId, score, event) => {
            const assignmentRef = doc(db, `artifacts/${appId}/public/data/assignments`, assignmentId);
            const studentId = state.selectedStudent.id;
            const assignmentDoc = state.assignments.find(a => a.id === assignmentId);
            let completions = assignmentDoc.completions || [];
            let completion = completions.find(c => c.studentId === studentId);

            if (!completion) {
                completion = { studentId, score, date: new Date().toISOString(), isExcused: false };
                completions.push(completion);
            } else {
                completion.score = score;
                completion.date = new Date().toISOString();
                completion.isExcused = false;
            }

            await updateDoc(assignmentRef, { completions });
        };
        window.handleScoreChange = handleScoreChange;
        
        const handleExcusedToggle = async (assignmentId, event) => {
            const assignmentRef = doc(db, `artifacts/${appId}/public/data/assignments`, assignmentId);
            const studentId = state.selectedStudent.id;
            const assignmentDoc = state.assignments.find(a => a.id === assignmentId);
            let completions = assignmentDoc.completions || [];
            let completion = completions.find(c => c.studentId === studentId);

            if (!completion) {
                completion = { studentId, score: 0, date: null, isExcused: true };
                completions.push(completion);
            } else {
                completion.isExcused = event.target.checked;
                completion.score = 0;
            }

            await updateDoc(assignmentRef, { completions });
        };
        window.handleExcusedToggle = handleExcusedToggle;

        const clearCompletion = async (assignmentId) => {
            const assignmentRef = doc(db, `artifacts/${appId}/public/data/assignments`, assignmentId);
            const studentId = state.selectedStudent.id;
            const assignmentDoc = state.assignments.find(a => a.id === assignmentId);
            const completions = assignmentDoc.completions.filter(c => c.studentId !== studentId);
            await updateDoc(assignmentRef, { completions });
        };
        window.clearCompletion = clearCompletion;

        const handleClearStudentData = async () => {
            if (!state.selectedStudent) return;
            const confirmClear = confirm(`Are you sure you want to clear all data for ${state.selectedStudent.name}? This will delete all their scores, excused assignments, and requests.`);
            if (confirmClear) {
                await runTransaction(db, async (transaction) => {
                    // Clear assignments
                    const assignmentsRef = collection(db, `artifacts/${appId}/public/data/assignments`);
                    const assignmentsSnapshot = await getDocs(query(assignmentsRef, where('periodId', '==', state.selectedStudent.periodId)));
                    
                    assignmentsSnapshot.forEach(doc => {
                        const completions = doc.data().completions.filter(c => c.studentId !== state.selectedStudent.id);
                        transaction.update(doc.ref, { completions });
                    });

                    // Clear requests
                    const requestsRef = collection(db, `artifacts/${appId}/public/data/requests`);
                    const q = query(requestsRef, where('studentId', '==', state.selectedStudent.studentId));
                    const requestsSnapshot = await getDocs(q);
                    requestsSnapshot.forEach(doc => transaction.delete(doc.ref));
                });
            }
        };
        window.handleClearStudentData = handleClearStudentData;

        const handleQueueItemClick = (e) => {
            const studentId = e.target.dataset.studentId;
            state.selectedStudent = state.students.find(s => s.id === studentId);
            renderUI();
        };

        const handleCopyLink = () => {
            const studentId = state.selectedStudent.studentId;
            const link = `${window.location.origin}/student.html?studentId=${studentId}`;
            const el = document.createElement('textarea');
            el.value = link;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);
            alert("Student link copied to clipboard!");
        };
        window.handleCopyLink = handleCopyLink;

        const handleClearAllRequests = async () => {
            if (!state.selectedStudent) return;
            const confirmClear = confirm(`Are you sure you want to clear all active help and check requests for ${state.selectedStudent.name}?`);
            if (confirmClear) {
                const requestsRef = collection(db, `artifacts/${appId}/public/data/requests`);
                const q = query(requestsRef, where('studentId', '==', state.selectedStudent.studentId));
                const requestsSnapshot = await getDocs(q);
                await Promise.all(requestsSnapshot.docs.map(doc => deleteDoc(doc.ref)));
            }
        };
        window.handleClearAllRequests = handleClearAllRequests;
        
        const setupDragAndDrop = () => {
            const grid = document.getElementById('class-grid');
            let dragSrcEl = null;

            function handleDragStart(e) {
                this.style.opacity = '0.4';
                dragSrcEl = this;
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', this.dataset.id);
            }

            function handleDragOver(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
            }

            function handleDrop(e) {
                e.preventDefault();
                const dropTarget = e.currentTarget;
                if (dragSrcEl !== dropTarget) {
                    const dragId = dragSrcEl.dataset.id;
                    const dropId = dropTarget.dataset.id;

                    const draggedStudent = state.students.find(s => s.id === dragId);
                    const dropStudent = state.students.find(s => s.id === dropId);

                    if (draggedStudent && dropStudent) {
                        const draggedSeatOrder = draggedStudent.seatOrder;
                        const dropSeatOrder = dropStudent.seatOrder;

                        runTransaction(db, async (transaction) => {
                            if (draggedSeatOrder < dropSeatOrder) {
                                state.students.filter(s => s.seatOrder > draggedSeatOrder && s.seatOrder <= dropSeatOrder)
                                    .forEach(s => {
                                        const studentRef = doc(db, `artifacts/${appId}/public/data/students`, s.id);
                                        transaction.update(studentRef, { seatOrder: s.seatOrder - 1 });
                                    });
                            } else {
                                state.students.filter(s => s.seatOrder >= dropSeatOrder && s.seatOrder < draggedSeatOrder)
                                    .forEach(s => {
                                        const studentRef = doc(db, `artifacts/${appId}/public/data/students`, s.id);
                                        transaction.update(studentRef, { seatOrder: s.seatOrder + 1 });
                                    });
                            }
                            const draggedStudentRef = doc(db, `artifacts/${appId}/public/data/students`, dragId);
                            transaction.update(draggedStudentRef, { seatOrder: dropSeatOrder });
                        });
                    }
                }
                return false;
            }

            function handleDragEnd(e) {
                this.style.opacity = '1';
                document.querySelectorAll('.student-card').forEach(card => {
                    card.classList.remove('drag-over');
                });
            }

            document.querySelectorAll('.student-card').forEach(card => {
                card.addEventListener('dragstart', handleDragStart, false);
                card.addEventListener('dragover', handleDragOver, false);
                card.addEventListener('drop', handleDrop, false);
                card.addEventListener('dragend', handleDragEnd, false);
            });
        };

        document.addEventListener('DOMContentLoaded', () => {
            renderUI();
        });
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
    </style>
</head>
<body>
    <div id="app"></div>
</body>
</html>
