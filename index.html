<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Classroom Management App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .view {
            display: none;
        }
        .view.active {
            display: block;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        /* Drag and Drop Styles */
        .seat.dragging-over {
            outline: 3px solid #2563eb;
            background-color: #dbeafe;
        }
        .student-roster-item:hover, .seat.draggable-student:hover {
             cursor: grab;
        }
        .seat.blank-seat {
            background-color: #e5e7eb;
        }
        .dragging {
            opacity: 0.7;
            transform: scale(1.05);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app" class="max-w-7xl mx-auto p-4 md:p-8">
        <div id="login-type-selection" class="view active text-center bg-white p-8 rounded-xl shadow-md">
            <h1 class="text-3xl font-bold mb-4 text-gray-900">Classroom Management</h1>
            <p class="text-gray-600 mb-8">Please select your login type.</p>
            <div class="flex flex-col md:flex-row justify-center items-center gap-4">
                <button onclick="switchView('teacher-login')" class="w-full max-w-xs bg-blue-600 text-white font-semibold py-4 px-8 rounded-lg shadow-md hover:bg-blue-700 transition-transform transform hover:scale-105">
                    Teacher Login
                </button>
                <button onclick="switchView('student-login')" class="w-full max-w-xs bg-green-600 text-white font-semibold py-4 px-8 rounded-lg shadow-md hover:bg-green-700 transition-transform transform hover:scale-105">
                    Student Login
                </button>
            </div>
        </div>

        <div id="teacher-login-view" class="view text-center bg-white p-8 rounded-xl shadow-md max-w-md mx-auto">
<h1 class="text-3xl font-bold mb-4 text-gray-900">Teacher Portal</h1>
<p class="text-gray-600 mb-8">Enter the teacher password to access the dashboard.</p>
<input type="password" id="teacher-password" placeholder="Enter Password"
       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 mb-4" required>
<button onclick="checkTeacherPassword()"
        class="w-full bg-blue-600 text-white font-semibold py-4 px-6 rounded-lg shadow-md hover:bg-blue-700 transition-transform transform hover:scale-105">
  Access Dashboard
</button>
<p id="teacher-login-error" class="text-red-500 text-sm h-4 mt-2"></p>
<button onclick="switchView('login-type-selection')" class="mt-4 text-sm text-gray-600 hover:text-gray-800">Back to login selection</button>
</div>

        <div id="student-login-view" class="view bg-white p-8 rounded-xl shadow-md max-w-md mx-auto">
            <h1 class="text-3xl font-bold mb-4 text-gray-900 text-center">Student Login</h1>
            <form id="student-login-form" class="flex flex-col items-center gap-4 mx-auto">
                <label for="student-id-login" class="sr-only">Student ID</label>
                <input type="number" id="student-id-login" placeholder="Enter Your Student ID#" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500" required>
                <button type="submit" class="w-full bg-green-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-green-700 transition">Login</button>
                <p id="login-error" class="text-red-500 text-sm h-4"></p> </form>
            <button onclick="switchView('login-type-selection')" class="mt-4 block w-full text-center text-sm text-gray-600 hover:text-gray-800">Back to login selection</button>
        </div>

        <div id="teacher-view" class="view">
            <header class="flex justify-between items-center mb-6">
                <div>
                    <h1 class="text-4xl font-bold text-gray-900">Teacher Dashboard</h1>
                    <p class="text-gray-500">Manage your classroom assignments, students, and seating arrangements.</p>
                </div>
                 <button onclick="switchView('login-type-selection')" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition">Logout</button>
            </header>

            <div class="mb-6 border-b border-gray-200">
                <nav class="flex space-x-4" aria-label="Tabs">
                    <button onclick="switchTeacherTab('assignments')" id="tab-assignments" class="tab-btn whitespace-nowrap pb-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                        Assignments
                    </button>
                    <button onclick="switchTeacherTab('students')" id="tab-students" class="tab-btn whitespace-nowrap pb-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                        Students
                    </button>
                    <button onclick="switchTeacherTab('seating-chart')" id="tab-seating-chart" class="tab-btn whitespace-nowrap pb-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                        Seating Chart
                    </button>
                    <button onclick="switchTeacherTab('backup')" id="tab-backup" class="tab-btn whitespace-nowrap pb-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                        Backup
                    </button>
                </nav>
            </div>

            <div id="content-assignments" class="tab-content">
                 <div class="bg-white p-6 rounded-xl shadow-md">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold">Assignments</h2>
                        <div class="flex gap-2">
  <button onclick="openModal('bulk-assignment-modal')" class="bg-purple-600 text-white font-semibold py-2.5 px-5 rounded-lg hover:bg-purple-700 transition">Bulk Add</button>
  <button onclick="openModal('add-assignment-modal')" class="bg-blue-600 text-white font-semibold py-2.5 px-5 rounded-lg hover:bg-blue-700 transition">Add Assignment</button>
</div>
</div>
                    <div class="flex items-center gap-2 flex-wrap mb-4">
                        <span class="text-sm font-medium text-gray-600">Sort by:</span>
                        <button onclick="sortTeacherAssignments('number_asc')" class="text-sm bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-full hover:bg-gray-300 transition">Number (Asc)</button>
                        <button onclick="sortTeacherAssignments('number_desc')" class="text-sm bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-full hover:bg-gray-300 transition">Number (Desc)</button>
                        <button onclick="sortTeacherAssignments('date_desc')" class="text-sm bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-full hover:bg-gray-300 transition">Date (Newest)</button>
                        <button onclick="sortTeacherAssignments('date_asc')" class="text-sm bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-full hover:bg-gray-300 transition">Date (Oldest)</button>
                    </div>
                    <div id="teacher-assignment-list" class="space-y-4">
                        </div>
                </div>
            </div>

            <div id="content-students" class="tab-content">
                 <div class="bg-white p-6 rounded-xl shadow-md">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold">Student Roster</h2>
                        <div class="flex items-center gap-2">
                            <button onclick="openModal('add-student-modal')" class="bg-green-600 text-white font-semibold py-2.5 px-5 rounded-lg hover:bg-green-700 transition">Add</button>
                            <button onclick="openModal('bulk-upload-modal')" class="bg-purple-600 text-white font-semibold py-2.5 px-5 rounded-lg hover:bg-purple-700 transition">Bulk Upload</button>
                        </div>
                    </div>
                    <div class="flex items-center gap-2 mb-4 border-b pb-4">
                        <span class="text-sm font-medium text-gray-600">Sort by:</span>
                        <button onclick="sortStudents('firstName')" class="text-sm bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-full hover:bg-gray-300 transition">First Name</button>
                        <button onclick="sortStudents('lastName')" class="text-sm bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-full hover:bg-gray-300 transition">Last Name</button>
                    </div>
                    <div class="flex justify-between items-center mb-4">
                         <div class="flex items-center gap-3">
                            <input type="checkbox" id="select-all-students" onchange="toggleSelectAll(this)" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            <label for="select-all-students" class="text-sm font-medium text-gray-700">Select All</label>
                        </div>
                        <button id="delete-selected-btn" onclick="confirmDeleteSelectedStudents()" class="hidden bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 transition">Delete Selected</button>
                    </div>
                    <ul id="teacher-student-list" class="space-y-3">
                        </ul>
                </div>
            </div>

             <div id="content-seating-chart" class="tab-content">
                <div class="flex flex-col xl:flex-row gap-8">
                    <div class="flex-grow bg-white p-6 rounded-xl shadow-md">
                        <h2 class="text-2xl font-bold mb-4">Classroom Layout</h2>
                        <div id="seating-chart-grid" class="grid grid-cols-6 gap-4">
                            </div>
                    </div>
                    <div class="xl:w-1/4 xl:max-w-sm flex-shrink-0 space-y-8">
                        <div class="bg-white p-6 rounded-xl shadow-md">
                            <h2 class="text-2xl font-bold mb-4">Student Requests</h2>
                            <ul id="student-requests-list" class="space-y-4 max-h-60 overflow-y-auto pr-2">
                                <li class="text-gray-500 italic">No student requests at the moment.</li>
                            </ul>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-md">
                             <h2 class="text-2xl font-bold mb-4">Unseated Students</h2>
                             <div class="mb-4">
                                 <div id="add-blank-seat" draggable="true" class="p-3 text-center bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 cursor-grab font-medium">
                                     Add Blank Seat
                                 </div>
                             </div>
                             <ul id="unseated-student-list" class="space-y-3 max-h-60 overflow-y-auto pr-2">
                                </ul>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="content-backup" class="tab-content">
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-2xl font-bold mb-4">Data Backup</h2>
                    <p class="mb-6 text-gray-600">Export all your classroom data into a single CSV file. This includes students, assignments, scores, requests, and the seating chart arrangement.</p>
                    <button onclick="exportAllDataAsCSV()" class="bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-indigo-700 transition">
                        Export All Data as CSV
                    </button>
                </div>
            </div>

        </div>

        <div id="student-view" class="view">
            <header class="flex justify-between items-center mb-8">
                 <div>
                    <h1 class="text-4xl font-bold text-gray-900">Student Dashboard</h1>
                    <p class="text-gray-500">Welcome, <span id="student-name" class="font-semibold"></span>!</p>
                </div>
                 <button onclick="logout()" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition">Logout</button>
            </header>

            <div class="bg-white p-6 rounded-xl shadow-md">
                <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                    <h2 class="text-2xl font-bold">Your Assignments</h2>
                    <div class="flex items-center gap-2 flex-wrap">
                        <span class="text-sm font-medium text-gray-600">Sort by:</span>
                        <button onclick="sortAssignments('number_asc')" class="text-sm bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-full hover:bg-gray-300 transition">Number (Asc)</button>
                        <button onclick="sortAssignments('number_desc')" class="text-sm bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-full hover:bg-gray-300 transition">Number (Desc)</button>
                        <button onclick="sortAssignments('date_desc')" class="text-sm bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-full hover:bg-gray-300 transition">Date (Newest)</button>
                        <button onclick="sortAssignments('date_asc')" class="text-sm bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-full hover:bg-gray-300 transition">Date (Oldest)</button>
                        <button onclick="sortAssignments('score_desc')" class="text-sm bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-full hover:bg-gray-300 transition">Score (High)</button>
                        <button onclick="sortAssignments('score_asc')" class="text-sm bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-full hover:bg-gray-300 transition">Score (Low)</button>
                    </div>
                </div>
                <div id="student-assignment-list" class="space-y-5">
                     </div>
            </div>
        </div>
    </div>

    <div id="add-assignment-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-lg">
            <h2 class="text-2xl font-bold mb-6">New Assignment</h2>
            <form id="add-assignment-form" class="space-y-6">
                <div>
                    <label for="assignment-number" class="block text-sm font-medium text-gray-700 mb-1">Assignment Number</label>
                    <input type="number" id="assignment-number" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <div>
                    <label for="assignment-title" class="block text-sm font-medium text-gray-700 mb-1">Title</label>
                    <input type="text" id="assignment-title" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <div>
                    <label for="assignment-posted-date" class="block text-sm font-medium text-gray-700 mb-1">Posted Date</label>
                    <input type="date" id="assignment-posted-date" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    <p class="text-xs text-gray-500 mt-1">Leave blank to use today's date.</p>
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" onclick="closeModal('add-assignment-modal')" class="bg-gray-200 text-gray-700 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300 transition">Cancel</button>
                    <button type="submit" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700 transition">Add</button>
                </div>
            </form>
        </div>
    </div>

    <div id="edit-assignment-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-lg">
            <h2 class="text-2xl font-bold mb-6">Edit Assignment</h2>
            <form id="edit-assignment-form" class="space-y-6">
                <input type="hidden" id="assignment-original-id-edit">
                <div>
                    <label for="assignment-number-edit" class="block text-sm font-medium text-gray-700 mb-1">Assignment Number</label>
                    <input type="number" id="assignment-number-edit" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <div>
                    <label for="assignment-title-edit" class="block text-sm font-medium text-gray-700 mb-1">Title</label>
                    <input type="text" id="assignment-title-edit" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <div>
                    <label for="assignment-posted-date-edit" class="block text-sm font-medium text-gray-700 mb-1">Posted Date</label>
                    <input type="date" id="assignment-posted-date-edit" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                     <p class="text-xs text-gray-500 mt-1">Leave blank to use today's date.</p>
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" onclick="closeModal('edit-assignment-modal')" class="bg-gray-200 text-gray-700 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300 transition">Cancel</button>
                    <button type="submit" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700 transition">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <div id="score-assignment-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-3xl">
            <h2 class="text-2xl font-bold mb-2">Score Assignment</h2>
            <h3 class="text-lg text-gray-600 mb-6" id="score-assignment-title"></h3>
            <form id="score-assignment-form">
                <input type="hidden" id="score-assignment-id">
                <div id="student-scores-list" class="space-y-4 max-h-96 overflow-y-auto pr-2">
                    </div>
                <div class="flex justify-end gap-4 mt-8">
                    <button type="button" onclick="closeModal('score-assignment-modal')" class="bg-gray-200 text-gray-700 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300 transition">Cancel</button>
                    <button type="submit" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700 transition">Save Scores</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="add-student-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-lg">
            <h2 class="text-2xl font-bold mb-6">Add New Student</h2>
            <form id="add-student-form" class="space-y-6">
                <div>
                    <label for="student-id-add" class="block text-sm font-medium text-gray-700 mb-1">Student ID#</label>
                    <input type="number" id="student-id-add" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500" required>
                </div>
                <div>
                    <label for="student-firstName-add" class="block text-sm font-medium text-gray-700 mb-1">First Name</label>
                    <input type="text" id="student-firstName-add" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500" required>
                </div>
                <div>
                    <label for="student-lastName-add" class="block text-sm font-medium text-gray-700 mb-1">Last Name</label>
                    <input type="text" id="student-lastName-add" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500" required>
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" onclick="closeModal('add-student-modal')" class="bg-gray-200 text-gray-700 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300 transition">Cancel</button>
                    <button type="submit" class="bg-green-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-green-700 transition">Add Student</button>
                </div>
            </form>
        </div>
    </div>

    <div id="edit-student-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-lg">
            <h2 class="text-2xl font-bold mb-6">Edit Student</h2>
            <form id="edit-student-form" class="space-y-6">
                <input type="hidden" id="student-original-id-edit">
                <div>
                    <label for="student-id-edit" class="block text-sm font-medium text-gray-700 mb-1">Student ID#</label>
                    <input type="number" id="student-id-edit" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <div>
                    <label for="student-firstName-edit" class="block text-sm font-medium text-gray-700 mb-1">First Name</label>
                    <input type="text" id="student-firstName-edit" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <div>
                    <label for="student-lastName-edit" class="block text-sm font-medium text-gray-700 mb-1">Last Name</label>
                    <input type="text" id="student-lastName-edit" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" onclick="closeModal('edit-student-modal')" class="bg-gray-200 text-gray-700 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300 transition">Cancel</button>
                    <button type="submit" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700 transition">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="bulk-upload-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-xl">
            <h2 class="text-2xl font-bold mb-6">Bulk Upload Students</h2>
            <form id="bulk-upload-form">
                <div class="mb-4">
                    <label for="bulk-student-data" class="block text-sm font-medium text-gray-700 mb-1">Student Data (ID, First Name, Last Name)</label>
                    <textarea id="bulk-student-data" rows="10" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500 font-mono text-sm" placeholder="Paste student data here. One student per line.&#10;Example:&#10;101,Frank,Castle&#10;102,Grace,Hopper"></textarea>
                    <p class="text-xs text-gray-500 mt-1">Note: Students with existing IDs will be skipped to avoid duplicates.</p>
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" onclick="closeModal('bulk-upload-modal')" class="bg-gray-200 text-gray-700 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300 transition">Cancel</button>
                    <button type="submit" class="bg-purple-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-purple-700 transition">Upload Students</button>
                </div>
            </form>
        </div>
    </div>

    <div id="student-assignment-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-3xl">
            <h2 id="student-assignment-modal-title" class="text-2xl font-bold mb-6"></h2>
            <div id="student-assignment-modal-list" class="space-y-4 max-h-96 overflow-y-auto pr-2">
                </div>
            <div id="student-assignment-modal-footer" class="flex justify-end mt-8 gap-4">
                <button type="button" onclick="closeModal('student-assignment-modal')" class="bg-gray-200 text-gray-700 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300 transition">Cancel</button>
                <button type="button" id="save-student-scores-btn" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700 transition">Save Scores</button>
            </div>
        </div>
    </div>

    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm text-center">
            <h2 class="text-xl font-bold mb-4" id="confirmation-title">Are you sure?</h2>
            <p id="confirmation-message" class="text-gray-600 mb-6">This action cannot be undone.</p>
            <div class="flex justify-center gap-4">
                <button id="cancel-button" class="bg-gray-200 text-gray-700 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300 transition">Cancel</button>
                <button id="confirm-button" class="bg-red-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-red-700 transition">Confirm</button>
            </div>
        </div>
    </div>

    <div id="bulk-assignment-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
  <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-2xl">
    <h2 class="text-2xl font-bold mb-6">Bulk Add Assignments</h2>

    <div class="mb-4 text-sm text-gray-600">
      Paste one assignment per line. Optional date in <code>YYYY-MM-DD</code> after a comma or pipe.
      <pre class="bg-gray-50 p-3 rounded mt-2 overflow-auto">Intro to Robotics
CAD Basics, 2025-09-01
Drafting Quiz | 2025-09-03</pre>
    </div>

    <form id="bulk-assignment-form" class="space-y-4">
      <textarea id="bulk-assignment-data" rows="10"
        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500 font-mono text-sm"
        placeholder="One per line: Title[, YYYY-MM-DD] or Title | YYYY-MM-DD"></textarea>

      <div class="flex items-center justify-between">
        <label class="flex items-center gap-2 text-sm">
          <input id="bulk-assignment-default-today" type="checkbox" class="h-4 w-4 text-purple-600" checked>
          Use today’s date when missing
        </label>
        <div class="flex gap-3">
          <button type="button" onclick="closeModal('bulk-assignment-modal')"
            class="bg-gray-200 text-gray-700 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300 transition">Cancel</button>
          <button type="submit"
            class="bg-purple-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-purple-700 transition">Add All</button>
        </div>
      </div>
    </form>
  </div>
</div>


    <div id="success-message" class="fixed bottom-8 right-8 bg-green-500 text-white py-3 px-6 rounded-lg shadow-xl transform translate-y-20 opacity-0 transition-all duration-300 ease-out">
        </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, writeBatch, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- FIREBASE & DATA ---


// --- Teacher Password (front-end gate) ---
const TEACHER_PASSWORD = "Rocket_22!!"; // TODO: change this to your real password

function checkTeacherPassword() {
    const input = document.getElementById('teacher-password')?.value || "";
    const errorEl = document.getElementById('teacher-login-error');
    if (input === TEACHER_PASSWORD) {
        if (errorEl) errorEl.textContent = '';
        switchView('teacher'); // grant access
    } else {
        if (errorEl) errorEl.textContent = 'Incorrect password. Please try again.';
    }
}
// IMPORTANT for <script type="module"> + inline onclick handler:
window.checkTeacherPassword = checkTeacherPassword;

        let db, auth;
        let students = [];
        let assignments = [];
        let helpRequests = [];
        let checkRequests = [];
        let seatingChart = [];
        let studentsLoaded = false;
        let seatingLoaded = false;
        
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-classroom-app';
        
        let confirmAction = null;
        let currentStudentId = null;
        let currentSortKey = 'lastName'; // For student sorting
        let currentAssignmentSortKey = 'date_desc'; // For assignment sorting
        let currentTeacherAssignmentSortKey = 'number_asc'; // For teacher assignment sorting

        const CLASSROOM_ROWS = 4;
        const CLASSROOM_COLS = 6;
        const TOTAL_SEATS = CLASSROOM_ROWS * CLASSROOM_COLS;
        
        // --- COLLECTIONS ---
        let studentsCol, assignmentsCol, helpRequestsCol, checkRequestsCol;
        let seatingChartDoc;

        async function initFirebase() {
            try {
              const firebaseConfig = {
  apiKey: "AIzaSyCG3rtswPSuTocyRDqRPhzHEF9pB3Hkgos",
  authDomain: "classdashboard-d8c4d.firebaseapp.com",
  projectId: "classdashboard-d8c4d",
  storageBucket: "classdashboard-d8c4d.appspot.com",
  messagingSenderId: "409652457373",
  appId: "1:409652457373:web:241cc1a53b39fc71fa8974",
  measurementId: "G-KXJVNZKTRQ"
};
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                
                // Define collection paths
                console.log("initFirebase running...");
console.log("appId:", appId);
console.log("db:", db);

                const basePath = `artifacts/${appId}/public/data`;
               studentsCol = collection(db, basePath, "students");
assignmentsCol = collection(db, basePath, "assignments");
helpRequestsCol = collection(db, basePath, "helpRequests");
checkRequestsCol = collection(db, basePath, "checkRequests");
seatingChartDoc = doc(db, basePath, "seatingChart", "main");
                loadData();

            } catch (error) {
                console.error("Firebase initialization failed:", error);
            }
        }


        // --- DATA SYNC ---
        function loadData() {
            onSnapshot(query(studentsCol), (snapshot) => {
                students = snapshot.docs.map(doc => ({ fbId: doc.id, ...doc.data() }));
                sortStudents();
                studentsLoaded = true;
                if (currentView === 'teacher') renderTeacherView();
                maybeRenderSeatingChart();
            });

            onSnapshot(query(assignmentsCol), (snapshot) => {
                assignments = snapshot.docs.map(doc => ({ fbId: doc.id, ...doc.data() }));
                if (currentView === 'teacher') renderTeacherAssignmentList();
                if (currentView === 'student') renderStudentView();
            });
            
            onSnapshot(query(helpRequestsCol), (snapshot) => {
                helpRequests = snapshot.docs.map(doc => ({ fbId: doc.id, ...doc.data() }));
                if (currentView === 'teacher') {
                    renderStudentRequests();
                    renderSeatingChart();
                }
                if (currentView === 'student') renderStudentView();
            });

            onSnapshot(query(checkRequestsCol), (snapshot) => {
                checkRequests = snapshot.docs.map(doc => ({ fbId: doc.id, ...doc.data() }));
                if (currentView === 'teacher') {
                    renderStudentRequests();
                    renderSeatingChart();
                }
                if (currentView === 'student') renderStudentView();
            });

             onSnapshot(seatingChartDoc, async (docSnap) => {
                if (docSnap.exists()) {
                    seatingChart = docSnap.data().chart || Array(TOTAL_SEATS).fill(null);
                } else {
                    seatingChart = Array(TOTAL_SEATS).fill(null);
                    // Create the document if it doesn't exist
                    await setDoc(seatingChartDoc, { chart: seatingChart });
                }
                seatingLoaded = true;
                maybeRenderSeatingChart();
            });
        }
        
        async function saveSeatingChart() {
            await setDoc(seatingChartDoc, { chart: seatingChart });
        }


        // --- VIEWS & RENDERING ---
        const views = {
            'login-type-selection': document.getElementById('login-type-selection'),
            'teacher-login': document.getElementById('teacher-login-view'),
            'student-login': document.getElementById('student-login-view'),
            'teacher': document.getElementById('teacher-view'),
            'student': document.getElementById('student-view'),
        };

        let currentView = 'login-type-selection';
        let currentTeacherTab = 'seating-chart';

        function switchView(viewName) {
            views[currentView].classList.remove('active');
            views[viewName].classList.add('active');
            currentView = viewName;
            
            if (viewName === 'teacher') {
                switchTeacherTab('seating-chart'); // Default to seating chart tab
                renderTeacherView();
            }
            if (viewName === 'student') renderStudentView();
        }

        function switchTeacherTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('border-blue-600', 'text-blue-600');
                btn.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
            });

            document.getElementById(`content-${tabName}`).classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('border-blue-600', 'text-blue-600');
            document.getElementById(`tab-${tabName}`).classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
            currentTeacherTab = tabName;

            if(tabName === 'seating-chart') {
                renderSeatingChart();
                renderUnseatedStudentList();
                renderStudentRequests();
            }
        }
        
        function renderTeacherView() {
            renderTeacherStudentList();
            renderTeacherAssignmentList();
            if (currentTeacherTab === 'seating-chart') {
                renderStudentRequests();
                renderSeatingChart();
                renderUnseatedStudentList();
            }
        }
        
        function renderStudentView() {
            const currentStudent = students.find(s => s.id === currentStudentId);
            if (currentStudent) {
                document.getElementById('student-name').textContent = `${currentStudent.firstName} ${currentStudent.lastName}`;
                renderStudentAssignmentList(currentStudent);
            } else {
                logout();
            }
        }

        function sortStudents(key) {
            if (key) {
                currentSortKey = key;
            }
            if (currentSortKey) {
                students.sort((a, b) => String(a[currentSortKey]).localeCompare(String(b[currentSortKey])));
            }
            renderTeacherStudentList();
            updateDeleteSelectedButtonState();
        }

        function getSortableScore(score) {
            if (score === 'Excused' || score === 'Not Graded' || score === undefined || score === null) {
                return -1; // Treat non-numeric scores as the lowest value
            }
            return Number(score);
        }

        function sortAssignments(key) {
            currentAssignmentSortKey = key;
            renderStudentView(); 
        }

        function sortTeacherAssignments(key) {
            currentTeacherAssignmentSortKey = key;
            renderTeacherAssignmentList();
        }

        function renderTeacherStudentList() {
            const list = document.getElementById('teacher-student-list');
            list.innerHTML = students.map(s => `
                <li class="flex justify-between items-center p-4 bg-gray-50 rounded-lg">
                    <div class="flex items-center gap-3">
                        <input type="checkbox" class="student-checkbox h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500" data-student-id="${s.id}" onchange="updateDeleteSelectedButtonState()">
                        <span class="font-medium">${s.firstName} ${s.lastName} <span class="text-xs text-gray-500">(ID: ${s.id})</span></span>
                    </div>
                    <div class="flex items-center gap-4">
                        <button onclick="openEditStudentModal('${s.fbId}')" class="text-sm text-blue-600 hover:text-blue-800 font-medium py-1 px-3">Edit</button>
                        <button onclick="confirmDeleteStudent('${s.fbId}')" class="text-sm text-red-600 hover:text-red-800 font-medium py-1 px-3">Delete</button>
                    </div>
                </li>
            `).join('');
        }
        
        function renderUnseatedStudentList() {
            const list = document.getElementById('unseated-student-list');
            const seatedStudentIds = new Set(seatingChart.filter(id => typeof id === 'number'));
            const unseatedStudents = students.filter(s => !seatedStudentIds.has(s.id));

            list.innerHTML = unseatedStudents.map(s => `
                <li id="roster-student-${s.id}" data-id="${s.id}" class="student-roster-item p-4 bg-gray-50 rounded-lg font-medium text-center" draggable="true" ondragstart="handleDragStart(event)">
                    ${s.firstName} ${s.lastName}
                </li>
            `).join('');
        }

        function getScoreColor(score) {
            if (score === 'Excused' || score === 'Not Graded' || score === undefined || score === null) {
                return 'text-gray-500';
            }
            const numericScore = Number(score);
            if (isNaN(numericScore)) return 'text-gray-500';
            if (numericScore >= 90) return 'text-green-600 font-bold';
            if (numericScore >= 80) return 'text-blue-600 font-semibold';
            if (numericScore >= 70) return 'text-yellow-600';
            return 'text-red-600';
        }

        function renderStudentAssignmentList(student) {
            const list = document.getElementById('student-assignment-list');
            if (!list) return;

            const studentAssignments = assignments.map(assignment => {
                const score = assignment.scores ? assignment.scores[student.id] : undefined;
                return { ...assignment, studentScore: score };
            });

            studentAssignments.sort((a, b) => {
                switch (currentAssignmentSortKey) {
                    case 'number_asc': return a.number - b.number;
                    case 'number_desc': return b.number - a.number;
                    case 'date_asc': return new Date(a.postedDate) - new Date(b.postedDate);
                    case 'score_asc': return getSortableScore(a.studentScore) - getSortableScore(b.studentScore);
                    case 'score_desc': return getSortableScore(b.studentScore) - getSortableScore(a.studentScore);
                    default: // date_desc
                        return new Date(b.postedDate) - new Date(a.postedDate);
                }
            });

            if (studentAssignments.length === 0) {
                list.innerHTML = `<p class="text-center text-gray-500 py-4">No assignments have been posted yet.</p>`;
                return;
            }
            
            list.innerHTML = studentAssignments.map(assignment => {
                const score = assignment.studentScore;
                const scoreDisplay = (score !== undefined && score !== null) ? score : 'Not Graded';
                const scoreColorClass = getScoreColor(score);
                
                return `
                    <div class="p-5 bg-gray-50 rounded-lg flex flex-col md:flex-row justify-between items-start md:items-center gap-4 border-l-4 ${score === undefined || score === null ? 'border-gray-200' : 'border-blue-500'}">
                        <div class="flex-grow">
                            <p class="font-bold text-lg text-gray-900">${assignment.title}</p>
                            <p class="text-sm text-gray-500">Assignment #${assignment.number} &bull; Posted: ${new Date(assignment.postedDate).toLocaleDateString()}</p>
                        </div>
                        <div class="text-right flex-shrink-0">
                            <p class="text-2xl font-bold ${scoreColorClass}">${scoreDisplay}</p>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function renderTeacherAssignmentList() {
            const list = document.getElementById('teacher-assignment-list');
            if (!list) return;

            assignments.sort((a, b) => {
                 switch (currentTeacherAssignmentSortKey) {
                    case 'number_desc': return b.number - a.number;
                    case 'date_desc': return new Date(b.postedDate) - new Date(a.postedDate);
                    case 'date_asc': return new Date(a.postedDate) - new Date(b.postedDate);
                    default: // number_asc
                       return a.number - b.number;
                }
            });

            if (assignments.length === 0) {
                list.innerHTML = `<p class="text-center text-gray-500 py-8">No assignments created. Click "Add Assignment" to start.</p>`;
                return;
            }

            list.innerHTML = assignments.map(a => `
                <div class="p-4 bg-gray-50 rounded-lg flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3">
                    <div>
                        <span class="font-bold text-lg text-gray-800">${a.title}</span>
                        <span class="text-sm text-gray-500 ml-2">(#${a.number})</span>
                        <p class="text-xs text-gray-500 mt-1">Posted: ${new Date(a.postedDate).toLocaleDateString()}</p>
                    </div>
                    <div class="flex items-center gap-3 flex-shrink-0">
                        <button onclick="openScoreAssignmentModal('${a.fbId}')" class="text-sm bg-blue-100 text-blue-700 font-semibold py-2 px-4 rounded-full hover:bg-blue-200 transition">Score</button>
                        <button onclick="openEditAssignmentModal('${a.fbId}')" class="text-sm bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-full hover:bg-gray-300 transition">Edit</button>
                        <button onclick="confirmDeleteAssignment('${a.fbId}')" class="text-sm bg-red-100 text-red-700 font-semibold py-2 px-4 rounded-full hover:bg-red-200 transition">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function renderStudentRequests() {
            const list = document.getElementById('student-requests-list');
            const allRequests = [...helpRequests, ...checkRequests]
                .sort((a, b) => a.timestamp - b.timestamp);

            if (allRequests.length === 0) {
                list.innerHTML = `<li class="text-gray-500 italic">No student requests at the moment.</li>`;
                return;
            }

            list.innerHTML = allRequests.map(req => {
                const student = students.find(s => s.id === req.studentId);
                const isHelp = 'helpText' in req;
                const bgColor = isHelp ? 'bg-yellow-100' : 'bg-green-100';
                const borderColor = isHelp ? 'border-yellow-500' : 'border-green-500';
                const buttonColor = isHelp ? 'bg-yellow-500 hover:bg-yellow-600' : 'bg-green-500 hover:bg-green-600';
                const requestTypeText = isHelp ? `needs help` : `wants their work checked`;

                if (!student) return ''; // Skip if student not found

                return `
                    <li class="${bgColor} p-4 rounded-lg border-l-4 ${borderColor}">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="font-bold text-gray-800">${student.firstName} ${student.lastName}</p>
                                <p class="text-sm text-gray-600">${requestTypeText}</p>
                            </div>
                            <button onclick="resolveRequest('${req.fbId}', ${isHelp})" class="${buttonColor} text-white font-bold py-2 px-3 rounded-md text-sm transition">
                                Resolve
                            </button>
                        </div>
                    </li>
                `;
            }).join('');
        }
        
        function maybeRenderSeatingChart() {
            if (studentsLoaded && seatingLoaded && currentView === 'teacher' && currentTeacherTab === 'seating-chart') {
                renderSeatingChart();
                renderUnseatedStudentList();
            }
        }
        
        function renderSeatingChart() {
            const grid = document.getElementById('seating-chart-grid');
            grid.innerHTML = '';
            for (let i = 0; i < TOTAL_SEATS; i++) {
                const studentId = seatingChart[i];
                const seatElement = document.createElement('div');
                seatElement.dataset.index = i;
                seatElement.className = 'seat p-2 h-24 rounded-lg flex flex-col justify-center items-center text-center shadow-sm transition-all duration-150';

                seatElement.ondragover = handleDragOver;
                seatElement.ondragleave = handleDragLeave;
                seatElement.ondrop = handleDrop;
                
                if (studentId === 'blank') {
                    seatElement.classList.add('blank-seat', 'border-2', 'border-dashed', 'border-gray-300');
                    seatElement.innerHTML = `<span class="text-xs text-gray-500">Blank Seat</span>`;
                } else if (typeof studentId === 'number') {
                    const student = students.find(s => s.id === studentId);
                    if (student) {
                        const hasHelpRequest = helpRequests.some(r => r.studentId === student.id);
                        const hasCheckRequest = checkRequests.some(r => r.studentId === student.id);
                        let stateClass = 'bg-white';
                        if (hasHelpRequest) stateClass = 'bg-yellow-400 animate-pulse';
                        else if (hasCheckRequest) stateClass = 'bg-green-400 animate-pulse';
                        
                        seatElement.classList.add('draggable-student', stateClass, 'cursor-grab');
                        seatElement.dataset.id = student.id;
                        seatElement.draggable = true;
                        seatElement.ondragstart = handleDragStart;
                        seatElement.innerHTML = `<span class="font-semibold text-gray-800 text-sm">${student.firstName} ${student.lastName.charAt(0)}.</span>`;
                    }
                } else {
                    seatElement.classList.add('bg-gray-100');
                    seatElement.innerHTML = `<span class="text-xs text-gray-400">Empty</span>`;
                }
                grid.appendChild(seatElement);
            }
        }

        // --- DRAG & DROP ---
        let draggedElement = null;
        function handleDragStart(event) {
            draggedElement = event.target;
            event.dataTransfer.setData('text/plain', event.target.dataset.id || 'blank-seat');
            setTimeout(() => {
                event.target.classList.add('dragging');
            }, 0);
        }

        function handleDragEnd(event) {
            event.target.classList.remove('dragging');
            draggedElement = null;
        }

        function handleDragOver(event) {
            event.preventDefault();
            const targetSeat = event.target.closest('.seat');
            if (targetSeat && targetSeat !== draggedElement) {
                targetSeat.classList.add('dragging-over');
            }
        }
        function handleDragLeave(event) {
            event.preventDefault();
            const targetSeat = event.target.closest('.seat');
            if (targetSeat) {
                 targetSeat.classList.remove('dragging-over');
            }
        }
        
       async function handleDrop(event) {
            event.preventDefault();
            const targetSeat = event.target.closest('.seat');
            if (!targetSeat) return;
            
            targetSeat.classList.remove('dragging-over');
            const droppedId = event.dataTransfer.getData('text/plain');

            // Find origin of dragged item
            const originIsRoster = draggedElement.id.startsWith('roster-student-') || draggedElement.id === 'add-blank-seat';
            const originIndex = originIsRoster ? null : parseInt(draggedElement.dataset.index, 10);
            const targetIndex = parseInt(targetSeat.dataset.index, 10);
            
            const targetOriginalContent = seatingChart[targetIndex];

            // Update chart model
            if (droppedId === 'blank-seat') {
                seatingChart[targetIndex] = 'blank';
            } else {
                seatingChart[targetIndex] = Number(droppedId);
            }
            
            if (originIndex !== null) {
                seatingChart[originIndex] = targetOriginalContent;
            }

            await saveSeatingChart();
            renderSeatingChart(); 
            renderUnseatedStudentList();
        }

        // --- MODALS ---
        function openModal(modalId) { document.getElementById(modalId).classList.remove('hidden'); }
        function closeModal(modalId) { document.getElementById(modalId).classList.add('hidden'); }

        function openEditStudentModal(fbId) {
            const student = students.find(s => s.fbId === fbId);
            if (student) {
                document.getElementById('student-original-id-edit').value = student.fbId;
                document.getElementById('student-id-edit').value = student.id;
                document.getElementById('student-firstName-edit').value = student.firstName;
                document.getElementById('student-lastName-edit').value = student.lastName;
                openModal('edit-student-modal');
            }
        }
        
        function openEditAssignmentModal(fbId) {
            const assignment = assignments.find(a => a.fbId === fbId);
            if(assignment) {
                document.getElementById('assignment-original-id-edit').value = assignment.fbId;
                document.getElementById('assignment-number-edit').value = assignment.number;
                document.getElementById('assignment-title-edit').value = assignment.title;
                const date = new Date(assignment.postedDate);
                const formattedDate = date.toISOString().split('T')[0];
                document.getElementById('assignment-posted-date-edit').value = formattedDate;
                openModal('edit-assignment-modal');
            }
        }
        
        function openScoreAssignmentModal(fbId) {
            const assignment = assignments.find(a => a.fbId === fbId);
            if (assignment) {
                document.getElementById('score-assignment-id').value = assignment.fbId;
                document.getElementById('score-assignment-title').textContent = `#${assignment.number}: ${assignment.title}`;
                const list = document.getElementById('student-scores-list');
                
                const sortedRoster = [...students].sort((a,b) => a.lastName.localeCompare(b.lastName));
                
                list.innerHTML = sortedRoster.map(s => {
                    const currentScore = (assignment.scores && assignment.scores[s.id] !== undefined) ? assignment.scores[s.id] : '';
                    return `
                        <div class="grid grid-cols-3 items-center gap-4">
                            <label for="score-${s.id}" class="text-sm font-medium text-gray-700 col-span-1">${s.firstName} ${s.lastName}</label>
                            <input type="text" id="score-${s.id}" data-student-id="${s.id}" value="${currentScore}" class="col-span-2 w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="Score (e.g., 85) or 'Excused'">
                        </div>
                    `;
                }).join('');
                openModal('score-assignment-modal');
            }
        }

        function confirmDeleteStudent(fbId) {
            confirmAction = () => deleteStudent(fbId);
            document.getElementById('confirmation-title').textContent = "Delete Student?";
            document.getElementById('confirmation-message').textContent = "Are you sure you want to delete this student? This action cannot be undone.";
            openModal('confirmation-modal');
        }

        function confirmDeleteSelectedStudents() {
            const selectedIds = getSelectedStudentIds();
            if (selectedIds.length > 0) {
                confirmAction = () => deleteSelectedStudents(selectedIds);
                document.getElementById('confirmation-title').textContent = `Delete ${selectedIds.length} Students?`;
                document.getElementById('confirmation-message').textContent = `Are you sure you want to delete the selected students? This action cannot be undone.`;
                openModal('confirmation-modal');
            }
        }

        function confirmDeleteAssignment(fbId) {
            confirmAction = () => deleteAssignment(fbId);
            document.getElementById('confirmation-title').textContent = "Delete Assignment?";
            document.getElementById('confirmation-message').textContent = "Are you sure you want to delete this assignment and all its scores? This cannot be undone.";
            openModal('confirmation-modal');
        }
        
        // --- DATA MANIPULATION ---
        async function addStudent(id, firstName, lastName) {
            const existingStudent = students.find(s => s.id === id);
            if (existingStudent) {
                alert(`Error: Student with ID ${id} already exists.`);
                return;
            }
            await addDoc(studentsCol, { id, firstName, lastName });
            showSuccessMessage('Student added successfully!');
        }
        
        async function editStudent(fbId, newId, newFirstName, newLastName) {
            const studentRef = doc(db, studentsCol.path, fbId);
            await updateDoc(studentRef, { id: newId, firstName: newFirstName, lastName: newLastName });
            showSuccessMessage('Student updated successfully!');
        }

        async function deleteStudent(fbId) {
            const studentRef = doc(db, studentsCol.path, fbId);
            await deleteDoc(studentRef);
            showSuccessMessage('Student deleted.');
        }

        async function addAssignment(number, title, postedDate) {
            const existingAssignment = assignments.find(a => a.number === number);
            if (existingAssignment) {
                 alert(`Error: Assignment with number ${number} already exists.`);
                return;
            }
            await addDoc(assignmentsCol, { number, title, postedDate, scores: {} });
            showSuccessMessage('Assignment added successfully!');
        }
        
        async function editAssignment(fbId, number, title, postedDate) {
            const assignmentRef = doc(db, assignmentsCol.path, fbId);
            await updateDoc(assignmentRef, { number, title, postedDate });
            showSuccessMessage('Assignment updated!');
        }

        async function deleteAssignment(fbId) {
            const assignmentRef = doc(db, assignmentsCol.path, fbId);
            await deleteDoc(assignmentRef);
            showSuccessMessage('Assignment deleted.');
        }

        async function saveScores(assignmentFbId, newScores) {
            const assignmentRef = doc(db, assignmentsCol.path, assignmentFbId);
            const assignmentDoc = await getDoc(assignmentRef);
            if (assignmentDoc.exists()) {
                const existingScores = assignmentDoc.data().scores || {};
                const updatedScores = { ...existingScores, ...newScores };
                await updateDoc(assignmentRef, { scores: updatedScores });
                showSuccessMessage('Scores saved!');
            }
        }
        
        async function requestHelp(studentId) {
            const existingRequest = helpRequests.find(r => r.studentId === studentId);
            if (existingRequest) return; // Don't allow multiple requests
            await addDoc(helpRequestsCol, { studentId, timestamp: serverTimestamp() });
        }
        
        async function requestCheck(studentId) {
            const existingRequest = checkRequests.find(r => r.studentId === studentId);
            if (existingRequest) return; // Don't allow multiple requests
            await addDoc(checkRequestsCol, { studentId, timestamp: serverTimestamp() });
        }
        
        async function resolveRequest(fbId, isHelpRequest) {
            const collection = isHelpRequest ? helpRequestsCol : checkRequestsCol;
            const docRef = doc(db, collection.path, fbId);
            await deleteDoc(docRef);
        }

        async function cancelRequest(studentId) {
            const helpReq = helpRequests.find(r => r.studentId === studentId);
            if (helpReq) await resolveRequest(helpReq.fbId, true);

            const checkReq = checkRequests.find(r => r.studentId === studentId);
            if (checkReq) await resolveRequest(checkReq.fbId, false);
        }

        // --- BULK OPERATIONS ---
        async function bulkAddStudents(studentData) {
            const batch = writeBatch(db);
            const existingIds = new Set(students.map(s => s.id));
            let addedCount = 0;
            
            studentData.forEach(s => {
                if (!existingIds.has(s.id)) {
                    const newStudentRef = doc(studentsCol);
                    batch.set(newStudentRef, s);
                    addedCount++;
                }
            });
            
            await batch.commit();
            showSuccessMessage(`${addedCount} student(s) added.`);
        }

        function getSelectedStudentIds() {
            const checkboxes = document.querySelectorAll('.student-checkbox:checked');
            const studentFbIds = Array.from(checkboxes).map(cb => {
                const studentId = parseInt(cb.dataset.studentId, 10);
                const student = students.find(s => s.id === studentId);
                return student ? student.fbId : null;
            }).filter(id => id !== null);
            return studentFbIds;
        }

        async function deleteSelectedStudents(fbIds) {
            const batch = writeBatch(db);
            fbIds.forEach(fbId => {
                const studentRef = doc(db, studentsCol.path, fbId);
                batch.delete(studentRef);
            });
            await batch.commit();
            showSuccessMessage(`${fbIds.length} student(s) deleted.`);
            document.getElementById('select-all-students').checked = false;
            updateDeleteSelectedButtonState();
        }
        
        async function bulkAddAssignments(assignmentData) {
            const batch = writeBatch(db);
            const existingNumbers = new Set(assignments.map(a => a.number));
            let highestNumber = assignments.length > 0 ? Math.max(...assignments.map(a => a.number)) : 0;
            
            let addedCount = 0;
            assignmentData.forEach(item => {
                const newNumber = ++highestNumber;
                 if (!existingNumbers.has(newNumber)) {
                    const newAssignmentRef = doc(assignmentsCol);
                    batch.set(newAssignmentRef, {
                        number: newNumber,
                        title: item.title,
                        postedDate: item.date,
                        scores: {}
                    });
                    addedCount++;
                 }
            });

            await batch.commit();
            showSuccessMessage(`${addedCount} assignment(s) added.`);
        }

        // --- EVENT HANDLERS ---
        document.getElementById('student-login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const id = parseInt(document.getElementById('student-id-login').value, 10);
            const student = students.find(s => s.id === id);
            if (student) {
                currentStudentId = id;
                document.getElementById('login-error').textContent = '';
                switchView('student');
            } else {
                document.getElementById('login-error').textContent = 'Student ID not found.';
            }
        });

        document.getElementById('add-student-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = parseInt(document.getElementById('student-id-add').value, 10);
            const firstName = document.getElementById('student-firstName-add').value;
            const lastName = document.getElementById('student-lastName-add').value;
            await addStudent(id, firstName, lastName);
            closeModal('add-student-modal');
            e.target.reset();
        });

        document.getElementById('edit-student-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const fbId = document.getElementById('student-original-id-edit').value;
            const newId = parseInt(document.getElementById('student-id-edit').value, 10);
            const newFirstName = document.getElementById('student-firstName-edit').value;
            const newLastName = document.getElementById('student-lastName-edit').value;
            await editStudent(fbId, newId, newFirstName, newLastName);
            closeModal('edit-student-modal');
        });

        document.getElementById('add-assignment-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const number = parseInt(document.getElementById('assignment-number').value, 10);
            const title = document.getElementById('assignment-title').value;
            let postedDate = document.getElementById('assignment-posted-date').value;
            if (!postedDate) {
                postedDate = new Date().toISOString().split('T')[0];
            }
            await addAssignment(number, title, postedDate);
            closeModal('add-assignment-modal');
            e.target.reset();
        });

         document.getElementById('edit-assignment-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const fbId = document.getElementById('assignment-original-id-edit').value;
            const number = parseInt(document.getElementById('assignment-number-edit').value, 10);
            const title = document.getElementById('assignment-title-edit').value;
            let postedDate = document.getElementById('assignment-posted-date-edit').value;
             if (!postedDate) {
                postedDate = new Date().toISOString().split('T')[0];
            }
            await editAssignment(fbId, number, title, postedDate);
            closeModal('edit-assignment-modal');
        });

        document.getElementById('score-assignment-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const assignmentFbId = document.getElementById('score-assignment-id').value;
            const inputs = document.querySelectorAll('#student-scores-list input');
            const newScores = {};
            inputs.forEach(input => {
                const studentId = input.dataset.studentId;
                const scoreValue = input.value.trim();
                if (scoreValue !== '') {
                    newScores[studentId] = isNaN(Number(scoreValue)) ? scoreValue : Number(scoreValue);
                }
            });
            await saveScores(assignmentFbId, newScores);
            closeModal('score-assignment-modal');
        });

         document.getElementById('bulk-upload-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = document.getElementById('bulk-student-data').value.trim();
            const lines = data.split('\n');
            const studentData = lines.map(line => {
                const [id, firstName, lastName] = line.split(/[,|]/).map(item => item.trim());
                if(id && firstName && lastName) {
                    return { id: parseInt(id, 10), firstName, lastName };
                }
                return null;
            }).filter(s => s !== null && !isNaN(s.id));
            
            if (studentData.length > 0) {
                await bulkAddStudents(studentData);
                closeModal('bulk-upload-modal');
                e.target.reset();
            } else {
                alert('No valid student data found. Please check the format.');
            }
        });
        
         document.getElementById('bulk-assignment-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = document.getElementById('bulk-assignment-data').value.trim();
            const useTodayForMissing = document.getElementById('bulk-assignment-default-today').checked;
            const today = new Date().toISOString().split('T')[0];

            const lines = data.split('\n').filter(line => line.trim() !== '');
            const assignmentData = lines.map(line => {
                const parts = line.split(/[,|]/).map(item => item.trim());
                const title = parts[0];
                let date = parts[1] || (useTodayForMissing ? today : null);

                // Basic validation for YYYY-MM-DD format
                if (date && !/^\d{4}-\d{2}-\d{2}$/.test(date)) {
                   console.warn(`Invalid date format for "${title}", using default.`);
                   date = useTodayForMissing ? today : null;
                }
                
                return { title, date };
            }).filter(a => a.title && a.date);

            if (assignmentData.length > 0) {
                await bulkAddAssignments(assignmentData);
                closeModal('bulk-assignment-modal');
                e.target.reset();
            } else {
                alert('No valid assignment data found. Each line must have a title.');
            }
        });

        document.getElementById('confirm-button').addEventListener('click', () => {
            if (confirmAction) {
                confirmAction();
            }
            closeModal('confirmation-modal');
            confirmAction = null;
        });

        document.getElementById('cancel-button').addEventListener('click', () => {
            closeModal('confirmation-modal');
            confirmAction = null;
        });

        // --- UTILITY ---
        function logout() {
            currentStudentId = null;
            switchView('login-type-selection');
        }

        function toggleSelectAll(checkbox) {
            document.querySelectorAll('.student-checkbox').forEach(cb => {
                cb.checked = checkbox.checked;
            });
            updateDeleteSelectedButtonState();
        }

        function updateDeleteSelectedButtonState() {
            const anyChecked = document.querySelectorAll('.student-checkbox:checked').length > 0;
            document.getElementById('delete-selected-btn').classList.toggle('hidden', !anyChecked);
        }

        function showSuccessMessage(message) {
            const el = document.getElementById('success-message');
            el.textContent = message;
            el.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => {
                el.classList.add('translate-y-20', 'opacity-0');
            }, 3000);
        }

         function exportAllDataAsCSV() {
            let csvContent = "data:text/csv;charset=utf-8,";

            // Students
            csvContent += "Students\nID,First Name,Last Name\n";
            students.forEach(s => {
                csvContent += `${s.id},${s.firstName},${s.lastName}\n`;
            });
            csvContent += "\n";

            // Assignments and Scores
            csvContent += "Assignments\nNumber,Title,Posted Date\n";
            assignments.forEach(a => {
                csvContent += `${a.number},"${a.title}",${a.postedDate}\n`;
            });
            csvContent += "\n";

            csvContent += "Scores\nStudent ID,Assignment Number,Score\n";
            students.forEach(s => {
                assignments.forEach(a => {
                    const score = a.scores ? a.scores[s.id] : undefined;
                    if (score !== undefined) {
                        csvContent += `${s.id},${a.number},${score}\n`;
                    }
                });
            });
            csvContent += "\n";
            
            // Seating Chart
            csvContent += "Seating Chart\nSeat Index,Student ID\n";
            seatingChart.forEach((studentId, index) => {
                csvContent += `${index},${studentId || ''}\n`;
            });
            csvContent += "\n";


            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `classroom_data_export_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // --- GLOBAL ACCESS ---
        window.switchView = switchView;
        window.switchTeacherTab = switchTeacherTab;
        window.openModal = openModal;
        window.closeModal = closeModal;
        window.sortStudents = sortStudents;
        window.sortAssignments = sortAssignments;
        window.sortTeacherAssignments = sortTeacherAssignments;
        window.logout = logout;
        window.openEditStudentModal = openEditStudentModal;
        window.confirmDeleteStudent = confirmDeleteStudent;
        window.toggleSelectAll = toggleSelectAll;
        window.updateDeleteSelectedButtonState = updateDeleteSelectedButtonState;
        window.confirmDeleteSelectedStudents = confirmDeleteSelectedStudents;
        window.openEditAssignmentModal = openEditAssignmentModal;
        window.openScoreAssignmentModal = openScoreAssignmentModal;
        window.confirmDeleteAssignment = confirmDeleteAssignment;
        window.handleDragStart = handleDragStart;
        window.handleDragEnd = handleDragEnd;
        window.handleDragOver = handleDragOver;
        window.handleDragLeave = handleDragLeave;
        window.handleDrop = handleDrop;
        window.openStudentAssignmentModal = openStudentAssignmentModal;
        window.exportAllDataAsCSV = exportAllDataAsCSV;
        window.requestHelp = requestHelp;
        window.requestCheck = requestCheck;
        window.resolveRequest = resolveRequest;
        window.cancelRequest = cancelRequest;

        // --- INITIALIZATION ---
        initFirebase();
    </script>
</body>
</html>
