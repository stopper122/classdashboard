<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Classroom Management App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .view {
            display: none;
        }
        .view.active {
            display: block;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        /* Drag and Drop Styles */
        .seat.dragging-over {
            outline: 3px solid #2563eb;
            background-color: #dbeafe;
        }
        .student-roster-item:hover, .seat.draggable-student:hover {
             cursor: grab;
        }
        .seat.blank-seat {
            background-color: #e5e7eb;
        }
        .dragging {
            opacity: 0.7;
            transform: scale(1.05);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app" class="max-w-7xl mx-auto p-4 md:p-8">
        <div id="login-type-selection" class="view active text-center bg-white p-8 rounded-xl shadow-md">
            <h1 class="text-3xl font-bold mb-4 text-gray-900">Classroom Management</h1>
            <p class="text-gray-600 mb-8">Please select your login type.</p>
            <div class="flex flex-col md:flex-row justify-center items-center gap-4">
                <button onclick="switchView('teacher-login')" class="w-full max-w-xs bg-blue-600 text-white font-semibold py-4 px-8 rounded-lg shadow-md hover:bg-blue-700 transition-transform transform hover:scale-105">
                    Teacher Login
                </button>
                <button onclick="switchView('student-login')" class="w-full max-w-xs bg-green-600 text-white font-semibold py-4 px-8 rounded-lg shadow-md hover:bg-green-700 transition-transform transform hover:scale-105">
                    Student Login
                </button>
            </div>
        </div>

        <div id="teacher-login-view" class="view text-center bg-white p-8 rounded-xl shadow-md max-w-md mx-auto">
<h1 class="text-3xl font-bold mb-4 text-gray-900">Teacher Portal</h1>
<p class="text-gray-600 mb-8">Enter the teacher password to access the dashboard.</p>
<input type="password" id="teacher-password" placeholder="Enter Password"
       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 mb-4" required>
<button onclick="checkTeacherPassword()"
        class="w-full bg-blue-600 text-white font-semibold py-4 px-6 rounded-lg shadow-md hover:bg-blue-700 transition-transform transform hover:scale-105">
  Access Dashboard
</button>
<p id="teacher-login-error" class="text-red-500 text-sm h-4 mt-2"></p>
<button onclick="switchView('login-type-selection')" class="mt-4 text-sm text-gray-600 hover:text-gray-800">Back to login selection</button>
</div>

        <div id="student-login-view" class="view bg-white p-8 rounded-xl shadow-md max-w-md mx-auto">
            <h1 class="text-3xl font-bold mb-4 text-gray-900 text-center">Student Login</h1>
            <form id="student-login-form" class="flex flex-col items-center gap-4 mx-auto">
                <label for="student-id-login" class="sr-only">Student ID</label>
                <input type="number" id="student-id-login" placeholder="Enter Your Student ID#" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500" required>
                <button type="submit" class="w-full bg-green-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-green-700 transition">Login</button>
                <p id="login-error" class="text-red-500 text-sm h-4"></p> </form>
            <button onclick="switchView('login-type-selection')" class="mt-4 block w-full text-center text-sm text-gray-600 hover:text-gray-800">Back to login selection</button>
        </div>

        <div id="teacher-view" class="view">
            <header class="flex justify-between items-center mb-6">
                <div>
                    <h1 class="text-4xl font-bold text-gray-900">Teacher Dashboard</h1>
                    <p class="text-gray-500">Manage your classroom assignments, students, and seating arrangements.</p>
                </div>
                 <button onclick="switchView('login-type-selection')" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition">Logout</button>
            </header>

            <div class="mb-6 border-b border-gray-200">
                <nav class="flex space-x-4" aria-label="Tabs">
                    <button onclick="switchTeacherTab('assignments')" id="tab-assignments" class="tab-btn whitespace-nowrap pb-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                        Assignments
                    </button>
                    <button onclick="switchTeacherTab('students')" id="tab-students" class="tab-btn whitespace-nowrap pb-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                        Students
                    </button>
                    <button onclick="switchTeacherTab('seating-chart')" id="tab-seating-chart" class="tab-btn whitespace-nowrap pb-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                        Seating Chart
                    </button>
                    <button onclick="switchTeacherTab('backup')" id="tab-backup" class="tab-btn whitespace-nowrap pb-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                        Backup
                    </button>
                </nav>
            </div>

            <div id="content-assignments" class="tab-content">
                 <div class="bg-white p-6 rounded-xl shadow-md">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold">Assignments</h2>
                        <div class="flex gap-2">
  <button onclick="openModal('bulk-assignment-modal')" class="bg-purple-600 text-white font-semibold py-2.5 px-5 rounded-lg hover:bg-purple-700 transition">Bulk Add</button>
  <button onclick="openModal('add-assignment-modal')" class="bg-blue-600 text-white font-semibold py-2.5 px-5 rounded-lg hover:bg-blue-700 transition">Add Assignment</button>
</div>
</div>
                    <div class="flex items-center gap-2 flex-wrap mb-4">
                        <span class="text-sm font-medium text-gray-600">Sort by:</span>
                        <button onclick="sortTeacherAssignments('number_asc')" class="text-sm bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-full hover:bg-gray-300 transition">Number (Asc)</button>
                        <button onclick="sortTeacherAssignments('number_desc')" class="text-sm bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-full hover:bg-gray-300 transition">Number (Desc)</button>
                        <button onclick="sortTeacherAssignments('date_desc')" class="text-sm bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-full hover:bg-gray-300 transition">Date (Newest)</button>
                        <button onclick="sortTeacherAssignments('date_asc')" class="text-sm bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-full hover:bg-gray-300 transition">Date (Oldest)</button>
                    </div>
                    <div id="teacher-assignment-list" class="space-y-4">
                        </div>
                </div>
            </div>

            <div id="content-students" class="tab-content">
                 <div class="bg-white p-6 rounded-xl shadow-md">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold">Student Roster</h2>
                        <div class="flex items-center gap-2">
                            <button onclick="openModal('add-student-modal')" class="bg-green-600 text-white font-semibold py-2.5 px-5 rounded-lg hover:bg-green-700 transition">Add</button>
                            <button onclick="openModal('bulk-upload-modal')" class="bg-purple-600 text-white font-semibold py-2.5 px-5 rounded-lg hover:bg-purple-700 transition">Bulk Upload</button>
                        </div>
                    </div>
                    <div class="flex items-center gap-2 mb-4 border-b pb-4">
                        <span class="text-sm font-medium text-gray-600">Sort by:</span>
                        <button onclick="sortStudents('firstName')" class="text-sm bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-full hover:bg-gray-300 transition">First Name</button>
                        <button onclick="sortStudents('lastName')" class="text-sm bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-full hover:bg-gray-300 transition">Last Name</button>
                    </div>
                    <div class="flex justify-between items-center mb-4">
                         <div class="flex items-center gap-3">
                            <input type="checkbox" id="select-all-students" onchange="toggleSelectAll(this)" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            <label for="select-all-students" class="text-sm font-medium text-gray-700">Select All</label>
                        </div>
                        <button id="delete-selected-btn" onclick="confirmDeleteSelectedStudents()" class="hidden bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 transition">Delete Selected</button>
                    </div>
                    <ul id="teacher-student-list" class="space-y-3">
                        </ul>
                </div>
            </div>

             <div id="content-seating-chart" class="tab-content">
                <div class="flex flex-col xl:flex-row gap-8">
                    <div class="flex-grow bg-white p-6 rounded-xl shadow-md">
                        <h2 class="text-2xl font-bold mb-4">Classroom Layout</h2>
                        <div id="seating-chart-grid" class="grid grid-cols-6 gap-4">
                            </div>
                    </div>
                    <div class="xl:w-1/4 xl:max-w-sm flex-shrink-0 space-y-8">
                        <div class="bg-white p-6 rounded-xl shadow-md">
                            <h2 class="text-2xl font-bold mb-4">Student Requests</h2>
                            <ul id="student-requests-list" class="space-y-4 max-h-60 overflow-y-auto pr-2">
                                <li class="text-gray-500 italic">No student requests at the moment.</li>
                            </ul>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-md">
                             <h2 class="text-2xl font-bold mb-4">Unseated Students</h2>
                             <div class="mb-4">
                                 <div id="add-blank-seat" draggable="true" class="p-3 text-center bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 cursor-grab font-medium">
                                     Add Blank Seat
                                 </div>
                             </div>
                             <ul id="unseated-student-list" class="space-y-3 max-h-60 overflow-y-auto pr-2">
                                </ul>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="content-backup" class="tab-content">
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-2xl font-bold mb-4">Data Backup</h2>
                    <p class="mb-6 text-gray-600">Export all your classroom data into a single CSV file. This includes students, assignments, scores, requests, and the seating chart arrangement.</p>
                    <button onclick="exportAllDataAsCSV()" class="bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-indigo-700 transition">
                        Export All Data as CSV
                    </button>
                </div>
            </div>

        </div>

        <div id="student-view" class="view">
            <header class="flex justify-between items-center mb-8">
                 <div>
                    <h1 class="text-4xl font-bold text-gray-900">Student Dashboard</h1>
                    <p class="text-gray-500">Welcome, <span id="student-name" class="font-semibold"></span>!</p>
                </div>
                 <button onclick="logout()" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition">Logout</button>
            </header>

            <div class="bg-white p-6 rounded-xl shadow-md">
                <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                    <h2 class="text-2xl font-bold">Your Assignments</h2>
                    <div class="flex items-center gap-2 flex-wrap">
                        <span class="text-sm font-medium text-gray-600">Sort by:</span>
                        <button onclick="sortAssignments('number_asc')" class="text-sm bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-full hover:bg-gray-300 transition">Number (Asc)</button>
                        <button onclick="sortAssignments('number_desc')" class="text-sm bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-full hover:bg-gray-300 transition">Number (Desc)</button>
                        <button onclick="sortAssignments('date_desc')" class="text-sm bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-full hover:bg-gray-300 transition">Date (Newest)</button>
                        <button onclick="sortAssignments('date_asc')" class="text-sm bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-full hover:bg-gray-300 transition">Date (Oldest)</button>
                        <button onclick="sortAssignments('score_desc')" class="text-sm bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-full hover:bg-gray-300 transition">Score (High)</button>
                        <button onclick="sortAssignments('score_asc')" class="text-sm bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-full hover:bg-gray-300 transition">Score (Low)</button>
                    </div>
                </div>
                <div id="student-assignment-list" class="space-y-5">
                     </div>
            </div>
        </div>
    </div>

    <div id="add-assignment-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-lg">
            <h2 class="text-2xl font-bold mb-6">New Assignment</h2>
            <form id="add-assignment-form" class="space-y-6">
                <div>
                    <label for="assignment-number" class="block text-sm font-medium text-gray-700 mb-1">Assignment Number</label>
                    <input type="number" id="assignment-number" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <div>
                    <label for="assignment-title" class="block text-sm font-medium text-gray-700 mb-1">Title</label>
                    <input type="text" id="assignment-title" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <div>
                    <label for="assignment-description" class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                    <textarea id="assignment-description" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>
                <div>
                    <label for="assignment-posted-date" class="block text-sm font-medium text-gray-700 mb-1">Posted Date</label>
                    <input type="date" id="assignment-posted-date" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    <p class="text-xs text-gray-500 mt-1">Leave blank to use today's date.</p>
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" onclick="closeModal('add-assignment-modal')" class="bg-gray-200 text-gray-700 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300 transition">Cancel</button>
                    <button type="submit" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700 transition">Add</button>
                </div>
            </form>
        </div>
    </div>

    <div id="edit-assignment-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-lg">
            <h2 class="text-2xl font-bold mb-6">Edit Assignment</h2>
            <form id="edit-assignment-form" class="space-y-6">
                <input type="hidden" id="assignment-original-id-edit">
                <div>
                    <label for="assignment-number-edit" class="block text-sm font-medium text-gray-700 mb-1">Assignment Number</label>
                    <input type="number" id="assignment-number-edit" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <div>
                    <label for="assignment-title-edit" class="block text-sm font-medium text-gray-700 mb-1">Title</label>
                    <input type="text" id="assignment-title-edit" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <div>
                    <label for="assignment-description-edit" class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                    <textarea id="assignment-description-edit" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>
                <div>
                    <label for="assignment-posted-date-edit" class="block text-sm font-medium text-gray-700 mb-1">Posted Date</label>
                    <input type="date" id="assignment-posted-date-edit" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                     <p class="text-xs text-gray-500 mt-1">Leave blank to use today's date.</p>
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" onclick="closeModal('edit-assignment-modal')" class="bg-gray-200 text-gray-700 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300 transition">Cancel</button>
                    <button type="submit" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700 transition">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <div id="score-assignment-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-3xl">
            <h2 class="text-2xl font-bold mb-2">Score Assignment</h2>
            <h3 class="text-lg text-gray-600 mb-6" id="score-assignment-title"></h3>
            <form id="score-assignment-form">
                <input type="hidden" id="score-assignment-id">
                <div id="student-scores-list" class="space-y-4 max-h-96 overflow-y-auto pr-2">
                    </div>
                <div class="flex justify-end gap-4 mt-8">
                    <button type="button" onclick="closeModal('score-assignment-modal')" class="bg-gray-200 text-gray-700 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300 transition">Cancel</button>
                    <button type="submit" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700 transition">Save Scores</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="add-student-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-lg">
            <h2 class="text-2xl font-bold mb-6">Add New Student</h2>
            <form id="add-student-form" class="space-y-6">
                <div>
                    <label for="student-id-add" class="block text-sm font-medium text-gray-700 mb-1">Student ID#</label>
                    <input type="number" id="student-id-add" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500" required>
                </div>
                <div>
                    <label for="student-firstName-add" class="block text-sm font-medium text-gray-700 mb-1">First Name</label>
                    <input type="text" id="student-firstName-add" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500" required>
                </div>
                <div>
                    <label for="student-lastName-add" class="block text-sm font-medium text-gray-700 mb-1">Last Name</label>
                    <input type="text" id="student-lastName-add" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500" required>
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" onclick="closeModal('add-student-modal')" class="bg-gray-200 text-gray-700 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300 transition">Cancel</button>
                    <button type="submit" class="bg-green-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-green-700 transition">Add Student</button>
                </div>
            </form>
        </div>
    </div>

    <div id="edit-student-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-lg">
            <h2 class="text-2xl font-bold mb-6">Edit Student</h2>
            <form id="edit-student-form" class="space-y-6">
                <input type="hidden" id="student-original-id-edit">
                <div>
                    <label for="student-id-edit" class="block text-sm font-medium text-gray-700 mb-1">Student ID#</label>
                    <input type="number" id="student-id-edit" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <div>
                    <label for="student-firstName-edit" class="block text-sm font-medium text-gray-700 mb-1">First Name</label>
                    <input type="text" id="student-firstName-edit" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <div>
                    <label for="student-lastName-edit" class="block text-sm font-medium text-gray-700 mb-1">Last Name</label>
                    <input type="text" id="student-lastName-edit" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" onclick="closeModal('edit-student-modal')" class="bg-gray-200 text-gray-700 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300 transition">Cancel</button>
                    <button type="submit" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700 transition">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="bulk-upload-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-xl">
            <h2 class="text-2xl font-bold mb-6">Bulk Upload Students</h2>
            <form id="bulk-upload-form">
                <div class="mb-4">
                    <label for="bulk-student-data" class="block text-sm font-medium text-gray-700 mb-1">Student Data (ID, First Name, Last Name)</label>
                    <textarea id="bulk-student-data" rows="10" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500 font-mono text-sm" placeholder="Paste student data here. One student per line.&#10;Example:&#10;101,Frank,Castle&#10;102,Grace,Hopper"></textarea>
                    <p class="text-xs text-gray-500 mt-1">Note: Students with existing IDs will be skipped to avoid duplicates.</p>
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" onclick="closeModal('bulk-upload-modal')" class="bg-gray-200 text-gray-700 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300 transition">Cancel</button>
                    <button type="submit" class="bg-purple-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-purple-700 transition">Upload Students</button>
                </div>
            </form>
        </div>
    </div>

    <div id="student-assignment-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-3xl">
            <h2 id="student-assignment-modal-title" class="text-2xl font-bold mb-6"></h2>
            <div id="student-assignment-modal-list" class="space-y-4 max-h-96 overflow-y-auto pr-2">
                </div>
            <div id="student-assignment-modal-footer" class="flex justify-end mt-8 gap-4">
                <button type="button" onclick="closeModal('student-assignment-modal')" class="bg-gray-200 text-gray-700 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300 transition">Cancel</button>
                <button type="button" id="save-student-scores-btn" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700 transition">Save Scores</button>
            </div>
        </div>
    </div>

    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm text-center">
            <h2 class="text-xl font-bold mb-4" id="confirmation-title">Are you sure?</h2>
            <p id="confirmation-message" class="text-gray-600 mb-6">This action cannot be undone.</p>
            <div class="flex justify-center gap-4">
                <button id="cancel-button" class="bg-gray-200 text-gray-700 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300 transition">Cancel</button>
                <button id="confirm-button" class="bg-red-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-red-700 transition">Confirm</button>
            </div>
        </div>
    </div>

    <div id="bulk-assignment-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
  <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-2xl">
    <h2 class="text-2xl font-bold mb-6">Bulk Add Assignments</h2>

    <div class="mb-4 text-sm text-gray-600">
      Paste one assignment per line. Optional date in <code>YYYY-MM-DD</code> after a comma or pipe.
      <pre class="bg-gray-50 p-3 rounded mt-2 overflow-auto">Intro to Robotics
CAD Basics, 2025-09-01
Drafting Quiz | 2025-09-03</pre>
    </div>

    <form id="bulk-assignment-form" class="space-y-4">
      <textarea id="bulk-assignment-data" rows="10"
        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500 font-mono text-sm"
        placeholder="One per line: Title[, YYYY-MM-DD] or Title | YYYY-MM-DD"></textarea>

      <div class="flex items-center justify-between">
        <label class="flex items-center gap-2 text-sm">
          <input id="bulk-assignment-default-today" type="checkbox" class="h-4 w-4 text-purple-600" checked>
          Use today’s date when missing
        </label>
        <div class="flex gap-3">
          <button type="button" onclick="closeModal('bulk-assignment-modal')"
            class="bg-gray-200 text-gray-700 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300 transition">Cancel</button>
          <button type="submit"
            class="bg-purple-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-purple-700 transition">Add All</button>
        </div>
      </div>
    </form>
  </div>
</div>


    <div id="success-message" class="fixed bottom-8 right-8 bg-green-500 text-white py-3 px-6 rounded-lg shadow-xl transform translate-y-20 opacity-0 transition-all duration-300 ease-out">
        </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, writeBatch, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- FIREBASE & DATA ---


// --- Teacher Password (front-end gate) ---
const TEACHER_PASSWORD = "Rocket_22!!"; // TODO: change this to your real password

function checkTeacherPassword() {
    const input = document.getElementById('teacher-password')?.value || "";
    const errorEl = document.getElementById('teacher-login-error');
    if (input === TEACHER_PASSWORD) {
        if (errorEl) errorEl.textContent = '';
        switchView('teacher'); // grant access
    } else {
        if (errorEl) errorEl.textContent = 'Incorrect password. Please try again.';
    }
}
// IMPORTANT for <script type="module"> + inline onclick handler:
window.checkTeacherPassword = checkTeacherPassword;

        let db, auth;
        let students = [];
        let assignments = [];
        let helpRequests = [];
        let checkRequests = [];
        let seatingChart = [];
        let studentsLoaded = false;
        let seatingLoaded = false;
        
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-classroom-app';
        
        let confirmAction = null;
        let currentStudentId = null;
        let currentSortKey = 'lastName'; // For student sorting
        let currentAssignmentSortKey = 'date_desc'; // For assignment sorting
        let currentTeacherAssignmentSortKey = 'number_asc'; // For teacher assignment sorting

        const CLASSROOM_ROWS = 4;
        const CLASSROOM_COLS = 6;
        const TOTAL_SEATS = CLASSROOM_ROWS * CLASSROOM_COLS;
        
        // --- COLLECTIONS ---
        let studentsCol, assignmentsCol, helpRequestsCol, checkRequestsCol;
        let seatingChartDoc;

        async function initFirebase() {
            try {
              const firebaseConfig = {
  apiKey: "AIzaSyCG3rtswPSuTocyRDqRPhzHEF9pB3Hkgos",
  authDomain: "classdashboard-d8c4d.firebaseapp.com",
  projectId: "classdashboard-d8c4d",
  storageBucket: "classdashboard-d8c4d.appspot.com",
  messagingSenderId: "409652457373",
  appId: "1:409652457373:web:241cc1a53b39fc71fa8974",
  measurementId: "G-KXJVNZKTRQ"
};
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                
                // Define collection paths
                console.log("initFirebase running...");
console.log("appId:", appId);
console.log("db:", db);

                const basePath = `artifacts/${appId}/public/data`;
               studentsCol = collection(db, basePath, "students");
assignmentsCol = collection(db, basePath, "assignments");
helpRequestsCol = collection(db, basePath, "helpRequests");
checkRequestsCol = collection(db, basePath, "checkRequests");
seatingChartDoc = doc(db, basePath, "seatingChart", "main");
                loadData();

            } catch (error) {
                console.error("Firebase initialization failed:", error);
            }
        }


        // --- DATA SYNC ---
        function loadData() {
            onSnapshot(query(studentsCol), (snapshot) => {
                students = snapshot.docs.map(doc => ({ fbId: doc.id, ...doc.data() }));
                sortStudents();
                studentsLoaded = true;
                if (currentView === 'teacher') renderTeacherView();
                maybeRenderSeatingChart();
            });

            onSnapshot(query(assignmentsCol), (snapshot) => {
                assignments = snapshot.docs.map(doc => ({ fbId: doc.id, ...doc.data() }));
                if (currentView === 'teacher') renderTeacherAssignmentList();
                if (currentView === 'student') renderStudentView();
            });
            
            onSnapshot(query(helpRequestsCol), (snapshot) => {
                helpRequests = snapshot.docs.map(doc => ({ fbId: doc.id, ...doc.data() }));
                if (currentView === 'teacher') {
                    renderStudentRequests();
                    renderSeatingChart();
                }
                if (currentView === 'student') renderStudentView();
            });

            onSnapshot(query(checkRequestsCol), (snapshot) => {
                checkRequests = snapshot.docs.map(doc => ({ fbId: doc.id, ...doc.data() }));
                if (currentView === 'teacher') {
                    renderStudentRequests();
                    renderSeatingChart();
                }
                if (currentView === 'student') renderStudentView();
            });

             onSnapshot(seatingChartDoc, async (docSnap) => {
                if (docSnap.exists()) {
                    seatingChart = docSnap.data().chart || Array(TOTAL_SEATS).fill(null);
                } else {
                    seatingChart = Array(TOTAL_SEATS).fill(null);
                    // Create the document if it doesn't exist
                    await setDoc(seatingChartDoc, { chart: seatingChart });
                }
                seatingLoaded = true;
                maybeRenderSeatingChart();
            });
        }
        
        async function saveSeatingChart() {
            await setDoc(seatingChartDoc, { chart: seatingChart });
        }


        // --- VIEWS & RENDERING ---
        const views = {
            'login-type-selection': document.getElementById('login-type-selection'),
            'teacher-login': document.getElementById('teacher-login-view'),
            'student-login': document.getElementById('student-login-view'),
            'teacher': document.getElementById('teacher-view'),
            'student': document.getElementById('student-view'),
        };

        let currentView = 'login-type-selection';
        let currentTeacherTab = 'seating-chart';

        function switchView(viewName) {
            views[currentView].classList.remove('active');
            views[viewName].classList.add('active');
            currentView = viewName;

            if (viewName === 'teacher') {
                switchTeacherTab('seating-chart'); // Default to seating chart tab
                renderTeacherView();
            }
            if (viewName === 'student') renderStudentView();
        }

        function switchTeacherTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('border-blue-600', 'text-blue-600');
                btn.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
            });

            document.getElementById(`content-${tabName}`).classList.add('active');
            const tabButton = document.getElementById(`tab-${tabName}`);
            tabButton.classList.add('border-blue-600', 'text-blue-600');
            tabButton.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
            currentTeacherTab = tabName;

            if(tabName === 'seating-chart') {
                renderSeatingChart();
                renderUnseatedStudentList();
                renderStudentRequests();
            }
        }

        function renderTeacherView() {
            renderTeacherStudentList();
            renderTeacherAssignmentList();
            if (currentTeacherTab === 'seating-chart') {
                renderStudentRequests();
                renderSeatingChart();
                renderUnseatedStudentList();
            }
        }

        function renderStudentView() {
            const currentStudent = students.find(s => s.id === currentStudentId);
            if (currentStudent) {
                document.getElementById('student-name').textContent = `${currentStudent.firstName} ${currentStudent.lastName}`;
                renderStudentAssignmentList(currentStudent);
            } else {
                logout();
            }
        }

        function sortStudents(key) {
            if (key) {
                currentSortKey = key;
            }
            if (currentSortKey) {
                students.sort((a, b) => String(a[currentSortKey]).localeCompare(String(b[currentSortKey])));
            }
            renderTeacherStudentList();
            updateDeleteSelectedButtonState();
        }

        function getSortableScore(score) {
            if (score === 'Excused' || score === 'Not Graded' || score === undefined || score === null) {
                return -1; // Treat non-numeric scores as the lowest value
            }
            return Number(score);
        }

        function getScoreColor(score) {
            const numericScore = parseFloat(score);
            if (isNaN(numericScore)) {
                return 'text-gray-500'; // Default color for non-numeric scores
            }
            if (numericScore >= 90) {
                return 'text-green-600';
            } else if (numericScore >= 80) {
                return 'text-blue-600';
            } else if (numericScore >= 70) {
                return 'text-yellow-600';
            } else {
                return 'text-red-600';
            }
        }

        function sortAssignments(key) {
            currentAssignmentSortKey = key;
            renderStudentView();
        }

        function sortTeacherAssignments(key) {
            currentTeacherAssignmentSortKey = key;
            renderTeacherAssignmentList();
        }

        function renderTeacherStudentList() {
            const list = document.getElementById('teacher-student-list');
            list.innerHTML = students.map(s => `
                <li class="flex justify-between items-center p-4 bg-gray-50 rounded-lg">
                    <div class="flex items-center gap-3">
                        <input type="checkbox" class="student-checkbox h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500" data-student-id="${s.id}" onchange="updateDeleteSelectedButtonState()">
                        <span class="font-medium">${s.firstName} ${s.lastName} <span class="text-xs text-gray-500">(ID: ${s.id})</span></span>
                    </div>
                    <div class="flex items-center gap-4">
                        <button onclick="openEditStudentModal('${s.fbId}')" class="text-sm text-blue-600 hover:text-blue-800 font-medium py-1 px-3">Edit</button>
                        <button onclick="confirmDeleteStudent('${s.fbId}')" class="text-sm text-red-600 hover:text-red-800 font-medium py-1 px-3">Delete</button>
                    </div>
                </li>
            `).join('');
        }

        function renderTeacherAssignmentList() {
            const list = document.getElementById('teacher-assignment-list');
            
            assignments.sort((a, b) => {
                switch (currentTeacherAssignmentSortKey) {
                    case 'number_asc': return a.number - b.number;
                    case 'number_desc': return b.number - a.number;
                    case 'date_asc': return new Date(a.postedDate) - new Date(b.postedDate);
                    case 'date_desc': return new Date(b.postedDate) - new Date(a.postedDate);
                    default: return 0;
                }
            });

            list.innerHTML = assignments.map(a => {
                const totalScores = students.map(s => s.scores ? s.scores[a.fbId] : undefined).filter(score => score !== undefined && !isNaN(parseFloat(score)));
                const averageScore = totalScores.length > 0 ? (totalScores.reduce((sum, score) => sum + parseFloat(score), 0) / totalScores.length).toFixed(1) : 'N/A';
                const averageScoreColor = getScoreColor(averageScore);

                return `
                <div class="bg-gray-50 p-4 rounded-lg">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
                        <div class="flex-grow mb-3 md:mb-0">
                            <div class="flex items-center gap-3">
                                <span class="font-bold text-lg text-gray-800">#${a.number}: ${a.title}</span>
                                <span class="text-xs text-gray-500">(${new Date(a.postedDate).toLocaleDateString()})</span>
                            </div>
                            <p class="text-sm text-gray-600 mt-1">${a.description || ''}</p>
                        </div>
                        <div class="flex items-center gap-2 flex-shrink-0">
                            <div class="text-center px-3">
                                <div class="text-sm text-gray-500">Avg. Score</div>
                                <div class="font-bold text-lg ${averageScoreColor}">${averageScore}</div>
                            </div>
                            <button onclick="openScoreAssignmentModal('${a.fbId}')" class="bg-green-100 text-green-800 font-semibold py-2 px-4 rounded-lg hover:bg-green-200 transition">Score</button>
                            <button onclick="openEditAssignmentModal('${a.fbId}')" class="bg-blue-100 text-blue-800 font-semibold py-2 px-4 rounded-lg hover:bg-blue-200 transition">Edit</button>
                            <button onclick="confirmDeleteAssignment('${a.fbId}')" class="bg-red-100 text-red-800 font-semibold py-2 px-4 rounded-lg hover:bg-red-200 transition">Delete</button>
                        </div>
                    </div>
                </div>
            `}).join('');
        }
        
        function renderStudentAssignmentList(student) {
            const list = document.getElementById('student-assignment-list');
            const studentScores = student.scores || {};

            const sortedAssignments = [...assignments].sort((a, b) => {
                switch (currentAssignmentSortKey) {
                    case 'number_asc': return a.number - b.number;
                    case 'number_desc': return b.number - a.number;
                    case 'date_asc': return new Date(a.postedDate) - new Date(b.postedDate);
                    case 'date_desc': return new Date(b.postedDate) - new Date(a.postedDate);
                    case 'score_asc': return getSortableScore(studentScores[a.fbId]) - getSortableScore(studentScores[b.fbId]);
                    case 'score_desc': return getSortableScore(studentScores[b.fbId]) - getSortableScore(studentScores[a.fbId]);
                    default: return 0;
                }
            });

            list.innerHTML = sortedAssignments.map(a => {
                const score = studentScores[a.fbId] !== undefined ? studentScores[a.fbId] : 'Not Graded';
                const scoreColor = getScoreColor(score);
                return `
                    <div class="bg-gray-50 p-4 rounded-lg flex justify-between items-center">
                        <div>
                            <p class="font-bold text-lg text-gray-800">#${a.number}: ${a.title}</p>
                            <p class="text-sm text-gray-600 mt-1">${a.description || ''}</p>
                            <p class="text-xs text-gray-500 mt-2">Posted: ${new Date(a.postedDate).toLocaleDateString()}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-sm text-gray-500">Your Score</p>
                            <p class="font-bold text-2xl ${scoreColor}">${score}</p>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function renderStudentRequests() {
            const list = document.getElementById('student-requests-list');
            const allRequests = [
                ...helpRequests.map(r => ({ ...r, type: 'help' })),
                ...checkRequests.map(r => ({ ...r, type: 'check' }))
            ];
            allRequests.sort((a, b) => a.timestamp - b.timestamp); // Sort by oldest first

            if (allRequests.length === 0) {
                list.innerHTML = '<li class="text-gray-500 italic">No student requests at the moment.</li>';
                return;
            }

            list.innerHTML = allRequests.map(r => {
                const student = students.find(s => s.id === r.studentId);
                const bgColor = r.type === 'help' ? 'bg-red-50' : 'bg-yellow-50';
                const textColor = r.type === 'help' ? 'text-red-800' : 'text-yellow-800';
                const borderColor = r.type === 'help' ? 'border-red-200' : 'border-yellow-200';
                const requestTypeLabel = r.type === 'help' ? 'Help' : 'Check';

                return `
                    <li class="${bgColor} ${textColor} p-3 rounded-lg border-l-4 ${borderColor}">
                        <div class="flex justify-between items-center">
                            <div>
                                <span class="font-bold">${student ? `${student.firstName} ${student.lastName}` : 'Unknown'}</span>
                                <span class="text-sm">(${requestTypeLabel})</span>
                            </div>
                            <button onclick="resolveRequest('${r.fbId}', '${r.type}')" class="text-sm font-medium hover:underline">Resolve</button>
                        </div>
                    </li>
                `;
            }).join('');
        }

        function maybeRenderSeatingChart() {
            if (studentsLoaded && seatingLoaded && currentView === 'teacher' && currentTeacherTab === 'seating-chart') {
                renderSeatingChart();
                renderUnseatedStudentList();
            }
        }

        function renderSeatingChart() {
            const grid = document.getElementById('seating-chart-grid');
            grid.innerHTML = seatingChart.map((studentId, index) => {
                const student = studentId ? students.find(s => s.id === studentId) : null;
                const hasHelpRequest = student && helpRequests.some(r => r.studentId === student.id);
                const hasCheckRequest = student && checkRequests.some(r => r.studentId === student.id);
                
                let seatClasses = "seat relative h-24 flex items-center justify-center p-2 border rounded-lg shadow-sm transition-all duration-200 ease-in-out";
                let content;

                if (student) {
                    seatClasses += " draggable-student bg-white";
                    let indicator = '';
                    if (hasHelpRequest) {
                        indicator = '<div class="absolute top-1 right-1 h-4 w-4 bg-red-500 rounded-full border-2 border-white animate-pulse"></div>';
                    } else if (hasCheckRequest) {
                         indicator = '<div class="absolute top-1 right-1 h-4 w-4 bg-yellow-400 rounded-full border-2 border-white animate-pulse"></div>';
                    }
                    content = `<div class="text-center">
                                 <span class="font-semibold text-sm">${student.firstName} ${student.lastName[0]}.</span>
                                 <span class="text-xs text-gray-500 block">ID: ${student.id}</span>
                               </div>${indicator}`;
                } else if (studentId === 'BLANK') {
                     seatClasses += " blank-seat";
                     content = '<span class="text-gray-500 text-sm">Blank Seat</span>';
                } else {
                    seatClasses += " bg-gray-100 border-dashed border-gray-300";
                    content = `<span class="text-gray-400 text-xs">Empty</span>`;
                }

                return `<div class="${seatClasses}" data-seat-index="${index}" draggable="${!!student || studentId === 'BLANK'}" ondragstart="handleDragStart(event)" ondragend="handleDragEnd(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event)">${content}</div>`;
            }).join('');
        }
        
        function renderUnseatedStudentList() {
            const list = document.getElementById('unseated-student-list');
            const seatedStudentIds = new Set(seatingChart.filter(id => id && id !== 'BLANK'));
            const unseatedStudents = students.filter(s => !seatedStudentIds.has(s.id));
            
            list.innerHTML = unseatedStudents.map(s => `
                <li id="roster-${s.id}" class="student-roster-item bg-gray-50 p-3 rounded-lg flex justify-between items-center cursor-grab" draggable="true" ondragstart="handleDragStart(event)" ondragend="handleDragEnd(event)" data-student-id="${s.id}">
                    <span class="font-medium">${s.firstName} ${s.lastName}</span>
                    <span class="text-sm text-gray-500">ID: ${s.id}</span>
                </li>
            `).join('');
        }

        // --- DRAG & DROP LOGIC ---
        let draggedElement = null;

        function handleDragStart(event) {
            draggedElement = event.target.closest('[draggable]');
            draggedElement.classList.add('dragging');
            event.dataTransfer.effectAllowed = 'move';
            // Set data to be transferred
            const studentId = draggedElement.dataset.studentId;
            const seatIndex = draggedElement.dataset.seatIndex;
            event.dataTransfer.setData('text/plain', JSON.stringify({ studentId, seatIndex }));
        }

        function handleDragEnd(event) {
             if (draggedElement) {
                draggedElement.classList.remove('dragging');
            }
            draggedElement = null;
        }

        function handleDragOver(event) {
            event.preventDefault();
            const targetSeat = event.target.closest('.seat');
            if (targetSeat) {
                targetSeat.classList.add('dragging-over');
            }
        }

        function handleDragLeave(event) {
            const targetSeat = event.target.closest('.seat');
            if (targetSeat) {
                targetSeat.classList.remove('dragging-over');
            }
        }

        async function handleDrop(event) {
            event.preventDefault();
            const targetSeat = event.target.closest('.seat');
            if (!targetSeat) return;
            
            targetSeat.classList.remove('dragging-over');
            
            const data = JSON.parse(event.dataTransfer.getData('text/plain'));
            const droppedStudentId = data.studentId;
            const sourceSeatIndex = data.seatIndex ? parseInt(data.seatIndex, 10) : null;
            const targetSeatIndex = parseInt(targetSeat.dataset.seatIndex, 10);

            // Case 1: Dropping a student from the roster
            if (droppedStudentId && sourceSeatIndex === null) {
                const targetCurrentStudentId = seatingChart[targetSeatIndex];
                seatingChart[targetSeatIndex] = parseInt(droppedStudentId, 10);
                // If the target seat was occupied, move the occupant to unseated
                // (This logic is implicitly handled by re-rendering)
            } 
            // Case 2: Moving a student from one seat to another
            else if (sourceSeatIndex !== null && !droppedStudentId) { // Dragged from seat
                const studentToMove = seatingChart[sourceSeatIndex];
                const occupantOfTarget = seatingChart[targetSeatIndex];
                
                // Swap them
                seatingChart[targetSeatIndex] = studentToMove;
                seatingChart[sourceSeatIndex] = occupantOfTarget; // Can be null or another student
            } 
            // Case 3: Dropping a blank seat from the "Add Blank Seat" button
            else if (draggedElement && draggedElement.id === 'add-blank-seat') {
                 seatingChart[targetSeatIndex] = 'BLANK';
            }

            await saveSeatingChart();
            // The onSnapshot listener will re-render everything automatically.
        }

        // --- MODALS ---
        function openModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        function openEditStudentModal(fbId) {
            const student = students.find(s => s.fbId === fbId);
            if (student) {
                document.getElementById('student-original-id-edit').value = fbId;
                document.getElementById('student-id-edit').value = student.id;
                document.getElementById('student-firstName-edit').value = student.firstName;
                document.getElementById('student-lastName-edit').value = student.lastName;
                openModal('edit-student-modal');
            }
        }

        function openEditAssignmentModal(fbId) {
            const assignment = assignments.find(a => a.fbId === fbId);
            if (assignment) {
                document.getElementById('assignment-original-id-edit').value = fbId;
                document.getElementById('assignment-number-edit').value = assignment.number;
                document.getElementById('assignment-title-edit').value = assignment.title;
                document.getElementById('assignment-description-edit').value = assignment.description || '';
                document.getElementById('assignment-posted-date-edit').value = assignment.postedDate;
                openModal('edit-assignment-modal');
            }
        }

        function openScoreAssignmentModal(fbId) {
            const assignment = assignments.find(a => a.fbId === fbId);
            if (assignment) {
                document.getElementById('score-assignment-id').value = fbId;
                document.getElementById('score-assignment-title').textContent = `#${assignment.number}: ${assignment.title}`;
                const list = document.getElementById('student-scores-list');
                list.innerHTML = students.map(s => `
                    <div class="flex items-center justify-between">
                        <label for="score-${s.id}" class="font-medium">${s.firstName} ${s.lastName}</label>
                        <div class="flex items-center gap-2">
                            <input type="number" id="score-${s.id}" data-student-id="${s.id}" value="${s.scores && s.scores[fbId] !== undefined ? s.scores[fbId] : ''}" class="w-24 px-2 py-1 border border-gray-300 rounded-md">
                             <button type="button" onclick="document.getElementById('score-${s.id}').value = 'Excused'" class="text-xs bg-gray-200 text-gray-700 font-semibold py-1 px-2 rounded-md hover:bg-gray-300">Exc</button>
                        </div>
                    </div>
                `).join('');
                openModal('score-assignment-modal');
            }
        }

        // --- DATA MANIPULATION ---
        async function addStudent(event) {
            event.preventDefault();
            const id = parseInt(document.getElementById('student-id-add').value, 10);
            const firstName = document.getElementById('student-firstName-add').value;
            const lastName = document.getElementById('student-lastName-add').value;

            if (students.some(s => s.id === id)) {
                alert('A student with this ID already exists.');
                return;
            }

            await addDoc(studentsCol, { id, firstName, lastName, scores: {} });
            closeModal('add-student-modal');
            document.getElementById('add-student-form').reset();
            showSuccessMessage('Student added!');
        }
        
        async function updateStudent(event) {
            event.preventDefault();
            const fbId = document.getElementById('student-original-id-edit').value;
            const id = parseInt(document.getElementById('student-id-edit').value, 10);
            const firstName = document.getElementById('student-firstName-edit').value;
            const lastName = document.getElementById('student-lastName-edit').value;

            const studentDocRef = doc(db, studentsCol.path, fbId);
            await updateDoc(studentDocRef, { id, firstName, lastName });

            closeModal('edit-student-modal');
            showSuccessMessage('Student updated!');
        }

        function confirmDeleteStudent(fbId) {
            const student = students.find(s => s.fbId === fbId);
            if (!student) return;

            document.getElementById('confirmation-title').textContent = 'Delete Student?';
            document.getElementById('confirmation-message').textContent = `Are you sure you want to delete ${student.firstName} ${student.lastName}? This will remove them from the roster and seating chart. This action cannot be undone.`;
            
            confirmAction = async () => {
                const studentDocRef = doc(db, studentsCol.path, fbId);
                await deleteDoc(studentDocRef);
                // Also remove student from seating chart
                const newSeatingChart = seatingChart.map(id => id === student.id ? null : id);
                if (JSON.stringify(newSeatingChart) !== JSON.stringify(seatingChart)) {
                    seatingChart = newSeatingChart;
                    await saveSeatingChart();
                }

                closeModal('confirmation-modal');
                showSuccessMessage('Student deleted.');
            };

            openModal('confirmation-modal');
        }
        
        function confirmDeleteSelectedStudents() {
            const selectedIds = Array.from(document.querySelectorAll('.student-checkbox:checked')).map(cb => parseInt(cb.dataset.studentId));
            if (selectedIds.length === 0) return;
            
            const studentsToDelete = students.filter(s => selectedIds.includes(s.id));
            
            document.getElementById('confirmation-title').textContent = `Delete ${selectedIds.length} Students?`;
            document.getElementById('confirmation-message').textContent = `Are you sure you want to delete these students? This action cannot be undone.`;
            
            confirmAction = async () => {
                const batch = writeBatch(db);
                studentsToDelete.forEach(student => {
                    batch.delete(doc(db, studentsCol.path, student.fbId));
                });
                await batch.commit();

                const newSeatingChart = seatingChart.map(id => selectedIds.includes(id) ? null : id);
                 if (JSON.stringify(newSeatingChart) !== JSON.stringify(seatingChart)) {
                    seatingChart = newSeatingChart;
                    await saveSeatingChart();
                }

                closeModal('confirmation-modal');
                showSuccessMessage(`${selectedIds.length} students deleted.`);
                document.getElementById('select-all-students').checked = false;
            };

            openModal('confirmation-modal');
        }

        function toggleSelectAll(checkbox) {
            document.querySelectorAll('.student-checkbox').forEach(cb => cb.checked = checkbox.checked);
            updateDeleteSelectedButtonState();
        }

        function updateDeleteSelectedButtonState() {
            const anySelected = document.querySelectorAll('.student-checkbox:checked').length > 0;
            document.getElementById('delete-selected-btn').classList.toggle('hidden', !anySelected);
        }

        async function bulkUploadStudents(event) {
            event.preventDefault();
            const data = document.getElementById('bulk-student-data').value.trim();
            if (!data) return;

            const lines = data.split('\n');
            const batch = writeBatch(db);
            const existingIds = new Set(students.map(s => s.id));
            let addedCount = 0;

            lines.forEach(line => {
                const parts = line.split(/[,\t]/).map(p => p.trim()); // Split by comma or tab
                if (parts.length === 3) {
                    const id = parseInt(parts[0], 10);
                    const firstName = parts[1];
                    const lastName = parts[2];
                    if (!isNaN(id) && firstName && lastName && !existingIds.has(id)) {
                        const newStudentRef = doc(studentsCol);
                        batch.set(newStudentRef, { id, firstName, lastName, scores: {} });
                        existingIds.add(id); // Prevent adding duplicate ID from the same bulk list
                        addedCount++;
                    }
                }
            });

            await batch.commit();
            closeModal('bulk-upload-modal');
            document.getElementById('bulk-upload-form').reset();
            showSuccessMessage(`${addedCount} students added!`);
        }

        async function addAssignment(event) {
            event.preventDefault();
            const number = parseInt(document.getElementById('assignment-number').value, 10);
            const title = document.getElementById('assignment-title').value;
            const description = document.getElementById('assignment-description').value;
            let postedDate = document.getElementById('assignment-posted-date').value;

            if (!postedDate) {
                postedDate = new Date().toISOString().split('T')[0];
            }

            await addDoc(assignmentsCol, { number, title, description, postedDate });
            closeModal('add-assignment-modal');
            document.getElementById('add-assignment-form').reset();
            showSuccessMessage('Assignment added!');
        }

        async function updateAssignment(event) {
            event.preventDefault();
            const fbId = document.getElementById('assignment-original-id-edit').value;
            const number = parseInt(document.getElementById('assignment-number-edit').value, 10);
            const title = document.getElementById('assignment-title-edit').value;
            const description = document.getElementById('assignment-description-edit').value;
            let postedDate = document.getElementById('assignment-posted-date-edit').value;

            if (!postedDate) {
                postedDate = new Date().toISOString().split('T')[0];
            }

            const assignmentDocRef = doc(db, assignmentsCol.path, fbId);
            await updateDoc(assignmentDocRef, { number, title, description, postedDate });

            closeModal('edit-assignment-modal');
            showSuccessMessage('Assignment updated!');
        }
        
        function confirmDeleteAssignment(fbId) {
            const assignment = assignments.find(a => a.fbId === fbId);
            if (!assignment) return;

            document.getElementById('confirmation-title').textContent = 'Delete Assignment?';
            document.getElementById('confirmation-message').textContent = `Are you sure you want to delete "${assignment.title}"? All associated scores will be removed. This action cannot be undone.`;
            
            confirmAction = async () => {
                // Delete the assignment itself
                const assignmentDocRef = doc(db, assignmentsCol.path, fbId);
                await deleteDoc(assignmentDocRef);

                // Remove scores for this assignment from all students
                const batch = writeBatch(db);
                students.forEach(student => {
                    if (student.scores && student.scores[fbId] !== undefined) {
                        const studentDocRef = doc(db, studentsCol.path, student.fbId);
                        const newScores = { ...student.scores };
                        delete newScores[fbId];
                        batch.update(studentDocRef, { scores: newScores });
                    }
                });
                await batch.commit();

                closeModal('confirmation-modal');
                showSuccessMessage('Assignment deleted.');
            };
            openModal('confirmation-modal');
        }
        
        async function saveScores(event) {
            event.preventDefault();
            const assignmentId = document.getElementById('score-assignment-id').value;
            const inputs = document.querySelectorAll('#student-scores-list input[type="number"]');
            
            const batch = writeBatch(db);

            inputs.forEach(input => {
                const studentId = parseInt(input.dataset.studentId, 10);
                let score = input.value;
                 if (score.trim() === '') score = 'Not Graded';
                const student = students.find(s => s.id === studentId);
                if (student) {
                    const studentDocRef = doc(db, studentsCol.path, student.fbId);
                    const newScores = { ...student.scores, [assignmentId]: score };
                    batch.update(studentDocRef, { scores: newScores });
                }
            });

            await batch.commit();
            closeModal('score-assignment-modal');
            showSuccessMessage('Scores saved!');
        }
        
        async function bulkAddAssignments(event) {
            event.preventDefault();
            const data = document.getElementById('bulk-assignment-data').value.trim();
            const useTodayForMissing = document.getElementById('bulk-assignment-default-today').checked;
            if (!data) return;

            const lines = data.split('\n');
            const batch = writeBatch(db);
            let addedCount = 0;

            const maxNumber = assignments.length > 0 ? Math.max(...assignments.map(a => a.number)) : 0;
            
            lines.forEach((line, index) => {
                const parts = line.split(/[|,]/);
                const title = parts[0]?.trim();
                let postedDate = parts[1]?.trim();

                if (title) {
                    if (!postedDate && useTodayForMissing) {
                        postedDate = new Date().toISOString().split('T')[0];
                    }
                    
                    const newAssignmentRef = doc(assignmentsCol);
                    batch.set(newAssignmentRef, { 
                        number: maxNumber + index + 1, 
                        title: title, 
                        postedDate: postedDate || new Date().toISOString().split('T')[0]
                    });
                    addedCount++;
                }
            });

            await batch.commit();
            closeModal('bulk-assignment-modal');
            document.getElementById('bulk-assignment-form').reset();
            showSuccessMessage(`${addedCount} assignments added.`);
        }

        // --- AUTH & LOGIN ---
        document.getElementById('student-login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const id = parseInt(document.getElementById('student-id-login').value, 10);
            const student = students.find(s => s.id === id);
            if (student) {
                currentStudentId = id;
                document.getElementById('login-error').textContent = '';
                switchView('student');
            } else {
                document.getElementById('login-error').textContent = 'Student ID not found.';
            }
        });

        function logout() {
            currentStudentId = null;
            switchView('login-type-selection');
        }
        
        // --- STUDENT REQUESTS ---
        async function requestHelp() {
            if (!currentStudentId) return;
            // Prevent duplicate requests
            if (helpRequests.some(r => r.studentId === currentStudentId)) {
                showSuccessMessage("You already have a help request active.");
                return;
            }
            await addDoc(helpRequestsCol, { studentId: currentStudentId, timestamp: serverTimestamp() });
            showSuccessMessage("Help requested! The teacher will be with you shortly.");
        }

        async function requestCheck() {
            if (!currentStudentId) return;
            if (checkRequests.some(r => r.studentId === currentStudentId)) {
                showSuccessMessage("You already have a check request active.");
                return;
            }
            await addDoc(checkRequestsCol, { studentId: currentStudentId, timestamp: serverTimestamp() });
             showSuccessMessage("Check requested! The teacher will be with you shortly.");
        }

        async function resolveRequest(fbId, type) {
            const col = type === 'help' ? helpRequestsCol : checkRequestsCol;
            await deleteDoc(doc(db, col.path, fbId));
            showSuccessMessage("Request resolved.");
        }
        
         async function cancelRequest(type) {
            if (!currentStudentId) return;
            const col = type === 'help' ? helpRequestsCol : checkRequestsCol;
            const request = (type === 'help' ? helpRequests : checkRequests).find(r => r.studentId === currentStudentId);
            if (request) {
                await deleteDoc(doc(db, col.path, request.fbId));
                showSuccessMessage("Request cancelled.");
            }
        }
        
        // --- UTILITIES ---
        function showSuccessMessage(message) {
            const el = document.getElementById('success-message');
            el.textContent = message;
            el.classList.remove('translate-y-20', 'opacity-0');
            el.classList.add('translate-y-0', 'opacity-100');
            setTimeout(() => {
                el.classList.remove('translate-y-0', 'opacity-100');
                el.classList.add('translate-y-20', 'opacity-0');
            }, 3000);
        }
        
        function exportAllDataAsCSV() {
            let csvContent = "data:text/csv;charset=utf-8,";
            
            // Students
            csvContent += "Students\nID,First Name,Last Name\n";
            students.forEach(s => {
                csvContent += `${s.id},${s.firstName},${s.lastName}\n`;
            });
            csvContent += "\n";

            // Assignments
            csvContent += "Assignments\nNumber,Title,Posted Date\n";
            assignments.forEach(a => {
                csvContent += `${a.number},"${a.title}",${a.postedDate}\n`;
            });
            csvContent += "\n";

            // Scores
            csvContent += "Scores\nStudent ID,Assignment Number,Score\n";
            students.forEach(student => {
                if (student.scores) {
                    for (const assignmentId in student.scores) {
                        const assignment = assignments.find(a => a.fbId === assignmentId);
                        if (assignment) {
                             csvContent += `${student.id},${assignment.number},${student.scores[assignmentId]}\n`;
                        }
                    }
                }
            });
            csvContent += "\n";

            // Seating Chart
            csvContent += "Seating Chart\nSeat Index,Student ID\n";
            seatingChart.forEach((studentId, index) => {
                 csvContent += `${index},${studentId || ''}\n`;
            });
            csvContent += "\n";

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "classroom_data_export.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- EVENT LISTENERS & GLOBAL ACCESS ---
        document.getElementById('add-student-form').addEventListener('submit', addStudent);
        document.getElementById('edit-student-form').addEventListener('submit', updateStudent);
        document.getElementById('add-assignment-form').addEventListener('submit', addAssignment);
        document.getElementById('edit-assignment-form').addEventListener('submit', updateAssignment);
        document.getElementById('score-assignment-form').addEventListener('submit', saveScores);
        document.getElementById('bulk-upload-form').addEventListener('submit', bulkUploadStudents);
        document.getElementById('bulk-assignment-form').addEventListener('submit', bulkAddAssignments);
        document.getElementById('confirm-button').addEventListener('click', () => confirmAction && confirmAction());
        document.getElementById('cancel-button').addEventListener('click', () => closeModal('confirmation-modal'));
        
        // Make functions globally accessible for inline event handlers
        window.switchView = switchView;
        window.switchTeacherTab = switchTeacherTab;
        window.openModal = openModal;
        window.closeModal = closeModal;
        window.sortStudents = sortStudents;
        window.sortAssignments = sortAssignments;
        window.sortTeacherAssignments = sortTeacherAssignments;
        window.logout = logout;
        window.openEditStudentModal = openEditStudentModal;
        window.confirmDeleteStudent = confirmDeleteStudent;
        window.toggleSelectAll = toggleSelectAll;
        window.updateDeleteSelectedButtonState = updateDeleteSelectedButtonState;
        window.confirmDeleteSelectedStudents = confirmDeleteSelectedStudents;
        window.openEditAssignmentModal = openEditAssignmentModal;
        window.openScoreAssignmentModal = openScoreAssignmentModal;
        window.confirmDeleteAssignment = confirmDeleteAssignment;
        window.handleDragStart = handleDragStart;
        window.handleDragEnd = handleDragEnd;
        window.handleDragOver = handleDragOver;
        window.handleDragLeave = handleDragLeave;
        window.handleDrop = handleDrop;
        window.openStudentAssignmentModal = openStudentAssignmentModal;
        window.exportAllDataAsCSV = exportAllDataAsCSV;
        window.requestHelp = requestHelp;
        window.requestCheck = requestCheck;
        window.resolveRequest = resolveRequest;
        window.cancelRequest = cancelRequest;

        // --- INITIALIZATION ---
        initFirebase();
    </script>
</body>
</html>
