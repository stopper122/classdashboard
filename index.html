<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Class Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, updateDoc, collection, query, orderBy, getDocs, addDoc, deleteDoc, getDoc, setDoc, arrayRemove, arrayUnion, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // IMPORTANT: These global variables are provided by the canvas environment.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = {
  apiKey: "AIzaSyBX96xDY5ThDAZn-SckmsnfynMnQjvUc2I",
  authDomain: "helprequest-469c0.firebaseapp.com",
  projectId: "helprequest-469c0",
  storageBucket: "helprequest-469c0.firebasestorage.app",
  messagingSenderId: "1092775554304",
  appId: "1:1092775554304:web:e771c3ebac1e6ba4f597e5"
};

        setLogLevel('debug');

        let auth, db;
        let state = {
            view: 'class_layout',
            periods: [],
            selectedPeriod: null,
            students: [],
            assignments: [],
            activeStudent: null,
            message: '',
            isProcessing: false,
            requests: [],
        };

        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);

        // Sign in user anonymously to access public data
        const signIn = async () => {
            try {
                await signInAnonymously(auth);
            } catch (error) {
                console.error("Authentication error:", error);
            }
        };

        auth.onAuthStateChanged(async (user) => {
            if (user) {
                await startDataListeners();
            } else {
                await signIn();
            }
        });

        const startDataListeners = async () => {
            // Periods Listener
            const periodsRef = collection(db, `artifacts/${appId}/public/data/periods`);
            onSnapshot(periodsRef, (snapshot) => {
                state.periods = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (!state.selectedPeriod && state.periods.length > 0) {
                    state.selectedPeriod = state.periods[0].id;
                }
                renderUI();
            });

            // Students Listener
            const studentsRef = collection(db, `artifacts/${appId}/public/data/students`);
            onSnapshot(studentsRef, (snapshot) => {
                state.students = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                sortStudents();
                renderUI();
            });

            // Assignments Listener
            const assignmentsRef = collection(db, `artifacts/${appId}/public/data/assignments`);
            onSnapshot(assignmentsRef, (snapshot) => {
                state.assignments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderUI();
            });

            // Requests Listener
            const requestsRef = collection(db, `artifacts/${appId}/public/data/requests`);
            onSnapshot(requestsRef, (snapshot) => {
                state.requests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderUI();
            });
        };

        const renderUI = () => {
            const app = document.getElementById('app');
            app.innerHTML = '';
            renderHeader();

            if (state.periods.length === 0) {
                renderNoPeriodsMessage();
            } else {
                renderDashboard();
            }
        };

        const renderHeader = () => {
            const header = document.getElementById('header');
            header.innerHTML = `
                <div class="flex justify-between items-center py-4 px-6 bg-white shadow-md rounded-b-xl">
                    <h1 class="text-3xl font-extrabold text-blue-800 tracking-tight">Class Dashboard</h1>
                </div>
            `;
        };

        const renderNoPeriodsMessage = () => {
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="flex items-center justify-center min-h-screen">
                    <div class="p-8 bg-white rounded-xl shadow-lg w-full max-w-lg text-center">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">No Periods Found</h2>
                        <p class="text-gray-600 mb-6">Please add a period to get started.</p>
                        <form id="add-period-form" class="flex flex-col space-y-4">
                            <input type="text" id="new-period-name" placeholder="Period Name (e.g., Period 1)"
                                class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <button type="submit" class="bg-blue-600 text-white font-bold py-2 rounded-lg hover:bg-blue-700 transition-colors duration-200">
                                Add Period
                            </button>
                        </form>
                    </div>
                </div>
            `;
            document.getElementById('add-period-form').addEventListener('submit', handleAddPeriod);
        };

        const renderDashboard = () => {
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="flex flex-col lg:flex-row min-h-screen bg-gray-100 p-4 space-y-4 lg:space-y-0 lg:space-x-4">
                    <!-- Left Sidebar -->
                    <div class="w-full lg:w-1/4 bg-white p-6 rounded-xl shadow-lg h-full space-y-6">
                        <!-- Period Selector -->
                        <div class="space-y-4">
                            <h2 class="text-2xl font-bold text-blue-800 mb-2">Manage Periods</h2>
                            <div class="relative">
                                <select id="period-select" class="block appearance-none w-full bg-white border border-gray-300 text-gray-700 py-3 px-4 pr-8 rounded-lg leading-tight focus:outline-none focus:bg-white focus:border-blue-500">
                                    ${state.periods.map(p => `<option value="${p.id}" ${state.selectedPeriod === p.id ? 'selected' : ''}>${p.name}</option>`).join('')}
                                </select>
                                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                                    <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                                </div>
                            </div>
                            <form id="add-period-form" class="flex space-x-2">
                                <input type="text" id="new-period-name" placeholder="New Period Name" class="flex-grow px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors duration-200">
                                    Add
                                </button>
                            </form>
                            <button onclick="handleDeletePeriod()" class="w-full bg-red-500 text-white font-bold py-2 rounded-lg hover:bg-red-600 transition-colors duration-200">
                                Delete Current Period
                            </button>
                        </div>
                        
                        <hr class="border-gray-200 my-6">

                        <!-- Add Students -->
                        <div class="space-y-4">
                            <h2 class="text-2xl font-bold text-blue-800 mb-2">Add Students & Seats</h2>
                            <p class="text-gray-600 text-sm">Paste your roster (Full Name, ID)</p>
                            <textarea id="student-roster" rows="5" placeholder="e.g., Doe, Jane, 12345"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                            <button onclick="handleAddStudents()" class="w-full bg-green-600 text-white font-bold py-2 rounded-lg hover:bg-green-700 transition-colors duration-200">
                                Add Students
                            </button>
                            <button onclick="handleAddEmptySeat()" class="w-full bg-gray-400 text-white font-bold py-2 rounded-lg hover:bg-gray-500 transition-colors duration-200">
                                Add Empty Seat
                            </button>
                        </div>

                        <hr class="border-gray-200 my-6">

                        <!-- Add Assignments -->
                        <div class="space-y-4">
                            <h2 class="text-2xl font-bold text-blue-800 mb-2">Add Assignments</h2>
                            <p class="text-gray-600 text-sm">Paste assignment titles (one per line)</p>
                            <textarea id="assignment-titles" rows="5" placeholder="e.g., Assignment 1"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                            <button onclick="handleAddAssignments()" class="w-full bg-purple-600 text-white font-bold py-2 rounded-lg hover:bg-purple-700 transition-colors duration-200">
                                Add Assignments
                            </button>
                        </div>
                    </div>

                    <!-- Main Content -->
                    <div class="w-full lg:w-3/4 bg-white p-6 rounded-xl shadow-lg h-full space-y-6">
                        <!-- Class Layout & Student Details -->
                        <div class="space-y-4">
                            <div class="flex justify-between items-center">
                                <h2 class="text-2xl font-bold text-blue-800">Class Layout</h2>
                                <div class="flex items-center space-x-2">
                                    <span class="text-gray-600">Sort:</span>
                                    <select id="sort-select" class="px-2 py-1 rounded-lg border border-gray-300">
                                        <option value="seat">Assigned Seat</option>
                                        <option value="lastName">Last Name</option>
                                        <option value="firstName">First Name</option>
                                    </select>
                                </div>
                            </div>
                            <div id="class-grid" class="grid grid-cols-6 gap-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
                                <!-- Student cards will be rendered here -->
                            </div>
                        </div>
                        
                        <!-- Selected Student Details -->
                        <div id="student-details" class="bg-gray-50 p-6 rounded-xl border border-gray-200" style="${state.activeStudent ? '' : 'display: none;'}">
                            <!-- Student details will be rendered here -->
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('period-select').addEventListener('change', handlePeriodChange);
            document.getElementById('add-period-form').addEventListener('submit', handleAddPeriod);
            document.getElementById('sort-select').addEventListener('change', handleSortChange);
            renderStudentCards();
            renderStudentDetails();
        };

        const renderStudentCards = () => {
            const grid = document.getElementById('class-grid');
            if (!grid) return;

            const periodStudents = state.students
                .filter(s => s.periodId === state.selectedPeriod);
            
            const sortedStudents = [...periodStudents].sort((a, b) => {
                if (state.sort === 'lastName') {
                    return (a.lastName || '').localeCompare(b.lastName || '');
                } else if (state.sort === 'firstName') {
                    return (a.firstName || '').localeCompare(b.firstName || '');
                } else {
                    const orderA = a.seatOrder !== undefined ? a.seatOrder : Infinity;
                    const orderB = b.seatOrder !== undefined ? b.seatOrder : Infinity;
                    return orderA - orderB;
                }
            });

            grid.innerHTML = sortedStudents.map(student => {
                const isActive = state.activeStudent && state.activeStudent.id === student.id;
                const activeRequests = state.requests.filter(r => r.studentId === student.studentId);
                const isHelpRequested = activeRequests.some(r => r.type === 'help');
                const isCheckRequested = activeRequests.some(r => r.type === 'check');
                const backgroundColor = isActive ? 'bg-blue-200' : 'bg-white';
                const borderColor = isActive ? 'border-blue-500' : 'border-gray-200';
                const hasRequests = activeRequests.length > 0;
                
                // Calculate queue position for each request type
                const helpRequests = state.requests.filter(r => r.type === 'help').sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                const checkRequests = state.requests.filter(r => r.type === 'check').sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                
                const helpPosition = helpRequests.findIndex(r => r.studentId === student.studentId) + 1;
                const checkPosition = checkRequests.findIndex(r => r.studentId === student.studentId) + 1;

                const isDraggable = state.sort === 'seat';
                const cursorStyle = isDraggable ? 'cursor-grab' : 'cursor-default';

                return `
                    <div draggable="${isDraggable}" id="student-${student.id}"
                        onclick="handleStudentClick('${student.id}')"
                        class="p-4 rounded-lg shadow-sm border ${borderColor} ${backgroundColor} flex flex-col items-center ${cursorStyle} transition-all duration-200 hover:shadow-md">
                        <button onclick="handleDeleteStudent('${student.id}')" class="text-sm text-gray-500 self-end -mt-2 -mr-2">
                             &times;
                        </button>
                        <span class="text-2xl mb-2">${student.isSeated ? '👨‍🎓' : '🪑'}</span>
                        <p class="font-semibold text-center">${student.name || 'Empty Seat'}</p>
                        ${hasRequests ? `
                            <div class="mt-2 flex space-x-2">
                                ${isHelpRequested ? `<span class="text-xs font-semibold px-2 py-1 rounded-full bg-red-500 text-white">${helpPosition}</span>` : ''}
                                ${isCheckRequested ? `<span class="text-xs font-semibold px-2 py-1 rounded-full bg-blue-500 text-white">${checkPosition}</span>` : ''}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');

            // Add drag and drop listeners
            if (state.sort === 'seat') {
                const studentCards = grid.querySelectorAll('[draggable="true"]');
                studentCards.forEach(card => {
                    card.addEventListener('dragstart', handleDragStart);
                    card.addEventListener('dragover', handleDragOver);
                    card.addEventListener('drop', handleDrop);
                });
            }
        };
        
        const renderStudentDetails = () => {
            const detailsDiv = document.getElementById('student-details');
            if (!detailsDiv) return;

            if (!state.activeStudent) {
                detailsDiv.style.display = 'none';
                return;
            }

            detailsDiv.style.display = 'block';

            const activeStudent = state.students.find(s => s.id === state.activeStudent.id);
            const studentAssignments = state.assignments.filter(a => a.periodId === activeStudent.periodId);
            const studentRequests = state.requests.filter(r => r.studentId === activeStudent.studentId);
            
            const assignmentsList = studentAssignments.map(a => {
                const completion = a.completions.find(c => c.studentId === activeStudent.studentId);
                const isCompleted = !!completion;
                const score = isCompleted ? (completion.score || 0) : 0;
                
                return `
                    <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 flex justify-between items-center">
                        <div>
                            <p class="font-semibold text-gray-700">${a.title}</p>
                            <p class="text-sm text-gray-500">Due: ${a.dueDate ? new Date(a.dueDate).toLocaleDateString() : 'N/A'}</p>
                        </div>
                        <div class="flex items-center space-x-2">
                             <input type="number" min="0" max="4" value="${score}" data-assignment-id="${a.id}" onchange="handleScoreUpdate(event, '${activeStudent.id}')"
                                class="w-16 px-2 py-1 border border-gray-300 rounded-lg text-center">
                        </div>
                    </div>
                `;
            }).join('');

            // Sort requests by timestamp to get correct queue order
            studentRequests.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

            const helpQueue = studentRequests.filter(r => r.type === 'help');
            const checkQueue = studentRequests.filter(r => r.type === 'check');
            
            const requestsList = studentRequests.length > 0 ? studentRequests.map((r, index) => {
                const assignment = state.assignments.find(a => a.id === r.assignmentId);
                const typeColor = r.type === 'help' ? 'bg-red-500' : 'bg-blue-500';
                const typeText = r.type === 'help' ? 'Help' : 'Check';
                
                let position = 0;
                if (r.type === 'help') {
                    position = helpQueue.findIndex(req => req.id === r.id) + 1;
                } else {
                    position = checkQueue.findIndex(req => req.id === r.id) + 1;
                }

                return `
                    <div class="flex items-center justify-between p-3 bg-white rounded-lg shadow-sm border border-gray-200">
                        <div class="flex-grow">
                            <span class="font-medium text-gray-700">${assignment ? assignment.title : 'Unknown Assignment'}</span>
                        </div>
                        <div class="flex items-center space-x-2 flex-shrink-0">
                            <span class="text-sm font-semibold text-white px-2 py-1 rounded-full ${typeColor}">#${position} ${typeText}</span>
                            <button onclick="handleAcknowledgeRequest('${r.id}')" class="text-red-500 hover:text-red-700 transition-colors duration-200">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                    </div>
                `;
            }).join('') : `<p class="text-center text-gray-500">No active requests.</p>`;

            detailsDiv.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-bold text-blue-800">${activeStudent.name || 'Empty Seat'}</h3>
                    <button onclick="handleCopyLink('${activeStudent.studentId}')"
                        class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors duration-200">
                        Share Student Link
                    </button>
                </div>
                <div class="space-y-4">
                    <div class="bg-gray-100 p-4 rounded-lg">
                        <h4 class="font-bold text-lg mb-2">Pending Requests</h4>
                        <div class="space-y-2">
                            ${requestsList}
                        </div>
                    </div>
                    <div class="bg-gray-100 p-4 rounded-lg">
                        <h4 class="font-bold text-lg mb-2">Assignments & Scores</h4>
                        <div class="space-y-2">
                            ${assignmentsList.length > 0 ? assignmentsList : `
                                <p class="text-center text-gray-500">No assignments for this period.</p>
                            `}
                        </div>
                    </div>
                </div>
            `;
        };

        const handlePeriodChange = (event) => {
            state.selectedPeriod = event.target.value;
            state.activeStudent = null;
            sortStudents();
            renderUI();
        };

        const handleAddPeriod = async (event) => {
            event.preventDefault();
            const name = document.getElementById('new-period-name').value.trim();
            if (name) {
                await addDoc(collection(db, `artifacts/${appId}/public/data/periods`), { name });
                document.getElementById('new-period-name').value = '';
            }
        };

        const handleDeletePeriod = async () => {
            if (state.selectedPeriod && confirm('Are you sure you want to delete this period and all its students?')) {
                const periodId = state.selectedPeriod;
                const periodDocRef = doc(db, `artifacts/${appId}/public/data/periods`, periodId);
                await deleteDoc(periodDocRef);
                state.selectedPeriod = state.periods[0] ? state.periods[0].id : null;
                renderUI();
            }
        };

        const handleAddStudents = async () => {
            const roster = document.getElementById('student-roster').value.trim().split('\n');
            if (!roster) return;

            for (const line of roster) {
                const parts = line.trim().split(',');
                if (parts.length >= 2) {
                    const studentId = parts.pop().trim();
                    const name = parts.join(',').trim();
                    const nameParts = name.split(',').map(s => s.trim());
                    const lastName = nameParts[0];
                    const firstName = nameParts.length > 1 ? nameParts[1] : '';

                    if (name && studentId) {
                        const studentData = {
                            name: name,
                            studentId: studentId,
                            isSeated: true,
                            periodId: state.selectedPeriod,
                            seatOrder: state.students.filter(s => s.periodId === state.selectedPeriod).length,
                            firstName: firstName,
                            lastName: lastName
                        };
                        await addDoc(collection(db, `artifacts/${appId}/public/data/students`), studentData);
                    }
                }
            }
            document.getElementById('student-roster').value = '';
        };

        const handleAddEmptySeat = async () => {
             const studentData = {
                name: null,
                studentId: null,
                isSeated: false,
                periodId: state.selectedPeriod,
                seatOrder: state.students.filter(s => s.periodId === state.selectedPeriod).length,
                firstName: null,
                lastName: null
            };
            await addDoc(collection(db, `artifacts/${appId}/public/data/students`), studentData);
        };

        const handleAddAssignments = async () => {
            const titles = document.getElementById('assignment-titles').value.trim().split('\n');
            if (!titles) return;

            for (const title of titles) {
                const trimmedTitle = title.trim();
                if (trimmedTitle) {
                    const assignmentData = {
                        title: trimmedTitle,
                        dueDate: null,
                        completions: [],
                        periodId: state.selectedPeriod,
                    };
                    await addDoc(collection(db, `artifacts/${appId}/public/data/assignments`), assignmentData);
                }
            }
            document.getElementById('assignment-titles').value = '';
        };

        const handleStudentClick = (studentId) => {
            state.activeStudent = state.students.find(s => s.id === studentId);
            renderStudentCards();
            renderStudentDetails();
        };

        const handleDeleteStudent = async (studentId) => {
            await deleteDoc(doc(db, `artifacts/${appId}/public/data/students`, studentId));
            if (state.activeStudent && state.activeStudent.id === studentId) {
                state.activeStudent = null;
            }
        };

        const handleScoreUpdate = async (event, studentDocId) => {
            const score = parseInt(event.target.value, 10);
            const assignmentId = event.target.dataset.assignmentId;
            
            const studentDocRef = doc(db, `artifacts/${appId}/public/data/students`, studentDocId);
            const studentDoc = await getDoc(studentDocRef);
            const currentStudentData = studentDoc.data();
            const currentCompletions = currentStudentData.completions || [];
            
            const existingCompletionIndex = currentCompletions.findIndex(c => c.assignmentId === assignmentId);

            if (score > 0) {
                if (existingCompletionIndex > -1) {
                    currentCompletions[existingCompletionIndex].score = score;
                } else {
                    currentCompletions.push({
                        assignmentId,
                        score,
                        dateCompleted: new Date().toISOString(),
                        studentId: currentStudentData.studentId
                    });
                }
            } else {
                 if (existingCompletionIndex > -1) {
                    currentCompletions.splice(existingCompletionIndex, 1);
                 }
            }

            const assignmentRef = doc(db, `artifacts/${appId}/public/data/assignments`, assignmentId);
            await updateDoc(assignmentRef, {
                completions: arrayUnion({ studentId: currentStudentData.studentId, score, dateCompleted: new Date().toISOString() })
            });

            renderUI();
        };

        const handleCopyLink = (studentId) => {
            const url = `${window.location.origin}/student.html?studentId=${studentId}`;
            const tempInput = document.createElement('input');
            tempInput.value = url;
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand('copy');
            document.body.removeChild(tempInput);
            showMessage('Link copied!');
        };

        const handleAcknowledgeRequest = async (requestId) => {
            await deleteDoc(doc(db, `artifacts/${appId}/public/data/requests`, requestId));
        };

        const handleSortChange = (event) => {
            state.sort = event.target.value;
            sortStudents();
            renderUI();
        };

        const sortStudents = () => {
            const periodStudents = state.students.filter(s => s.periodId === state.selectedPeriod);
            if (state.sort === 'lastName') {
                periodStudents.sort((a, b) => (a.lastName || '').localeCompare(b.lastName || ''));
            } else if (state.sort === 'firstName') {
                periodStudents.sort((a, b) => (a.firstName || '').localeCompare(b.firstName || ''));
            } else {
                periodStudents.sort((a, b) => {
                    const orderA = a.seatOrder !== undefined ? a.seatOrder : Infinity;
                    const orderB = b.seatOrder !== undefined ? b.seatOrder : Infinity;
                    return orderA - orderB;
                });
            }
        };
        
        const showMessage = (message) => {
            state.message = message;
            const messageDiv = document.getElementById('message');
            messageDiv.innerHTML = `
                <div class="fixed top-20 left-1/2 -translate-x-1/2 bg-blue-500 text-white px-6 py-3 rounded-full shadow-lg z-50 transition-all duration-300 transform scale-100">
                    ${message}
                </div>
            `;
            setTimeout(() => {
                messageDiv.innerHTML = '';
            }, 3000);
        };

        // Drag and drop logic
        let draggedElement = null;

        const handleDragStart = (e) => {
            draggedElement = e.target;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', e.target.id);
        };

        const handleDragOver = (e) => {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        };

        const handleDrop = async (e) => {
            e.preventDefault();
            const droppedOnId = e.target.closest('[draggable="true"]').id;
            const draggedId = draggedElement.id;

            if (draggedId === droppedOnId) return;

            const draggedStudentId = draggedId.split('-')[1];
            const droppedOnStudentId = droppedOnId.split('-')[1];

            const draggedIndex = state.students.findIndex(s => s.id === draggedStudentId);
            const droppedOnIndex = state.students.findIndex(s => s.id === droppedOnStudentId);
            
            if (draggedIndex === -1 || droppedOnIndex === -1) return;

            const draggedStudent = state.students[draggedIndex];
            const droppedOnStudent = state.students[droppedOnIndex];

            // Re-order the local state
            const studentsInPeriod = state.students.filter(s => s.periodId === state.selectedPeriod);
            const draggedStudentCurrentOrder = draggedStudent.seatOrder;
            const droppedOnStudentCurrentOrder = droppedOnStudent.seatOrder;
            
            if (draggedStudentCurrentOrder < droppedOnStudentCurrentOrder) {
                // Moving down
                for (let i = draggedStudentCurrentOrder + 1; i <= droppedOnStudentCurrentOrder; i++) {
                    const studentToUpdate = studentsInPeriod.find(s => s.seatOrder === i);
                    if (studentToUpdate) {
                        await updateDoc(doc(db, `artifacts/${appId}/public/data/students`, studentToUpdate.id), {
                            seatOrder: i - 1
                        });
                    }
                }
                await updateDoc(doc(db, `artifacts/${appId}/public/data/students`, draggedStudentId), {
                    seatOrder: droppedOnStudentCurrentOrder
                });
            } else {
                // Moving up
                for (let i = draggedStudentCurrentOrder - 1; i >= droppedOnStudentCurrentOrder; i--) {
                    const studentToUpdate = studentsInPeriod.find(s => s.seatOrder === i);
                    if (studentToUpdate) {
                        await updateDoc(doc(db, `artifacts/${appId}/public/data/students`, studentToUpdate.id), {
                            seatOrder: i + 1
                        });
                    }
                }
                 await updateDoc(doc(db, `artifacts/${appId}/public/data/students`, draggedStudentId), {
                    seatOrder: droppedOnStudentCurrentOrder
                });
            }
        };

        window.handlePeriodChange = handlePeriodChange;
        window.handleAddPeriod = handleAddPeriod;
        window.handleDeletePeriod = handleDeletePeriod;
        window.handleAddStudents = handleAddStudents;
        window.handleAddEmptySeat = handleAddEmptySeat;
        window.handleAddAssignments = handleAddAssignments;
        window.handleStudentClick = handleStudentClick;
        window.handleDeleteStudent = handleDeleteStudent;
        window.handleScoreUpdate = handleScoreUpdate;
        window.handleCopyLink = handleCopyLink;
        window.handleAcknowledgeRequest = handleAcknowledgeRequest;
        window.handleSortChange = handleSortChange;
        window.handleDragOver = handleDragOver;
        window.handleDrop = handleDrop;
        window.handleDragStart = handleDragStart;

        document.addEventListener('DOMContentLoaded', renderUI);
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
    </style>
</head>
<body>
    <header id="header"></header>
    <div id="message"></div>
    <main id="app" class="mt-6 md:mt-10"></main>
</body>
</html>
