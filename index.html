<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Instructor Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, query, where, addDoc, updateDoc, deleteDoc, getDoc, getDocs, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // IMPORTANT: These global variables are provided by the canvas environment.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = {
  apiKey: "AIzaSyBX96xDY5ThDAZn-SckmsnfynMnQjvUc2I",
  authDomain: "helprequest-469c0.firebaseapp.com",
  projectId: "helprequest-469c0",
  storageBucket: "helprequest-469c0.firebasestorage.app",
  messagingSenderId: "362143493922",
  appId: "1:362143493922:web:763262a5b658145a538260",
  measurementId: "G-L5S59L4JSP"
};

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        signInAnonymously(auth);

        let state = {
            periods: [],
            students: [],
            assignments: [],
            requests: [],
            scores: [],
            currentPeriodId: localStorage.getItem('currentPeriodId') || null,
            currentView: localStorage.getItem('currentView') || 'layout',
            loading: true,
            editingAssignmentId: null,
        };

        const dataPath = `data/${appId}`;
        let publicDataPath;
        let periodsRef;
        let studentsRef;
        let assignmentsRef;
        let scoresRef;
        let requestsRef;

        let periodsUnsubscribe = null;
        let studentsUnsubscribe = null;
        let assignmentsUnsubscribe = null;
        let scoresUnsubscribe = null;
        let requestsUnsubscribe = null;

        const setupRefs = () => {
            publicDataPath = `publicData/${appId}${state.currentPeriodId ? `/${state.currentPeriodId}` : ''}`;
            periodsRef = collection(db, `${dataPath}/periods`);
            if (state.currentPeriodId) {
                studentsRef = collection(db, `${publicDataPath}/students`);
                assignmentsRef = collection(db, `${publicDataPath}/assignments`);
                scoresRef = collection(db, `${publicDataPath}/scores`);
                requestsRef = collection(db, `${publicDataPath}/requests`);
            }
        };

        const startDataListeners = () => {
            if (periodsUnsubscribe) periodsUnsubscribe();
            periodsUnsubscribe = onSnapshot(periodsRef, (snapshot) => {
                state.periods = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (!state.currentPeriodId && state.periods.length > 0) {
                    state.currentPeriodId = state.periods[0].id;
                    localStorage.setItem('currentPeriodId', state.currentPeriodId);
                }
                setupRefs();
                startPeriodSpecificListeners();
                renderUI();
            });
        };

        const startPeriodSpecificListeners = () => {
            if (!state.currentPeriodId) {
                state.students = [];
                state.assignments = [];
                state.scores = [];
                state.requests = [];
                state.loading = false;
                renderUI();
                return;
            }

            if (studentsUnsubscribe) studentsUnsubscribe();
            studentsUnsubscribe = onSnapshot(query(studentsRef, where("isActive", "==", true)), (snapshot) => {
                state.students = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderUI();
            });

            if (assignmentsUnsubscribe) assignmentsUnsubscribe();
            assignmentsUnsubscribe = onSnapshot(assignmentsRef, (snapshot) => {
                state.assignments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderUI();
            });

            if (scoresUnsubscribe) scoresUnsubscribe();
            scoresUnsubscribe = onSnapshot(scoresRef, (snapshot) => {
                state.scores = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderUI();
            });

            if (requestsUnsubscribe) requestsUnsubscribe();
            requestsUnsubscribe = onSnapshot(requestsRef, (snapshot) => {
                state.requests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderUI();
            });

            state.loading = false;
        };

        const addPeriod = async () => {
            const periodName = prompt("Enter period name:");
            if (periodName) {
                await addDoc(periodsRef, { name: periodName });
            }
        };

        const addStudent = async (periodId) => {
            const studentName = prompt("Enter student's first name:");
            if (studentName) {
                const studentLastName = prompt("Enter student's last name:");
                if (studentLastName) {
                    const newStudentRef = await addDoc(studentsRef, {
                        firstName: studentName,
                        lastName: studentLastName,
                        seatNumber: 0,
                        isActive: true
                    });
                    
                    const assignmentsQuery = await getDocs(assignmentsRef);
                    assignmentsQuery.forEach(async (assignmentDoc) => {
                        await addDoc(scoresRef, {
                            studentId: newStudentRef.id,
                            assignmentId: assignmentDoc.id,
                            score: 'Not Graded'
                        });
                    });
                }
            }
        };
        
        const addEmptySeat = async () => {
            await addDoc(studentsRef, {
                firstName: 'Empty',
                lastName: 'Seat',
                seatNumber: 0,
                isActive: false 
            });
        };

        const addAssignment = async (periodId) => {
            const assignmentName = prompt("Enter assignment name:");
            if (assignmentName) {
                const maxAssignmentNum = state.assignments.reduce((max, a) => Math.max(max, a.assignmentNumber || 0), 0);
                const newAssignment = await addDoc(assignmentsRef, {
                    name: assignmentName,
                    assignmentNumber: maxAssignmentNum + 1,
                    postedDate: new Date()
                });

                const studentsQuery = await getDocs(studentsRef);
                studentsQuery.forEach(async (studentDoc) => {
                    await addDoc(scoresRef, {
                        studentId: studentDoc.id,
                        assignmentId: newAssignment.id,
                        score: 'Not Graded'
                    });
                });
            }
        };

        const updateAssignment = async (assignmentId, newName, newNumber) => {
            const assignmentRef = doc(db, `${publicDataPath}/assignments/${assignmentId}`);
            await updateDoc(assignmentRef, {
                name: newName,
                assignmentNumber: parseInt(newNumber, 10)
            });
            state.editingAssignmentId = null;
            renderUI();
        };

        const clearAllData = async () => {
            const password = prompt("This is a destructive action. Enter password to continue:");
            if (password === "teacher") {
                if (confirm("Are you sure you want to delete all data for this period?")) {
                    const collectionsToDelete = [studentsRef, assignmentsRef, scoresRef, requestsRef];
                    for (const ref of collectionsToDelete) {
                        const snapshot = await getDocs(ref);
                        snapshot.forEach(doc => deleteDoc(doc.ref));
                    }
                }
            } else {
                alert("Incorrect password.");
            }
        };

        const deleteAllStudents = async () => {
            if (confirm("Are you sure you want to delete all students in this period?")) {
                const snapshot = await getDocs(studentsRef);
                snapshot.forEach(doc => deleteDoc(doc.ref));
            }
        };

        const clearAllRequests = async () => {
            const snapshot = await getDocs(requestsRef);
            snapshot.forEach(doc => deleteDoc(doc.ref));
        };
        
        window.App = {
            addPeriod,
            addStudent,
            addAssignment,
            addEmptySeat,
            clearAllData,
            deleteAllStudents,
            clearAllRequests,
            updateAssignment,
            setView: (view) => {
                state.currentView = view;
                localStorage.setItem('currentView', view);
                renderUI();
            },
            setPeriod: (periodId) => {
                state.currentPeriodId = periodId;
                localStorage.setItem('currentPeriodId', periodId);
                setupRefs();
                startPeriodSpecificListeners();
            },
            deleteRequest: async (requestId) => {
                await deleteDoc(doc(db, `${requestsRef.path}/${requestId}`));
            },
            setEditingAssignment: (assignmentId) => {
                state.editingAssignmentId = assignmentId;
                renderUI();
            }
        };

        const LayoutView = () => {
            const helpQueue = state.requests.filter(r => r.type === 'help').sort((a, b) => a.timestamp - b.timestamp);
            const checkQueue = state.requests.filter(r => r.type === 'check').sort((a, b) => a.timestamp - b.timestamp);

            return `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 p-4">
                    <div class="lg:col-span-2">
                        <h2 class="text-xl font-bold mb-2">Class Layout</h2>
                        <div id="student-grid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                            ${state.students.map(student => {
                                const helpRequest = helpQueue.find(r => r.studentId === student.id);
                                const checkRequest = checkQueue.find(r => r.studentId === student.id);
                                let bgColor = 'bg-white';
                                if (helpRequest) bgColor = 'bg-yellow-300';
                                if (checkRequest) bgColor = 'bg-green-300';
                                if (!student.isActive) bgColor = 'bg-gray-200';

                                return `
                                    <div class="student-card p-4 rounded-lg shadow-md text-center ${bgColor}" draggable="true" data-student-id="${student.id}">
                                        <p class="font-semibold">${student.firstName} ${student.lastName}</p>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    <div>
                        <div class="mb-4">
                            <h2 class="text-xl font-bold mb-2">Help Queue (${helpQueue.length})</h2>
                            <ul class="bg-white p-4 rounded-lg shadow-md">
                                ${helpQueue.map(r => {
                                    const student = state.students.find(s => s.id === r.studentId);
                                    return `<li class="flex justify-between items-center py-1">${student ? `${student.firstName} ${student.lastName}` : 'Unknown'}<button onclick="App.deleteRequest('${r.id}')" class="text-red-500 hover:text-red-700">X</button></li>`;
                                }).join('')}
                            </ul>
                        </div>
                        <div>
                            <h2 class="text-xl font-bold mb-2">Check Queue (${checkQueue.length})</h2>
                            <ul class="bg-white p-4 rounded-lg shadow-md">
                                ${checkQueue.map(r => {
                                    const student = state.students.find(s => s.id === r.studentId);
                                    return `<li class="flex justify-between items-center py-1">${student ? `${student.firstName} ${student.lastName}` : 'Unknown'}<button onclick="App.deleteRequest('${r.id}')" class="text-red-500 hover:text-red-700">X</button></li>`;
                                }).join('')}
                            </ul>
                        </div>
                    </div>
                </div>
            `;
        };

        const ScoresView = () => {
            const sortedAssignments = [...state.assignments].sort((a, b) => (a.assignmentNumber || 0) - (b.assignmentNumber || 0));
            return `
                <div class="p-4">
                    <h2 class="text-xl font-bold mb-2">Scores</h2>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white rounded-lg shadow-md">
                            <thead>
                                <tr class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                                    <th class="py-3 px-6 text-left">Student</th>
                                    ${sortedAssignments.map(assignment => `
                                        <th class="py-3 px-6 text-left cursor-pointer" onclick="App.setEditingAssignment('${assignment.id}')">
                                            ${state.editingAssignmentId === assignment.id ? `
                                                <input id="edit-assignment-num-${assignment.id}" type="number" value="${assignment.assignmentNumber || 0}" class="w-12 p-1 border rounded">
                                                <input id="edit-assignment-name-${assignment.id}" type="text" value="${assignment.name}" class="p-1 border rounded">
                                            ` : `
                                                ${assignment.assignmentNumber || 'N/A'}. ${assignment.name}
                                            `}
                                        </th>
                                    `).join('')}
                                </tr>
                            </thead>
                            <tbody class="text-gray-600 text-sm font-light">
                                ${state.students.filter(s => s.isActive).map(student => `
                                    <tr class="border-b border-gray-200 hover:bg-gray-100">
                                        <td class="py-3 px-6 text-left whitespace-nowrap">${student.firstName} ${student.lastName}</td>
                                        ${sortedAssignments.map(assignment => {
                                            const score = state.scores.find(s => s.studentId === student.id && s.assignmentId === assignment.id);
                                            return `<td class="py-3 px-6 text-left">${score ? score.score : 'N/A'}</td>`;
                                        }).join('')}
                                    </tr>
                                `).join('')}
                                ${state.editingAssignmentId ? `
                                    <tr>
                                        <td colspan="${sortedAssignments.length + 1}" class="text-right p-2">
                                            <button onclick="App.updateAssignment(state.editingAssignmentId, document.getElementById('edit-assignment-name-' + state.editingAssignmentId).value, document.getElementById('edit-assignment-num-' + state.editingAssignmentId).value)" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-1 px-2 rounded">Save</button>
                                            <button onclick="App.setEditingAssignment(null)" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-1 px-2 rounded">Cancel</button>
                                        </td>
                                    </tr>
                                ` : ''}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        };
        
        const renderUI = () => {
            const appDiv = document.getElementById('app');
            if (state.loading) {
                appDiv.innerHTML = `<div class="p-4">Loading...</div>`;
                return;
            }

            let viewHtml;
            if (state.currentView === 'layout') {
                viewHtml = LayoutView();
            } else if (state.currentView === 'scores') {
                viewHtml = ScoresView();
            }

            appDiv.innerHTML = `
                <div class="min-h-screen bg-gray-100">
                    <nav class="bg-white shadow-md p-4 flex justify-between items-center">
                        <div>
                            <h1 class="text-2xl font-bold">Instructor Dashboard</h1>
                            <select onchange="App.setPeriod(this.value)" class="mt-2 p-2 rounded border">
                                ${state.periods.map(p => `<option value="${p.id}" ${state.currentPeriodId === p.id ? 'selected' : ''}>${p.name}</option>`).join('')}
                            </select>
                            <button onclick="App.addPeriod()" class="ml-2 bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">+</button>
                        </div>
                        <div>
                            <button onclick="App.setView('layout')" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-l">Layout</button>
                            <button onclick="App.setView('scores')" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-r">Scores</button>
                        </div>
                    </nav>
                    <div class="p-4">
                        <button onclick="App.addStudent('${state.currentPeriodId}')" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">Add Student</button>
                        <button onclick="App.addAssignment('${state.currentPeriodId}')" class="ml-2 bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">Add Assignment</button>
                        <button onclick="App.addEmptySeat()" class="ml-2 bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">Add Empty Seat</button>
                        <button onclick="App.clearAllRequests()" class="ml-2 bg-yellow-500 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded">Clear All Requests</button>
                        <button onclick="App.deleteAllStudents()" class="ml-2 bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">Delete All Students</button>
                        <button onclick="App.clearAllData()" class="ml-2 bg-red-700 hover:bg-red-900 text-white font-bold py-2 px-4 rounded">Clear All Data</button>
                    </div>
                    ${viewHtml}
                </div>
            `;

            if (state.currentView === 'layout') {
                attachDragAndDrop();
            }
        };

        const attachDragAndDrop = () => {
            let draggedItemId = null;
        
            const handleDragStart = (e) => {
                draggedItemId = e.currentTarget.dataset.studentId;
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', draggedItemId);
                e.currentTarget.style.opacity = '0.5';
                state.isDragging = true;
            };
        
            const handleDragOver = (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                if (e.currentTarget.dataset.studentId !== draggedItemId) {
                    e.currentTarget.classList.add('bg-blue-200');
                }
            };
        
            const handleDragLeave = (e) => {
                e.currentTarget.classList.remove('bg-blue-200');
            };
        
            const handleDrop = async (e) => {
                e.preventDefault();
                e.stopPropagation();
                const targetItemId = e.currentTarget.dataset.studentId;
                e.currentTarget.classList.remove('bg-blue-200');
        
                if (draggedItemId === targetItemId) {
                    return;
                }
                await runTransaction(db, async (transaction) => {
                    const students = [...state.students].sort((a, b) => a.seatOrder - b.seatOrder);
                    const draggedIndex = students.findIndex(s => s.id === draggedItemId);
                    const targetIndex = students.findIndex(s => s.id === targetItemId);
        
                    const studentToMove = students.splice(draggedIndex, 1)[0];
                    students.splice(targetIndex, 0, studentToMove);
        
                    students.forEach((s, index) => {
                        const newOrder = index;
                        if (s.seatOrder !== newOrder) {
                            transaction.update(doc(db, `${studentsRef.path}/${s.id}`), { seatOrder: newOrder });
                        }
                    });
                });
            };
        
            const handleDragEnd = (e) => {
                e.currentTarget.style.opacity = '1';
                state.isDragging = false;
                document.querySelectorAll('.student-card').forEach(card => card.classList.remove('bg-blue-200'));
            };
        
            document.querySelectorAll('.student-card[draggable="true"]').forEach(card => {
                card.addEventListener('dragstart', handleDragStart);
                card.addEventListener('dragover', handleDragOver);
                card.addEventListener('dragleave', handleDragLeave);
                card.addEventListener('drop', handleDrop);
                card.addEventListener('dragend', handleDragEnd);
            });
        };

        document.addEventListener('DOMContentLoaded', () => {
            setupRefs();
            startDataListeners();
        });
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
    </style>
</head>
<body>
    <div id="app"></div>
</body>
</html>
