<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Classroom Management App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .view {
            display: none;
        }
        .view.active {
            display: block;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        /* Drag and Drop Styles */
        .seat.dragging-over {
            outline: 3px solid #2563eb;
            background-color: #dbeafe;
        }
        .student-roster-item:hover, .seat.draggable-student:hover {
             cursor: grab;
        }
        .seat.blank-seat {
            background-color: #e5e7eb;
        }
        .dragging {
            opacity: 0.7;
            transform: scale(1.05);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            z-index: 1000;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="login-view" class="view active flex items-center justify-center min-h-screen">
        <div class="bg-white p-10 rounded-xl shadow-lg w-full max-w-md">
            <h1 class="text-4xl font-bold text-center mb-8 text-gray-700">Classroom Manager</h1>
            <div id="firebaseui-auth-container"></div>
            <p id="loader" class="text-center mt-4">Loading...</p>
        </div>
    </div>

    <div id="teacher-view" class="view">
        <header class="bg-white shadow-md">
            <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
                <h1 class="text-2xl font-bold text-gray-700">Teacher Dashboard</h1>
                <div>
                    <button onclick="logout()" class="bg-red-500 text-white font-semibold py-2 px-5 rounded-lg hover:bg-red-600 transition">Logout</button>
                </div>
            </nav>
            <div class="container mx-auto px-6">
                <div class="flex border-b border-gray-200">
                    <button id="tab-students" onclick="switchTeacherTab('students')" class="py-4 px-6 block hover:text-blue-500 focus:outline-none text-blue-500 border-b-2 font-medium border-blue-500">Students</button>
                    <button id="tab-assignments" onclick="switchTeacherTab('assignments')" class="py-4 px-6 block hover:text-blue-500 focus:outline-none">Assignments</button>
                    <button id="tab-requests" onclick="switchTeacherTab('requests')" class="py-4 px-6 block hover:text-blue-500 focus:outline-none">Requests</button>
                    <button id="tab-seating" onclick="switchTeacherTab('seating')" class="py-4 px-6 block hover:text-blue-500 focus:outline-none">Seating Chart</button>
                    <button id="tab-backup" onclick="switchTeacherTab('backup')" class="py-4 px-6 block hover:text-blue-500 focus:outline-none">Backup</button>
                </div>
            </div>
        </header>

        <main class="container mx-auto p-6">
            <div id="content-students" class="tab-content active">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold">Manage Students</h2>
                    <button onclick="openModal('add-student-modal')" class="bg-blue-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-blue-700 transition">Add Student</button>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-4">
                         <button id="delete-selected-btn" onclick="confirmDeleteSelectedStudents()" class="bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600 transition hidden">Delete Selected</button>
                    </div>
                    <table class="w-full">
                        <thead>
                            <tr class="text-left text-gray-600">
                                <th class="p-3"><input type="checkbox" onchange="toggleSelectAll(this)"></th>
                                <th class="p-3 cursor-pointer" onclick="sortStudents('firstName')">First Name &#x2195;</th>
                                <th class="p-3 cursor-pointer" onclick="sortStudents('lastName')">Last Name &#x2195;</th>
                                <th class="p-3">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="student-list">
                            </tbody>
                    </table>
                </div>
            </div>

            <div id="content-assignments" class="tab-content">
                 <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold">Manage Assignments</h2>
                    <button onclick="openModal('add-assignment-modal')" class="bg-blue-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-blue-700 transition">Add Assignment</button>
                </div>
                 <div class="bg-white p-6 rounded-lg shadow-md">
                    <table class="w-full">
                        <thead>
                            <tr class="text-left text-gray-600">
                                <th class="p-3 cursor-pointer" onclick="sortTeacherAssignments('title')">Title &#x2195;</th>
                                <th class="p-3 cursor-pointer" onclick="sortTeacherAssignments('postedDate')">Posted Date &#x2195;</th>
                                <th class="p-3">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="teacher-assignment-list">
                            </tbody>
                    </table>
                </div>
            </div>

            <div id="content-requests" class="tab-content">
                <h2 class="text-3xl font-bold mb-6">Student Requests</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div>
                        <h3 class="text-2xl font-semibold mb-4">Help Requests</h3>
                        <div id="help-requests-list" class="space-y-4">
                            </div>
                    </div>
                    <div>
                        <h3 class="text-2xl font-semibold mb-4">Check Requests</h3>
                        <div id="check-requests-list" class="space-y-4">
                           </div>
                    </div>
                </div>
            </div>

            <div id="content-seating" class="tab-content">
                <h2 class="text-3xl font-bold mb-6">Seating Chart</h2>
                 <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-bold mb-4">Classroom Layout</h3>
                        <div id="seating-chart" class="grid grid-cols-6 gap-4">
                           </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-bold mb-4">Student Roster</h3>
                        <div id="student-roster" class="space-y-2">
                           </div>
                    </div>
                 </div>
            </div>
             <div id="content-backup" class="tab-content">
                <h2 class="text-3xl font-bold mb-6">Data Management</h2>
                <div class="bg-white p-8 rounded-lg shadow-md">
                    <h2 class="text-2xl font-bold mb-4">Data Export</h2>
                    <p class="mb-6 text-gray-600">Export all classroom data (students, assignments, scores, etc.) into a single CSV file. This can be used for backup or for importing into other systems.</p>
                    <button onclick="exportAllDataAsCSV()" class="bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-indigo-700 transition">
                        Export All Data as CSV
                    </button>
                    <div class="mt-8 pt-6 border-t border-gray-200">
                        <h2 class="text-2xl font-bold mb-4">Data Restore</h2>
                        <p class="mb-6 text-gray-600">
                            Restore all classroom data from a previously exported CSV file.
                            <strong class="text-red-600">Warning:</strong> This will overwrite all current data.
                        </p>
                        <input type="file" id="csv-restore-input" class="hidden" accept=".csv" onchange="restoreDataFromCSV(event)">
                        <button onclick="document.getElementById('csv-restore-input').click()" class="bg-amber-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-amber-700 transition">
                            Import and Restore from CSV
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="student-view" class="view">
         <header class="bg-white shadow-md">
            <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
                <h1 id="student-welcome" class="text-2xl font-bold text-gray-700">Welcome, Student</h1>
                <div>
                     <button onclick="requestHelp()" class="bg-yellow-500 text-white font-semibold py-2 px-5 rounded-lg hover:bg-yellow-600 transition mr-2">Request Help</button>
                     <button onclick="requestCheck()" class="bg-green-500 text-white font-semibold py-2 px-5 rounded-lg hover:bg-green-600 transition mr-4">Request Check</button>
                    <button onclick="logout()" class="bg-red-500 text-white font-semibold py-2 px-5 rounded-lg hover:bg-red-600 transition">Logout</button>
                </div>
            </nav>
        </header>

        <main class="container mx-auto p-6">
            <h2 class="text-3xl font-bold mb-6">Your Assignments</h2>
            <div class="bg-white p-6 rounded-lg shadow-md">
                 <table class="w-full">
                    <thead>
                        <tr class="text-left text-gray-600">
                            <th class="p-3 cursor-pointer" onclick="sortAssignments('title')">Title &#x2195;</th>
                            <th class="p-3 cursor-pointer" onclick="sortAssignments('postedDate')">Posted Date &#x2195;</th>
                            <th class="p-3">Score</th>
                             <th class="p-3">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="student-assignment-list">
                        </tbody>
                </table>
            </div>
        </main>
    </div>

    <div id="add-student-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">Add New Student</h3>
                <div class="mt-2 px-7 py-3">
                    <input id="student-firstname-input" type="text" placeholder="First Name" class="mb-3 px-3 py-2 text-gray-700 bg-white border rounded-md w-full focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <input id="student-lastname-input" type="text" placeholder="Last Name" class="mb-3 px-3 py-2 text-gray-700 bg-white border rounded-md w-full focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="items-center px-4 py-3">
                    <button id="add-student-btn" class="px-4 py-2 bg-blue-600 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Add Student</button>
                    <button onclick="closeModal('add-student-modal')" class="mt-2 px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-300 focus:outline-none">Cancel</button>
                </div>
            </div>
        </div>
    </div>
    <div id="edit-student-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">Edit Student</h3>
                 <input type="hidden" id="edit-student-id">
                <div class="mt-2 px-7 py-3">
                    <input id="edit-student-firstname-input" type="text" placeholder="First Name" class="mb-3 px-3 py-2 text-gray-700 bg-white border rounded-md w-full focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <input id="edit-student-lastname-input" type="text" placeholder="Last Name" class="mb-3 px-3 py-2 text-gray-700 bg-white border rounded-md w-full focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="items-center px-4 py-3">
                    <button id="update-student-btn" class="px-4 py-2 bg-blue-600 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-700 focus:outline-none">Update Student</button>
                    <button onclick="closeModal('edit-student-modal')" class="mt-2 px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-300 focus:outline-none">Cancel</button>
                </div>
            </div>
        </div>
    </div>
    <div id="add-assignment-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">Add New Assignment</h3>
                <div class="mt-2 px-7 py-3">
                    <input id="assignment-title-input" type="text" placeholder="Assignment Title" class="mb-3 px-3 py-2 text-gray-700 bg-white border rounded-md w-full focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="items-center px-4 py-3">
                    <button id="add-assignment-btn" class="px-4 py-2 bg-blue-600 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-700 focus:outline-none">Add Assignment</button>
                    <button onclick="closeModal('add-assignment-modal')" class="mt-2 px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-300 focus:outline-none">Cancel</button>
                </div>
            </div>
        </div>
    </div>
    <div id="edit-assignment-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
         <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">Edit Assignment</h3>
                <input type="hidden" id="edit-assignment-id">
                <div class="mt-2 px-7 py-3">
                    <input id="edit-assignment-title-input" type="text" placeholder="Assignment Title" class="mb-3 px-3 py-2 text-gray-700 bg-white border rounded-md w-full focus:outline-none">
                </div>
                <div class="items-center px-4 py-3">
                    <button id="update-assignment-btn" class="px-4 py-2 bg-blue-600 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-700 focus:outline-none">Update Assignment</button>
                    <button onclick="closeModal('edit-assignment-modal')" class="mt-2 px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-300 focus:outline-none">Cancel</button>
                </div>
            </div>
        </div>
    </div>
    <div id="score-assignment-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 id="score-assignment-title" class="text-lg leading-6 font-medium text-gray-900">Score Assignment</h3>
                <input type="hidden" id="score-assignment-id">
                <div id="student-scores-list" class="mt-4 px-2 py-3 max-h-60 overflow-y-auto">
                    </div>
                <div class="items-center px-4 py-3">
                    <button onclick="closeModal('score-assignment-modal')" class="mt-2 px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-300 focus:outline-none">Close</button>
                </div>
            </div>
        </div>
    </div>
    <div id="student-assignment-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 id="student-assignment-modal-title" class="text-lg leading-6 font-medium text-gray-900 text-center mb-4">Assignment Details</h3>
                <div id="student-assignment-details">
                    </div>
                <div class="items-center px-4 py-3">
                     <button onclick="closeModal('student-assignment-modal')" class="mt-2 px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-300 focus:outline-none">Close</button>
                </div>
            </div>
        </div>
    </div>
    <div id="success-message" class="hidden fixed bottom-5 right-5 bg-green-500 text-white py-3 px-6 rounded-lg shadow-lg">
        <p>Success!</p>
    </div>


    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/ui/6.0.1/firebase-ui-auth.js"></script>
    <link type="text/css" rel="stylesheet" href="https://www.gstatic.com/firebasejs/ui/6.0.1/firebase-ui-auth.css" />
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, writeBatch, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };


        // --- GLOBAL VARIABLES ---
        let db, auth, currentUser;
        let students = [], assignments = [];
        let studentsCol, assignmentsCol, helpRequestsCol, checkRequestsCol, seatingChartDoc;
        let currentStudentSort = { key: 'firstName', order: 'asc' };
        let currentAssignmentSort = { key: 'title', order: 'asc' };
        let currentTeacherAssignmentSort = { key: 'title', order: 'asc' };
        let draggedElement = null;

        // --- FIREBASE INITIALIZATION & AUTH ---
        function initFirebase() {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            const ui = new firebaseui.auth.AuthUI(firebase.auth());

            onAuthStateChanged(auth, user => {
                const loader = document.getElementById('loader');
                loader.style.display = 'none';

                if (user) {
                    currentUser = user;
                    setupUI(user);
                } else {
                    currentUser = null;
                    displayLoginUI(ui);
                }
            });
        }

        function displayLoginUI(ui) {
            switchView('login-view');
             ui.start('#firebaseui-auth-container', {
                signInOptions: [
                    {
                        provider: GoogleAuthProvider.PROVIDER_ID,
                        scopes: [
                            'https://www.googleapis.com/auth/contacts.readonly'
                        ],
                        customParameters: {
                            prompt: 'select_account'
                        }
                    }
                ],
                signInSuccessUrl: '#',
                callbacks: {
                    signInSuccessWithAuthResult: function(authResult, redirectUrl) {
                        return false;
                    }
                }
            });
        }
       async function setupUI(user) {
            const userDocRef = doc(db, "users", user.uid);
            const userDoc = await getDoc(userDocRef);

            if (userDoc.exists() && userDoc.data().role === 'teacher') {
                setupTeacherView();
            } else {
                 setupStudentView(user);
            }
        }

        async function setupTeacherView() {
            switchView('teacher-view');

            studentsCol = collection(db, `users/${currentUser.uid}/students`);
            assignmentsCol = collection(db, `users/${currentUser.uid}/assignments`);
            helpRequestsCol = collection(db, `users/${currentUser.uid}/helpRequests`);
            checkRequestsCol = collection(db, `users/${currentUser.uid}/checkRequests`);
            seatingChartDoc = doc(db, `users/${currentUser.uid}/seating/chart`);

            setupSnapshots();
            document.getElementById('add-student-btn').onclick = addStudent;
            document.getElementById('update-student-btn').onclick = updateStudent;
            document.getElementById('add-assignment-btn').onclick = addAssignment;
            document.getElementById('update-assignment-btn').onclick = updateAssignment;
        }
       async function setupStudentView(user) {
            const userDocRef = doc(db, "students", user.uid);
            const userDoc = await getDoc(userDocRef);
            if (!userDoc.exists()) {
                 console.error("Student document not found!");
                 switchView('login-view');
                 return;
            }
            const studentData = userDoc.data();
            const teacherUid = studentData.teacherUid;

            switchView('student-view');
            document.getElementById('student-welcome').textContent = `Welcome, ${studentData.firstName}`;


            studentsCol = collection(db, `users/${teacherUid}/students`);
            assignmentsCol = collection(db, `users/${teacherUid}/assignments`);
            helpRequestsCol = collection(db, `users/${teacherUid}/helpRequests`);
            checkRequestsCol = collection(db, `users/${teacherUid}/checkRequests`);

            onSnapshot(assignmentsCol, snapshot => {
                assignments = [];
                snapshot.forEach(doc => {
                    assignments.push({ id: doc.id, ...doc.data() });
                });
                renderStudentAssignments(studentData.id);
            });
        }

        function setupSnapshots() {
            onSnapshot(studentsCol, snapshot => {
                students = [];
                snapshot.forEach(doc => {
                    students.push({ id: doc.id, ...doc.data() });
                });
                renderStudents();
                renderStudentRoster();
            });

            onSnapshot(assignmentsCol, snapshot => {
                assignments = [];
                snapshot.forEach(doc => {
                    assignments.push({ id: doc.id, ...doc.data() });
                });
                 renderTeacherAssignments();
            });
             onSnapshot(helpRequestsCol, snapshot => {
                const requests = [];
                snapshot.forEach(doc => requests.push({ id: doc.id, ...doc.data() }));
                renderRequests(requests, 'help-requests-list');
            });

            onSnapshot(checkRequestsCol, snapshot => {
                const requests = [];
                snapshot.forEach(doc => requests.push({ id: doc.id, ...doc.data() }));
                renderRequests(requests, 'check-requests-list');
            });
            onSnapshot(seatingChartDoc, (doc) => {
                const data = doc.data();
                renderSeatingChart(data ? data.chart : null);
            });
        }
        function logout() {
            signOut(auth).catch(error => console.error("Sign out error", error));
        }

        // --- UI RENDERING ---
        function renderStudents() {
             sortStudents(currentStudentSort.key, true);
            const list = document.getElementById('student-list');
            list.innerHTML = '';
            students.forEach(student => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-200 hover:bg-gray-50';
                row.innerHTML = `
                    <td class="p-3"><input type="checkbox" class="student-checkbox" value="${student.id}" onchange="updateDeleteSelectedButtonState()"></td>
                    <td class="p-3">${student.firstName}</td>
                    <td class="p-3">${student.lastName}</td>
                    <td class="p-3">
                        <button onclick="openEditStudentModal('${student.id}')" class="text-blue-600 hover:underline mr-4">Edit</button>
                        <button onclick="confirmDeleteStudent('${student.id}')" class="text-red-600 hover:underline">Delete</button>
                    </td>
                `;
                list.appendChild(row);
            });
        }
        function renderTeacherAssignments() {
            sortTeacherAssignments(currentTeacherAssignmentSort.key, true);
            const list = document.getElementById('teacher-assignment-list');
            list.innerHTML = '';
            assignments.forEach(assignment => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-200 hover:bg-gray-50';
                row.innerHTML = `
                    <td class="p-3">${assignment.title}</td>
                    <td class="p-3">${new Date(assignment.postedDate).toLocaleDateString()}</td>
                    <td class="p-3">
                        <button onclick="openScoreAssignmentModal('${assignment.id}')" class="text-green-600 hover:underline mr-4">Score</button>
                        <button onclick="openEditAssignmentModal('${assignment.id}')" class="text-blue-600 hover:underline mr-4">Edit</button>
                        <button onclick="confirmDeleteAssignment('${assignment.id}')" class="text-red-600 hover:underline">Delete</button>
                    </td>
                `;
                list.appendChild(row);
            });
        }

        function renderStudentAssignments(studentId) {
            sortAssignments(currentAssignmentSort.key, true);
            const list = document.getElementById('student-assignment-list');
            list.innerHTML = '';
             assignments.forEach(assignment => {
                const student = students.find(s => s.id === studentId);
                const score = student && student.scores && student.scores[assignment.id] ? student.scores[assignment.id] : 'Not Graded';
                const row = document.createElement('tr');
                 row.className = 'border-b border-gray-200 hover:bg-gray-50';
                row.innerHTML = `
                    <td class="p-3">${assignment.title}</td>
                    <td class="p-3">${new Date(assignment.postedDate).toLocaleDateString()}</td>
                    <td class="p-3">${score}</td>
                    <td class="p-3">
                        <button onclick="openStudentAssignmentModal('${assignment.id}', '${studentId}')" class="text-blue-600 hover:underline">View Details</button>
                    </td>
                `;
                list.appendChild(row);
            });
        }
         function renderRequests(requests, listId) {
            const list = document.getElementById(listId);
            list.innerHTML = '';
            requests.sort((a, b) => a.timestamp.toDate() - b.timestamp.toDate());
            requests.forEach(request => {
                const student = students.find(s => s.id === request.studentId);
                const studentName = student ? `${student.firstName} ${student.lastName}` : 'Unknown Student';
                const card = document.createElement('div');
                card.className = 'bg-white p-4 rounded-lg shadow flex justify-between items-center';
                card.innerHTML = `
                    <div>
                        <p class="font-semibold">${studentName}</p>
                        <p class="text-sm text-gray-500">${request.timestamp.toDate().toLocaleTimeString()}</p>
                    </div>
                    <div>
                        <button onclick="resolveRequest('${listId === 'help-requests-list' ? 'help' : 'check'}', '${request.id}')" class="bg-green-500 text-white py-1 px-3 rounded hover:bg-green-600 mr-2">Resolve</button>
                        <button onclick="cancelRequest('${listId === 'help-requests-list' ? 'help' : 'check'}', '${request.id}')" class="bg-red-500 text-white py-1 px-3 rounded hover:bg-red-600">Cancel</button>
                    </div>
                `;
                list.appendChild(card);
            });
        }
        function renderSeatingChart(chartData) {
            const chart = document.getElementById('seating-chart');
            chart.innerHTML = '';
            const numSeats = 30; // 5 rows, 6 columns
            const seatingChart = chartData || Array(numSeats).fill(null);

            for(let i = 0; i < numSeats; i++) {
                const seat = document.createElement('div');
                seat.dataset.seatId = i;
                seat.className = 'seat border-2 border-gray-300 rounded-lg h-24 flex items-center justify-center text-center p-2';
                const studentId = seatingChart[i];
                if(studentId) {
                    const student = students.find(s => s.id === studentId);
                    if (student) {
                        seat.textContent = `${student.firstName} ${student.lastName}`;
                        seat.className += ' draggable-student bg-blue-100 border-blue-300';
                        seat.draggable = true;
                        seat.dataset.studentId = student.id;
                    } else {
                         seat.textContent = 'Unassigned';
                         seat.className += ' blank-seat';
                    }
                } else {
                    seat.textContent = 'Empty';
                    seat.className += ' blank-seat';
                }
                seat.addEventListener('dragstart', handleDragStart);
                seat.addEventListener('dragend', handleDragEnd);
                seat.addEventListener('dragover', handleDragOver);
                seat.addEventListener('dragleave', handleDragLeave);
                seat.addEventListener('drop', handleDrop);
                chart.appendChild(seat);
            }
             updateStudentRosterAvailability(seatingChart);
        }

        function renderStudentRoster() {
            const roster = document.getElementById('student-roster');
            roster.innerHTML = '';
            students.forEach(student => {
                const item = document.createElement('div');
                item.id = `roster-${student.id}`;
                item.className = 'student-roster-item p-3 bg-gray-100 rounded-md shadow-sm';
                item.textContent = `${student.firstName} ${student.lastName}`;
                item.draggable = true;
                item.dataset.studentId = student.id;
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragend', handleDragEnd);
                roster.appendChild(item);
            });
        }

        function updateStudentRosterAvailability(seatingChart) {
            students.forEach(student => {
                const rosterItem = document.getElementById(`roster-${student.id}`);
                if (rosterItem) {
                    if (seatingChart.includes(student.id)) {
                        rosterItem.style.display = 'none';
                    } else {
                        rosterItem.style.display = 'block';
                    }
                }
            });
        }
        // --- STUDENT MANAGEMENT ---
        async function addStudent() {
            const firstName = document.getElementById('student-firstname-input').value.trim();
            const lastName = document.getElementById('student-lastname-input').value.trim();
            if (firstName && lastName) {
                try {
                     await addDoc(studentsCol, { firstName, lastName, scores: {} });
                    closeModal('add-student-modal');
                    showSuccessMessage('Student added successfully!');
                     document.getElementById('student-firstname-input').value = '';
                     document.getElementById('student-lastname-input').value = '';
                } catch (error) {
                    console.error("Error adding student: ", error);
                }
            } else {
                alert("Please enter both first and last names.");
            }
        }
        function openEditStudentModal(studentId) {
            const student = students.find(s => s.id === studentId);
            if (student) {
                document.getElementById('edit-student-id').value = student.id;
                document.getElementById('edit-student-firstname-input').value = student.firstName;
                document.getElementById('edit-student-lastname-input').value = student.lastName;
                openModal('edit-student-modal');
            }
        }
        async function updateStudent() {
             const studentId = document.getElementById('edit-student-id').value;
             const firstName = document.getElementById('edit-student-firstname-input').value.trim();
             const lastName = document.getElementById('edit-student-lastname-input').value.trim();
             if (studentId && firstName && lastName) {
                 try {
                     const studentRef = doc(db, `users/${currentUser.uid}/students`, studentId);
                     await updateDoc(studentRef, { firstName, lastName });
                     closeModal('edit-student-modal');
                     showSuccessMessage('Student updated successfully!');
                 } catch (error) {
                     console.error("Error updating student:", error);
                 }
             } else {
                alert("Please fill out all fields.");
             }
        }
       async function confirmDeleteStudent(studentId) {
            if (confirm("Are you sure you want to delete this student? This action cannot be undone.")) {
                try {
                    await deleteDoc(doc(db, `users/${currentUser.uid}/students`, studentId));
                    showSuccessMessage('Student deleted successfully!');
                } catch (error) {
                    console.error("Error deleting student: ", error);
                }
            }
        }
         function toggleSelectAll(checkbox) {
            document.querySelectorAll('.student-checkbox').forEach(cb => {
                cb.checked = checkbox.checked;
            });
            updateDeleteSelectedButtonState();
        }
        function updateDeleteSelectedButtonState() {
            const selectedCount = document.querySelectorAll('.student-checkbox:checked').length;
            const btn = document.getElementById('delete-selected-btn');
            if (selectedCount > 0) {
                btn.classList.remove('hidden');
                btn.textContent = `Delete Selected (${selectedCount})`;
            } else {
                btn.classList.add('hidden');
            }
        }
        async function confirmDeleteSelectedStudents() {
            const selectedCheckboxes = document.querySelectorAll('.student-checkbox:checked');
            if (selectedCheckboxes.length === 0) {
                alert("Please select students to delete.");
                return;
            }
            if (confirm(`Are you sure you want to delete ${selectedCheckboxes.length} students? This cannot be undone.`)) {
                const batch = writeBatch(db);
                selectedCheckboxes.forEach(cb => {
                    const studentRef = doc(db, `users/${currentUser.uid}/students`, cb.value);
                    batch.delete(studentRef);
                });
                try {
                    await batch.commit();
                    showSuccessMessage('Selected students deleted successfully!');
                    document.querySelector('thead input[type="checkbox"]').checked = false;
                } catch (error) {
                     console.error("Error deleting selected students: ", error);
                }
            }
        }
        // --- ASSIGNMENT MANAGEMENT ---
        async function addAssignment() {
            const title = document.getElementById('assignment-title-input').value.trim();
            if (title) {
                try {
                    await addDoc(assignmentsCol, { title, postedDate: new Date().toISOString() });
                    closeModal('add-assignment-modal');
                    showSuccessMessage('Assignment added successfully!');
                    document.getElementById('assignment-title-input').value = '';
                } catch (error) {
                    console.error("Error adding assignment: ", error);
                }
            } else {
                alert("Please enter an assignment title.");
            }
        }
        function openEditAssignmentModal(assignmentId) {
            const assignment = assignments.find(a => a.id === assignmentId);
            if(assignment) {
                document.getElementById('edit-assignment-id').value = assignment.id;
                document.getElementById('edit-assignment-title-input').value = assignment.title;
                openModal('edit-assignment-modal');
            }
        }
        async function updateAssignment() {
            const assignmentId = document.getElementById('edit-assignment-id').value;
            const title = document.getElementById('edit-assignment-title-input').value.trim();
            if(assignmentId && title) {
                try {
                    const assignmentRef = doc(db, `users/${currentUser.uid}/assignments`, assignmentId);
                    await updateDoc(assignmentRef, { title });
                    closeModal('edit-assignment-modal');
                    showSuccessMessage('Assignment updated successfully!');
                } catch (error) {
                    console.error("Error updating assignment:", error);
                }
            } else {
                alert("Please enter a title.");
            }
        }
        function openScoreAssignmentModal(assignmentId) {
            const assignment = assignments.find(a => a.id === assignmentId);
            if (assignment) {
                document.getElementById('score-assignment-title').textContent = `Scoring: ${assignment.title}`;
                document.getElementById('score-assignment-id').value = assignment.id;
                const list = document.getElementById('student-scores-list');
                list.innerHTML = '';
                students.forEach(student => {
                    const score = student.scores && student.scores[assignmentId] ? student.scores[assignmentId] : '';
                    const item = document.createElement('div');
                    item.className = 'flex justify-between items-center p-2 hover:bg-gray-100';
                    item.innerHTML = `
                        <span>${student.firstName} ${student.lastName}</span>
                        <input type="text" value="${score}" onchange="updateScore('${student.id}', '${assignmentId}', this.value)" class="w-24 px-2 py-1 border rounded">
                    `;
                    list.appendChild(item);
                });
                openModal('score-assignment-modal');
            }
        }

        async function updateScore(studentId, assignmentId, score) {
            try {
                const studentRef = doc(db, `users/${currentUser.uid}/students`, studentId);
                const fieldPath = `scores.${assignmentId}`;
                await updateDoc(studentRef, { [fieldPath]: score });
            } catch (error) {
                console.error("Error updating score:", error);
                alert("Could not update score. See console for details.");
            }
        }
         async function confirmDeleteAssignment(assignmentId) {
            if (confirm("Are you sure you want to delete this assignment? All associated scores will also be removed.")) {
                try {
                    // Start a batch to delete the assignment and update all students
                    const batch = writeBatch(db);

                    // 1. Delete the assignment document
                    const assignmentRef = doc(db, `users/${currentUser.uid}/assignments`, assignmentId);
                    batch.delete(assignmentRef);

                    // 2. Remove the score from each student who has it
                    students.forEach(student => {
                        if (student.scores && student.scores[assignmentId]) {
                            const studentRef = doc(db, `users/${currentUser.uid}/students`, student.id);
                            const fieldPath = `scores.${assignmentId}`;
                            batch.update(studentRef, { [fieldPath]: deleteField() });
                        }
                    });

                    await batch.commit();
                    showSuccessMessage('Assignment deleted successfully!');
                } catch (error) {
                    console.error("Error deleting assignment: ", error);
                }
            }
        }
        // --- STUDENT VIEW ACTIONS ---
        function openStudentAssignmentModal(assignmentId, studentId) {
            const assignment = assignments.find(a => a.id === assignmentId);
            const student = students.find(s => s.id === studentId);
            if (assignment && student) {
                const score = student.scores && student.scores[assignmentId] ? student.scores[assignmentId] : 'Not Graded';
                document.getElementById('student-assignment-modal-title').textContent = assignment.title;
                const details = document.getElementById('student-assignment-details');
                details.innerHTML = `
                    <p class="text-gray-600 mb-2"><strong>Posted Date:</strong> ${new Date(assignment.postedDate).toLocaleDateString()}</p>
                    <p class="text-gray-800 font-semibold"><strong>Your Score:</strong> ${score}</p>
                `;
                openModal('student-assignment-modal');
            }
        }
        // --- REQUESTS ---
        async function requestHelp() {
            try {
                await addDoc(helpRequestsCol, {
                    studentId: currentUser.uid, // This assumes student UID is used as their doc ID
                    timestamp: serverTimestamp()
                });
                showSuccessMessage("Help request sent!");
            } catch(error) {
                console.error("Error requesting help:", error);
            }
        }
         async function requestCheck() {
             try {
                await addDoc(checkRequestsCol, {
                    studentId: currentUser.uid,
                    timestamp: serverTimestamp()
                });
                showSuccessMessage("Check request sent!");
            } catch(error) {
                console.error("Error requesting check:", error);
            }
        }

        async function resolveRequest(type, requestId) {
            const coll = type === 'help' ? helpRequestsCol : checkRequestsCol;
            await deleteDoc(doc(coll, requestId));
            showSuccessMessage("Request resolved.");
        }

       async function cancelRequest(type, requestId) {
            const coll = type === 'help' ? helpRequestsCol : checkRequestsCol;
            await deleteDoc(doc(coll, requestId));
             showSuccessMessage("Request canceled.");
        }

        // --- SEATING CHART ---
        function handleDragStart(e) {
            draggedElement = e.target;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', e.target.dataset.studentId);
            setTimeout(() => {
                e.target.classList.add('dragging');
            }, 0);
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
            draggedElement = null;
        }

        function handleDragOver(e) {
            e.preventDefault();
            const targetSeat = e.target.closest('.seat');
             if(targetSeat) {
                 targetSeat.classList.add('dragging-over');
             }
        }

         function handleDragLeave(e) {
             const targetSeat = e.target.closest('.seat');
             if(targetSeat) {
                 targetSeat.classList.remove('dragging-over');
             }
        }

       async function handleDrop(e) {
            e.preventDefault();
            const targetSeat = e.target.closest('.seat');
            if(!targetSeat || !draggedElement) return;

            targetSeat.classList.remove('dragging-over');
            const studentIdToPlace = draggedElement.dataset.studentId;
            const targetSeatId = parseInt(targetSeat.dataset.seatId);
            const sourceSeatId = draggedElement.classList.contains('seat') ? parseInt(draggedElement.dataset.seatId) : null;

            // Get current chart from Firestore
            const chartDoc = await getDoc(seatingChartDoc);
            const seatingChart = chartDoc.exists() ? chartDoc.data().chart : Array(30).fill(null);

            // If the target seat is occupied, move the student back to the roster
            const studentIdInTarget = seatingChart[targetSeatId];
            if(studentIdInTarget) {
                 const rosterItem = document.getElementById(`roster-${studentIdInTarget}`);
                 if (rosterItem) rosterItem.style.display = 'block';
            }

            // Place the new student
            seatingChart[targetSeatId] = studentIdToPlace;

            // If the student was dragged from another seat, clear that seat
            if (sourceSeatId !== null) {
                seatingChart[sourceSeatId] = null;
            }

            // Update Firestore
            await setDoc(seatingChartDoc, { chart: seatingChart });

             // Optimistic UI update
            renderSeatingChart(seatingChart);
            updateStudentRosterAvailability(seatingChart);
        }
        // --- DATA MANAGEMENT ---
       async function exportAllDataAsCSV() {
            let csvContent = "data:text/csv;charset=utf-8,";

            // Students Data
            csvContent += "[Students]\r\n";
            csvContent += "ID,FirstName,LastName\r\n";
            students.forEach(student => {
                csvContent += `${student.id},${student.firstName},${student.lastName}\r\n`;
            });
            csvContent += "\r\n";

            // Assignments Data
            csvContent += "[Assignments]\r\n";
            csvContent += "ID,Title,PostedDate\r\n";
            assignments.forEach(assignment => {
                 csvContent += `${assignment.id},${assignment.title},${assignment.postedDate}\r\n`;
            });
            csvContent += "\r\n";

            // Scores Data
            csvContent += "[Scores]\r\n";
            csvContent += "StudentID,AssignmentID,Score\r\n";
            students.forEach(student => {
                if(student.scores) {
                    Object.entries(student.scores).forEach(([assignmentId, score]) => {
                        csvContent += `${student.id},${assignmentId},${score}\r\n`;
                    });
                }
            });
            csvContent += "\r\n";
             // Help Requests
            const helpRequests = await getDocs(helpRequestsCol);
            csvContent += "[Help Requests]\r\n";
            csvContent += "StudentID,Timestamp\r\n";
            helpRequests.forEach(doc => {
                const data = doc.data();
                csvContent += `${data.studentId},${data.timestamp.toDate().toISOString()}\r\n`;
            });
            csvContent += "\r\n";

            // Check Requests
            const checkRequests = await getDocs(checkRequestsCol);
            csvContent += "[Check Requests]\r\n";
            csvContent += "StudentID,Timestamp\r\n";
            checkRequests.forEach(doc => {
                 const data = doc.data();
                csvContent += `${data.studentId},${data.timestamp.toDate().toISOString()}\r\n`;
            });
            csvContent += "\r\n";
             // Seating Chart
            const chartDoc = await getDoc(seatingChartDoc);
            if (chartDoc.exists()) {
                csvContent += "[Seating Chart]\r\n";
                csvContent += chartDoc.data().chart.join(',') + "\r\n";
            }
            csvContent += "\r\n";


            // Create and trigger download
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "classroom_data_export.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        async function restoreDataFromCSV(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            const reader = new FileReader();
            reader.onload = async (e) => {
                const text = e.target.result;
                const lines = text.split('\n').map(line => line.trim()).filter(line => line);

                const data = {
                    students: [],
                    assignments: [],
                    scores: {},
                    helpRequests: [],
                    checkRequests: [],
                    seatingChart: []
                };

                let currentSection = '';
                lines.forEach(line => {
                    // Skip header rows
                    if (line.includes('ID,FirstName,LastName') || line.includes('ID,Title,PostedDate') || line.includes('StudentID,AssignmentID,Score') || line.includes('StudentID,Timestamp')) {
                        return;
                    }
                    if (line.startsWith('[') && line.endsWith(']')) {
                        currentSection = line.substring(1, line.length - 1).toLowerCase();
                        return;
                    }


                    const values = line.split(',');
                    switch (currentSection) {
                        case 'students':
                            data.students.push({
                                id: values[0],
                                firstName: values[1],
                                lastName: values[2]
                            });
                            break;
                        case 'assignments':
                            data.assignments.push({
                                id: values[0],
                                title: values[1],
                                postedDate: values[2]
                            });
                            break;
                        case 'scores':
                            const studentId = values[0];
                            const assignmentId = values[1];
                            const score = values[2];
                            if (!data.scores[studentId]) {
                                data.scores[studentId] = {};
                            }
                            data.scores[studentId][assignmentId] = score;
                            break;
                        case 'help requests':
                            data.helpRequests.push({
                                studentId: values[0],
                                timestamp: new Date(values[1])
                            });
                            break;
                        case 'check requests':
                             data.checkRequests.push({
                                studentId: values[0],
                                timestamp: new Date(values[1])
                            });
                            break;
                        case 'seating chart':
                            data.seatingChart = values.map(val => val ? val : null);
                            break;
                    }
                });

                try {
                    // Clear existing data in a batch
                    const batch = writeBatch(db);
                    const collectionsToClear = [studentsCol, assignmentsCol, helpRequestsCol, checkRequestsCol];
                    for (const coll of collectionsToClear) {
                        const snapshot = await getDocs(coll);
                        snapshot.docs.forEach(doc => {
                            batch.delete(doc.ref);
                        });
                    }
                    await batch.commit();

                    // Add new data in a new batch
                    const newBatch = writeBatch(db);
                    data.students.forEach(student => {
                        const studentRef = doc(db, `users/${currentUser.uid}/students`, student.id);
                        const studentData = {
                             firstName: student.firstName,
                             lastName: student.lastName,
                             scores: data.scores[student.id] || {}
                         };
                        newBatch.set(studentRef, studentData);
                    });
                    data.assignments.forEach(assignment => {
                        const assignmentRef = doc(db, `users/${currentUser.uid}/assignments`, assignment.id);
                        newBatch.set(assignmentRef, { title: assignment.title, postedDate: assignment.postedDate });
                    });
                    data.helpRequests.forEach(request => {
                        const docRef = doc(helpRequestsCol);
                        newBatch.set(docRef, request);
                    });
                     data.checkRequests.forEach(request => {
                        const docRef = doc(checkRequestsCol);
                        newBatch.set(docRef, request);
                    });
                    await newBatch.commit();

                    // Restore seating chart
                    if (data.seatingChart.length > 0) {
                         await setDoc(seatingChartDoc, { chart: data.seatingChart });
                    }

                    showSuccessMessage('Data restored successfully!');
                } catch (error) {
                    console.error('Error restoring data:', error);
                    alert('An error occurred while restoring data. Please check the console for details.');
                }
            };
            reader.readAsText(file);
        }


        // --- UI UTILITY FUNCTIONS ---
        function switchView(viewId) {
            document.querySelectorAll('.view').forEach(view => view.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
        }

        function switchTeacherTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`content-${tabName}`).classList.add('active');

            document.querySelectorAll('header .flex button').forEach(button => {
                button.classList.remove('text-blue-500', 'border-b-2', 'font-medium', 'border-blue-500');
            });
            document.getElementById(`tab-${tabName}`).classList.add('text-blue-500', 'border-b-2', 'font-medium', 'border-blue-500');
        }

        function openModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        function showSuccessMessage(message) {
            const successDiv = document.getElementById('success-message');
            successDiv.textContent = message;
            successDiv.classList.remove('hidden');
            setTimeout(() => {
                successDiv.classList.add('hidden');
            }, 3000);
        }

        function sortStudents(key, keepOrder = false) {
             if (!keepOrder && currentStudentSort.key === key) {
                currentStudentSort.order = currentStudentSort.order === 'asc' ? 'desc' : 'asc';
            } else if (!keepOrder) {
                 currentStudentSort.key = key;
                 currentStudentSort.order = 'asc';
            }

            students.sort((a, b) => {
                if (a[key] < b[key]) return currentStudentSort.order === 'asc' ? -1 : 1;
                if (a[key] > b[key]) return currentStudentSort.order === 'asc' ? 1 : -1;
                return 0;
            });
            renderStudents();
        }
         function sortAssignments(key, keepOrder = false) {
            if (!keepOrder && currentAssignmentSort.key === key) {
                currentAssignmentSort.order = currentAssignmentSort.order === 'asc' ? 'desc' : 'asc';
            } else if (!keepOrder){
                 currentAssignmentSort.key = key;
                 currentAssignmentSort.order = 'asc';
            }

            assignments.sort((a, b) => {
                if (a[key] < b[key]) return currentAssignmentSort.order === 'asc' ? -1 : 1;
                if (a[key] > b[key]) return currentAssignmentSort.order === 'asc' ? 1 : -1;
                return 0;
            });
             if(document.getElementById('student-view').classList.contains('active')) {
                // Find student ID to re-render assignments
                // This is a simplified approach. A more robust solution might store the current student's ID globally.
                const studentDocRef = doc(db, "students", currentUser.uid);
                getDoc(studentDocRef).then(doc => {
                     if(doc.exists()) renderStudentAssignments(doc.id);
                });
             }
        }
        function sortTeacherAssignments(key, keepOrder = false) {
             if (!keepOrder && currentTeacherAssignmentSort.key === key) {
                currentTeacherAssignmentSort.order = currentTeacherAssignmentSort.order === 'asc' ? 'desc' : 'asc';
            } else if (!keepOrder){
                 currentTeacherAssignmentSort.key = key;
                 currentTeacherAssignmentSort.order = 'asc';
            }

            assignments.sort((a, b) => {
                if (a[key] < b[key]) return currentTeacherAssignmentSort.order === 'asc' ? -1 : 1;
                if (a[key] > b[key]) return currentTeacherAssignmentSort.order === 'asc' ? 1 : -1;
                return 0;
            });
            renderTeacherAssignments();
        }

        // --- GLOBAL ACCESS TO FUNCTIONS ---
        window.switchView = switchView;
        window.switchTeacherTab = switchTeacherTab;
        window.openModal = openModal;
        window.closeModal = closeModal;
        window.sortStudents = sortStudents;
        window.sortAssignments = sortAssignments;
        window.sortTeacherAssignments = sortTeacherAssignments;
        window.logout = logout;
        window.openEditStudentModal = openEditStudentModal;
        window.confirmDeleteStudent = confirmDeleteStudent;
        window.toggleSelectAll = toggleSelectAll;
        window.updateDeleteSelectedButtonState = updateDeleteSelectedButtonState;
        window.confirmDeleteSelectedStudents = confirmDeleteSelectedStudents;
        window.openEditAssignmentModal = openEditAssignmentModal;
        window.openScoreAssignmentModal = openScoreAssignmentModal;
        window.updateScore = updateScore;
        window.confirmDeleteAssignment = confirmDeleteAssignment;
        window.handleDragStart = handleDragStart;
        window.handleDragEnd = handleDragEnd;
        window.handleDragOver = handleDragOver;
        window.handleDragLeave = handleDragLeave;
        window.handleDrop = handleDrop;
        window.openStudentAssignmentModal = openStudentAssignmentModal;
        window.exportAllDataAsCSV = exportAllDataAsCSV;
        window.restoreDataFromCSV = restoreDataFromCSV;
        window.requestHelp = requestHelp;
        window.requestCheck = requestCheck;
        window.resolveRequest = resolveRequest;
        window.cancelRequest = cancelRequest;

        // --- INITIALIZATION ---
        initFirebase();
    </script>
</body>
</html>
