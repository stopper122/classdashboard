<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Classroom Management App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .view {
            display: none;
        }
        .view.active {
            display: block;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        /* Drag and Drop Styles */
        .seat.dragging-over {
            outline: 3px solid #2563eb;
            background-color: #dbeafe;
        }
        .student-roster-item:hover, .seat.draggable-student:hover {
             cursor: grab;
        }
        .seat.blank-seat {
            background-color: #e5e7eb;
        }
        .dragging {
            opacity: 0.7;
            transform: scale(1.05);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app" class="max-w-7xl mx-auto p-4 md:p-8">
        <div id="login-type-selection" class="view active text-center bg-white p-8 rounded-xl shadow-md">
            <h1 class="text-3xl font-bold mb-4 text-gray-900">Classroom Management</h1>
            <p class="text-gray-600 mb-8">Please select your login type.</p>
            <div class="flex flex-col md:flex-row justify-center items-center gap-4">
                <button onclick="switchView('teacher-login')" class="w-full max-w-xs bg-blue-600 text-white font-semibold py-4 px-8 rounded-lg shadow-md hover:bg-blue-700 transition-transform transform hover:scale-105">
                    Teacher Login
                </button>
                <button onclick="switchView('student-login')" class="w-full max-w-xs bg-green-600 text-white font-semibold py-4 px-8 rounded-lg shadow-md hover:bg-green-700 transition-transform transform hover:scale-105">
                    Student Login
                </button>
            </div>
        </div>

        <div id="teacher-login-view" class="view text-center bg-white p-8 rounded-xl shadow-md max-w-md mx-auto">
<h1 class="text-3xl font-bold mb-4 text-gray-900">Teacher Portal</h1>
<p class="text-gray-600 mb-8">Enter the teacher password to access the dashboard.</p>
<input type="password" id="teacher-password" placeholder="Enter Password"
       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 mb-4" required>
<button onclick="checkTeacherPassword()"
        class="w-full bg-blue-600 text-white font-semibold py-4 px-6 rounded-lg shadow-md hover:bg-blue-700 transition-transform transform hover:scale-105">
  Access Dashboard
</button>
<p id="teacher-login-error" class="text-red-500 text-sm h-4 mt-2"></p>
<button onclick="switchView('login-type-selection')" class="mt-4 text-sm text-gray-600 hover:text-gray-800">Back to login selection</button>
</div>

        <div id="student-login-view" class="view bg-white p-8 rounded-xl shadow-md max-w-md mx-auto">
            <h1 class="text-3xl font-bold mb-4 text-gray-900 text-center">Student Login</h1>
            <form id="student-login-form" class="flex flex-col items-center gap-4 mx-auto">
                <label for="student-id-login" class="sr-only">Student ID</label>
                <input type="number" id="student-id-login" placeholder="Enter Your Student ID#" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500" required>
                <button type="submit" class="w-full bg-green-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-green-700 transition">Login</button>
                <p id="login-error" class="text-red-500 text-sm h-4"></p> </form>
            <button onclick="switchView('login-type-selection')" class="mt-4 block w-full text-center text-sm text-gray-600 hover:text-gray-800">Back to login selection</button>
        </div>

        <div id="teacher-view" class="view">
            <header class="flex justify-between items-center mb-6">
                <div>
                    <h1 class="text-4xl font-bold text-gray-900">Teacher Dashboard</h1>
                    <p class="text-gray-500">Manage your classroom assignments, students, and seating arrangements.</p>
                </div>
                 <button onclick="switchView('login-type-selection')" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition">Logout</button>
            </header>

            <div class="mb-6 border-b border-gray-200">
                <nav class="flex space-x-4" aria-label="Tabs">
                    <button onclick="switchTeacherTab('assignments')" id="tab-assignments" class="tab-btn whitespace-nowrap pb-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                        Assignments
                    </button>
                    <button onclick="switchTeacherTab('students')" id="tab-students" class="tab-btn whitespace-nowrap pb-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                        Students
                    </button>
                    <button onclick="switchTeacherTab('seating-chart')" id="tab-seating-chart" class="tab-btn whitespace-nowrap pb-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                        Seating Chart
                    </button>
                    <button onclick="switchTeacherTab('backup')" id="tab-backup" class="tab-btn whitespace-nowrap pb-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                        Backup
                    </button>
                </nav>
            </div>

            <div id="content-assignments" class="tab-content">
                 <div class="bg-white p-6 rounded-xl shadow-md">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold">Assignments</h2>
                        <div class="flex gap-2">
  <button onclick="openModal('bulk-assignment-modal')" class="bg-purple-600 text-white font-semibold py-2.5 px-5 rounded-lg hover:bg-purple-700 transition">Bulk Add</button>
  <button onclick="openModal('add-assignment-modal')" class="bg-blue-600 text-white font-semibold py-2.5 px-5 rounded-lg hover:bg-blue-700 transition">Add Assignment</button>
</div>
</div>
                    <div class="flex items-center gap-2 flex-wrap mb-4">
                        <span class="text-sm font-medium text-gray-600">Sort by:</span>
                        <button onclick="sortTeacherAssignments('number_asc')" class="text-sm bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-full hover:bg-gray-300 transition">Number (Asc)</button>
                        <button onclick="sortTeacherAssignments('number_desc')" class="text-sm bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-full hover:bg-gray-300 transition">Number (Desc)</button>
                        <button onclick="sortTeacherAssignments('date_desc')" class="text-sm bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-full hover:bg-gray-300 transition">Date (Newest)</button>
                        <button onclick="sortTeacherAssignments('date_asc')" class="text-sm bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-full hover:bg-gray-300 transition">Date (Oldest)</button>
                    </div>
                    <div id="teacher-assignment-list" class="space-y-4">
                        </div>
                </div>
            </div>

            <div id="content-students" class="tab-content">
                 <div class="bg-white p-6 rounded-xl shadow-md">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold">Student Roster</h2>
                        <div class="flex items-center gap-2">
                            <button onclick="openModal('add-student-modal')" class="bg-green-600 text-white font-semibold py-2.5 px-5 rounded-lg hover:bg-green-700 transition">Add</button>
                            <button onclick="openModal('bulk-upload-modal')" class="bg-purple-600 text-white font-semibold py-2.5 px-5 rounded-lg hover:bg-purple-700 transition">Bulk Upload</button>
                        </div>
                    </div>
                    <div class="flex items-center gap-2 mb-4 border-b pb-4">
                        <span class="text-sm font-medium text-gray-600">Sort by:</span>
                        <button onclick="sortStudents('firstName')" class="text-sm bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-full hover:bg-gray-300 transition">First Name</button>
                        <button onclick="sortStudents('lastName')" class="text-sm bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-full hover:bg-gray-300 transition">Last Name</button>
                    </div>
                    <div class="flex justify-between items-center mb-4">
                         <div class="flex items-center gap-3">
                            <input type="checkbox" id="select-all-students" onchange="toggleSelectAll(this)" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            <label for="select-all-students" class="text-sm font-medium text-gray-700">Select All</label>
                        </div>
                        <button id="delete-selected-btn" onclick="confirmDeleteSelectedStudents()" class="hidden bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 transition">Delete Selected</button>
                    </div>
                    <ul id="teacher-student-list" class="space-y-3">
                        </ul>
                </div>
            </div>

             <div id="content-seating-chart" class="tab-content">
                <div class="flex flex-col xl:flex-row gap-8">
                    <div class="flex-grow bg-white p-6 rounded-xl shadow-md">
                        <h2 class="text-2xl font-bold mb-4">Classroom Layout</h2>
                        <div id="seating-chart-grid" class="grid grid-cols-6 gap-4">
                            </div>
                    </div>
                    <div class="xl:w-1/4 xl:max-w-sm flex-shrink-0 space-y-8">
                        <div class="bg-white p-6 rounded-xl shadow-md">
                            <h2 class="text-2xl font-bold mb-4">Student Requests</h2>
                            <ul id="student-requests-list" class="space-y-4 max-h-60 overflow-y-auto pr-2">
                                <li class="text-gray-500 italic">No student requests at the moment.</li>
                            </ul>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-md">
                             <h2 class="text-2xl font-bold mb-4">Unseated Students</h2>
                             <div class="mb-4">
                                 <div id="add-blank-seat" draggable="true" class="p-3 text-center bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 cursor-grab font-medium">
                                     Add Blank Seat
                                 </div>
                             </div>
                             <ul id="unseated-student-list" class="space-y-3 max-h-60 overflow-y-auto pr-2">
                                </ul>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="content-backup" class="tab-content">
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-2xl font-bold mb-4">Data Backup</h2>
                    <p class="mb-6 text-gray-600">Export all your classroom data into a single CSV file. This includes students, assignments, scores, requests, and the seating chart arrangement.</p>
                    <button onclick="exportAllDataAsCSV()" class="bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-indigo-700 transition">
                        Export All Data as CSV
                    </button>
                </div>
            </div>

        </div>

        <div id="student-view" class="view">
            <header class="flex justify-between items-center mb-8">
                 <div>
                    <h1 class="text-4xl font-bold text-gray-900">Student Dashboard</h1>
                    <p class="text-gray-500">Welcome, <span id="student-name" class="font-semibold"></span>!</p>
                </div>
                 <button onclick="logout()" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition">Logout</button>
            </header>

            <div class="bg-white p-6 rounded-xl shadow-md">
                <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                    <h2 class="text-2xl font-bold">Your Assignments</h2>
                    <div class="flex items-center gap-2 flex-wrap">
                        <span class="text-sm font-medium text-gray-600">Sort by:</span>
                        <button onclick="sortAssignments('number_asc')" class="text-sm bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-full hover:bg-gray-300 transition">Number (Asc)</button>
                        <button onclick="sortAssignments('number_desc')" class="text-sm bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-full hover:bg-gray-300 transition">Number (Desc)</button>
                        <button onclick="sortAssignments('date_desc')" class="text-sm bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-full hover:bg-gray-300 transition">Date (Newest)</button>
                        <button onclick="sortAssignments('date_asc')" class="text-sm bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-full hover:bg-gray-300 transition">Date (Oldest)</button>
                        <button onclick="sortAssignments('score_desc')" class="text-sm bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-full hover:bg-gray-300 transition">Score (High)</button>
                        <button onclick="sortAssignments('score_asc')" class="text-sm bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-full hover:bg-gray-300 transition">Score (Low)</button>
                    </div>
                </div>
                <div id="student-assignment-list" class="space-y-5">
                     </div>
            </div>
        </div>
    </div>

    <div id="add-assignment-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-lg">
            <h2 class="text-2xl font-bold mb-6">New Assignment</h2>
            <form id="add-assignment-form" class="space-y-6">
                <div>
                    <label for="assignment-number" class="block text-sm font-medium text-gray-700 mb-1">Assignment Number</label>
                    <input type="number" id="assignment-number" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <div>
                    <label for="assignment-title" class="block text-sm font-medium text-gray-700 mb-1">Title</label>
                    <input type="text" id="assignment-title" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <div>
                    <label for="assignment-posted-date" class="block text-sm font-medium text-gray-700 mb-1">Posted Date</label>
                    <input type="date" id="assignment-posted-date" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    <p class="text-xs text-gray-500 mt-1">Leave blank to use today's date.</p>
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" onclick="closeModal('add-assignment-modal')" class="bg-gray-200 text-gray-700 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300 transition">Cancel</button>
                    <button type="submit" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700 transition">Add</button>
                </div>
            </form>
        </div>
    </div>

    <div id="edit-assignment-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-lg">
            <h2 class="text-2xl font-bold mb-6">Edit Assignment</h2>
            <form id="edit-assignment-form" class="space-y-6">
                <input type="hidden" id="assignment-original-id-edit">
                <div>
                    <label for="assignment-number-edit" class="block text-sm font-medium text-gray-700 mb-1">Assignment Number</label>
                    <input type="number" id="assignment-number-edit" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <div>
                    <label for="assignment-title-edit" class="block text-sm font-medium text-gray-700 mb-1">Title</label>
                    <input type="text" id="assignment-title-edit" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <div>
                    <label for="assignment-posted-date-edit" class="block text-sm font-medium text-gray-700 mb-1">Posted Date</label>
                    <input type="date" id="assignment-posted-date-edit" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                     <p class="text-xs text-gray-500 mt-1">Leave blank to use today's date.</p>
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" onclick="closeModal('edit-assignment-modal')" class="bg-gray-200 text-gray-700 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300 transition">Cancel</button>
                    <button type="submit" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700 transition">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <div id="score-assignment-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-3xl">
            <h2 class="text-2xl font-bold mb-2">Score Assignment</h2>
            <h3 class="text-lg text-gray-600 mb-6" id="score-assignment-title"></h3>
            <form id="score-assignment-form">
                <input type="hidden" id="score-assignment-id">
                <div id="student-scores-list" class="space-y-4 max-h-96 overflow-y-auto pr-2">
                    </div>
                <div class="flex justify-end gap-4 mt-8">
                    <button type="button" onclick="closeModal('score-assignment-modal')" class="bg-gray-200 text-gray-700 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300 transition">Cancel</button>
                    <button type="submit" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700 transition">Save Scores</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="add-student-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-lg">
            <h2 class="text-2xl font-bold mb-6">Add New Student</h2>
            <form id="add-student-form" class="space-y-6">
                <div>
                    <label for="student-id-add" class="block text-sm font-medium text-gray-700 mb-1">Student ID#</label>
                    <input type="number" id="student-id-add" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500" required>
                </div>
                <div>
                    <label for="student-firstName-add" class="block text-sm font-medium text-gray-700 mb-1">First Name</label>
                    <input type="text" id="student-firstName-add" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500" required>
                </div>
                <div>
                    <label for="student-lastName-add" class="block text-sm font-medium text-gray-700 mb-1">Last Name</label>
                    <input type="text" id="student-lastName-add" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500" required>
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" onclick="closeModal('add-student-modal')" class="bg-gray-200 text-gray-700 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300 transition">Cancel</button>
                    <button type="submit" class="bg-green-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-green-700 transition">Add Student</button>
                </div>
            </form>
        </div>
    </div>

    <div id="edit-student-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-lg">
            <h2 class="text-2xl font-bold mb-6">Edit Student</h2>
            <form id="edit-student-form" class="space-y-6">
                <input type="hidden" id="student-original-id-edit">
                <div>
                    <label for="student-id-edit" class="block text-sm font-medium text-gray-700 mb-1">Student ID#</label>
                    <input type="number" id="student-id-edit" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <div>
                    <label for="student-firstName-edit" class="block text-sm font-medium text-gray-700 mb-1">First Name</label>
                    <input type="text" id="student-firstName-edit" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <div>
                    <label for="student-lastName-edit" class="block text-sm font-medium text-gray-700 mb-1">Last Name</label>
                    <input type="text" id="student-lastName-edit" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" onclick="closeModal('edit-student-modal')" class="bg-gray-200 text-gray-700 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300 transition">Cancel</button>
                    <button type="submit" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700 transition">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="bulk-upload-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-xl">
            <h2 class="text-2xl font-bold mb-6">Bulk Upload Students</h2>
            <form id="bulk-upload-form">
                <div class="mb-4">
                    <label for="bulk-student-data" class="block text-sm font-medium text-gray-700 mb-1">Student Data (ID, First Name, Last Name)</label>
                    <textarea id="bulk-student-data" rows="10" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500 font-mono text-sm" placeholder="Paste student data here. One student per line.&#10;Example:&#10;101,Frank,Castle&#10;102,Grace,Hopper"></textarea>
                    <p class="text-xs text-gray-500 mt-1">Note: Students with existing IDs will be skipped to avoid duplicates.</p>
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" onclick="closeModal('bulk-upload-modal')" class="bg-gray-200 text-gray-700 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300 transition">Cancel</button>
                    <button type="submit" class="bg-purple-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-purple-700 transition">Upload Students</button>
                </div>
            </form>
        </div>
    </div>

    <div id="student-assignment-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-3xl">
            <h2 id="student-assignment-modal-title" class="text-2xl font-bold mb-6"></h2>
            <div id="student-assignment-modal-list" class="space-y-4 max-h-96 overflow-y-auto pr-2">
                </div>
            <div id="student-assignment-modal-footer" class="flex justify-end mt-8 gap-4">
                <button type="button" onclick="closeModal('student-assignment-modal')" class="bg-gray-200 text-gray-700 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300 transition">Cancel</button>
                <button type="button" id="save-student-scores-btn" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700 transition">Save Scores</button>
            </div>
        </div>
    </div>

    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm text-center">
            <h2 class="text-xl font-bold mb-4" id="confirmation-title">Are you sure?</h2>
            <p id="confirmation-message" class="text-gray-600 mb-6">This action cannot be undone.</p>
            <div class="flex justify-center gap-4">
                <button id="cancel-button" class="bg-gray-200 text-gray-700 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300 transition">Cancel</button>
                <button id="confirm-button" class="bg-red-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-red-700 transition">Confirm</button>
            </div>
        </div>
    </div>

    <div id="bulk-assignment-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
  <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-2xl">
    <h2 class="text-2xl font-bold mb-6">Bulk Add Assignments</h2>

    <div class="mb-4 text-sm text-gray-600">
      Paste one assignment per line. Optional date in <code>YYYY-MM-DD</code> after a comma or pipe.
      <pre class="bg-gray-50 p-3 rounded mt-2 overflow-auto">Intro to Robotics
CAD Basics, 2025-09-01
Drafting Quiz | 2025-09-03</pre>
    </div>

    <form id="bulk-assignment-form" class="space-y-4">
      <textarea id="bulk-assignment-data" rows="10"
        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500 font-mono text-sm"
        placeholder="One per line: Title[, YYYY-MM-DD] or Title | YYYY-MM-DD"></textarea>

      <div class="flex items-center justify-between">
        <label class="flex items-center gap-2 text-sm">
          <input id="bulk-assignment-default-today" type="checkbox" class="h-4 w-4 text-purple-600" checked>
          Use today’s date when missing
        </label>
        <div class="flex gap-3">
          <button type="button" onclick="closeModal('bulk-assignment-modal')"
            class="bg-gray-200 text-gray-700 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300 transition">Cancel</button>
          <button type="submit"
            class="bg-purple-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-purple-700 transition">Add All</button>
        </div>
      </div>
    </form>
  </div>
</div>


    <div id="success-message" class="fixed bottom-8 right-8 bg-green-500 text-white py-3 px-6 rounded-lg shadow-xl transform translate-y-20 opacity-0 transition-all duration-300 ease-out">
        </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, writeBatch, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- FIREBASE & DATA ---


// --- Teacher Password (front-end gate) ---
const TEACHER_PASSWORD = "Rocket_22!!"; // TODO: change this to your real password

function checkTeacherPassword() {
    const input = document.getElementById('teacher-password')?.value || "";
    const errorEl = document.getElementById('teacher-login-error');
    if (input === TEACHER_PASSWORD) {
        if (errorEl) errorEl.textContent = '';
        switchView('teacher'); // grant access
    } else {
        if (errorEl) errorEl.textContent = 'Incorrect password. Please try again.';
    }
}
// IMPORTANT for <script type="module"> + inline onclick handler:
window.checkTeacherPassword = checkTeacherPassword;

        let db, auth;
        let students = [];
        let assignments = [];
        let helpRequests = [];
        let checkRequests = [];
        let seatingChart = [];
        let studentsLoaded = false;
        let seatingLoaded = false;
        
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-classroom-app';
        
        let confirmAction = null;
        let currentStudentId = null;
        let currentSortKey = 'lastName'; // For student sorting
        let currentAssignmentSortKey = 'date_desc'; // For assignment sorting
        let currentTeacherAssignmentSortKey = 'number_asc'; // For teacher assignment sorting

        const CLASSROOM_ROWS = 4;
        const CLASSROOM_COLS = 6;
        const TOTAL_SEATS = CLASSROOM_ROWS * CLASSROOM_COLS;
        
        // --- COLLECTIONS ---
        let studentsCol, assignmentsCol, helpRequestsCol, checkRequestsCol;
        let seatingChartDoc;

        async function initFirebase() {
            try {
              const firebaseConfig = {
  apiKey: "AIzaSyCG3rtswPSuTocyRDqRPhzHEF9pB3Hkgos",
  authDomain: "classdashboard-d8c4d.firebaseapp.com",
  projectId: "classdashboard-d8c4d",
  storageBucket: "classdashboard-d8c4d.appspot.com",
  messagingSenderId: "409652457373",
  appId: "1:409652457373:web:241cc1a53b39fc71fa8974",
  measurementId: "G-KXJVNZKTRQ"
};
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                
                // Define collection paths
                console.log("initFirebase running...");
console.log("appId:", appId);
console.log("db:", db);

                const basePath = `artifacts/${appId}/public/data`;
               studentsCol = collection(db, basePath, "students");
assignmentsCol = collection(db, basePath, "assignments");
helpRequestsCol = collection(db, basePath, "helpRequests");
checkRequestsCol = collection(db, basePath, "checkRequests");
seatingChartDoc = doc(db, basePath, "seatingChart", "main");
                loadData();

            } catch (error) {
                console.error("Firebase initialization failed:", error);
            }
        }


        // --- DATA SYNC ---
        function loadData() {
            onSnapshot(query(studentsCol), (snapshot) => {
                students = snapshot.docs.map(doc => ({ fbId: doc.id, ...doc.data() }));
                sortStudents();
                studentsLoaded = true;
                if (currentView === 'teacher') renderTeacherView();
                maybeRenderSeatingChart();
            });

            onSnapshot(query(assignmentsCol), (snapshot) => {
                assignments = snapshot.docs.map(doc => ({ fbId: doc.id, ...doc.data() }));
                if (currentView === 'teacher') renderTeacherAssignmentList();
                if (currentView === 'student') renderStudentView();
            });
            
            onSnapshot(query(helpRequestsCol), (snapshot) => {
                helpRequests = snapshot.docs.map(doc => ({ fbId: doc.id, ...doc.data() }));
                if (currentView === 'teacher') renderStudentRequests();
                if (currentView === 'student') renderStudentView();
            });

            onSnapshot(query(checkRequestsCol), (snapshot) => {
                checkRequests = snapshot.docs.map(doc => ({ fbId: doc.id, ...doc.data() }));
                if (currentView === 'teacher') renderStudentRequests();
                if (currentView === 'student') renderStudentView();
            });

             onSnapshot(seatingChartDoc, async (docSnap) => {
                if (docSnap.exists()) {
                    seatingChart = docSnap.data().chart || Array(TOTAL_SEATS).fill(null);
                } else {
                    seatingChart = Array(TOTAL_SEATS).fill(null);
                    // Create the document if it doesn't exist
                    await setDoc(seatingChartDoc, { chart: seatingChart });
                }
                seatingLoaded = true;
                maybeRenderSeatingChart();
            });
        }
        
        async function saveSeatingChart() {
            await setDoc(seatingChartDoc, { chart: seatingChart });
        }


        // --- VIEWS & RENDERING ---
        const views = {
            'login-type-selection': document.getElementById('login-type-selection'),
            'teacher-login': document.getElementById('teacher-login-view'),
            'student-login': document.getElementById('student-login-view'),
            'teacher': document.getElementById('teacher-view'),
            'student': document.getElementById('student-view'),
        };

        let currentView = 'login-type-selection';
        let currentTeacherTab = 'seating-chart';

        function switchView(viewName) {
            views[currentView].classList.remove('active');
            views[viewName].classList.add('active');
            currentView = viewName;
            
            if (viewName === 'teacher') {
                switchTeacherTab('seating-chart'); // Default to seating chart tab
                renderTeacherView();
            }
            if (viewName === 'student') renderStudentView();
        }

        function switchTeacherTab(tabName) {
             document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
             document.querySelectorAll('.tab-btn').forEach(btn => {
                 btn.classList.remove('border-blue-600', 'text-blue-600');
                 btn.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
             });
             
             document.getElementById(`content-${tabName}`).classList.add('active');
             document.getElementById(`tab-${tabName}`).classList.add('border-blue-600', 'text-blue-600');
             document.getElementById(`tab-${tabName}`).classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
             currentTeacherTab = tabName;

             if(tabName === 'seating-chart') {
                renderSeatingChart();
                renderUnseatedStudentList();
                renderStudentRequests();
             }
        }
        
        function renderTeacherView() {
            renderTeacherStudentList();
            renderTeacherAssignmentList();
            if (currentTeacherTab === 'seating-chart') {
                renderStudentRequests();
                renderSeatingChart();
                renderUnseatedStudentList();
            }
        }
        
        function renderStudentView() {
            const currentStudent = students.find(s => s.id === currentStudentId);
            if (currentStudent) {
                document.getElementById('student-name').textContent = `${currentStudent.firstName} ${currentStudent.lastName}`;
                renderStudentAssignmentList(currentStudent);
            } else {
                 logout();
            }
        }

        function sortStudents(key) {
            if (key) { currentSortKey = key; }
            if (currentSortKey) {
                students.sort((a, b) => String(a[currentSortKey]).localeCompare(String(b[currentSortKey])));
            }
            renderTeacherStudentList();
            updateDeleteSelectedButtonState();
        }
        
        function getSortableScore(score) {
            if (score === 'Excused' || score === 'Not Graded' || score === undefined || score === null) {
                return -1; // Treat non-numeric scores as the lowest value
            }
            return Number(score);
        }
        
        function sortAssignments(key) {
            currentAssignmentSortKey = key;
            renderStudentView();
        }
        
        function sortTeacherAssignments(key) {
            currentTeacherAssignmentSortKey = key;
            renderTeacherAssignmentList();
        }

        function renderTeacherStudentList() {
            const list = document.getElementById('teacher-student-list');
            list.innerHTML = students.map(s => `
                <li class="flex justify-between items-center p-4 bg-gray-50 rounded-lg">
                    <div class="flex items-center gap-3">
                        <input type="checkbox" class="student-checkbox h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500" data-student-id="${s.id}" onchange="updateDeleteSelectedButtonState()">
                        <span class="font-medium">${s.firstName} ${s.lastName} <span class="text-xs text-gray-500">(ID: ${s.id})</span></span>
                    </div>
                    <div class="flex items-center gap-4">
                        <button onclick="openEditStudentModal('${s.fbId}')" class="text-sm text-blue-600 hover:text-blue-800 font-medium py-1 px-3">Edit</button>
                        <button onclick="confirmDeleteStudent('${s.fbId}')" class="text-sm text-red-600 hover:text-red-800 font-medium py-1 px-3">Delete</button>
                    </div>
                </li>
            `).join('');
        }

        function renderUnseatedStudentList() {
            const list = document.getElementById('unseated-student-list');
            const seatedStudentIds = new Set(seatingChart.filter(id => typeof id === 'number'));
            const unseatedStudents = students.filter(s => !seatedStudentIds.has(s.id));

            list.innerHTML = unseatedStudents.map(s => `
                <li id="roster-student-${s.id}" data-id="${s.id}" class="student-roster-item p-4 bg-gray-50 rounded-lg font-medium text-center" draggable="true" ondragstart="handleDragStart(event, 'roster_student', ${s.id})" ondragend="handleDragEnd(event)">
                    ${s.firstName} ${s.lastName}
                </li>
            `).join('');
        }
        
        function renderSeatingChart() {
            const grid = document.getElementById('seating-chart-grid');
            const studentsNeedingHelp = new Set(helpRequests.map(req => req.studentId));
            const studentsNeedingCheck = new Set(checkRequests.map(req => req.studentId));

            grid.innerHTML = '';
            for (let i = 0; i < TOTAL_SEATS; i++) {
                const seatContent = seatingChart[i];
                const seatEl = document.createElement('div');
                seatEl.dataset.seatIndex = i;
                seatEl.className = 'seat border border-gray-300 rounded-lg h-24 flex items-center justify-center text-center p-2 transition-colors duration-300';
                
                seatEl.addEventListener('dragover', handleDragOver);
                seatEl.addEventListener('dragleave', handleDragLeave);
                seatEl.addEventListener('drop', handleDrop);
                
                if (seatContent === 'BLANK') {
                    seatEl.classList.add('blank-seat');
                    seatEl.textContent = 'Blank';
                    seatEl.draggable = true;
                    seatEl.addEventListener('dragstart', (e) => handleDragStart(e, 'grid_seat', null, i));
                    seatEl.addEventListener('dragend', handleDragEnd);
                } else if (typeof seatContent === 'number') {
                    const student = students.find(s => s.id === seatContent);
                    if(student) {
                        seatEl.textContent = `${student.firstName} ${student.lastName}`;
                        seatEl.classList.add('font-semibold', 'draggable-student', 'cursor-pointer');
                        seatEl.draggable = true;
                        seatEl.addEventListener('dragstart', (e) => handleDragStart(e, 'grid_seat', null, i));
                        seatEl.addEventListener('dragend', handleDragEnd);
                        seatEl.addEventListener('click', () => openStudentAssignmentModal(student.id));

                        const needsHelp = studentsNeedingHelp.has(student.id);
                        const needsCheck = studentsNeedingCheck.has(student.id);

                        if (needsHelp && needsCheck) {
                            seatEl.classList.add('bg-purple-200', 'border-purple-400', 'text-purple-900');
                        } else if (needsHelp) {
                            seatEl.classList.add('bg-red-200', 'border-red-400', 'text-red-900');
                        } else if (needsCheck) {
                            seatEl.classList.add('bg-sky-200', 'border-sky-400', 'text-sky-900');
                        } else {
                            seatEl.classList.add('bg-blue-100');
                        }
                    }
                } else {
                    seatEl.classList.add('bg-gray-50');
                }
                grid.appendChild(seatEl);
            }
        }
        
        function maybeRenderSeatingChart() {
            if (!studentsLoaded || !seatingLoaded) return;
            if (currentView === 'teacher') {
                renderSeatingChart();
                renderUnseatedStudentList();
                if (typeof renderStudentRequests === 'function') renderStudentRequests();
            }
        }
        
        function renderTeacherAssignmentList() {
            const list = document.getElementById('teacher-assignment-list');
            let sortedAssignments = [...assignments];

            sortedAssignments.sort((a, b) => {
                switch (currentTeacherAssignmentSortKey) {
                    case 'number_asc': return a.assignmentNumber - b.assignmentNumber;
                    case 'number_desc': return b.assignmentNumber - a.assignmentNumber;
                    case 'date_desc': return new Date(b.postedDate) - new Date(a.postedDate);
                    case 'date_asc': return new Date(a.postedDate) - new Date(b.postedDate);
                    default: return 0;
                }
            });

            list.innerHTML = sortedAssignments.map(a => `
                <div class="p-5 border border-gray-200 rounded-lg">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="font-semibold text-lg">#${a.assignmentNumber}: ${a.title}</h3>
                            <p class="text-sm text-gray-500">Posted: ${new Date(a.postedDate).toLocaleDateString()}</p>
                        </div>
                        <div class="flex items-center gap-4">
                            <button onclick="openScoreAssignmentModal('${a.fbId}')" class="text-sm text-green-600 hover:text-green-800 font-medium py-2 px-4 bg-green-100 rounded-full">Score</button>
                            <button onclick="openEditAssignmentModal('${a.fbId}')" class="text-sm text-blue-600 hover:text-blue-800 font-medium py-1 px-3">Edit</button>
                            <button onclick="confirmDeleteAssignment('${a.fbId}')" class="text-sm text-red-600 hover:text-red-800 font-medium py-1 px-3">Delete</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderStudentAssignmentList(student) {
            const list = document.getElementById('student-assignment-list');
            
            let sortedAssignments = [...assignments];

            sortedAssignments.sort((a, b) => {
                const scoreA = a.scores ? a.scores[student.id] : undefined;
                const scoreB = b.scores ? b.scores[student.id] : undefined;

                switch (currentAssignmentSortKey) {
                    case 'number_asc': return a.assignmentNumber - b.assignmentNumber;
                    case 'number_desc': return b.assignmentNumber - a.assignmentNumber;
                    case 'date_desc': return new Date(b.postedDate) - new Date(a.postedDate);
                    case 'date_asc': return new Date(a.postedDate) - new Date(b.postedDate);
                    case 'score_desc': return getSortableScore(scoreB) - getSortableScore(scoreA);
                    case 'score_asc': return getSortableScore(scoreA) - getSortableScore(scoreB);
                    default: return 0;
                }
            });

            list.innerHTML = sortedAssignments.map(a => {
                const score = a.scores && a.scores[student.id] !== undefined ? a.scores[student.id] : 'Not Graded';
                return `
                    <div class="p-5 border border-gray-200 rounded-lg">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center">
                            <div>
                                <h3 class="font-semibold text-lg">#${a.assignmentNumber}: ${a.title}</h3>
                                <p class="text-sm text-gray-500">Posted: ${new Date(a.postedDate).toLocaleDateString()}</p>
                            </div>
                            <div class="mt-3 sm:mt-0">
                                <span class="font-bold text-lg ${score === 'Not Graded' ? 'text-gray-500' : 'text-blue-600'}">${score}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function renderStudentRequests() {
            const list = document.getElementById('student-requests-list');
            const allRequests = [
                ...helpRequests.map(r => ({ ...r, type: 'help' })),
                ...checkRequests.map(r => ({ ...r, type: 'check' }))
            ].sort((a, b) => a.timestamp - b.timestamp);

            if (allRequests.length === 0) {
                list.innerHTML = `<li class="text-gray-500 italic">No student requests at the moment.</li>`;
                return;
            }

            list.innerHTML = allRequests.map(req => {
                const student = students.find(s => s.id === req.studentId);
                const name = student ? `${student.firstName} ${student.lastName}` : `ID ${req.studentId}`;
                const bgColor = req.type === 'help' ? 'bg-red-100' : 'bg-sky-100';
                const textColor = req.type === 'help' ? 'text-red-800' : 'text-sky-800';
                const buttonColor = req.type === 'help' ? 'bg-red-200 hover:bg-red-300' : 'bg-sky-200 hover:bg-sky-300';

                return `
                    <li class="${bgColor} ${textColor} p-3 rounded-lg flex justify-between items-center">
                        <span class="font-medium">${name} needs ${req.type}</span>
                        <button onclick="resolveRequest('${req.type}', '${req.fbId}')" class="${buttonColor} text-xs font-bold py-1 px-2 rounded-full">
                            RESOLVE
                        </button>
                    </li>
                `;
            }).join('');
        }
        
        async function resolveRequest(type, fbId) {
            const col = type === 'help' ? helpRequestsCol : checkRequestsCol;
            await deleteDoc(doc(col, fbId));
            showSuccessMessage('Request resolved.');
        }

        
        // --- MODALS ---
        function openModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        function openEditStudentModal(studentFbId) {
            const student = students.find(s => s.fbId === studentFbId);
            if (!student) return;

            document.getElementById('student-original-id-edit').value = student.id;
            document.getElementById('student-id-edit').value = student.id;
            document.getElementById('student-firstName-edit').value = student.firstName;
            document.getElementById('student-lastName-edit').value = student.lastName;
            openModal('edit-student-modal');
        }
        
        function openEditAssignmentModal(assignmentFbId) {
            const assignment = assignments.find(a => a.fbId === assignmentFbId);
            if (!assignment) return;
            
            document.getElementById('assignment-original-id-edit').value = assignment.id;
            document.getElementById('assignment-number-edit').value = assignment.assignmentNumber;
            document.getElementById('assignment-title-edit').value = assignment.title;
            document.getElementById('assignment-posted-date-edit').value = assignment.postedDate;
            openModal('edit-assignment-modal');
        }
        
        function openScoreAssignmentModal(assignmentFbId) {
            const assignment = assignments.find(a => a.fbId === assignmentFbId);
            if (!assignment) return;

            document.getElementById('score-assignment-title').textContent = `#${assignment.assignmentNumber}: ${assignment.title}`;
            document.getElementById('score-assignment-id').value = assignmentFbId;
            
            const list = document.getElementById('student-scores-list');
            const scoreOptions = ['0', '1', '2', '3', '4', 'Excused'];
            list.innerHTML = students.map(s => {
                const currentScore = assignment.scores && assignment.scores[s.id] !== undefined ? String(assignment.scores[s.id]) : '';
                const radioButtons = scoreOptions.map(option => `
                    <label class="flex items-center">
                        <input type="radio" name="score-${s.id}" value="${option}" ${currentScore === option ? 'checked' : ''} class="mr-1">
                        ${option}
                    </label>
                `).join('');
                return `
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg" data-student-id="${s.id}">
                        <span class="font-medium">${s.firstName} ${s.lastName}</span>
                        <div class="flex items-center gap-x-4">${radioButtons}</div>
                    </div>
                `;
            }).join('');
            
            openModal('score-assignment-modal');
        }

        function openStudentAssignmentModal(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            const modal = document.getElementById('student-assignment-modal');
            const titleEl = document.getElementById('student-assignment-modal-title');
            const listEl = document.getElementById('student-assignment-modal-list');
            const saveBtn = document.getElementById('save-student-scores-btn');

            titleEl.textContent = `Assignments for ${student.firstName} ${student.lastName}`;
            const scoreOptions = ['0', '1', '2', '3', '4', 'Excused'];
            
            const sortedAssignments = [...assignments].sort((a, b) => a.assignmentNumber - b.assignmentNumber);

            listEl.innerHTML = sortedAssignments.map(a => {
                const currentScore = a.scores && a.scores[student.id] !== undefined ? String(a.scores[student.id]) : '';
                const radioButtons = scoreOptions.map(option => `
                    <label class="flex items-center">
                        <input type="radio" name="score-${a.fbId}-${student.id}" value="${option}" ${currentScore === option ? 'checked' : ''} class="mr-1">
                        ${option}
                    </label>
                `).join('');
                return `
                     <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg" data-assignment-id="${a.fbId}">
                        <span class="font-medium">#${a.assignmentNumber}: ${a.title}</span>
                        <div class="flex items-center gap-x-4">${radioButtons}</div>
                    </div>
                `;
            }).join('');
            
            saveBtn.onclick = () => saveStudentScoresFromModal(studentId);
            openModal('student-assignment-modal');
        }
        
        async function saveStudentScoresFromModal(studentId) {
            const scoreDivs = document.querySelectorAll('#student-assignment-modal-list > div');
            const batch = writeBatch(db);

            scoreDivs.forEach(div => {
                const assignmentFbId = div.dataset.assignmentId;
                const selectedRadio = div.querySelector(`input[name="score-${assignmentFbId}-${studentId}"]:checked`);
                
                if (selectedRadio) {
                    const score = selectedRadio.value;
                    let scoreToSave = score === 'Excused' ? 'Excused' : Number(score);
                    const assignmentRef = doc(assignmentsCol, assignmentFbId);
                    batch.update(assignmentRef, { [`scores.${studentId}`]: scoreToSave });
                }
            });

            await batch.commit();
            showSuccessMessage("Scores updated successfully!");
            closeModal('student-assignment-modal');
        }


        // --- EVENT HANDLERS & FORMS ---
        document.getElementById('add-student-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = Number(document.getElementById('student-id-add').value);
            const firstName = document.getElementById('student-firstName-add').value;
            const lastName = document.getElementById('student-lastName-add').value;
            
            if (students.some(s => s.id === id)) {
                alert("A student with this ID already exists.");
                return;
            }

            await addDoc(studentsCol, { id, firstName, lastName });
            showSuccessMessage('Student added successfully.');
            closeModal('add-student-modal');
            e.target.reset();
        });

        document.getElementById('edit-student-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const originalId = Number(document.getElementById('student-original-id-edit').value);
            const newId = Number(document.getElementById('student-id-edit').value);
            const firstName = document.getElementById('student-firstName-edit').value;
            const lastName = document.getElementById('student-lastName-edit').value;

            if (originalId !== newId && students.some(s => s.id === newId)) {
                alert("A student with the new ID already exists.");
                return;
            }

            const studentDoc = students.find(s => s.id === originalId);
            if (studentDoc) {
                await updateDoc(doc(studentsCol, studentDoc.fbId), { id: newId, firstName, lastName });
                showSuccessMessage('Student updated successfully.');
            }
            closeModal('edit-student-modal');
        });

        document.getElementById('add-assignment-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const assignmentNumber = document.getElementById('assignment-number').value;
            const title = document.getElementById('assignment-title').value;
            let postedDate = document.getElementById('assignment-posted-date').value;
            if (!postedDate) postedDate = new Date().toISOString().split('T')[0];

            await addDoc(assignmentsCol, { 
                id: Date.now(),
                assignmentNumber: Number(assignmentNumber),
                title, 
                postedDate,
                scores: {}
            });
            showSuccessMessage('Assignment added successfully.');
            closeModal('add-assignment-modal');
            e.target.reset();
        });

        document.getElementById('edit-assignment-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const originalId = Number(document.getElementById('assignment-original-id-edit').value);
            const assignmentNumber = document.getElementById('assignment-number-edit').value;
            const title = document.getElementById('assignment-title-edit').value;
            let postedDate = document.getElementById('assignment-posted-date-edit').value;
             if (!postedDate) postedDate = new Date().toISOString().split('T')[0];

            const assignmentDoc = assignments.find(a => a.id === originalId);
            if (assignmentDoc) {
                await updateDoc(doc(assignmentsCol, assignmentDoc.fbId), {
                    assignmentNumber: Number(assignmentNumber),
                    title,
                    postedDate
                });
                showSuccessMessage('Assignment updated successfully.');
            }
            closeModal('edit-assignment-modal');
        });
        
        document.getElementById('score-assignment-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const assignmentFbId = document.getElementById('score-assignment-id').value;
            const studentScoreDivs = document.querySelectorAll('#student-scores-list > div');

            const assignmentRef = doc(assignmentsCol, assignmentFbId);
            const updates = {};
            
            studentScoreDivs.forEach(div => {
                const studentId = div.dataset.studentId;
                const selectedRadio = div.querySelector(`input[name="score-${studentId}"]:checked`);
                if (selectedRadio) {
                    const score = selectedRadio.value;
                    const scoreToSave = score === 'Excused' ? 'Excused' : Number(score);
                    updates[`scores.${studentId}`] = scoreToSave;
                }
            });

            await updateDoc(assignmentRef, updates);
            showSuccessMessage("Scores saved successfully!");
            closeModal('score-assignment-modal');
        });

        document.getElementById('student-login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const id = Number(document.getElementById('student-id-login').value);
            const student = students.find(s => s.id === id);
            const errorEl = document.getElementById('login-error');

            if (student) {
                currentStudentId = id;
                if (errorEl) errorEl.textContent = '';
                switchView('student');
            } else {
                if (errorEl) errorEl.textContent = 'Student ID not found.';
            }
        });
        
        document.getElementById('bulk-upload-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = document.getElementById('bulk-student-data').value;
            const lines = data.split('\n').filter(line => line.trim() !== '');
            const existingIds = new Set(students.map(s => s.id));
            const batch = writeBatch(db);
            let addedCount = 0;

            lines.forEach(line => {
                const [idStr, firstName, lastName] = line.split(',').map(s => s.trim());
                const id = Number(idStr);
                if (id && firstName && lastName && !existingIds.has(id)) {
                    const newStudentRef = doc(studentsCol);
                    batch.set(newStudentRef, { id, firstName, lastName });
                    existingIds.add(id); // Prevent adding duplicates from the textarea itself
                    addedCount++;
                }
            });
            
            await batch.commit();
            if (addedCount > 0) {
                 showSuccessMessage(`${addedCount} student(s) added successfully.`);
            } else {
                 showSuccessMessage(`No new students were added.`);
            }
            closeModal('bulk-upload-modal');
            e.target.reset();
        });

        
        // --- DRAG AND DROP ---
        let draggedItem = null;

        function handleDragStart(e, type, id, index) {
            draggedItem = { type, id, index };
            e.dataTransfer.effectAllowed = 'move';
            e.target.classList.add('dragging');
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
            draggedItem = null;
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            e.target.closest('.seat').classList.add('dragging-over');
        }

        function handleDragLeave(e) {
            e.target.closest('.seat').classList.remove('dragging-over');
        }

        async function handleDrop(e) {
            e.preventDefault();
            if (!draggedItem) return;

            const targetSeat = e.target.closest('.seat');
            targetSeat.classList.remove('dragging-over');
            const targetIndex = Number(targetSeat.dataset.seatIndex);

            // Logic to handle the drop
            const sourceIndex = draggedItem.index;
            const studentId = draggedItem.id;

            if (draggedItem.type === 'roster_student') {
                const currentContent = seatingChart[targetIndex];
                seatingChart[targetIndex] = studentId;
                if (currentContent) { // If seat was occupied, move that student back to unseated
                     const unseatedStudentList = document.getElementById('unseated-student-list');
                     const studentToUnseat = students.find(s => s.id === currentContent);
                     if (studentToUnseat) {
                        const li = document.createElement('li');
                        li.textContent = `${studentToUnseat.firstName} ${studentToUnseat.lastName}`;
                        // Add necessary attributes and event listeners for the new unseated student item
                        unseatedStudentList.appendChild(li);
                     }
                }
            } else if (draggedItem.type === 'grid_seat') {
                // Swap seats
                const sourceContent = seatingChart[sourceIndex];
                const targetContent = seatingChart[targetIndex];
                seatingChart[targetIndex] = sourceContent;
                seatingChart[sourceIndex] = targetContent;
            } else if (draggedItem.type === 'blank_seat') {
                 seatingChart[targetIndex] = 'BLANK';
            }


            await saveSeatingChart(); // Save the new chart layout to Firebase
            // Re-render is handled by onSnapshot, but we can force it for immediate feedback if needed
            renderSeatingChart();
            renderUnseatedStudentList();
        }

        document.getElementById('add-blank-seat').addEventListener('dragstart', (e) => handleDragStart(e, 'blank_seat'));

        // --- CONFIRMATION MODAL ---
        function showConfirmation(title, message, onConfirm) {
            document.getElementById('confirmation-title').textContent = title;
            document.getElementById('confirmation-message').textContent = message;
            confirmAction = onConfirm;
            openModal('confirmation-modal');
        }
        
        document.getElementById('confirm-button').addEventListener('click', () => {
            if (confirmAction) confirmAction();
            closeModal('confirmation-modal');
            confirmAction = null;
        });
        
        document.getElementById('cancel-button').addEventListener('click', () => {
            closeModal('confirmation-modal');
            confirmAction = null;
        });

        // --- DELETION ---
        function confirmDeleteStudent(studentFbId) {
            showConfirmation('Delete Student?', 'This will permanently remove the student and all their scores.', async () => {
                await deleteDoc(doc(studentsCol, studentFbId));
                showSuccessMessage('Student deleted.');
            });
        }
        
        function confirmDeleteAssignment(assignmentFbId) {
            showConfirmation('Delete Assignment?', 'This will permanently remove this assignment for all students.', async () => {
                await deleteDoc(doc(assignmentsCol, assignmentFbId));
                showSuccessMessage('Assignment deleted.');
            });
        }

        function confirmDeleteSelectedStudents() {
            const selectedIds = getSelectedStudentIds();
            if (selectedIds.length === 0) return;
            
            showConfirmation(`Delete ${selectedIds.length} Students?`, 'This will permanently remove the selected students and their scores.', async () => {
                const batch = writeBatch(db);
                selectedIds.forEach(id => {
                     const studentDoc = students.find(s => s.id === id);
                     if(studentDoc) {
                        batch.delete(doc(studentsCol, studentDoc.fbId));
                     }
                });
                await batch.commit();
                showSuccessMessage(`${selectedIds.length} student(s) deleted.`);
                document.getElementById('select-all-students').checked = false;
                updateDeleteSelectedButtonState();
            });
        }
        
        // --- HELPERS ---
        function logout() {
            currentStudentId = null;
            document.getElementById('student-login-form').reset();
            switchView('login-type-selection');
        }
        
        function showSuccessMessage(message) {
            const el = document.getElementById('success-message');
            el.textContent = message;
            el.classList.remove('opacity-0', 'translate-y-20');
            setTimeout(() => {
                el.classList.add('opacity-0', 'translate-y-20');
            }, 3000);
        }

        function toggleSelectAll(checkbox) {
            document.querySelectorAll('.student-checkbox').forEach(cb => {
                cb.checked = checkbox.checked;
            });
            updateDeleteSelectedButtonState();
        }
        
        function getSelectedStudentIds() {
            return Array.from(document.querySelectorAll('.student-checkbox:checked')).map(cb => Number(cb.dataset.studentId));
        }
        
        function updateDeleteSelectedButtonState() {
            const anySelected = getSelectedStudentIds().length > 0;
            document.getElementById('delete-selected-btn').classList.toggle('hidden', !anySelected);
            const allChecked = document.querySelectorAll('.student-checkbox:checked').length === students.length && students.length > 0;
            document.getElementById('select-all-students').checked = allChecked;
        }


        // --- BULK ASSIGNMENTS ---
function parseBulkAssignmentLine(line) {
  if (!line || !line.trim()) return null;
  const separator = line.includes('|') ? '|' : ',';
  const parts = line.split(separator).map(s => s.trim());
  const title = parts[0];
  const date = parts.length > 1 ? parts[1] : null;
  if (!title) return null;
  return { title, date };
}

function isValidYYYYMMDD(str) {
  if (!/^\d{4}-\d{2}-\d{2}$/.test(str)) return false;
  const d = new Date(str);
  return d instanceof Date && !isNaN(d) && d.toISOString().slice(0, 10) === str;
}

document.getElementById('bulk-assignment-form').addEventListener('submit', async (e) => {
  e.preventDefault();
  const textarea = document.getElementById('bulk-assignment-data');
  const useTodayIfMissing = document.getElementById('bulk-assignment-default-today').checked;
  const lines = (textarea.value || '').split('\n');
  const items = [];
  const today = new Date().toISOString().split('T')[0];
  for (const line of lines) {
    const parsed = parseBulkAssignmentLine(line);
    if (!parsed) continue;
    let postedDate = parsed.date && isValidYYYYMMDD(parsed.date) ? parsed.date : null;
    if (!postedDate && useTodayIfMissing) postedDate = today;
    items.push({ title: parsed.title, postedDate });
  }

  if (items.length === 0) {
    showSuccessMessage("No valid assignments found.");
    closeModal('bulk-assignment-modal');
    e.target.reset();
    return;
  }

  try {
    const batch = writeBatch(db);
    let i = 0;
    for (const item of items) {
      const ref = doc(assignmentsCol);
      batch.set(ref, {
        title: item.title,
        postedDate: item.postedDate || today,
        scores: {},
        id: Date.now() + i,
        assignmentNumber: assignments.length + i + 1,
      });
      i++;
    }
    await batch.commit();
    showSuccessMessage(`${items.length} assignment(s) added successfully.`);
  } catch (err) {
    console.error("Bulk add assignments failed:", err);
    showSuccessMessage("Bulk add failed. See console for details.");
  } finally {
    closeModal('bulk-assignment-modal');
    e.target.reset();
  }
});

        // --- CSV EXPORT ---
        function escapeCSV(str) {
            if (str === null || str === undefined) return '';
            str = String(str);
            if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                return `"${str.replace(/"/g, '""')}"`;
            }
            return str;
        }

        function exportAllDataAsCSV() {
            let csvContent = "";

            // Students
            csvContent += "Students\n";
            csvContent += "ID,First Name,Last Name\n";
            students.forEach(s => {
                csvContent += `${s.id},${escapeCSV(s.firstName)},${escapeCSV(s.lastName)}\n`;
            });
            csvContent += "\n";

            // Assignments and Scores
            csvContent += "Assignments and Scores\n";
            const studentHeaders = students.map(s => `"${s.firstName} ${s.lastName} (ID: ${s.id})"`).join(',');
            csvContent += `Assignment Number,Title,Posted Date,${studentHeaders}\n`;
            assignments.forEach(a => {
                const scoresRow = students.map(s => a.scores[s.id] || '').join(',');
                csvContent += `${a.assignmentNumber},${escapeCSV(a.title)},${a.postedDate},${scoresRow}\n`;
            });
            csvContent += "\n";
            
            // Seating Chart
            csvContent += "Seating Chart\n";
            for (let i = 0; i < CLASSROOM_ROWS; i++) {
                let row = [];
                for (let j = 0; j < CLASSROOM_COLS; j++) {
                    const seatIndex = i * CLASSROOM_COLS + j;
                    const seatContent = seatingChart[seatIndex];
                    if (seatContent === 'BLANK') {
                        row.push('BLANK');
                    } else if (typeof seatContent === 'number') {
                        const student = students.find(s => s.id === seatContent);
                        row.push(student ? `${student.firstName} ${student.lastName}` : `ID ${seatContent}`);
                    } else {
                        row.push('');
                    }
                }
                csvContent += row.map(escapeCSV).join(',') + '\n';
            }
            csvContent += "\n";

            // Help Requests
            csvContent += "Help Requests\n";
            csvContent += "Student ID,Student Name,Timestamp\n";
            helpRequests.forEach(r => {
                const student = students.find(s => s.id === r.studentId);
                const name = student ? `${student.firstName} ${student.lastName}` : '';
                csvContent += `${r.studentId},${escapeCSV(name)},${new Date(r.timestamp.seconds * 1000).toLocaleString()}\n`;
            });
             csvContent += "\n";

            // Check Requests
            csvContent += "Check Requests\n";
            csvContent += "Student ID,Student Name,Timestamp\n";
            checkRequests.forEach(r => {
                const student = students.find(s => s.id === r.studentId);
                const name = student ? `${student.firstName} ${student.lastName}` : '';
                csvContent += `${r.studentId},${escapeCSV(name)},${new Date(r.timestamp.seconds * 1000).toLocaleString()}\n`;
            });


            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            const date = new Date().toISOString().split('T')[0];
            link.setAttribute("download", `classroom_backup_${date}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        
        // --- GLOBAL ATTACHMENTS ---
        window.switchView = switchView;
        window.switchTeacherTab = switchTeacherTab;
        window.openModal = openModal;
        window.closeModal = closeModal;
        window.sortStudents = sortStudents;
        window.sortAssignments = sortAssignments;
        window.sortTeacherAssignments = sortTeacherAssignments;
        window.logout = logout;
        window.openEditStudentModal = openEditStudentModal;
        window.confirmDeleteStudent = confirmDeleteStudent;
        window.toggleSelectAll = toggleSelectAll;
        window.updateDeleteSelectedButtonState = updateDeleteSelectedButtonState;
        window.confirmDeleteSelectedStudents = confirmDeleteSelectedStudents;
        window.openEditAssignmentModal = openEditAssignmentModal;
        window.openScoreAssignmentModal = openScoreAssignmentModal;
        window.confirmDeleteAssignment = confirmDeleteAssignment;
        window.handleDragStart = handleDragStart;
        window.handleDragEnd = handleDragEnd;
        window.handleDragOver = handleDragOver;
        window.handleDragLeave = handleDragLeave;
        window.handleDrop = handleDrop;
        window.openStudentAssignmentModal = openStudentAssignmentModal;
        window.exportAllDataAsCSV = exportAllDataAsCSV;

        // --- INITIALIZATION ---
        initFirebase();
    </script>
</body>
</html>
