<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Instructor Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, query, where, addDoc, updateDoc, deleteDoc, getDoc, getDocs, runTransaction, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // IMPORTANT: These global variables are provided by the canvas environment.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = {
          apiKey: "AIzaSyBX96xDY5ThDAZn-SckmsnfynMnQjvUc2I",
          authDomain: "helprequest-469c0.firebaseapp.com",
          projectId: "helprequest-469c0",
          storageBucket: "helprequest-469c0.firebasestorage.app",
          messagingSenderId: "362143493922",
          appId: "1:362143493922:web:763262a5b658145a538260",
          measurementId: "G-L5S59L4JSP"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let state = {
            periods: [],
            students: [],
            assignments: [],
            requests: [],
            scores: [],
            currentPeriodId: localStorage.getItem('currentPeriodId') || null,
            currentView: localStorage.getItem('currentView') || 'layout',
            loading: true,
            editingAssignmentId: null,
        };

        const publicRootPath = `artifacts/${appId}/public/data`;
        let publicDataPath;
        let periodsRef = collection(db, `${publicRootPath}/periods`);
        let studentsRef;
        let assignmentsRef;
        let scoresRef;
        let requestsRef;

        let periodsUnsubscribe = null;
        let studentsUnsubscribe = null;
        let assignmentsUnsubscribe = null;
        let scoresUnsubscribe = null;
        let requestsUnsubscribe = null;

        const setupPeriodSpecificRefs = () => {
            if (state.currentPeriodId) {
                publicDataPath = `${publicRootPath}/${state.currentPeriodId}`;
                studentsRef = collection(db, `${publicDataPath}/students`);
                assignmentsRef = collection(db, `${publicDataPath}/assignments`);
                scoresRef = collection(db, `${publicDataPath}/scores`);
                requestsRef = collection(db, `${publicDataPath}/requests`);
            } else {
                publicDataPath = null;
                studentsRef = null;
                assignmentsRef = null;
                scoresRef = null;
                requestsRef = null;
            }
        };

        const startDataListeners = () => {
            state.loading = false;
            renderUI(); // Render the shell immediately

            if (periodsUnsubscribe) periodsUnsubscribe();
            
            periodsUnsubscribe = onSnapshot(periodsRef, (snapshot) => {
                const previousPeriodId = state.currentPeriodId;
                state.periods = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                const isValidPeriod = state.periods.some(p => p.id === state.currentPeriodId);

                if (!state.currentPeriodId || !isValidPeriod) {
                    state.currentPeriodId = state.periods.length > 0 ? state.periods[0].id : null;
                    if(state.currentPeriodId) {
                        localStorage.setItem('currentPeriodId', state.currentPeriodId);
                    } else {
                        localStorage.removeItem('currentPeriodId');
                    }
                }
                
                if (state.currentPeriodId !== previousPeriodId) {
                    setupPeriodSpecificRefs();
                    startPeriodSpecificListeners();
                } else {
                    renderUI(); // Just update the periods list if the selection hasn't changed
                }

            }, (error) => {
                console.error("Error fetching periods:", error);
                state.loading = false;
                renderUI();
            });
        };

        const startPeriodSpecificListeners = () => {
             // Clear previous listeners
            if (studentsUnsubscribe) studentsUnsubscribe();
            if (assignmentsUnsubscribe) assignmentsUnsubscribe();
            if (scoresUnsubscribe) scoresUnsubscribe();
            if (requestsUnsubscribe) requestsUnsubscribe();

            state.students = [];
            state.assignments = [];
            state.scores = [];
            state.requests = [];
            renderUI(); // Render the empty state for the period

            if (!state.currentPeriodId) {
                return;
            }

            studentsUnsubscribe = onSnapshot(query(studentsRef), (snapshot) => {
                state.students = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderUI();
            }, (error) => console.error("Error fetching students: ", error));

            assignmentsUnsubscribe = onSnapshot(assignmentsRef, (snapshot) => {
                state.assignments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderUI();
            }, (error) => console.error("Error fetching assignments: ", error));

            scoresUnsubscribe = onSnapshot(scoresRef, (snapshot) => {
                state.scores = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderUI();
            }, (error) => console.error("Error fetching scores: ", error));

            requestsUnsubscribe = onSnapshot(requestsRef, (snapshot) => {
                state.requests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderUI();
            }, (error) => console.error("Error fetching requests: ", error));
        };

        const addPeriod = async () => {
            const periodName = prompt("Enter period name:");
            if (periodName) {
                await addDoc(periodsRef, { name: periodName });
            }
        };

        const addStudent = async () => {
            if (!studentsRef) return;
            const studentName = prompt("Enter student's first name:");
            if (studentName) {
                const studentLastName = prompt("Enter student's last name:");
                if (studentLastName) {
                    const newStudentRef = await addDoc(studentsRef, {
                        firstName: studentName,
                        lastName: studentLastName,
                        seatOrder: 999, // Add to end of layout
                        isActive: true
                    });
                    
                    const assignmentsQuery = await getDocs(assignmentsRef);
                    assignmentsQuery.forEach(async (assignmentDoc) => {
                        await addDoc(scoresRef, {
                            studentId: newStudentRef.id,
                            assignmentId: assignmentDoc.id,
                            score: 'Not Graded'
                        });
                    });
                }
            }
        };
        
        const addEmptySeat = async () => {
            if (!studentsRef) return;
            await addDoc(studentsRef, {
                firstName: 'Empty',
                lastName: 'Seat',
                seatOrder: 999,
                isActive: false 
            });
        };

        const addAssignment = async () => {
            if (!assignmentsRef) return;
            const assignmentName = prompt("Enter assignment name:");
            if (assignmentName) {
                const maxAssignmentNum = state.assignments.reduce((max, a) => Math.max(max, a.assignmentNumber || 0), 0);
                const newAssignment = await addDoc(assignmentsRef, {
                    name: assignmentName,
                    assignmentNumber: maxAssignmentNum + 1,
                    postedDate: serverTimestamp()
                });

                const studentsQuery = await getDocs(query(studentsRef, where("isActive", "==", true)));
                studentsQuery.forEach(async (studentDoc) => {
                    await addDoc(scoresRef, {
                        studentId: studentDoc.id,
                        assignmentId: newAssignment.id,
                        score: 'Not Graded'
                    });
                });
            }
        };
        
        const updateAssignment = async () => {
            const assignmentId = state.editingAssignmentId;
            if (!assignmentId || !assignmentsRef) return;

            const newName = document.getElementById(`edit-assignment-name-${assignmentId}`).value;
            const newNumber = document.getElementById(`edit-assignment-num-${assignmentId}`).value;

            const assignmentRef = doc(assignmentsRef, assignmentId);
            await updateDoc(assignmentRef, {
                name: newName,
                assignmentNumber: parseInt(newNumber, 10) || 0
            });
            state.editingAssignmentId = null;
            renderUI();
        };

        const clearAllData = async () => {
            const password = prompt("This is a destructive action. Enter password to continue:");
            if (password === "teacher") {
                if (confirm("Are you sure you want to delete all data for this period?")) {
                    const collectionsToDelete = [studentsRef, assignmentsRef, scoresRef, requestsRef];
                    for (const ref of collectionsToDelete) {
                        if (ref) {
                            const snapshot = await getDocs(ref);
                            const deletePromises = snapshot.docs.map(d => deleteDoc(d.ref));
                            await Promise.all(deletePromises);
                        }
                    }
                }
            } else {
                alert("Incorrect password.");
            }
        };

        const deleteAllStudents = async () => {
            if (confirm("Are you sure you want to delete all students in this period?") && studentsRef) {
                const snapshot = await getDocs(studentsRef);
                const deletePromises = snapshot.docs.map(d => deleteDoc(d.ref));
                await Promise.all(deletePromises);
            }
        };

        const clearAllRequests = async () => {
            if (requestsRef) {
                const snapshot = await getDocs(requestsRef);
                const deletePromises = snapshot.docs.map(d => deleteDoc(d.ref));
                await Promise.all(deletePromises);
            }
        };
        
        window.App = {
            addPeriod,
            addStudent,
            addAssignment,
            addEmptySeat,
            clearAllData,
            deleteAllStudents,
            clearAllRequests,
            updateAssignment,
            setView: (view) => {
                state.currentView = view;
                localStorage.setItem('currentView', view);
                renderUI();
            },
            setPeriod: (periodId) => {
                const previousPeriodId = state.currentPeriodId;
                state.currentPeriodId = periodId;
                localStorage.setItem('currentPeriodId', periodId);

                if (state.currentPeriodId !== previousPeriodId) {
                    setupPeriodSpecificRefs();
                    startPeriodSpecificListeners();
                }
            },
            deleteRequest: async (requestId) => {
                if (requestsRef) {
                    await deleteDoc(doc(requestsRef, requestId));
                }
            },
            setEditingAssignment: (assignmentId) => {
                state.editingAssignmentId = assignmentId;
                renderUI();
            },
            cancelEditAssignment: () => {
                state.editingAssignmentId = null;
                renderUI();
            }
        };

        const LayoutView = () => {
            const helpQueue = state.requests.filter(r => r.type === 'help' && r.timestamp).sort((a, b) => a.timestamp.seconds - b.timestamp.seconds);
            const checkQueue = state.requests.filter(r => r.type === 'check' && r.timestamp).sort((a, b) => a.timestamp.seconds - b.timestamp.seconds);
            const allStudents = [...state.students];
            const sortedStudents = allStudents.sort((a, b) => (a.seatOrder || 0) - (b.seatOrder || 0));

            return `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 p-4">
                    <div class="lg:col-span-2">
                        <h2 class="text-xl font-bold mb-2">Class Layout</h2>
                        <div id="student-grid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                            ${sortedStudents.map(student => {
                                const helpRequest = helpQueue.find(r => r.studentId === student.id);
                                const checkRequest = checkQueue.find(r => r.studentId === student.id);
                                let bgColor = 'bg-white';
                                if (helpRequest) bgColor = 'bg-yellow-300';
                                if (checkRequest) bgColor = 'bg-green-300';
                                if (!student.isActive) bgColor = 'bg-gray-200';

                                return `
                                    <div class="student-card p-4 rounded-lg shadow-md text-center ${bgColor}" draggable="${student.isActive}" data-student-id="${student.id}">
                                        <p class="font-semibold">${student.firstName} ${student.lastName}</p>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    <div>
                        <div class="mb-4">
                            <h2 class="text-xl font-bold mb-2">Help Queue (${helpQueue.length})</h2>
                            <ul class="bg-white p-4 rounded-lg shadow-md min-h-[100px]">
                                ${helpQueue.map(r => {
                                    const student = state.students.find(s => s.id === r.studentId);
                                    return `<li class="flex justify-between items-center py-1">${student ? `${student.firstName} ${student.lastName}` : 'Unknown'}<button onclick="App.deleteRequest('${r.id}')" class="text-red-500 hover:text-red-700 font-bold">X</button></li>`;
                                }).join('')}
                            </ul>
                        </div>
                        <div>
                            <h2 class="text-xl font-bold mb-2">Check Queue (${checkQueue.length})</h2>
                            <ul class="bg-white p-4 rounded-lg shadow-md min-h-[100px]">
                                ${checkQueue.map(r => {
                                    const student = state.students.find(s => s.id === r.studentId);
                                    return `<li class="flex justify-between items-center py-1">${student ? `${student.firstName} ${student.lastName}` : 'Unknown'}<button onclick="App.deleteRequest('${r.id}')" class="text-red-500 hover:text-red-700 font-bold">X</button></li>`;
                                }).join('')}
                            </ul>
                        </div>
                    </div>
                </div>
            `;
        };

        const ScoresView = () => {
            const sortedAssignments = [...state.assignments].sort((a, b) => (a.assignmentNumber || 0) - (b.assignmentNumber || 0));
            const activeStudents = state.students.filter(s => s.isActive).sort((a, b) => a.lastName.localeCompare(b.lastName));

            return `
                <div class="p-4">
                    <h2 class="text-xl font-bold mb-2">Scores</h2>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white rounded-lg shadow-md">
                            <thead>
                                <tr class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                                    <th class="py-3 px-6 text-left">Student</th>
                                    ${sortedAssignments.map(assignment => `
                                        <th class="py-3 px-6 text-center cursor-pointer hover:bg-gray-300" onclick="App.setEditingAssignment('${assignment.id}')">
                                            ${assignment.assignmentNumber || 'N/A'}. ${assignment.name}
                                        </th>
                                    `).join('')}
                                </tr>
                            </thead>
                            <tbody class="text-gray-600 text-sm font-light">
                                ${activeStudents.map(student => `
                                    <tr class="border-b border-gray-200 hover:bg-gray-100">
                                        <td class="py-3 px-6 text-left whitespace-nowrap">${student.firstName} ${student.lastName}</td>
                                        ${sortedAssignments.map(assignment => {
                                            const score = state.scores.find(s => s.studentId === student.id && s.assignmentId === assignment.id);
                                            return `<td class="py-3 px-6 text-center">${score ? score.score : 'N/A'}</td>`;
                                        }).join('')}
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
                ${state.editingAssignmentId ? EditAssignmentModal() : ''}
            `;
        };
        
        const EditAssignmentModal = () => {
            const assignment = state.assignments.find(a => a.id === state.editingAssignmentId);
            if (!assignment) return '';

            return `
                <div class="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center">
                    <div class="bg-white p-6 rounded-lg shadow-xl">
                        <h3 class="text-lg font-bold mb-4">Edit Assignment</h3>
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="edit-assignment-num-${assignment.id}">Number</label>
                            <input id="edit-assignment-num-${assignment.id}" type="number" value="${assignment.assignmentNumber || 0}" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        </div>
                        <div class="mb-6">
                             <label class="block text-gray-700 text-sm font-bold mb-2" for="edit-assignment-name-${assignment.id}">Name</label>
                            <input id="edit-assignment-name-${assignment.id}" type="text" value="${assignment.name}" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        </div>
                        <div class="flex items-center justify-end">
                            <button onclick="App.cancelEditAssignment()" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline mr-2">Cancel</button>
                            <button onclick="App.updateAssignment()" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">Save</button>
                        </div>
                    </div>
                </div>
            `;
        }

        const renderUI = () => {
            const appDiv = document.getElementById('app');
            if (!appDiv) return;

            if (state.loading) {
                appDiv.innerHTML = `<div class="p-4 text-center">Loading data...</div>`;
                return;
            }

            let viewHtml = '';
            if (state.currentView === 'layout') {
                viewHtml = LayoutView();
            } else if (state.currentView === 'scores') {
                viewHtml = ScoresView();
            }

            appDiv.innerHTML = `
                <div class="min-h-screen bg-gray-100">
                    <nav class="bg-white shadow-md p-4 flex justify-between items-center flex-wrap">
                        <div class="flex items-center mb-2 sm:mb-0">
                            <h1 class="text-2xl font-bold mr-4">Instructor Dashboard</h1>
                            <select onchange="App.setPeriod(this.value)" class="p-2 rounded border">
                                ${state.periods.length === 0 ? '<option>No periods found</option>' : ''}
                                ${state.periods.map(p => `<option value="${p.id}" ${state.currentPeriodId === p.id ? 'selected' : ''}>${p.name}</option>`).join('')}
                            </select>
                            <button onclick="App.addPeriod()" class="ml-2 bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">+</button>
                        </div>
                        <div>
                            <button onclick="App.setView('layout')" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-l ${state.currentView === 'layout' ? 'bg-gray-500 text-white' : ''}">Layout</button>
                            <button onclick="App.setView('scores')" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-r ${state.currentView === 'scores' ? 'bg-gray-500 text-white' : ''}">Scores</button>
                        </div>
                    </nav>
                    <div class="p-4 bg-gray-50 border-b border-t">
                        <button onclick="App.addStudent()" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">Add Student</button>
                        <button onclick="App.addAssignment()" class="ml-2 bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">Add Assignment</button>
                        <button onclick="App.addEmptySeat()" class="ml-2 bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">Add Empty Seat</button>
                        <button onclick="App.clearAllRequests()" class="ml-2 bg-yellow-500 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded">Clear All Requests</button>
                        <button onclick="App.deleteAllStudents()" class="ml-2 bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">Delete All Students</button>
                        <button onclick="App.clearAllData()" class="ml-2 bg-red-700 hover:bg-red-900 text-white font-bold py-2 px-4 rounded">Clear All Data</button>
                    </div>
                    ${viewHtml}
                </div>
            `;

            if (state.currentView === 'layout') {
                attachDragAndDrop();
            }
        };

        const attachDragAndDrop = () => {
            let draggedItemId = null;
        
            const handleDragStart = (e) => {
                draggedItemId = e.currentTarget.dataset.studentId;
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', draggedItemId);
                setTimeout(() => {
                    e.currentTarget.classList.add('opacity-50');
                }, 0);
            };
        
            const handleDragOver = (e) => {
                e.preventDefault();
                const targetCard = e.currentTarget;
                if(targetCard.dataset.studentId !== draggedItemId && targetCard.getAttribute('draggable') === 'true') {
                    targetCard.classList.add('bg-blue-200');
                }
            };
        
            const handleDragLeave = (e) => {
                e.currentTarget.classList.remove('bg-blue-200');
            };
        
            const handleDrop = async (e) => {
                e.preventDefault();
                e.stopPropagation();
                const targetItemId = e.currentTarget.dataset.studentId;
                e.currentTarget.classList.remove('bg-blue-200');
        
                if (draggedItemId === targetItemId || !targetItemId) return;

                if (!studentsRef) return;
                
                await runTransaction(db, async (transaction) => {
                    // Re-fetch students within the transaction to ensure fresh data
                    const studentsSnapshot = await getDocs(query(studentsRef));
                    const students = studentsSnapshot.docs.map(d => ({id: d.id, ...d.data()}));
                    students.sort((a, b) => (a.seatOrder || 0) - (b.seatOrder || 0));

                    const draggedIndex = students.findIndex(s => s.id === draggedItemId);
                    const targetIndex = students.findIndex(s => s.id === targetItemId);

                    if (draggedIndex === -1 || targetIndex === -1) return;
        
                    const [draggedItem] = students.splice(draggedIndex, 1);
                    students.splice(targetIndex, 0, draggedItem);
        
                    students.forEach((student, index) => {
                        const studentRef = doc(studentsRef, student.id);
                        transaction.update(studentRef, { seatOrder: index });
                    });
                });
            };
        
            const handleDragEnd = (e) => {
                e.currentTarget.classList.remove('opacity-50');
                document.querySelectorAll('.student-card').forEach(card => card.classList.remove('bg-blue-200'));
            };
        
            document.querySelectorAll('.student-card[draggable="true"]').forEach(card => {
                card.addEventListener('dragstart', handleDragStart);
                card.addEventListener('dragover', handleDragOver);
                card.addEventListener('dragleave', handleDragLeave);
                card.addEventListener('drop', handleDrop);
                card.addEventListener('dragend', handleDragEnd);
            });
        };

        let appInitialized = false;
        document.addEventListener('DOMContentLoaded', () => {
            renderUI(); // Initial render with loading state
            onAuthStateChanged(auth, (user) => {
                if (user && !appInitialized) {
                    appInitialized = true;
                    // User is signed in, start the app logic.
                    startDataListeners();
                } else if (!user) {
                    // User is signed out, sign them in anonymously.
                    signInAnonymously(auth).catch((error) => {
                        console.error("Anonymous sign in failed:", error);
                        const appDiv = document.getElementById('app');
                        if (appDiv) {
                            appDiv.innerHTML = `<div class="p-4 text-center text-red-600">Could not connect to the service.</div>`;
                        }
                    });
                }
            });
        });
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
    </style>
</head>
<body>
    <div id="app"></div>
</body>
</html>

