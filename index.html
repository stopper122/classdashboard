<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Instructor Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, query, where, addDoc, updateDoc, deleteDoc, getDoc, getDocs, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = {
  apiKey: "AIzaSyBX96xDY5ThDAZn-SckmsnfynMnQjvUc2I",
  authDomain: "helprequest-469c0.firebaseapp.com",
  projectId: "helprequest-469c0",
  storageBucket: "helprequest-469c0.firebasestorage.app",
  messagingSenderId: "1092775554304",
  appId: "1:1092775554304:web:e771c3ebac1e6ba4f597e5"
};
        setLogLevel('debug');

        let auth, db;
        let state = {
            periods: [],
            selectedPeriodId: null,
            students: [],
            assignments: [],
            requests: [],
            selectedStudent: null,
            sortOption: 'seatOrder',
            loading: true,
            isDragging: false,
            draggedId: null,
            draggedIndex: null,
            selectedAssignmentsForDeletion: [],
            showPasswordModal: false,
            passwordModalCallback: null,
            showAssignmentEditModal: false,
            selectedAssignmentForEdit: null,
            showConfirmModal: false,
            confirmModalMessage: '',
            confirmModalCallback: null
        };
        const TEACHER_PASSWORD = 'Rocket_22!!';

        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        const publicDataPath = `artifacts/${appId}/public/data`;

        auth.onAuthStateChanged(async (user) => {
            if (user) {
                if (state.loading) {
                    await startDataListeners();
                    state.loading = false;
                }
            } else {
                await signInAnonymously(auth);
            }
        });

        // Function to start real-time listeners for all data
        const startDataListeners = async () => {
            const userId = auth.currentUser?.uid || "anonymous_user";

            // Listen for periods
            onSnapshot(collection(db, `${publicDataPath}/periods`), (snapshot) => {
                state.periods = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (!state.selectedPeriodId && state.periods.length > 0) {
                    state.selectedPeriodId = state.periods[0].id;
                }
                renderUI();
            });

            // Listen for students and sort
            onSnapshot(collection(db, `${publicDataPath}/students`), (snapshot) => {
                state.students = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                sortStudents();
                renderUI();
            });
            
            // Listen for assignments
            onSnapshot(collection(db, `${publicDataPath}/assignments`), (snapshot) => {
                state.assignments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderUI();
            });

            // Listen for requests
            onSnapshot(collection(db, `${publicDataPath}/requests`), (snapshot) => {
                state.requests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderUI();
            });
        };

        const sortStudents = () => {
            const filteredStudents = state.students.filter(s => s.periodId === state.selectedPeriodId);
            if (state.sortOption === 'seatOrder') {
                state.students = filteredStudents.sort((a, b) => (a.seatOrder || 0) - (b.seatOrder || 0));
            } else if (state.sortOption === 'firstName') {
                state.students = filteredStudents.sort((a, b) => (a.firstName || '').localeCompare(b.firstName || ''));
            } else if (state.sortOption === 'lastName') {
                state.students = filteredStudents.sort((a, b) => (a.lastName || '').localeCompare(b.lastName || ''));
            }
            if (state.sortOption !== 'seatOrder') {
                state.students.forEach((s, i) => s.seatOrder = i);
            }
        };

        // ... [all your existing render functions, event handlers, etc. remain unchanged] ...

        const showConfirmModal = (message, callback) => {
            state.showConfirmModal = true;
            state.confirmModalMessage = message;
            state.confirmModalCallback = callback;
            renderUI();
            
            const confirmBtn = document.getElementById('confirm-modal-confirm-btn');
            const cancelBtn = document.getElementById('confirm-modal-cancel-btn');

            const handleConfirm = async () => {
                state.showConfirmModal = false;
                renderUI();
                await state.confirmModalCallback();
                state.confirmModalCallback = null;
                renderUI();
            };

            const handleCancel = () => {
                state.showConfirmModal = false;
                state.confirmModalCallback = null;
                renderUI();
            };

            confirmBtn.addEventListener('click', handleConfirm);
            cancelBtn.addEventListener('click', handleCancel);
        };

        const handleClearAllAppData = async () => {
            const publicDataPath = `artifacts/${appId}/public/data`;
            await runTransaction(db, async (transaction) => {
                const periodsRef = collection(db, `${publicDataPath}/periods`);
                const studentsRef = collection(db, `${publicDataPath}/students`);
                const assignmentsRef = collection(db, `${publicDataPath}/assignments`);
                const requestsRef = collection(db, `${publicDataPath}/requests`);

                for (const ref of [periodsRef, studentsRef, assignmentsRef, requestsRef]) {
                    const snapshot = await getDocs(ref);
                    snapshot.forEach(doc => transaction.delete(doc.ref));
                }
            });

            // Reset state so UI doesn't get stuck on loading
            state.periods = [];
            state.students = [];
            state.assignments = [];
            state.requests = [];
            state.selectedPeriodId = null;
            state.selectedStudent = null;
            renderUI();
        };

        // ... [rest of your original code unchanged, including renderUI, handlers, etc.] ...

        document.addEventListener('DOMContentLoaded', () => {
            renderUI();
        });
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
    </style>
</head>
<body>
    <div id="app"></div>
</body>
</html>
