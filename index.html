<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Instructor Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, query, where, addDoc, updateDoc, deleteDoc, getDocs, runTransaction, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURATION ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = {
          apiKey: "AIzaSyBX96xDY5ThDAZn-SckmsnfynMnQjvUc2I",
          authDomain: "helprequest-469c0.firebaseapp.com",
          projectId: "helprequest-469c0",
          storageBucket: "helprequest-469c0.firebasestorage.app",
          messagingSenderId: "362143493922",
          appId: "1:362143493922:web:763262a5b658145a538260",
          measurementId: "G-L5S59L4JSP"
        };

        // --- FIREBASE INITIALIZATION ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- APPLICATION STATE ---
        let state = {
            periods: [],
            students: [],
            assignments: [],
            requests: [],
            scores: [],
            currentPeriodId: null,
            currentView: localStorage.getItem('currentView') || 'layout',
            loading: true,
            error: null,
            showConfirmModal: false,
            confirmAction: null,
            confirmMessage: '',
            editingAssignmentId: null,
        };

        // --- FIREBASE REFERENCES ---
        const publicRootPath = `artifacts/${appId}/public/data`;
        let periodsRef;
        let studentsRef, assignmentsRef, scoresRef, requestsRef;

        // To hold our real-time listeners
        let unsubscribe = {
            periods: null,
            students: null,
            assignments: null,
            scores: null,
            requests: null,
        };
        
        // --- CORE LOGIC ---

        /**
         * Sets up Firestore collection references based on the current period ID.
         */
        const setupPeriodSpecificRefs = () => {
            if (state.currentPeriodId) {
                const periodPath = `${publicRootPath}/${state.currentPeriodId}`;
                studentsRef = collection(db, `${periodPath}/students`);
                assignmentsRef = collection(db, `${periodPath}/assignments`);
                scoresRef = collection(db, `${periodPath}/scores`);
                requestsRef = collection(db, `${periodPath}/requests`);
            } else {
                [studentsRef, assignmentsRef, scoresRef, requestsRef] = [null, null, null, null];
            }
        };

        /**
         * Detaches all active Firestore listeners.
         */
        const detachAllListeners = () => {
            Object.values(unsubscribe).forEach(unsub => unsub && unsub());
        };

        /**
         * Attaches real-time listeners for the currently selected period.
         */
        const attachPeriodListeners = () => {
            if (!state.currentPeriodId) return;

            unsubscribe.students = onSnapshot(query(studentsRef), snap => {
                state.students = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderUI();
            }, e => console.error("Error fetching students:", e));

            unsubscribe.assignments = onSnapshot(query(assignmentsRef), snap => {
                state.assignments = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderUI();
            }, e => console.error("Error fetching assignments:", e));

            unsubscribe.scores = onSnapshot(query(scoresRef), snap => {
                state.scores = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderUI();
            }, e => console.error("Error fetching scores:", e));

            unsubscribe.requests = onSnapshot(query(requestsRef), snap => {
                state.requests = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderUI();
            }, e => console.error("Error fetching requests:", e));
        };

        /**
         * Main initialization function. Runs once after user is authenticated.
         */
        const initializeAppLogic = () => {
            if (unsubscribe.periods) return; // Already initialized

            periodsRef = collection(db, `${publicRootPath}/periods`);

            unsubscribe.periods = onSnapshot(periodsRef, (snapshot) => {
                const isInitialLoad = state.loading;
                state.periods = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                let newPeriodId = state.currentPeriodId;
                const periodStillExists = state.periods.some(p => p.id === newPeriodId);
                
                if (isInitialLoad || !periodStillExists) {
                    const storedPeriodId = localStorage.getItem('currentPeriodId');
                    newPeriodId = state.periods.some(p => p.id === storedPeriodId)
                        ? storedPeriodId
                        : (state.periods.length > 0 ? state.periods[0].id : null);
                }

                if (isInitialLoad || newPeriodId !== state.currentPeriodId) {
                    App.setPeriod(newPeriodId);
                }

                state.loading = false;
                renderUI();
            }, (error) => {
                console.error("Critical Error initializing periods:", error);
                state.loading = false;
                state.error = "Could not connect to the periods database.";
                renderUI();
            });
        };

        // --- ACTIONS (Exposed via window.App) ---

        const App = {
            setPeriod: (periodId) => {
                state.currentPeriodId = periodId;
                if (periodId) {
                    localStorage.setItem('currentPeriodId', periodId);
                } else {
                    localStorage.removeItem('currentPeriodId');
                }
                
                detachAllListeners(); // Stop listening to old period data
                setupPeriodSpecificRefs();
                attachPeriodListeners(); // Start listening to new period data
                renderUI();
            },

            setView: (view) => {
                state.currentView = view;
                localStorage.setItem('currentView', view);
                renderUI();
            },

            addPeriod: async () => {
                const periodName = prompt("Enter new period name:");
                if (periodName) {
                    try {
                        await addDoc(periodsRef, { name: periodName });
                    } catch (e) {
                        console.error("Error adding period:", e);
                        state.error = "Failed to add period.";
                        renderUI();
                    }
                }
            },

            addStudent: async () => {
                if (!studentsRef) return;
                const firstName = prompt("Enter student's first name:");
                if (!firstName) return;
                const lastName = prompt("Enter student's last name:");
                if (!lastName) return;

                try {
                    const newStudentRef = await addDoc(studentsRef, { firstName, lastName, seatOrder: 999, isActive: true });
                    const assignmentsSnap = await getDocs(assignmentsRef);
                    const scorePromises = assignmentsSnap.docs.map(assignDoc => 
                        addDoc(scoresRef, { studentId: newStudentRef.id, assignmentId: assignDoc.id, score: 'Not Graded' })
                    );
                    await Promise.all(scorePromises);
                } catch (e) {
                    console.error("Error adding student:", e);
                    state.error = "Failed to add student.";
                    renderUI();
                }
            },

            addEmptySeat: async () => {
                if (!studentsRef) return;
                try {
                    await addDoc(studentsRef, { firstName: 'Empty', lastName: 'Seat', seatOrder: 999, isActive: false });
                } catch (e) {
                    console.error("Error adding empty seat:", e);
                    state.error = "Failed to add empty seat.";
                    renderUI();
                }
            },

            addAssignment: async () => {
                if (!assignmentsRef) return;
                const name = prompt("Enter new assignment name:");
                if (!name) return;
                
                try {
                    const maxNum = state.assignments.reduce((max, a) => Math.max(max, a.assignmentNumber || 0), 0);
                    const newAssignmentRef = await addDoc(assignmentsRef, { name, assignmentNumber: maxNum + 1, postedDate: serverTimestamp() });
                    const studentsSnap = await getDocs(query(studentsRef, where("isActive", "==", true)));
                    const scorePromises = studentsSnap.docs.map(studentDoc => 
                        addDoc(scoresRef, { studentId: studentDoc.id, assignmentId: newAssignmentRef.id, score: 'Not Graded' })
                    );
                    await Promise.all(scorePromises);
                } catch (e) {
                    console.error("Error adding assignment:", e);
                    state.error = "Failed to add assignment.";
                    renderUI();
                }
            },

            clearAllRequests: async () => {
                if (!requestsRef) return;
                const reqsSnap = await getDocs(requestsRef);
                const deletePromises = reqsSnap.docs.map(d => deleteDoc(d.ref));
                await Promise.all(deletePromises);
            },
            
            _showConfirm: (message, action) => {
                state.confirmMessage = message;
                state.confirmAction = action;
                state.showConfirmModal = true;
                renderUI();
            },

            deleteAllStudents: () => {
                App._showConfirm("Are you sure you want to delete all students?", async () => {
                    if (studentsRef) {
                        const studentsSnap = await getDocs(studentsRef);
                        await Promise.all(studentsSnap.docs.map(d => deleteDoc(d.ref)));
                    }
                    App.cancelConfirm();
                });
            },

            clearAllData: () => {
                const password = prompt("This is a destructive action. Enter password to continue:");
                if (password === "teacher") {
                    App._showConfirm("Are you sure you want to delete ALL data for this period?", async () => {
                        const refs = [studentsRef, assignmentsRef, scoresRef, requestsRef];
                        for (const ref of refs) {
                            if (ref) {
                                const snap = await getDocs(ref);
                                await Promise.all(snap.docs.map(d => deleteDoc(d.ref)));
                            }
                        }
                        App.cancelConfirm();
                    });
                } else if (password !== null) {
                    state.error = "Incorrect password.";
                    renderUI();
                }
            },

            deleteRequest: async (requestId) => {
                if (requestsRef) await deleteDoc(doc(requestsRef, requestId));
            },
            
            setEditingAssignment: (assignmentId) => {
                state.editingAssignmentId = assignmentId;
                renderUI();
            },
            
            cancelEditAssignment: () => {
                state.editingAssignmentId = null;
                renderUI();
            },
            
            updateAssignment: async () => {
                const id = state.editingAssignmentId;
                if (!id || !assignmentsRef) return;
                const name = document.getElementById(`edit-name-${id}`).value;
                const num = document.getElementById(`edit-num-${id}`).value;
                await updateDoc(doc(assignmentsRef, id), { name, assignmentNumber: parseInt(num, 10) || 0 });
                state.editingAssignmentId = null;
                renderUI();
            },

            confirmAction: () => {
                if (state.confirmAction) state.confirmAction();
            },

            cancelConfirm: () => {
                state.showConfirmModal = false;
                state.confirmAction = null;
                state.confirmMessage = '';
                renderUI();
            },
            
            clearError: () => {
                state.error = null;
                renderUI();
            }
        };

        window.App = App;

        // --- UI COMPONENTS ---

        const LayoutView = () => {
            const helpQueue = state.requests.filter(r => r.type === 'help').sort((a,b) => (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0));
            const checkQueue = state.requests.filter(r => r.type === 'check').sort((a,b) => (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0));
            const sortedStudents = [...state.students].sort((a, b) => (a.seatOrder || 0) - (b.seatOrder || 0));

            return `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 p-4">
                    <div class="lg:col-span-2">
                        <h2 class="text-xl font-bold mb-2">Class Layout</h2>
                        <div id="student-grid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                            ${sortedStudents.map(student => {
                                const hasHelp = helpQueue.some(r => r.studentId === student.id);
                                const hasCheck = checkQueue.some(r => r.studentId === student.id);
                                let bgColor = 'bg-white';
                                if (hasHelp) bgColor = 'bg-yellow-300';
                                if (hasCheck) bgColor = 'bg-green-300';
                                if (!student.isActive) bgColor = 'bg-gray-200';

                                return `<div class="student-card p-4 rounded-lg shadow-md text-center ${bgColor}" draggable="${student.isActive}" data-student-id="${student.id}">
                                            <p class="font-semibold">${student.firstName} ${student.lastName}</p>
                                        </div>`;
                            }).join('')}
                        </div>
                    </div>
                    <div>
                        <div class="mb-4">
                            <h2 class="text-xl font-bold mb-2">Help Queue (${helpQueue.length})</h2>
                            <ul class="bg-white p-4 rounded-lg shadow-md min-h-[100px]">${helpQueue.map(r => {
                                const s = state.students.find(s => s.id === r.studentId);
                                return `<li class="flex justify-between items-center py-1">${s ? `${s.firstName} ${s.lastName}` : '...'}
                                            <button onclick="App.deleteRequest('${r.id}')" class="text-red-500 font-bold">X</button>
                                        </li>`;
                            }).join('')}</ul>
                        </div>
                        <div>
                            <h2 class="text-xl font-bold mb-2">Check Queue (${checkQueue.length})</h2>
                            <ul class="bg-white p-4 rounded-lg shadow-md min-h-[100px]">${checkQueue.map(r => {
                                const s = state.students.find(s => s.id === r.studentId);
                                return `<li class="flex justify-between items-center py-1">${s ? `${s.firstName} ${s.lastName}` : '...'}
                                            <button onclick="App.deleteRequest('${r.id}')" class="text-red-500 font-bold">X</button>
                                        </li>`;
                            }).join('')}</ul>
                        </div>
                    </div>
                </div>`;
        };

        const ScoresView = () => {
            const sortedAssignments = [...state.assignments].sort((a, b) => (a.assignmentNumber || 0) - (b.assignmentNumber || 0));
            const activeStudents = state.students.filter(s => s.isActive && s.lastName).sort((a, b) => (a.lastName || '').localeCompare(b.lastName || ''));

            return `<div class="p-4 overflow-x-auto">
                        <h2 class="text-xl font-bold mb-2">Scores</h2>
                        <table class="min-w-full bg-white rounded-lg shadow-md">
                            <thead>
                                <tr class="bg-gray-200 text-gray-600 uppercase text-sm">
                                    <th class="py-3 px-6 text-left">Student</th>
                                    ${sortedAssignments.map(a => `<th class="py-3 px-6 text-center cursor-pointer hover:bg-gray-300" onclick="App.setEditingAssignment('${a.id}')">${a.assignmentNumber || '#'}. ${a.name}</th>`).join('')}
                                </tr>
                            </thead>
                            <tbody class="text-gray-600 text-sm">
                                ${activeStudents.map(student => `
                                    <tr class="border-b border-gray-200 hover:bg-gray-100">
                                        <td class="py-3 px-6 text-left whitespace-nowrap">${student.firstName} ${student.lastName}</td>
                                        ${sortedAssignments.map(a => {
                                            const score = state.scores.find(s => s.studentId === student.id && s.assignmentId === a.id);
                                            return `<td class="py-3 px-6 text-center">${score ? score.score : 'N/A'}</td>`;
                                        }).join('')}
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>`;
        };
        
        const EditAssignmentModal = () => {
            const assignment = state.assignments.find(a => a.id === state.editingAssignmentId);
            if (!assignment) return '';

            return `<div class="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center">
                        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm">
                            <h3 class="text-lg font-bold mb-4">Edit Assignment</h3>
                            <div class="mb-4">
                                <label class="block text-sm font-bold mb-2">Number</label>
                                <input id="edit-num-${assignment.id}" type="number" value="${assignment.assignmentNumber || 0}" class="shadow border rounded w-full py-2 px-3">
                            </div>
                            <div class="mb-6">
                                <label class="block text-sm font-bold mb-2">Name</label>
                                <input id="edit-name-${assignment.id}" type="text" value="${assignment.name}" class="shadow border rounded w-full py-2 px-3">
                            </div>
                            <div class="flex justify-end">
                                <button onclick="App.cancelEditAssignment()" class="bg-gray-500 text-white font-bold py-2 px-4 rounded mr-2">Cancel</button>
                                <button onclick="App.updateAssignment()" class="bg-blue-500 text-white font-bold py-2 px-4 rounded">Save</button>
                            </div>
                        </div>
                    </div>`;
        };

        const ConfirmModal = () => {
            if (!state.showConfirmModal) return '';
            return `<div class="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center">
                        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md">
                            <h3 class="text-lg font-bold mb-4">Confirm Action</h3>
                            <p class="mb-6">${state.confirmMessage}</p>
                            <div class="flex justify-end">
                                <button onclick="App.cancelConfirm()" class="bg-gray-500 text-white font-bold py-2 px-4 rounded mr-2">Cancel</button>
                                <button onclick="App.confirmAction()" class="bg-red-500 text-white font-bold py-2 px-4 rounded">Yes, Proceed</button>
                            </div>
                        </div>
                    </div>`;
        };

        const renderUI = () => {
            const appDiv = document.getElementById('app');
            if (!appDiv) return;

            if (state.loading) {
                appDiv.innerHTML = `<div class="p-4 text-center">Loading data...</div>`;
                return;
            }

            const isPeriodSelected = !!state.currentPeriodId;
            const buttonClasses = "text-white font-bold py-2 px-4 rounded disabled:opacity-50 disabled:cursor-not-allowed";

            appDiv.innerHTML = `
                <div class="min-h-screen bg-gray-100">
                    ${state.error ? `<div class="bg-red-500 text-white p-3 text-center relative">${state.error}<button onclick="App.clearError()" class="absolute top-0 right-0 mt-3 mr-3 font-bold text-xl">&times;</button></div>` : ''}
                    <nav class="bg-white shadow-md p-4 flex justify-between items-center flex-wrap gap-4">
                        <div class="flex items-center">
                            <h1 class="text-2xl font-bold mr-4">Instructor Dashboard</h1>
                            <select onchange="App.setPeriod(this.value)" class="p-2 rounded border">
                                ${state.periods.length === 0 ? '<option>No periods yet</option>' : ''}
                                ${state.periods.map(p => `<option value="${p.id}" ${state.currentPeriodId === p.id ? 'selected' : ''}>${p.name}</option>`).join('')}
                            </select>
                            <button onclick="App.addPeriod()" class="ml-2 bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">+</button>
                        </div>
                        <div>
                            <button onclick="App.setView('layout')" class="bg-gray-300 hover:bg-gray-400 font-bold py-2 px-4 rounded-l ${state.currentView === 'layout' ? 'bg-gray-500 text-white' : ''}">Layout</button>
                            <button onclick="App.setView('scores')" class="bg-gray-300 hover:bg-gray-400 font-bold py-2 px-4 rounded-r ${state.currentView === 'scores' ? 'bg-gray-500 text-white' : ''}">Scores</button>
                        </div>
                    </nav>
                    <div class="p-4 bg-gray-50 border-y flex flex-wrap gap-2">
                        <button onclick="App.addStudent()" class="bg-green-500 hover:bg-green-700 ${buttonClasses}" ${!isPeriodSelected ? 'disabled' : ''}>Add Student</button>
                        <button onclick="App.addAssignment()" class="bg-green-500 hover:bg-green-700 ${buttonClasses}" ${!isPeriodSelected ? 'disabled' : ''}>Add Assignment</button>
                        <button onclick="App.addEmptySeat()" class="bg-gray-500 hover:bg-gray-700 ${buttonClasses}" ${!isPeriodSelected ? 'disabled' : ''}>Add Empty Seat</button>
                        <button onclick="App.clearAllRequests()" class="bg-yellow-500 hover:bg-yellow-700 ${buttonClasses}" ${!isPeriodSelected ? 'disabled' : ''}>Clear Requests</button>
                        <button onclick="App.deleteAllStudents()" class="bg-red-500 hover:bg-red-700 ${buttonClasses}" ${!isPeriodSelected ? 'disabled' : ''}>Delete Students</button>
                        <button onclick="App.clearAllData()" class="bg-red-700 hover:bg-red-900 ${buttonClasses}" ${!isPeriodSelected ? 'disabled' : ''}>Clear All Data</button>
                    </div>
                    ${state.currentView === 'layout' ? LayoutView() : ScoresView()}
                    ${ConfirmModal()}
                    ${EditAssignmentModal()}
                </div>
            `;
            
            if (state.currentView === 'layout') {
                attachDragAndDrop();
            }
        };

        const attachDragAndDrop = () => {
             let draggedItemId = null;
        
            const handleDragStart = (e) => {
                draggedItemId = e.currentTarget.dataset.studentId;
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', draggedItemId);
                setTimeout(() => e.currentTarget.classList.add('opacity-50'), 0);
            };
        
            const handleDragOver = (e) => {
                e.preventDefault();
                const target = e.currentTarget;
                if(target.dataset.studentId !== draggedItemId && target.getAttribute('draggable') === 'true') {
                    target.classList.add('bg-blue-200');
                }
            };
        
            const handleDragLeave = (e) => e.currentTarget.classList.remove('bg-blue-200');
        
            const handleDrop = async (e) => {
                e.preventDefault();
                e.stopPropagation();
                const targetId = e.currentTarget.dataset.studentId;
                e.currentTarget.classList.remove('bg-blue-200');
                if (draggedItemId === targetId || !targetId || !studentsRef) return;
                
                await runTransaction(db, async (transaction) => {
                    const studentsSnap = await getDocs(query(studentsRef));
                    const students = studentsSnap.docs.map(d => ({id: d.id, ...d.data()})).sort((a, b) => (a.seatOrder || 0) - (b.seatOrder || 0));
                    
                    const draggedIndex = students.findIndex(s => s.id === draggedItemId);
                    const targetIndex = students.findIndex(s => s.id === targetId);
                    if (draggedIndex === -1 || targetIndex === -1) return;
        
                    const [draggedItem] = students.splice(draggedIndex, 1);
                    students.splice(targetIndex, 0, draggedItem);
        
                    students.forEach((student, index) => {
                        transaction.update(doc(studentsRef, student.id), { seatOrder: index });
                    });
                });
            };
        
            const handleDragEnd = (e) => e.currentTarget.classList.remove('opacity-50');
        
            document.querySelectorAll('.student-card[draggable="true"]').forEach(card => {
                card.addEventListener('dragstart', handleDragStart);
                card.addEventListener('dragover', handleDragOver);
                card.addEventListener('dragleave', handleDragLeave);
                card.addEventListener('drop', handleDrop);
                card.addEventListener('dragend', handleDragEnd);
            });
        };

        // --- APP START ---
        document.addEventListener('DOMContentLoaded', () => {
            renderUI();
            onAuthStateChanged(auth, user => {
                if (user) {
                    initializeAppLogic();
                } else {
                    signInAnonymously(auth).catch(e => {
                        console.error("Anonymous sign in failed:", e);
                        state.error = "Could not connect to the service.";
                        state.loading = false;
                        renderUI();
                    });
                }
            });
        });
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; color: #1f2937; }
    </style>
</head>
<body>
    <div id="app"></div>
</body>
</html>

