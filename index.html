<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Class Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
  <!-- Full original HTML structure from your uploaded index.html remains here -->

  <script type="module">
    // === Firebase imports, config, variables ===
    // (all your original Firebase initialization code remains unchanged)

    // Existing globals
    let students = [];
    let assignments = [];
    let seatingChart = [];

    // New flags for sync
    let studentsLoaded = false;
    let seatingLoaded = false;

    // ======================
    // Drag & Drop Handlers (already patched)
    // ======================
    function handleDragStart(event, type, id) {
      let payloadId = id;
      if (!payloadId && event.currentTarget.dataset.id) {
        payloadId = event.currentTarget.dataset.id;
      }
      const payload = {
        type,
        id: payloadId,
        originSeatIndex: event.currentTarget.dataset.seatIndex
      };
      event.dataTransfer.setData("application/json", JSON.stringify(payload));
      event.dataTransfer.effectAllowed = "move";
    }

    function handleDragEnd(event) {
      event.preventDefault();
    }

    function handleDragOver(event) {
      event.preventDefault();
      event.currentTarget.classList.add('dragging-over');
    }

    function handleDragLeave(event) {
      event.currentTarget.classList.remove('dragging-over');
    }

    function handleDrop(event) {
      event.preventDefault();
      event.currentTarget.classList.remove('dragging-over');

      const raw = event.dataTransfer.getData('application/json') || event.dataTransfer.getData('text') || '';
      if (!raw) {
        console.warn('handleDrop: no drag data found');
        return;
      }

      let payload;
      try {
        payload = JSON.parse(raw);
      } catch (err) {
        console.error('handleDrop: failed to parse drag payload:', err, 'raw:', raw);
        return;
      }

      const targetSeatIndex = parseInt(event.currentTarget.dataset.seatIndex, 10);
      const itemAtTarget = seatingChart[targetSeatIndex];

      switch (payload.type) {
        case 'roster_student':
          seatingChart[targetSeatIndex] = payload.id;
          break;
        case 'new_blank_seat':
          seatingChart[targetSeatIndex] = 'BLANK';
          break;
        case 'grid_seat':
          const originSeatIndex = payload.originSeatIndex;
          const itemAtOrigin = seatingChart[originSeatIndex];
          seatingChart[originSeatIndex] = itemAtTarget;
          seatingChart[targetSeatIndex] = itemAtOrigin;
          break;
      }

      saveSeatingChart();
    }

    // ======================
    // Roster Rendering (already patched li template)
    // ======================
    function renderUnseatedStudentList() {
      const list = document.getElementById('unseated-student-list');
      const seatedIds = new Set(seatingChart.filter(id => id !== 'BLANK'));
      const unseatedStudents = students.filter(s => !seatedIds.has(s.id));
      list.innerHTML = unseatedStudents.map(s => `
           <li id="roster-student-${s.id}" data-id="${s.id}"
               class="student-roster-item p-4 bg-gray-50 rounded-lg font-medium text-center"
               draggable="true" 
               ondragstart="handleDragStart(event, 'roster_student', ${s.id})"
               ondragend="handleDragEnd(event)">
              ${s.firstName} ${s.lastName}
          </li>
      `).join('');
    }

    // ======================
    // Seating load sync helper
    // ======================
    function maybeRenderSeatingChart() {
      if (!studentsLoaded || !seatingLoaded) return;
      if (currentView === 'teacher') {
        renderSeatingChart();
        renderUnseatedStudentList();
        renderStudentRequests();
      }
    }

    // ======================
    // Firestore listeners (patched)
    // ======================
    onSnapshot(query(studentsCol), (snapshot) => {
      students = snapshot.docs.map(doc => ({ fbId: doc.id, ...doc.data() }));
      sortStudents();
      studentsLoaded = true;
      if (currentView === 'teacher') renderTeacherView();
      maybeRenderSeatingChart();
    });

    onSnapshot(seatingChartDoc, async (docSnap) => {
      if (docSnap.exists()) {
        seatingChart = docSnap.data().chart || Array(TOTAL_SEATS).fill(null);
      } else {
        seatingChart = Array(TOTAL_SEATS).fill(null);
        await setDoc(seatingChartDoc, { chart: seatingChart });
      }
      seatingLoaded = true;
      maybeRenderSeatingChart();
    });

    // ======================
    // Init (patched to reset flags)
    // ======================
    async function init() {
      await initFirebase();
      studentsLoaded = false;
      seatingLoaded = false;

      // ... rest of your init code ...

      Object.assign(window, {
        switchView, switchTeacherTab, openModal, closeModal,
        sortStudents, sortAssignments, toggleSelectAll, confirmDeleteSelectedStudents,
        openEditStudentModal, confirmDeleteStudent, openScoreAssignmentModal, openEditAssignmentModal, confirmDeleteAssignment,
        requestHelp, requestCheck, cancelHelpRequest, cancelCheckRequest, resolveRequest, logout,
        handleDragStart, handleDragEnd, handleDragOver, handleDragLeave, handleDrop
      });
    }

    init();
  </script>
</body>
</html>