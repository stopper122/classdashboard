import React, { useState, useEffect, useCallback } from 'react';
import { initializeApp } from 'firebase/app';
import { getFirestore, collection, doc, setDoc, onSnapshot, getDoc, updateDoc, writeBatch } from 'firebase/firestore';
import { getAuth, signInAnonymously, signInWithCustomToken } from 'firebase/auth';

// --- Helper Functions/Components ---

const Spinner = () => (
  <div className="flex justify-center items-center h-full">
    <div className="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-indigo-500"></div>
  </div>
);

const Modal = ({ title, message, onClose }) => (
  <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
    <div className="bg-white rounded-lg shadow-2xl p-6 w-full max-w-sm text-center">
      <h3 className="text-lg font-bold text-gray-800 mb-2">{title}</h3>
      <p className="text-gray-600 mb-4">{message}</p>
      <button
        onClick={onClose}
        className="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-50 transition-colors duration-300"
      >
        Close
      </button>
    </div>
  </div>
);


// --- Main App Component ---

export default function App() {
  // --- State Management ---
  const [view, setView] = useState('loading'); // loading, admin, studentLogin, studentDashboard
  const [students, setStudents] = useState([]);
  const [loggedInStudent, setLoggedInStudent] = useState(null);
  const [error, setError] = useState(null);
  const [modal, setModal] = useState(null); // {title, message}

  // Input states
  const [newStudentName, setNewStudentName] = useState('');
  const [newStudentId, setNewStudentId] = useState('');
  const [bulkStudents, setBulkStudents] = useState('');
  const [loginId, setLoginId] = useState('');

  // Firebase state
  const [db, setDb] = useState(null);
  const [isAuthReady, setIsAuthReady] = useState(false);
  
  const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

  // --- Firebase Initialization ---
  useEffect(() => {
    const initFirebase = async () => {
        try {
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
            const app = initializeApp(firebaseConfig);
            const firestore = getFirestore(app);
            const auth = getAuth(app);
            setDb(firestore);

            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
            setIsAuthReady(true);
        } catch (e) {
            console.error("Firebase initialization or auth error:", e);
            setError("Failed to initialize the application. Check your connection or configuration.");
            setView('error');
        }
    };
    initFirebase();
  }, [appId]);

  // --- Real-time Student Data Subscription ---
  useEffect(() => {
    if (!isAuthReady || !db) return;

    setView('admin'); // Default view after loading

    const studentsCollectionPath = `/artifacts/${appId}/public/data/students`;
    const studentsCollection = collection(db, studentsCollectionPath);
    
    const unsubscribe = onSnapshot(studentsCollection, (snapshot) => {
      const studentsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      setStudents(studentsData);
    }, (err) => {
      console.error("Error fetching students:", err);
      setError("Could not fetch student data in real-time.");
    });

    return () => unsubscribe();
  }, [isAuthReady, db, appId]);

  // --- Core Functions ---

  const addStudent = async (e) => {
    e.preventDefault();
    if (!newStudentName.trim() || !newStudentId.trim() || !db) return;

    const studentDocRef = doc(db, `/artifacts/${appId}/public/data/students`, newStudentId.trim());
    try {
      await setDoc(studentDocRef, {
        name: newStudentName.trim(),
        studentId: newStudentId.trim(),
        status: 'none' // 'none', 'help', 'check'
      });
      setNewStudentName('');
      setNewStudentId('');
      setModal({ title: 'Success', message: `Student ${newStudentName.trim()} added.` });
    } catch (err) {
      console.error("Error adding student:", err);
      setModal({ title: 'Error', message: 'Could not add the student.' });
    }
  };

  const handleBulkAdd = async () => {
    if (!bulkStudents.trim() || !db) return;

    const lines = bulkStudents.trim().split('\n');
    const studentsToAdd = [];
    
    lines.forEach(line => {
      const [name, id] = line.split(',').map(s => s.trim());
      if (name && id) {
        studentsToAdd.push({ name, id, status: 'none' });
      }
    });

    if (studentsToAdd.length === 0) {
      setModal({ title: 'Info', message: 'No valid student data found. Please use the format: Name, StudentID' });
      return;
    }

    const batch = writeBatch(db);
    studentsToAdd.forEach(student => {
      const studentDocRef = doc(db, `/artifacts/${appId}/public/data/students`, student.id);
      batch.set(studentDocRef, { name: student.name, studentId: student.id, status: student.status });
    });

    try {
      await batch.commit();
      setBulkStudents('');
      setModal({ title: 'Success', message: `${studentsToAdd.length} students have been added.` });
    } catch (err) {
      console.error("Error bulk adding students:", err);
      setModal({ title: 'Error', message: 'An error occurred during the bulk add.' });
    }
  };
  
  const handleStudentLogin = async (e) => {
      e.preventDefault();
      if (!loginId.trim() || !db) return;

      const studentDocRef = doc(db, `/artifacts/${appId}/public/data/students`, loginId.trim());
      try {
          const docSnap = await getDoc(studentDocRef);
          if (docSnap.exists()) {
              setLoggedInStudent({ id: docSnap.id, ...docSnap.data() });
              setView('studentDashboard');
              setLoginId('');
          } else {
              setModal({ title: 'Login Failed', message: 'Student ID not found.' });
          }
      } catch (err) {
          console.error("Login error:", err);
          setModal({ title: 'Error', message: 'Could not verify student ID.' });
      }
  };

  const updateStudentStatus = useCallback(async (studentId, newStatus) => {
    if(!db) return;
    const studentDocRef = doc(db, `/artifacts/${appId}/public/data/students`, studentId);
    try {
      await updateDoc(studentDocRef, { status: newStatus });
      if (loggedInStudent && loggedInStudent.id === studentId) {
        setLoggedInStudent(prev => ({ ...prev, status: newStatus }));
      }
    } catch (err) {
      console.error("Error updating status:", err);
      setModal({ title: 'Error', message: 'Failed to update status.' });
    }
  }, [db, loggedInStudent, appId]);

  const clearRequest = (studentId) => {
    updateStudentStatus(studentId, 'none');
  };

  const studentLogout = () => {
    setLoggedInStudent(null);
    setView('studentLogin');
  };

  // --- Render Logic ---

  const renderStatusTile = (student) => {
    const { status } = student;
    let bgColor = 'bg-white hover:bg-gray-100';
    let textColor = 'text-gray-700';
    let statusText = 'No request';

    if (status === 'help') {
      bgColor = 'bg-yellow-400 animate-pulse';
      textColor = 'text-yellow-900';
      statusText = 'Needs Help!';
    } else if (status === 'check') {
      bgColor = 'bg-blue-400 animate-pulse';
      textColor = 'text-blue-900';
      statusText = 'Assignment Check';
    }

    return (
      <div
        key={student.id}
        onClick={() => clearRequest(student.id)}
        className={`p-4 rounded-lg shadow-md transition-all duration-300 cursor-pointer text-center ${bgColor} ${textColor} flex flex-col justify-between`}
      >
        <h3 className="font-bold text-lg">{student.name}</h3>
        <p className="text-sm font-medium">{statusText}</p>
        <p className="text-xs text-gray-500 mt-2">{student.studentId}</p>
      </div>
    );
  };
  
  if (view === 'loading' || !isAuthReady) {
    return <div className="bg-gray-100 min-h-screen flex items-center justify-center"><Spinner /></div>;
  }
  
  if (view === 'error') {
      return <div className="bg-red-100 min-h-screen flex items-center justify-center text-red-700 p-4">{error}</div>;
  }
  
  const AdminView = (
    <div className="p-4 sm:p-6 md:p-8">
      <div className="flex justify-between items-center mb-6 flex-wrap gap-4">
        <h1 className="text-2xl sm:text-3xl font-bold text-gray-800">Teacher Dashboard</h1>
        <button onClick={() => setView('studentLogin')} className="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors">Switch to Student View</button>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
        {/* Add Single Student */}
        <div className="bg-white p-6 rounded-lg shadow-lg">
          <h2 className="text-xl font-semibold mb-4 text-gray-700">Add Student</h2>
          <form onSubmit={addStudent} className="space-y-4">
            <input type="text" value={newStudentName} onChange={e => setNewStudentName(e.target.value)} placeholder="Student Name" className="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500" required />
            <input type="text" value={newStudentId} onChange={e => setNewStudentId(e.target.value)} placeholder="Student ID" className="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500" required />
            <button type="submit" className="w-full bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 transition-colors">Add Student</button>
          </form>
        </div>

        {/* Bulk Add Students */}
        <div className="bg-white p-6 rounded-lg shadow-lg">
          <h2 className="text-xl font-semibold mb-4 text-gray-700">Bulk Add Students</h2>
          <textarea value={bulkStudents} onChange={e => setBulkStudents(e.target.value)} placeholder="One per line: Name, StudentID&#10;e.g., Jane Doe, 12345" className="w-full p-2 border border-gray-300 rounded-md h-24 resize-none focus:ring-2 focus:ring-indigo-500"></textarea>
          <button onClick={handleBulkAdd} className="w-full mt-4 bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 transition-colors">Bulk Add</button>
        </div>
      </div>

      <h2 className="text-2xl font-bold text-gray-800 mb-4">Student Status</h2>
      <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4">
        {students.length > 0 ? students.map(renderStatusTile) : <p className="col-span-full text-center text-gray-500">No students added yet.</p>}
      </div>
    </div>
  );

  const StudentLoginView = (
    <div className="flex flex-col items-center justify-center min-h-screen p-4">
       <div className="w-full max-w-sm">
         <div className="bg-white p-8 rounded-2xl shadow-2xl text-center">
            <h1 className="text-2xl font-bold text-gray-800 mb-2">Student Login</h1>
            <p className="text-gray-500 mb-6">Enter your Student ID to continue.</p>
            <form onSubmit={handleStudentLogin} className="space-y-4">
              <input type="text" value={loginId} onChange={e => setLoginId(e.target.value)} placeholder="Student ID" className="w-full p-3 border border-gray-300 rounded-lg text-center focus:ring-2 focus:ring-indigo-500" required />
              <button type="submit" className="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition-colors">Login</button>
            </form>
         </div>
         <button onClick={() => setView('admin')} className="mt-6 text-sm text-gray-600 hover:text-indigo-600 font-medium transition-colors">Switch to Teacher View</button>
       </div>
    </div>
  );

  const StudentDashboardView = (
     <div className="flex flex-col items-center justify-center min-h-screen p-4">
       <div className="w-full max-w-md text-center">
        <div className="bg-white p-8 rounded-2xl shadow-2xl">
            <h1 className="text-2xl font-bold text-gray-800">Welcome, {loggedInStudent?.name}!</h1>
            <p className="text-gray-500 mt-2 mb-6">How can we help you today?</p>
            
            <div className="space-y-4">
                 <button 
                    onClick={() => updateStudentStatus(loggedInStudent.id, 'help')} 
                    disabled={loggedInStudent?.status === 'help'}
                    className="w-full text-lg bg-yellow-400 text-yellow-900 font-bold py-4 px-4 rounded-lg hover:bg-yellow-500 transition-colors disabled:bg-yellow-200 disabled:cursor-not-allowed">
                     Request Help
                 </button>
                 <button 
                    onClick={() => updateStudentStatus(loggedInStudent.id, 'check')} 
                    disabled={loggedInStudent?.status === 'check'}
                    className="w-full text-lg bg-blue-400 text-blue-900 font-bold py-4 px-4 rounded-lg hover:bg-blue-500 transition-colors disabled:bg-blue-200 disabled:cursor-not-allowed">
                    Request Assignment Check
                 </button>
                 <button 
                    onClick={() => clearRequest(loggedInStudent.id)}
                    disabled={loggedInStudent?.status === 'none'}
                    className="w-full text-lg bg-gray-200 text-gray-700 font-bold py-3 px-4 rounded-lg hover:bg-gray-300 transition-colors disabled:opacity-50">
                    Clear My Request
                 </button>
            </div>
        </div>
        <button onClick={studentLogout} className="mt-6 bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600 transition-colors">Log Out</button>
       </div>
    </div>
  );

  return (
    <main className="bg-gray-100 min-h-screen font-sans">
      {modal && <Modal title={modal.title} message={modal.message} onClose={() => setModal(null)} />}
      {view === 'admin' && AdminView}
      {view === 'studentLogin' && StudentLoginView}
      {view === 'studentDashboard' && StudentDashboardView}
    </main>
  );
}

