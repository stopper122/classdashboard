<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Instructor Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, query, where, addDoc, updateDoc, deleteDoc, getDoc, getDocs, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // IMPORTANT: These global variables are provided by the canvas environment.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = {
  apiKey: "AIzaSyBX96xDY5ThDAZn-SckmsnfynMnQjvUc2I",
  authDomain: "helprequest-469c0.firebaseapp.com",
  projectId: "helprequest-469c0",
  storageBucket: "helprequest-469c0.firebasestorage.app",
  messagingSenderId: "1092775554304",
  appId: "1:1092775554304:web:e771c3ebac1e6ba4f597e5"
};
        setLogLevel('debug');

        let auth, db;
        let state = {
            periods: [],
            selectedPeriodId: null,
            students: [],
            assignments: [],
            requests: [],
            selectedStudent: null,
            sortOption: 'seatOrder',
            loading: true,
            isDragging: false,
            draggedId: null,
            draggedIndex: null,
            selectedAssignmentsForDeletion: [],
            showPasswordModal: false,
            passwordModalCallback: null,
            showAssignmentEditModal: false,
            selectedAssignmentForEdit: null,
            showConfirmModal: false,
            confirmModalMessage: '',
            confirmModalCallback: null
        };
        const TEACHER_PASSWORD = 'Rocket_22!!';

        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        const publicDataPath = `artifacts/${appId}/public/data`;

        // Sign in anonymously to get a user ID for private data access
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                if (state.loading) {
                    await startDataListeners();
                    state.loading = false;
                }
            } else {
                await signInAnonymously(auth);
            }
        });

        // Function to start real-time listeners for all data
        const startDataListeners = async () => {
            const userId = auth.currentUser?.uid || "anonymous_user";

            // Listen for periods
            onSnapshot(collection(db, `${publicDataPath}/periods`), (snapshot) => {
                state.periods = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (!state.selectedPeriodId && state.periods.length > 0) {
                    state.selectedPeriodId = state.periods[0].id;
                }
                renderUI();
            });

            // Listen for students and sort
            onSnapshot(collection(db, `${publicDataPath}/students`), (snapshot) => {
                state.students = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                sortStudents();
                renderUI();
            });
            
            // Listen for assignments
            onSnapshot(collection(db, `${publicDataPath}/assignments`), (snapshot) => {
                state.assignments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderUI();
            });

            // Listen for requests
            onSnapshot(collection(db, `${publicDataPath}/requests`), (snapshot) => {
                state.requests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderUI();
            });
        };

        const sortStudents = () => {
            const filteredStudents = state.students.filter(s => s.periodId === state.selectedPeriodId);
            if (state.sortOption === 'seatOrder') {
                state.students = filteredStudents.sort((a, b) => (a.seatOrder || 0) - (b.seatOrder || 0));
            } else if (state.sortOption === 'firstName') {
                state.students = filteredStudents.sort((a, b) => (a.firstName || '').localeCompare(b.firstName || ''));
            } else if (state.sortOption === 'lastName') {
                state.students = filteredStudents.sort((a, b) => (a.lastName || '').localeCompare(b.lastName || ''));
            }
            if (state.sortOption !== 'seatOrder') {
                state.students.forEach((s, i) => s.seatOrder = i);
            }
        };
        
        const renderAssignmentList = () => {
            const assignmentsInPeriod = state.assignments
                .filter(a => a.periodId === state.selectedPeriodId)
                .sort((a, b) => {
                    const dateA = new Date(a.datePosted);
                    const dateB = new Date(b.datePosted);
                    return dateB - dateA;
                });
            
            if (assignmentsInPeriod.length === 0) {
                return '<p class="text-gray-500">No assignments found for this period.</p>';
            }

            return assignmentsInPeriod.map(a => `
                <li class="p-2 border-b border-gray-200 last:border-b-0">
                    <button class="w-full text-left font-semibold text-gray-800 hover:text-blue-600 transition-colors duration-200"
                            onclick="handleEditAssignmentClick('${a.id}')">
                        ${a.title}
                    </button>
                    <p class="text-sm text-gray-500">Posted: ${new Date(a.datePosted).toLocaleDateString()}</p>
                    ${a.description ? `<p class="text-sm text-gray-700 mt-1">${a.description}</p>` : ''}
                </li>
            `).join('');
        };
        
        const renderAssignmentEditModal = () => {
            const assignment = state.selectedAssignmentForEdit;
            if (!assignment) return '';
            
            return `
                <div id="assignment-edit-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full ${state.showAssignmentEditModal ? '' : 'hidden'}">
                    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                        <div class="mt-3 text-center">
                            <h3 class="text-lg leading-6 font-medium text-gray-900">Edit Assignment</h3>
                            <div class="mt-2 px-7 py-3">
                                <p class="text-sm text-gray-500">Title:</p>
                                <input type="text" id="edit-assignment-title" value="${assignment.title}" class="mt-1 w-full px-4 py-2 border rounded-lg">
                                <p class="text-sm text-gray-500 mt-4">Description:</p>
                                <textarea id="edit-assignment-description" class="mt-1 w-full px-4 py-2 border rounded-lg" rows="4">${assignment.description || ''}</textarea>
                                <p class="text-sm text-gray-500 mt-4">Posted: ${new Date(assignment.datePosted).toLocaleDateString()}</p>
                            </div>
                            <div class="items-center px-4 py-3">
                                <button id="save-assignment-edit-btn" class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-700 focus:outline-none">
                                    Save
                                </button>
                                <button id="cancel-assignment-edit-btn" class="mt-2 px-4 py-2 bg-gray-300 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-400 focus:outline-none">
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        };

        const handleEditAssignmentClick = (assignmentId) => {
            state.selectedAssignmentForEdit = state.assignments.find(a => a.id === assignmentId);
            state.showAssignmentEditModal = true;
            renderUI();
        };
        window.handleEditAssignmentClick = handleEditAssignmentClick;

        const handleSaveAssignmentEdit = async () => {
            const saveBtn = document.getElementById('save-assignment-edit-btn');
            const originalText = saveBtn.textContent;
            saveBtn.disabled = true;
            saveBtn.textContent = 'Saving...';
            
            const newTitle = document.getElementById('edit-assignment-title').value.trim();
            const newDescription = document.getElementById('edit-assignment-description').value.trim();

            if (!newTitle) {
                state.showAssignmentEditModal = false;
                state.selectedAssignmentForEdit = null;
                renderUI();
                return;
            }

            if (state.selectedAssignmentForEdit) {
                try {
                    const assignmentRef = doc(db, `${publicDataPath}/assignments`, state.selectedAssignmentForEdit.id);
                    await updateDoc(assignmentRef, {
                        title: newTitle,
                        description: newDescription
                    });

                } catch (error) {
                    console.error("Error saving assignment edit:", error);
                } finally {
                    state.showAssignmentEditModal = false;
                    state.selectedAssignmentForEdit = null;
                    renderUI();
                }
            }
        };

        const renderUI = () => {
            const app = document.getElementById('app');
            if (state.loading) {
                app.innerHTML = `<div class="flex items-center justify-center h-screen"><div class="text-xl font-semibold">Loading...</div></div>`;
                return;
            }

            app.innerHTML = `
                <div class="min-h-screen bg-gray-100 p-4 font-sans">
                    <div class="max-w-7xl mx-auto bg-white p-6 rounded-xl shadow-lg">
                        <!-- Header -->
                        <div class="flex justify-between items-center mb-6">
                            <h1 class="text-4xl font-extrabold text-gray-800 tracking-tight">Assignment Tracker</h1>
                            <div class="flex items-center space-x-2">
                                <span class="text-sm text-gray-500">${auth.currentUser?.uid}</span>
                                <button id="clear-all-data-btn" class="text-sm bg-red-500 px-3 py-1 rounded-lg hover:bg-red-600 text-white font-bold">Clear All App Data</button>
                            </div>
                        </div>

                        <!-- Period Management -->
                        <div class="bg-gray-50 p-4 rounded-lg shadow-inner mb-6">
                            <h2 class="text-xl font-bold text-gray-700 mb-4">Period Management</h2>
                            <div class="flex flex-col md:flex-row md:items-center md:space-x-4 mb-4">
                                <div class="flex-1 mb-4 md:mb-0">
                                    <label for="period-select" class="block text-sm font-medium text-gray-700">Select Period:</label>
                                    <select id="period-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 rounded-md">
                                        ${state.periods.map(p => `<option value="${p.id}" ${p.id === state.selectedPeriodId ? 'selected' : ''}>${p.name}</option>`).join('')}
                                    </select>
                                </div>
                                <div class="flex-1 flex flex-col space-y-2">
                                    <input type="text" id="new-period-name" placeholder="New Period Name" class="px-3 py-2 border rounded-lg">
                                    <div class="flex space-x-2">
                                        <button id="add-period-btn" class="flex-1 bg-green-500 text-white font-bold py-2 rounded-lg hover:bg-green-600 transition-colors duration-200">
                                            Add Period
                                        </button>
                                        <button id="delete-period-btn" class="flex-1 bg-red-500 text-white font-bold py-2 rounded-lg hover:bg-red-600 transition-colors duration-200">
                                            Delete Selected Period
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Main Content -->
                        <div class="flex flex-col lg:flex-row lg:space-x-6">
                            <!-- Left Sidebar -->
                            <div class="w-full lg:w-1/4 space-y-6 mb-6 lg:mb-0">
                                <!-- Add Assignments Section -->
                                <div class="bg-gray-50 p-4 rounded-lg shadow-inner">
                                    <h2 class="text-xl font-bold text-gray-700 mb-2">Assignments</h2>
                                    <textarea id="new-assignment-titles" rows="4" placeholder="Paste assignment titles here (one per line)" class="w-full px-3 py-2 border rounded-lg mb-2"></textarea>
                                    <div class="flex space-x-2">
                                        
                                        <button id="add-assignments-btn" class="flex-1 bg-blue-500 text-white font-bold py-2 rounded-lg hover:bg-blue-600 transition-colors duration-200">
                                            Add Assignments
                                        </button>
                                    </div>
                                    <div class="mt-4">
                                        <h3 class="text-lg font-bold text-gray-700 mb-2">All Assignments</h3>
                                        <ul class="divide-y divide-gray-200">
                                            ${renderAssignmentList()}
                                        </ul>
                                    </div>
                                </div>
                                
                                <!-- Add Students Section -->
                                <div class="bg-gray-50 p-4 rounded-lg shadow-inner">
                                    <h2 class="text-xl font-bold text-gray-700 mb-2">Add Students & Seats</h2>
                                    <textarea id="student-roster" rows="6" placeholder="Paste student roster (one per line, e.g., Last, First, ID#)" class="w-full px-3 py-2 border rounded-lg mb-2"></textarea>
                                    <div class="flex space-x-2">
                                        <button id="add-students-btn" class="flex-1 bg-blue-500 text-white font-bold py-2 rounded-lg hover:bg-blue-600 transition-colors duration-200">
                                            Add Students
                                        </button>
                                        <button id="add-empty-seat-btn" class="flex-1 bg-gray-500 text-white font-bold py-2 rounded-lg hover:bg-gray-600 transition-colors duration-200">
                                            Add Empty Seat
                                        </button>
                                    </div>
                                    <button id="delete-all-students-btn" class="w-full mt-2 bg-red-500 text-white font-bold py-2 rounded-lg hover:bg-red-600 transition-colors duration-200">
                                        Delete All Students in Period
                                    </button>
                                </div>

                                <!-- Queue Display -->
                                <div class="bg-gray-50 p-4 rounded-lg shadow-inner">
                                    <h2 class="text-xl font-bold text-gray-700 mb-2">Help & Check Queue</h2>
                                    <div class="space-y-2">
                                        <div class="bg-red-100 p-2 rounded-md">
                                            <h3 class="font-semibold text-gray-700">Help Queue</h3>
                                            <ul id="help-queue-list" class="list-disc list-inside text-gray-600">
                                                ${state.requests.filter(r => r.type === 'help').sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp)).map((r, i) => {
                                                    const student = state.students.find(s => s.studentId === r.studentId);
                                                    const assignment = state.assignments.find(a => a.id === r.assignmentId);
                                                    if (!student) return '';
                                                    return `<li class="cursor-pointer hover:text-red-500 transition-colors" data-student-id="${student.id}">${i + 1}. ${student.name} - ${assignment ? assignment.title : 'N/A'}</li>`;
                                                }).join('')}
                                            </ul>
                                        </div>
                                        <div class="bg-blue-100 p-2 rounded-md">
                                            <h3 class="font-semibold text-gray-700">Check Queue</h3>
                                            <ul id="check-queue-list" class="list-disc list-inside text-gray-600">
                                                ${state.requests.filter(r => r.type === 'check').sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp)).map((r, i) => {
                                                    const student = state.students.find(s => s.studentId === r.studentId);
                                                    const assignment = state.assignments.find(a => a.id === r.assignmentId);
                                                    if (!student) return '';
                                                    return `<li class="cursor-pointer hover:text-blue-500 transition-colors" data-student-id="${student.id}">${i + 1}. ${student.name} - ${assignment ? assignment.title : 'N/A'}</li>`;
                                                }).join('')}
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Main Content Area -->
                            <div class="w-full lg:w-3/4 space-y-6">
                                <!-- Sort and Class Layout -->
                                <div class="bg-gray-50 p-4 rounded-lg shadow-inner">
                                    <div class="flex items-center space-x-4 mb-4">
                                        <span class="text-sm font-medium text-gray-700">Sort By:</span>
                                        <div class="flex space-x-2">
                                            <label class="inline-flex items-center">
                                                <input type="radio" name="sort-option" value="seatOrder" class="form-radio" ${state.sortOption === 'seatOrder' ? 'checked' : ''}>
                                                <span class="ml-2 text-gray-700">Assigned Seat</span>
                                            </label>
                                            <label class="inline-flex items-center">
                                                <input type="radio" name="sort-option" value="firstName" class="form-radio" ${state.sortOption === 'firstName' ? 'checked' : ''}>
                                                <span class="ml-2 text-gray-700">First Name</span>
                                            </label>
                                            <label class="inline-flex items-center">
                                                <input type="radio" name="sort-option" value="lastName" class="form-radio" ${state.sortOption === 'lastName' ? 'checked' : ''}>
                                                <span class="ml-2 text-gray-700">Last Name</span>
                                            </label>
                                        </div>
                                    </div>
                                    <div id="class-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4">
                                        ${state.students.filter(s => s.periodId === state.selectedPeriodId).map(s => {
                                            const hasHelpRequest = state.requests.some(r => r.studentId === s.studentId && r.type === 'help');
                                            const hasCheckRequest = state.requests.some(r => r.studentId === s.studentId && r.type === 'check');
                                            let backgroundColor;
                                            if (hasHelpRequest && hasCheckRequest) {
                                                backgroundColor = 'bg-purple-400';
                                            } else if (hasHelpRequest) {
                                                backgroundColor = 'bg-red-400';
                                            } else if (hasCheckRequest) {
                                                backgroundColor = 'bg-blue-400';
                                            } else {
                                                backgroundColor = 'bg-gray-200';
                                            }
                                            const textColor = hasHelpRequest || hasCheckRequest ? 'text-white' : 'text-gray-800';

                                            return `
                                                <div id="student-card-${s.id}" draggable="${state.sortOption === 'seatOrder'}"
                                                    class="student-card p-4 rounded-lg shadow cursor-pointer transition-colors duration-200
                                                    ${s.isPlaceholder ? 'border-2 border-dashed border-gray-400' : backgroundColor} ${textColor}
                                                    ${state.selectedStudent && state.selectedStudent.id === s.id ? 'ring-4 ring-blue-500' : ''}"
                                                    data-id="${s.id}" data-seat-order="${s.seatOrder}">
                                                    <div class="flex justify-between items-center mb-2">
                                                        <h3 class="font-bold">${s.isPlaceholder ? 'Empty Seat' : s.name}</h3>
                                                        ${s.isPlaceholder ? '' : `<button onclick="deleteStudent('${s.id}')" class="text-gray-600 hover:text-red-500 transition-colors ml-2">
                                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor">
                                                                    <path d="M18.3 5.71a.996.996 0 0 0-1.41 0L12 10.59 7.11 5.7A.996.996 0 1 0 5.7 7.11L10.59 12 5.7 16.89A.996.996 0 1 0 7.11 18.3L12 13.41l4.89 4.89a.996.996 0 1 0 1.41-1.41L13.41 12l4.89-4.89a.996.996 0 0 0 0-1.4z"/>
                                                                </svg>
                                                            </button>`}
                                                    </div>
                                                    <p class="text-sm">ID: ${s.studentId}</p>
                                                    ${hasHelpRequest ? `<span class="text-sm font-semibold">Help Queue: #${state.requests.filter(r => r.type === 'help').sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp)).findIndex(r => r.studentId === s.studentId) + 1}</span>` : ''}
                                                    ${hasCheckRequest ? `<span class="text-sm font-semibold">Check Queue: #${state.requests.filter(r => r.type === 'check').sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp)).findIndex(r => r.studentId === s.studentId) + 1}</span>` : ''}
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>
                                
                                <!-- Student Details -->
                                <div id="student-details" class="bg-gray-50 p-4 rounded-lg shadow-inner ${state.selectedStudent ? '' : 'hidden'}">
                                    <div class="flex justify-between items-center mb-4">
                                        <h2 class="text-xl font-bold text-gray-700">Assignments for ${state.selectedStudent ? state.selectedStudent.name : ''}</h2>
                                        <div class="flex space-x-2">
                                            <button id="clear-all-student-data-btn" class="text-sm bg-red-500 px-3 py-1 rounded-lg hover:bg-red-600 text-white font-bold">Clear All Student Data</button>
                                            <button id="copy-link-btn" class="text-sm bg-gray-300 px-3 py-1 rounded-lg hover:bg-gray-400">Share Student Link</button>
                                        </div>
                                    </div>
                                    <div id="student-assignments" class="space-y-4">
                                        <!-- Assignments will be rendered here -->
                                    </div>
                                    <div class="flex flex-col sm:flex-row justify-between items-center mt-4">
                                        <h3 class="font-bold text-lg mb-2 sm:mb-0">Active Requests</h3>
                                        <button id="delete-selected-assignments-btn" class="text-sm bg-red-500 px-3 py-1 rounded-lg hover:bg-red-600 text-white font-bold transition-colors duration-200" disabled>
                                            Delete Selected Assignments
                                        </button>
                                    </div>
                                    <ul id="active-requests-list" class="space-y-2 mt-4">
                                        <!-- Requests will be rendered here -->
                                    </ul>
                                    <button id="clear-all-requests-btn" class="mt-4 w-full bg-red-500 text-white font-bold py-2 rounded-lg hover:bg-red-600 transition-colors duration-200">
                                        Clear All Requests
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Password Modal -->
                <div id="password-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full ${state.showPasswordModal ? '' : 'hidden'}">
                    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                        <div class="mt-3 text-center">
                            <h3 class="text-lg leading-6 font-medium text-gray-900">Enter Password</h3>
                            <div class="mt-2 px-7 py-3">
                                <p class="text-sm text-gray-500">Please enter the teacher password to confirm this action.</p>
                                <input type="password" id="password-input" class="mt-4 w-full px-4 py-2 border rounded-lg">
                                <p id="password-error-message" class="mt-2 text-red-500 text-sm hidden">Incorrect password.</p>
                            </div>
                            <div class="items-center px-4 py-3">
                                <button id="password-modal-confirm-btn" class="px-4 py-2 bg-red-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500">
                                    Confirm
                                </button>
                                <button id="password-modal-cancel-btn" class="mt-2 px-4 py-2 bg-gray-300 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500">
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Assignment Edit Modal -->
                ${renderAssignmentEditModal()}
                <!-- Confirmation Modal -->
                <div id="confirm-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full ${state.showConfirmModal ? '' : 'hidden'}">
                    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                        <div class="mt-3 text-center">
                            <h3 class="text-lg leading-6 font-medium text-gray-900">Confirm Deletion</h3>
                            <div class="mt-2 px-7 py-3">
                                <p id="confirm-modal-message" class="text-sm text-gray-500">${state.confirmModalMessage}</p>
                            </div>
                            <div class="items-center px-4 py-3">
                                <button id="confirm-modal-confirm-btn" class="px-4 py-2 bg-red-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500">
                                    Confirm
                                </button>
                                <button id="confirm-modal-cancel-btn" class="mt-2 px-4 py-2 bg-gray-300 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500">
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Re-attach event listeners
            document.getElementById('period-select').addEventListener('change', (e) => {
                state.selectedPeriodId = e.target.value;
                sortStudents();
                renderUI();
            });
            document.getElementById('add-period-btn').addEventListener('click', handleAddPeriod);
            document.getElementById('delete-period-btn').addEventListener('click', () => {
                showConfirmModal(
                    'Are you sure you want to delete this period and all associated students, assignments, and requests? This cannot be undone.',
                    handleDeletePeriod
                );
            });
            document.getElementById('add-assignments-btn').addEventListener('click', handleAddAssignments);
            document.getElementById('add-students-btn').addEventListener('click', handleAddStudents);
            document.getElementById('add-empty-seat-btn').addEventListener('click', handleAddEmptySeat);
            document.getElementById('delete-all-students-btn').addEventListener('click', () => {
                 showPasswordModal(() => showConfirmModal(
                     'Are you sure you want to delete all students in the selected period? This cannot be undone.',
                     handleDeleteAllStudents
                 ));
            });
            document.getElementById('clear-all-data-btn').addEventListener('click', () => {
                showPasswordModal(() => showConfirmModal(
                    'Are you sure you want to clear all app data? This will delete all periods, students, assignments, and requests. This cannot be undone.',
                    handleClearAllAppData
                ));
            });

            document.querySelectorAll('input[name="sort-option"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    state.sortOption = e.target.value;
                    sortStudents();
                    renderUI();
                });
            });

            document.querySelectorAll('.student-card').forEach(card => {
                card.addEventListener('click', handleStudentSelect);
            });
            
            document.querySelectorAll('#help-queue-list li, #check-queue-list li').forEach(item => {
                item.addEventListener('click', handleQueueItemClick);
            });

            if (state.selectedStudent) {
                renderStudentDetails();
                document.getElementById('copy-link-btn').addEventListener('click', handleCopyLink);
                document.getElementById('clear-all-requests-btn').addEventListener('click', handleClearAllRequests);
                document.getElementById('delete-selected-assignments-btn').addEventListener('click', () => {
                     showPasswordModal(() => showConfirmModal(
                         'Are you sure you want to delete the selected assignments?',
                         handleDeleteMultipleAssignments
                     ));
                });
                document.getElementById('clear-all-student-data-btn').addEventListener('click', () => {
                    showPasswordModal(() => showConfirmModal(
                        'Are you sure you want to clear all data for this student? This cannot be undone.',
                        handleClearAllStudentData
                    ));
                });
            }

            if (state.showAssignmentEditModal) {
                document.getElementById('save-assignment-edit-btn').addEventListener('click', handleSaveAssignmentEdit);
                document.getElementById('cancel-assignment-edit-btn').addEventListener('click', () => {
                    state.showAssignmentEditModal = false;
                    renderUI();
                });
            }

            if (state.sortOption === 'seatOrder') {
                setupDragAndDrop();
            }
        };
        
        const showConfirmModal = (message, callback) => {
            state.showConfirmModal = true;
            state.confirmModalMessage = message;
            state.confirmModalCallback = callback;
            renderUI();
            
            const confirmBtn = document.getElementById('confirm-modal-confirm-btn');
            const cancelBtn = document.getElementById('confirm-modal-cancel-btn');

            const handleConfirm = async () => {
                state.showConfirmModal = false;
                state.loading = true;
                renderUI();
                await state.confirmModalCallback();
                state.loading = false;
                state.confirmModalCallback = null;
                renderUI();
            };

            const handleCancel = () => {
                state.showConfirmModal = false;
                state.confirmModalCallback = null;
                renderUI();
            };

            confirmBtn.addEventListener('click', handleConfirm);
            cancelBtn.addEventListener('click', handleCancel);
        };
        
        const showPasswordModal = (callback) => {
            state.showPasswordModal = true;
            state.passwordModalCallback = callback;
            renderUI();
            
            const passwordInput = document.getElementById('password-input');
            const confirmBtn = document.getElementById('password-modal-confirm-btn');
            const cancelBtn = document.getElementById('password-modal-cancel-btn');
            const errorMessageEl = document.getElementById('password-error-message');

            passwordInput.focus();

            const handleConfirm = async () => {
                const password = passwordInput.value;
                if (password === TEACHER_PASSWORD) {
                    errorMessageEl.classList.add('hidden');
                    state.showPasswordModal = false;
                    state.loading = true;
                    renderUI();
                    await state.passwordModalCallback();
                    state.loading = false;
                    state.passwordModalCallback = null;
                    renderUI();
                } else {
                    errorMessageEl.classList.remove('hidden');
                }
            };

            const handleCancel = () => {
                state.showPasswordModal = false;
                state.passwordModalCallback = null;
                renderUI();
            };

            confirmBtn.addEventListener('click', handleConfirm);
            cancelBtn.addEventListener('click', handleCancel);
        };

        const handleAddPeriod = async () => {
            const name = document.getElementById('new-period-name').value.trim();
            if (name) {
                const periodsRef = collection(db, `${publicDataPath}/periods`);
                await addDoc(periodsRef, { name, timestamp: new Date().toISOString() });
                document.getElementById('new-period-name').value = '';
            }
        };
        
        const handleDeletePeriod = async () => {
            if (!state.selectedPeriodId) return;
            const periodIdToDelete = state.selectedPeriodId;
            
            await runTransaction(db, async (transaction) => {
                // Get all students, assignments, and requests for the period
                const studentsQuery = query(collection(db, `${publicDataPath}/students`), where('periodId', '==', periodIdToDelete));
                const assignmentsQuery = query(collection(db, `${publicDataPath}/assignments`), where('periodId', '==', periodIdToDelete));
                const requestsQuery = query(collection(db, `${publicDataPath}/requests`), where('periodId', '==', periodIdToDelete));
                
                const studentsSnapshot = await getDocs(studentsQuery);
                const assignmentsSnapshot = await getDocs(assignmentsQuery);
                const requestsSnapshot = await getDocs(requestsQuery);

                // Delete all students in the period
                studentsSnapshot.forEach(doc => {
                    transaction.delete(doc.ref);
                });

                // Delete all assignments in the period
                assignmentsSnapshot.forEach(doc => {
                    transaction.delete(doc.ref);
                });

                // Delete all requests in the period
                requestsSnapshot.forEach(doc => {
                    transaction.delete(doc.ref);
                });

                // Finally, delete the period itself
                const periodRef = doc(db, `${publicDataPath}/periods`, periodIdToDelete);
                transaction.delete(periodRef);
            });

            // After deletion, reset selected period if the deleted one was selected
            if (state.selectedPeriodId === periodIdToDelete) {
                state.selectedPeriodId = null;
            }
        };

        const handleAddAssignments = async () => {
            const titles = document.getElementById('new-assignment-titles').value.split('\n').map(t => t.trim()).filter(t => t);
            
            if (!titles.length || !state.selectedPeriodId) return;
            
            const assignmentsRef = collection(db, `artifacts/${appId}/public/data/assignments`);
            const assignmentsInPeriodCount = state.assignments.filter(a => a.periodId === state.selectedPeriodId).length;

            for (let i = 0; i < titles.length; i++) {
                const title = titles[i];
                await addDoc(assignmentsRef, {
                    periodId: state.selectedPeriodId,
                    title,
                    datePosted: new Date().toISOString(),
                    assignmentOrder: assignmentsInPeriodCount + i,
                    completions: [],
                    description: ''
                });
            }
            document.getElementById('new-assignment-titles').value = '';
        };

        const handleAddStudents = async () => {
            const rosterText = document.getElementById('student-roster').value.trim();
            if (!rosterText || !state.selectedPeriodId) return;
            
            const lines = rosterText.split('\n').map(line => line.trim()).filter(line => line);
            if (lines.length === 0) return;

            const studentsRef = collection(db, `artifacts/${appId}/public/data/students`);
            
            let lastSeatOrder = -1;
            const existingStudentsInPeriod = state.students.filter(s => s.periodId === state.selectedPeriodId);
            if (existingStudentsInPeriod.length > 0) {
                lastSeatOrder = Math.max(...existingStudentsInPeriod.map(s => s.seatOrder || 0));
            }

            await runTransaction(db, async (transaction) => {
                const existingAssignmentsInPeriod = state.assignments.filter(a => a.periodId === state.selectedPeriodId).map(a => ({ id: a.id, completions: a.completions || [] }));
                let currentSeatOrder = lastSeatOrder;

                for (const line of lines) {
                    const parts = line.split(',').map(p => p.trim());
                    if (parts.length >= 3) {
                        const lastName = parts[0];
                        const firstName = parts[1];
                        const studentId = parts[2];
                        const name = `${firstName} ${lastName}`;
                        currentSeatOrder++;

                        const newStudentRef = doc(studentsRef);
                        const newStudentDoc = {
                            id: newStudentRef.id,
                            periodId: state.selectedPeriodId,
                            name,
                            firstName,
                            lastName,
                            studentId,
                            seatOrder: currentSeatOrder,
                            isPlaceholder: false
                        };
                        transaction.set(newStudentRef, newStudentDoc);

                        for (const assignment of existingAssignmentsInPeriod) {
                            const newCompletion = { studentId: newStudentDoc.studentId, score: null, isExcused: false, timestamp: new Date().toISOString() };
                            const assignmentRef = doc(db, `${publicDataPath}/assignments`, assignment.id);
                            const completions = [...assignment.completions, newCompletion];
                            transaction.update(assignmentRef, { completions });
                        }
                    }
                }
            });
            document.getElementById('student-roster').value = '';
        };

        const handleAddEmptySeat = async () => {
            if (!state.selectedPeriodId) return;
            const studentsRef = collection(db, `artifacts/${appId}/public/data/students`);
            const existingStudentsCount = state.students.filter(s => s.periodId === state.selectedPeriodId).length;
            await addDoc(studentsRef, {
                periodId: state.selectedPeriodId,
                name: "Empty Seat",
                studentId: `empty-${Date.now()}`,
                seatOrder: existingStudentsCount,
                isPlaceholder: true,
                firstName: "",
                lastName: ""
            });
        };
        
        const handleClearAllAppData = async () => {
            const publicDataPath = `artifacts/${appId}/public/data`;
            await runTransaction(db, async (transaction) => {
                const periodsRef = collection(db, `${publicDataPath}/periods`);
                const periodsSnapshot = await getDocs(periodsRef);
                periodsSnapshot.forEach(doc => transaction.delete(doc.ref));

                const studentsRef = collection(db, `${publicDataPath}/students`);
                const studentsSnapshot = await getDocs(studentsRef);
                studentsSnapshot.forEach(doc => transaction.delete(doc.ref));
                
                const assignmentsRef = collection(db, `${publicDataPath}/assignments`);
                const assignmentsSnapshot = await getDocs(assignmentsRef);
                assignmentsSnapshot.forEach(doc => transaction.delete(doc.ref));
                
                const requestsRef = collection(db, `${publicDataPath}/requests`);
                const requestsSnapshot = await getDocs(requestsRef);
                requestsSnapshot.forEach(doc => transaction.delete(doc.ref));
            });
            state.selectedPeriodId = null;
            state.selectedStudent = null;
        };

        const handleDeleteAllStudents = async () => {
            if (!state.selectedPeriodId) return;
            const publicDataPath = `artifacts/${appId}/public/data`;
            const studentsToDelete = state.students.filter(s => s.periodId === state.selectedPeriodId);
            
            await runTransaction(db, async (transaction) => {
                for (const student of studentsToDelete) {
                    const studentRef = doc(db, `${publicDataPath}/students`, student.id);
                    transaction.delete(studentRef);

                    // Delete all requests for this student
                    const requestsQuery = query(collection(db, `${publicDataPath}/requests`), where('studentId', '==', student.studentId));
                    const requestsSnapshot = await getDocs(requestsQuery);
                    requestsSnapshot.forEach(requestDoc => {
                        transaction.delete(requestDoc.ref);
                    });

                    // Remove completions for this student from all assignments
                    const assignmentsQuery = query(collection(db, `${publicDataPath}/assignments`), where('periodId', '==', state.selectedPeriodId));
                    const assignmentsSnapshot = await getDocs(assignmentsQuery);
                    assignmentsSnapshot.forEach(assignmentDoc => {
                        const completions = assignmentDoc.data().completions || [];
                        const updatedCompletions = completions.filter(c => c.studentId !== student.studentId);
                        transaction.update(assignmentDoc.ref, { completions: updatedCompletions });
                    });
                }
            });
        };

        const deleteStudent = async (studentId) => {
            const student = state.students.find(s => s.id === studentId);
            if (!student) return;

            const publicDataPath = `artifacts/${appId}/public/data`;
            
            await runTransaction(db, async (transaction) => {
                // Delete the student document
                const studentRef = doc(db, `${publicDataPath}/students`, studentId);
                transaction.delete(studentRef);

                // Delete all requests for this student
                const requestsQuery = query(collection(db, `${publicDataPath}/requests`), where('studentId', '==', student.studentId));
                const requestsSnapshot = await getDocs(requestsQuery);
                requestsSnapshot.forEach(requestDoc => {
                    transaction.delete(requestDoc.ref);
                });

                // Remove completions for this student from all assignments
                const assignmentsQuery = query(collection(db, `${publicDataPath}/assignments`), where('periodId', '==', student.periodId));
                const assignmentsSnapshot = await getDocs(assignmentsQuery);
                assignmentsSnapshot.forEach(assignmentDoc => {
                    const completions = assignmentDoc.data().completions || [];
                    const updatedCompletions = completions.filter(c => c.studentId !== student.studentId);
                    transaction.update(assignmentDoc.ref, { completions: updatedCompletions });
                });
            });

            if (state.selectedStudent && state.selectedStudent.id === studentId) {
                state.selectedStudent = null;
            }
        };
        window.deleteStudent = (studentId) => {
            showConfirmModal(
                `Are you sure you want to delete this student and all their data? This cannot be undone.`,
                () => deleteStudent(studentId)
            );
        };

        const handleStudentSelect = (e) => {
            const studentCard = e.currentTarget;
            const studentId = studentCard.dataset.id;
            state.selectedStudent = state.students.find(s => s.id === studentId);
            state.selectedAssignmentsForDeletion = [];
            renderUI();
        };

        const renderStudentDetails = () => {
            const detailsSection = document.getElementById('student-details');
            if (!detailsSection || !state.selectedStudent) return;
            
            const studentAssignmentsList = document.getElementById('student-assignments');
            studentAssignmentsList.innerHTML = state.assignments
                .filter(a => a.periodId === state.selectedStudent.periodId)
                .map(a => {
                    const completion = a.completions.find(c => c.studentId === state.selectedStudent.studentId);
                    const isExcused = completion ? completion.isExcused : false;
                    const score = completion ? completion.score : 0;
                    const isSelectedForDeletion = state.selectedAssignmentsForDeletion.includes(a.id);
                    
                    const descriptionHtml = a.description ? `<p class="text-sm text-gray-700 mt-2">${a.description}</p>` : '';

                    return `
                        <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 flex items-center space-x-2">
                            <input type="checkbox" class="form-checkbox h-5 w-5 text-red-600 rounded"
                                data-assignment-id="${a.id}"
                                ${isSelectedForDeletion ? 'checked' : ''}
                                onchange="handleAssignmentSelectionForDeletion('${a.id}', event)">
                            <div class="flex-1">
                                <div class="flex justify-between items-center">
                                    <span contenteditable="true" onblur="handleAssignmentEdit('${a.id}', this.innerText)" class="text-lg font-semibold text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-md p-1">${a.title}</span>
                                    <button onclick="deleteAssignment('${a.id}')" class="text-gray-600 hover:text-red-500 transition-colors ml-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M18.3 5.71a.996.996 0 0 0-1.41 0L12 10.59 7.11 5.7A.996.996 0 1 0 5.7 7.11L10.59 12 5.7 16.89A.996.996 0 1 0 7.11 18.3L12 13.41l4.89 4.89a.996.996 0 1 0 1.41-1.41L13.41 12l4.89-4.89a.996.996 0 0 0 0-1.4z"/>
                                        </svg>
                                    </button>
                                </div>
                                <p class="text-sm text-gray-500 mb-2">Posted: ${a.datePosted ? new Date(a.datePosted).toLocaleDateString() : 'N/A'}</p>
                                ${descriptionHtml}
                                <div class="flex items-center space-x-4">
                                    <div class="flex items-center space-x-1">
                                        ${[1, 2, 3, 4].map(s => `
                                            <input type="checkbox" id="score-${a.id}-${s}" 
                                                class="form-checkbox text-blue-600 rounded" 
                                                data-score="${s}"
                                                ${score >= s ? 'checked' : ''}
                                                onclick="handleScoreChange('${a.id}', ${s}, event)"
                                            >
                                            <label for="score-${a.id}-${s}" class="text-gray-700">${s}</label>
                                        `).join('')}
                                    </div>
                                    <label class="inline-flex items-center space-x-2 cursor-pointer">
                                        <input type="checkbox" id="excused-${a.id}" class="form-checkbox text-purple-600 rounded"
                                            ${isExcused ? 'checked' : ''}
                                            onclick="handleExcusedToggle('${a.id}', event)">
                                        <span class="${isExcused ? 'text-purple-600 font-semibold' : ''}">Excused</span>
                                    </label>
                                    <button onclick="clearCompletion('${a.id}')" class="text-gray-500 hover:text-red-500 transition-colors">Clear</button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            
            // Render active requests
            const requestsList = document.getElementById('active-requests-list');
            if (requestsList) {
                const studentRequests = state.requests.filter(r => r.studentId === state.selectedStudent.studentId);
                requestsList.innerHTML = studentRequests.length > 0 ? studentRequests.map(r => {
                    const assignment = state.assignments.find(a => a.id === r.assignmentId);
                    const type = r.type === 'help' ? 'Help' : 'Check';
                    return `
                        <li class="flex justify-between items-center p-2 rounded-md ${r.type === 'help' ? 'bg-red-100' : 'bg-blue-100'}">
                            <span>${type} on: ${assignment ? assignment.title : 'N/A'}</span>
                            <button onclick="clearSpecificRequest('${r.id}')" class="text-gray-500 hover:text-red-500">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M18.3 5.71a.996.996 0 0 0-1.41 0L12 10.59 7.11 5.7A.996.996 0 1 0 5.7 7.11L10.59 12 5.7 16.89A.996.996 0 1 0 7.11 18.3L12 13.41l4.89 4.89a.996.996 0 1 0 1.41-1.41L13.41 12l4.89-4.89a.996.996 0 0 0 0-1.4z"/>
                                </svg>
                            </button>
                        </li>
                    `;
                }).join('') : `<li class="text-gray-500">No active requests.</li>`;
            }
            // Update the state of the delete button
            const deleteButton = document.getElementById('delete-selected-assignments-btn');
            if (deleteButton) {
                deleteButton.disabled = state.selectedAssignmentsForDeletion.length === 0;
            }
        };
        window.handleAssignmentSelectionForDeletion = (assignmentId, event) => {
            if (event.target.checked) {
                state.selectedAssignmentsForDeletion.push(assignmentId);
            } else {
                state.selectedAssignmentsForDeletion = state.selectedAssignmentsForDeletion.filter(id => id !== assignmentId);
            }
            const deleteButton = document.getElementById('delete-selected-assignments-btn');
            if (deleteButton) {
                deleteButton.disabled = state.selectedAssignmentsForDeletion.length === 0;
            }
        };

        const handleAssignmentEdit = async (assignmentId, newTitle) => {
            const assignmentRef = doc(db, `${publicDataPath}/assignments`, assignmentId);
            await updateDoc(assignmentRef, { title: newTitle.trim() });
        };
        window.handleAssignmentEdit = handleAssignmentEdit;

        const handleDeleteAssignment = async (assignmentId) => {
            const publicDataPath = `artifacts/${appId}/public/data`;
            const assignmentRef = doc(db, `${publicDataPath}/assignments`, assignmentId);
            
            await runTransaction(db, async (transaction) => {
                const requestsQuery = query(collection(db, `${publicDataPath}/requests`), where('assignmentId', '==', assignmentId));
                const requestsSnapshot = await getDocs(requestsQuery);
                requestsSnapshot.forEach(doc => {
                    transaction.delete(doc.ref);
                });
                transaction.delete(assignmentRef);
            });
        };
        window.handleDeleteAssignment = (assignmentId) => {
            showConfirmModal(
                `Are you sure you want to delete this assignment and all associated student data? This cannot be undone.`,
                () => handleDeleteAssignment(assignmentId)
            );
        };

        const handleDeleteMultipleAssignments = async () => {
            const assignmentsToDelete = [...state.selectedAssignmentsForDeletion];
            state.selectedAssignmentsForDeletion = [];
            
            await runTransaction(db, async (transaction) => {
                const publicDataPath = `artifacts/${appId}/public/data`;
                for (const assignmentId of assignmentsToDelete) {
                    const assignmentRef = doc(db, `${publicDataPath}/assignments`, assignmentId);
                    transaction.delete(assignmentRef);

                    const requestsQuery = query(collection(db, `${publicDataPath}/requests`), where('assignmentId', '==', assignmentId));
                    const requestsSnapshot = await getDocs(requestsQuery);
                    requestsSnapshot.forEach(doc => {
                        transaction.delete(doc.ref);
                    });
                }
            });
            state.selectedStudent = null;
        };
        window.handleDeleteMultipleAssignments = handleDeleteMultipleAssignments;

        const handleScoreChange = async (assignmentId, score, event) => {
            const isChecked = event.target.checked;
            const assignmentRef = doc(db, `artifacts/${appId}/public/data/assignments`, assignmentId);
            const studentId = state.selectedStudent.studentId;

            await runTransaction(db, async (transaction) => {
                const assignmentDoc = await transaction.get(assignmentRef);
                const completions = assignmentDoc.data().completions || [];
                const existingCompletionIndex = completions.findIndex(c => c.studentId === studentId);
                
                let newScore = isChecked ? score : score -1;
                
                if (existingCompletionIndex !== -1) {
                    const updatedCompletions = [...completions];
                    if (!isChecked && newScore < 1) { // If the user unchecks the 1-star box
                         updatedCompletions.splice(existingCompletionIndex, 1);
                    } else {
                         updatedCompletions[existingCompletionIndex] = { ...updatedCompletions[existingCompletionIndex], score: newScore, isExcused: false, timestamp: new Date().toISOString() };
                    }
                    transaction.update(assignmentRef, { completions: updatedCompletions });
                } else {
                    if (isChecked) {
                        const newCompletion = { studentId, score: newScore, isExcused: false, timestamp: new Date().toISOString() };
                        transaction.update(assignmentRef, { completions: [...completions, newCompletion] });
                    }
                }
            });
            renderUI();
        };
        window.handleScoreChange = handleScoreChange;
        
        const handleExcusedToggle = async (assignmentId, event) => {
            const isChecked = event.target.checked;
            const assignmentRef = doc(db, `artifacts/${appId}/public/data/assignments`, assignmentId);
            const studentId = state.selectedStudent.studentId;

            await runTransaction(db, async (transaction) => {
                const assignmentDoc = await transaction.get(assignmentRef);
                const completions = assignmentDoc.data().completions || [];
                const existingCompletionIndex = completions.findIndex(c => c.studentId === studentId);
                
                if (existingCompletionIndex !== -1) {
                    const updatedCompletions = [...completions];
                    if (isChecked) {
                        updatedCompletions[existingCompletionIndex] = { ...updatedCompletions[existingCompletionIndex], score: null, isExcused: isChecked, timestamp: new Date().toISOString() };
                    } else {
                        updatedCompletions.splice(existingCompletionIndex, 1);
                    }
                    transaction.update(assignmentRef, { completions: updatedCompletions });
                } else {
                    if (isChecked) {
                        const newCompletion = { studentId, score: null, isExcused: isChecked, timestamp: new Date().toISOString() };
                        transaction.update(assignmentRef, { completions: [...completions, newCompletion] });
                    }
                }
            });
            renderUI();
        };
        window.handleExcusedToggle = handleExcusedToggle;

        const clearCompletion = async (assignmentId) => {
            const assignmentRef = doc(db, `artifacts/${appId}/public/data/assignments`, assignmentId);
            const studentId = state.selectedStudent.studentId;

            await runTransaction(db, async (transaction) => {
                const assignmentDoc = await transaction.get(assignmentRef);
                const completions = assignmentDoc.data().completions || [];
                const updatedCompletions = completions.filter(c => c.studentId !== studentId);
                transaction.update(assignmentRef, { completions: updatedCompletions });
            });
            renderUI();
        };
        window.clearCompletion = clearCompletion;
        
        const handleClearAllStudentData = async () => {
            if (!state.selectedStudent) return;
            const studentId = state.selectedStudent.studentId;
            
            await runTransaction(db, async (transaction) => {
                // Find all requests for this student
                const requestsQuery = query(collection(db, `${publicDataPath}/requests`), where('studentId', '==', studentId));
                const requestsSnapshot = await getDocs(requestsQuery);
                requestsSnapshot.forEach(doc => {
                    transaction.delete(doc.ref);
                });

                // Find all assignments for the student's period
                const assignmentsQuery = query(collection(db, `${publicDataPath}/assignments`), where('periodId', '==', state.selectedStudent.periodId));
                const assignmentsSnapshot = await getDocs(assignmentsQuery);
                
                // For each assignment, remove the completion record for the student
                assignmentsSnapshot.forEach(assignmentDoc => {
                    const completions = assignmentDoc.data().completions || [];
                    const updatedCompletions = completions.filter(c => c.studentId !== studentId);
                    transaction.update(doc(db, `${publicDataPath}/assignments`, assignmentDoc.id), { completions: updatedCompletions });
                });
            });
            state.selectedStudent = null;
        };
        window.handleClearAllStudentData = handleClearAllStudentData;

        const handleCopyLink = () => {
            const link = `${window.location.origin}/student.html?studentId=${state.selectedStudent.studentId}`;
            const tempInput = document.createElement('input');
            document.body.appendChild(tempInput);
            tempInput.value = link;
            tempInput.select();
            document.execCommand('copy');
            document.body.removeChild(tempInput);
        };
        window.handleCopyLink = handleCopyLink;

        const clearSpecificRequest = async (requestId) => {
            const requestRef = doc(db, `artifacts/${appId}/public/data/requests`, requestId);
            await deleteDoc(requestRef);
        };
        window.clearSpecificRequest = clearSpecificRequest;

        const handleClearAllRequests = async () => {
            if (!state.selectedStudent) return;
            const requestsRef = collection(db, `artifacts/${appId}/public/data/requests`);
            const q = query(requestsRef, where('studentId', '==', state.selectedStudent.studentId));
            const requestsSnapshot = await getDocs(q);
            requestsSnapshot.forEach(async (doc) => {
                await deleteDoc(doc.ref);
            });
        };
        window.handleClearAllRequests = handleClearAllRequests;
        
        const handleQueueItemClick = (e) => {
            const studentId = e.currentTarget.dataset.id;
            state.selectedStudent = state.students.find(s => s.id === studentId);
            renderUI();
            const detailsSection = document.getElementById('student-details');
            if (detailsSection) {
                detailsSection.scrollIntoView({ behavior: 'smooth' });
            }
        };

        const setupDragAndDrop = () => {
            const classGrid = document.getElementById('class-grid');
            let dragSrcEl = null;
        
            const handleDragStart = (e) => {
                dragSrcEl = e.currentTarget;
                dragSrcEl.style.opacity = '0.4';
                state.isDragging = true;
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', dragSrcEl.dataset.id);
            };
        
            const handleDragOver = (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                e.currentTarget.classList.add('bg-blue-200');
            };
        
            const handleDragLeave = (e) => {
                e.currentTarget.classList.remove('bg-blue-200');
            };
        
            const handleDrop = async (e) => {
                e.preventDefault();
                e.currentTarget.classList.remove('bg-blue-200');
                
                if (dragSrcEl === e.currentTarget) {
                    return;
                }
        
                const studentIdToMove = dragSrcEl.dataset.id;
                const targetStudentId = e.currentTarget.dataset.id;
                
                if (state.students.filter(s => s.periodId === state.selectedPeriodId).length < 2) return;
        
                const studentsRef = collection(db, `artifacts/${appId}/public/data/students`);
        
                await runTransaction(db, async (transaction) => {
                    const studentsSnapshot = await getDocs(query(studentsRef, where('periodId', '==', state.selectedPeriodId)));
                    const studentDocs = studentsSnapshot.docs;
        
                    const students = studentDocs.map(doc => ({ id: doc.id, ...doc.data() }));
                    students.sort((a, b) => a.seatOrder - b.seatOrder);
        
                    const studentToMoveIndex = students.findIndex(s => s.id === studentIdToMove);
                    const targetIndex = students.findIndex(s => s.id === targetStudentId);
        
                    const [studentToMove] = students.splice(studentToMoveIndex, 1);
                    students.splice(targetIndex, 0, studentToMove);
        
                    students.forEach((s, index) => {
                        const newOrder = index;
                        if (s.seatOrder !== newOrder) {
                            transaction.update(doc(db, `${studentsRef.path}/${s.id}`), { seatOrder: newOrder });
                        }
                    });
                });
            };
        
            const handleDragEnd = (e) => {
                e.currentTarget.style.opacity = '1';
                state.isDragging = false;
                document.querySelectorAll('.student-card').forEach(card => card.classList.remove('bg-blue-200'));
            };
        
            document.querySelectorAll('.student-card[draggable="true"]').forEach(card => {
                card.addEventListener('dragstart', handleDragStart);
                card.addEventListener('dragover', handleDragOver);
                card.addEventListener('dragleave', handleDragLeave);
                card.addEventListener('drop', handleDrop);
                card.addEventListener('dragend', handleDragEnd);
            });
        };

        document.addEventListener('DOMContentLoaded', () => {
            renderUI();
        });
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
    </style>
</head>
<body>
    <div id="app"></div>
</body>
</html>
