<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Class Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: system-ui, sans-serif; }
    .active { display: block; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .dragging { opacity: 0.5; }
    .dragging-over { background-color: #f0f9ff; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">

  <!-- Teacher Login View -->
  <div id="teacher-login-view" class="view active p-6">
    <h1 class="text-2xl font-bold mb-4">Teacher Login</h1>
    <form id="teacher-login-form" class="space-y-4">
      <input type="text" id="teacher-username" placeholder="Username" class="w-full p-2 border rounded">
      <input type="password" id="teacher-password" placeholder="Password" class="w-full p-2 border rounded">
      <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded">Login</button>
    </form>
  </div>

  <!-- Student Login View -->
  <div id="student-login-view" class="view p-6 hidden">
    <h1 class="text-2xl font-bold mb-4">Student Login</h1>
    <form id="student-login-form" class="space-y-4">
      <input type="text" id="student-id" placeholder="Student ID" class="w-full p-2 border rounded">
      <button type="submit" class="bg-green-500 text-white px-4 py-2 rounded">Login</button>
    </form>
  </div>

  <!-- Teacher Dashboard -->
  <div id="teacher-dashboard" class="view hidden p-6">
    <h1 class="text-2xl font-bold mb-4">Teacher Dashboard</h1>
    <div class="tabs flex space-x-4 mb-6">
      <button data-tab="students" class="tab-button px-4 py-2 bg-gray-200 rounded">Students</button>
      <button data-tab="assignments" class="tab-button px-4 py-2 bg-gray-200 rounded">Assignments</button>
      <button data-tab="seating" class="tab-button px-4 py-2 bg-gray-200 rounded">Seating</button>
      <button data-tab="help" class="tab-button px-4 py-2 bg-gray-200 rounded">Help Requests</button>
      <button data-tab="check" class="tab-button px-4 py-2 bg-gray-200 rounded">Check Requests</button>
    </div>
    <!-- Students Tab -->
    <div id="tab-students" class="tab-content active">
      <h2 class="text-xl font-semibold mb-4">Students</h2>
      <button id="add-student-btn" class="bg-blue-500 text-white px-4 py-2 rounded mb-4">Add Student</button>
      <button id="bulk-upload-btn" class="bg-purple-500 text-white px-4 py-2 rounded mb-4">Bulk Upload</button>
      <ul id="student-list" class="space-y-2"></ul>
    </div>

    <!-- Assignments Tab -->
    <div id="tab-assignments" class="tab-content hidden">
      <h2 class="text-xl font-semibold mb-4">Assignments</h2>
      <button id="add-assignment-btn" class="bg-blue-500 text-white px-4 py-2 rounded mb-4">Add Assignment</button>
      <ul id="assignment-list" class="space-y-2"></ul>
    </div>

    <!-- Seating Tab -->
    <div id="tab-seating" class="tab-content hidden">
      <h2 class="text-xl font-semibold mb-4">Seating Chart</h2>
      <div id="seating-grid" class="grid grid-cols-6 gap-2"></div>
      <h3 class="text-lg font-semibold mt-6">Unseated Students</h3>
      <div id="unseated-students" class="flex flex-wrap gap-2 mt-2"></div>
    </div>

    <!-- Help Requests Tab -->
    <div id="tab-help" class="tab-content hidden">
      <h2 class="text-xl font-semibold mb-4">Help Requests</h2>
      <ul id="help-request-list" class="space-y-2"></ul>
    </div>

    <!-- Check Requests Tab -->
    <div id="tab-check" class="tab-content hidden">
      <h2 class="text-xl font-semibold mb-4">Check Requests</h2>
      <ul id="check-request-list" class="space-y-2"></ul>
    </div>
  </div>

  <!-- Student Dashboard -->
  <div id="student-dashboard" class="view hidden p-6">
    <h1 class="text-2xl font-bold mb-4">Student Dashboard</h1>
    <div class="tabs flex space-x-4 mb-6">
      <button data-tab="my-assignments" class="tab-button px-4 py-2 bg-gray-200 rounded">My Assignments</button>
      <button data-tab="request-help" class="tab-button px-4 py-2 bg-gray-200 rounded">Request Help</button>
      <button data-tab="request-check" class="tab-button px-4 py-2 bg-gray-200 rounded">Request Check</button>
    </div>

    <!-- My Assignments Tab -->
    <div id="tab-my-assignments" class="tab-content active">
      <h2 class="text-xl font-semibold mb-4">My Assignments</h2>
      <ul id="my-assignment-list" class="space-y-2"></ul>
    </div>

    <!-- Request Help Tab -->
    <div id="tab-request-help" class="tab-content hidden">
      <h2 class="text-xl font-semibold mb-4">Request Help</h2>
      <button id="request-help-btn" class="bg-yellow-500 text-white px-4 py-2 rounded">Request Help</button>
    </div>

    <!-- Request Check Tab -->
    <div id="tab-request-check" class="tab-content hidden">
      <h2 class="text-xl font-semibold mb-4">Request Check</h2>
      <button id="request-check-btn" class="bg-green-500 text-white px-4 py-2 rounded">Request Check</button>
    </div>
  </div>

  <!-- Add Student Modal -->
  <div id="add-student-modal" class="hidden fixed inset-0 flex items-center justify-center bg-black bg-opacity-50">
    <div class="bg-white p-6 rounded shadow-md w-96">
      <h2 class="text-xl font-semibold mb-4">Add Student</h2>
      <form id="add-student-form" class="space-y-4">
        <input type="text" id="student-id-input" placeholder="Student ID" class="w-full p-2 border rounded">
        <input type="text" id="student-firstname-input" placeholder="First Name" class="w-full p-2 border rounded">
        <input type="text" id="student-lastname-input" placeholder="Last Name" class="w-full p-2 border rounded">
        <div class="flex justify-end space-x-2">
          <button type="button" onclick="closeModal('add-student-modal')" class="px-4 py-2 bg-gray-300 rounded">Cancel</button>
          <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded">Add</button>
        </div>
      </form>
    </div>
  </div>
  <!-- Bulk Upload Modal -->
  <div id="bulk-upload-modal" class="hidden fixed inset-0 flex items-center justify-center bg-black bg-opacity-50">
    <div class="bg-white p-6 rounded shadow-md w-96">
      <h2 class="text-xl font-semibold mb-4">Bulk Upload Students</h2>
      <form id="bulk-upload-form" class="space-y-4">
        <textarea id="bulk-student-data" rows="6" placeholder="Enter students: ID, FirstName, LastName (one per line)" class="w-full p-2 border rounded"></textarea>
        <div class="flex justify-end space-x-2">
          <button type="button" onclick="closeModal('bulk-upload-modal')" class="px-4 py-2 bg-gray-300 rounded">Cancel</button>
          <button type="submit" class="bg-purple-500 text-white px-4 py-2 rounded">Upload</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Add Assignment Modal -->
  <div id="add-assignment-modal" class="hidden fixed inset-0 flex items-center justify-center bg-black bg-opacity-50">
    <div class="bg-white p-6 rounded shadow-md w-96">
      <h2 class="text-xl font-semibold mb-4">Add Assignment</h2>
      <form id="add-assignment-form" class="space-y-4">
        <input type="text" id="assignment-title-input" placeholder="Assignment Title" class="w-full p-2 border rounded">
        <div class="flex justify-end space-x-2">
          <button type="button" onclick="closeModal('add-assignment-modal')" class="px-4 py-2 bg-gray-300 rounded">Cancel</button>
          <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded">Add</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Success Message -->
  <div id="success-message" class="hidden fixed bottom-4 right-4 bg-green-500 text-white px-4 py-2 rounded shadow"></div>

  <!-- Script -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { 
      getFirestore, doc, addDoc, setDoc, updateDoc, deleteDoc, 
      onSnapshot, collection, query, where, writeBatch, getDocs 
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyCG3rtswPSuTocyRDqRPhzHEF9pB3Hkgos",
      authDomain: "classdashboard-d8c4d.firebaseapp.com",
      projectId: "classdashboard-d8c4d",
      storageBucket: "classdashboard-d8c4d.firebasestorage.app",
      messagingSenderId: "409652457373",
      appId: "1:409652457373:web:241cc1a53b39fc71fa8974",
      measurementId: "G-KXJVNZKTRQ"
    };

    // Globals
    let db, auth;
    let students = [];
    let assignments = [];
    let helpRequests = [];
    let checkRequests = [];
    let seatingChart = [];

    let studentsCol, assignmentsCol, helpRequestsCol, checkRequestsCol, seatingChartDoc;

    async function initFirebase() {
      try {
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        await signInAnonymously(auth);

        studentsCol = collection(db, "students");
        assignmentsCol = collection(db, "assignments");
        helpRequestsCol = collection(db, "helpRequests");
        checkRequestsCol = collection(db, "checkRequests");
        seatingChartDoc = doc(db, "seatingChart/main");

        loadData();
      } catch (error) {
        console.error("Firebase initialization failed:", error.code, error.message);
      }
    }

    initFirebase();
    // Utility: show success messages
    function showSuccessMessage(msg) {
      const el = document.getElementById("success-message");
      el.textContent = msg;
      el.classList.remove("hidden");
      setTimeout(() => el.classList.add("hidden"), 3000);
    }

    // Utility: close modal
    function closeModal(id) {
      document.getElementById(id).classList.add("hidden");
    }

    // Bulk upload
    document.getElementById('bulk-upload-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      const form = this;
      const data = document.getElementById('bulk-student-data').value;
      const lines = data.split('\n');
      const studentsToProcess = [];
      const processedIds = new Set();

      for (const line of lines) {
        const trimmedLine = line.trim();
        if (!trimmedLine) continue;
        const parts = trimmedLine.split(',');
        if (parts.length === 3) {
          const id = parseInt(parts[0].trim(), 10);
          const firstName = parts[1].trim();
          const lastName = parts[2].trim();
          if (!isNaN(id) && firstName && lastName && !processedIds.has(id)) {
            studentsToProcess.push({ id, firstName, lastName });
            processedIds.add(id);
          }
        }
      }

      if (studentsToProcess.length === 0) {
        showSuccessMessage("No valid new students found in the provided data.");
        closeModal('bulk-upload-modal');
        form.reset();
        return;
      }

      try {
        const existingIds = new Set(students.map(s => s.id));
        const studentsToUpload = studentsToProcess.filter(s => !existingIds.has(s.id));
        const skippedCount = studentsToProcess.length - studentsToUpload.length;

        if (studentsToUpload.length > 0) {
          const batch = writeBatch(db);
          studentsToUpload.forEach(student => {
            const newStudentRef = doc(studentsCol);
            batch.set(newStudentRef, student);
          });
          await batch.commit();
        }

        let message = "";
        if (studentsToUpload.length > 0) {
          message += `${studentsToUpload.length} student(s) added successfully. `;
        }
        if (skippedCount > 0) {
          message += `${skippedCount} student(s) were skipped as their IDs already exist.`;
        }
        if (!message) {
          message = "All students in the list already exist.";
        }
        showSuccessMessage(message.trim());

      } catch (error) {
        console.error("Error during bulk upload:", error.code, error.message);
        showSuccessMessage("Error: " + error.message);
      } finally {
        closeModal('bulk-upload-modal');
        form.reset();
      }
    });

    // Seating Chart persistence
    async function saveSeatingChart() {
      try {
        await setDoc(seatingChartDoc, { chart: seatingChart });
      } catch (error) {
        console.error("Error saving seating chart:", error.code, error.message);
        throw error;
      }
    }

    // Drag/drop handlers
    function handleDragStart(e) {
      e.dataTransfer.effectAllowed = "move";
      const payload = JSON.stringify({ type: this.dataset.type, id: this.dataset.id, originSeatIndex: this.dataset.seatIndex });
      e.dataTransfer.setData("application/json", payload);
      e.dataTransfer.setData("text/plain", payload); // fallback
      this.classList.add("dragging");
    }

    function handleDragEnd() {
      this.classList.remove("dragging");
    }

    async function handleDrop(event) {
      event.preventDefault();
      this.classList.remove('dragging-over');

      let payloadRaw = null;
      try {
        payloadRaw = event.dataTransfer.getData('application/json');
      } catch (e) {}
      if (!payloadRaw) {
        try { payloadRaw = event.dataTransfer.getData('text/plain'); } catch (e) {}
      }
      if (!payloadRaw) return;

      let payload;
      try {
        payload = JSON.parse(payloadRaw);
      } catch (e) {
        payload = { type: 'roster_student', id: isNaN(Number(payloadRaw)) ? payloadRaw : Number(payloadRaw) };
      }

      const targetSeatIndex = parseInt(this.dataset.seatIndex, 10);
      const itemAtTarget = seatingChart[targetSeatIndex];

      if (payload.type === 'roster_student') {
        const prevIndex = seatingChart.findIndex(x => x === payload.id);
        if (prevIndex !== -1) seatingChart[prevIndex] = null;
        seatingChart[targetSeatIndex] = payload.id;
      } else if (payload.type === 'new_blank_seat') {
        seatingChart[targetSeatIndex] = 'BLANK';
      } else if (payload.type === 'grid_seat') {
        const originSeatIndex = payload.originSeatIndex;
        const itemAtOrigin = seatingChart[originSeatIndex];
        seatingChart[originSeatIndex] = itemAtTarget;
        seatingChart[targetSeatIndex] = itemAtOrigin;
      }

      try {
        await saveSeatingChart();
        renderSeatingChart();
        renderUnseatedStudentList();
        showSuccessMessage('Seat assignment saved.');
      } catch (err) {
        console.error('Could not persist seating chart:', err);
        showSuccessMessage('Error: could not save seat assignment.');
      }
    }
    // Drag Over
    function handleDragOver(e) {
      e.preventDefault();
      this.classList.add("dragging-over");
    }

    function handleDragLeave() {
      this.classList.remove("dragging-over");
    }

    // Render Seating Chart
    function renderSeatingChart() {
      const grid = document.getElementById("seating-grid");
      grid.innerHTML = "";
      seatingChart.forEach((item, index) => {
        const seat = document.createElement("div");
        seat.className = "w-24 h-24 border flex items-center justify-center bg-white rounded shadow";
        seat.dataset.seatIndex = index;
        seat.addEventListener("dragover", handleDragOver);
        seat.addEventListener("dragleave", handleDragLeave);
        seat.addEventListener("drop", handleDrop);

        if (item === "BLANK") {
          seat.textContent = "Blank";
          seat.classList.add("bg-gray-200");
        } else if (item) {
          const student = students.find(s => s.id === item || String(s.id) === String(item));
          if (student) {
            seat.textContent = `${student.firstName} ${student.lastName}`;
          }
          seat.draggable = true;
          seat.dataset.type = "grid_seat";
          seat.dataset.id = item;
          seat.addEventListener("dragstart", handleDragStart);
          seat.addEventListener("dragend", handleDragEnd);
        }

        grid.appendChild(seat);
      });
    }

    function renderUnseatedStudentList() {
      const container = document.getElementById("unseated-students");
      container.innerHTML = "";
      students.forEach(student => {
        if (!seatingChart.includes(student.id)) {
          const div = document.createElement("div");
          div.textContent = `${student.firstName} ${student.lastName}`;
          div.className = "px-2 py-1 bg-blue-200 rounded cursor-move";
          div.draggable = true;
          div.dataset.type = "roster_student";
          div.dataset.id = student.id;
          div.addEventListener("dragstart", handleDragStart);
          div.addEventListener("dragend", handleDragEnd);
          container.appendChild(div);
        }
      });
    }

    // Load Data from Firestore
    function loadData() {
      // Students
      onSnapshot(studentsCol, (snapshot) => {
        students = snapshot.docs.map(doc => doc.data());
        const list = document.getElementById("student-list");
        list.innerHTML = "";
        students.forEach(s => {
          const li = document.createElement("li");
          li.textContent = `${s.id}: ${s.firstName} ${s.lastName}`;
          list.appendChild(li);
        });
        renderUnseatedStudentList();
      });

      // Assignments
      onSnapshot(assignmentsCol, (snapshot) => {
        assignments = snapshot.docs.map(doc => doc.data());
        const list = document.getElementById("assignment-list");
        list.innerHTML = "";
        assignments.forEach(a => {
          const li = document.createElement("li");
          li.textContent = a.title;
          list.appendChild(li);
        });

        const myList = document.getElementById("my-assignment-list");
        if (myList) {
          myList.innerHTML = "";
          assignments.forEach(a => {
            const li = document.createElement("li");
            li.textContent = a.title;
            myList.appendChild(li);
          });
        }
      });

      // Help Requests
      onSnapshot(helpRequestsCol, (snapshot) => {
        helpRequests = snapshot.docs.map(doc => doc.data());
        const list = document.getElementById("help-request-list");
        list.innerHTML = "";
        helpRequests.forEach(r => {
          const li = document.createElement("li");
          li.textContent = `Student ${r.studentId} requested help`;
          list.appendChild(li);
        });
      });

      // Check Requests
      onSnapshot(checkRequestsCol, (snapshot) => {
        checkRequests = snapshot.docs.map(doc => doc.data());
        const list = document.getElementById("check-request-list");
        list.innerHTML = "";
        checkRequests.forEach(r => {
          const li = document.createElement("li");
          li.textContent = `Student ${r.studentId} requested check`;
          list.appendChild(li);
        });
      });

      // Seating Chart
      onSnapshot(seatingChartDoc, (docSnap) => {
        if (docSnap.exists()) {
          seatingChart = docSnap.data().chart || [];
        } else {
          seatingChart = Array(30).fill(null);
        }
        renderSeatingChart();
        renderUnseatedStudentList();
      });
    }
    // Add Student
    document.getElementById("add-student-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const id = parseInt(document.getElementById("student-id-input").value.trim(), 10);
      const firstName = document.getElementById("student-firstname-input").value.trim();
      const lastName = document.getElementById("student-lastname-input").value.trim();
      if (!id || !firstName || !lastName) return;

      try {
        await addDoc(studentsCol, { id, firstName, lastName });
        showSuccessMessage("Student added.");
        closeModal("add-student-modal");
        e.target.reset();
      } catch (error) {
        console.error("Error adding student:", error);
      }
    });

    // Add Assignment
    document.getElementById("add-assignment-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const title = document.getElementById("assignment-title-input").value.trim();
      if (!title) return;

      try {
        await addDoc(assignmentsCol, { title });
        showSuccessMessage("Assignment added.");
        closeModal("add-assignment-modal");
        e.target.reset();
      } catch (error) {
        console.error("Error adding assignment:", error);
      }
    });

    // Student Actions
    document.getElementById("request-help-btn").addEventListener("click", async () => {
      try {
        await addDoc(helpRequestsCol, { studentId: currentStudentId(), timestamp: Date.now() });
        showSuccessMessage("Help request sent.");
      } catch (error) {
        console.error("Error requesting help:", error);
      }
    });

    document.getElementById("request-check-btn").addEventListener("click", async () => {
      try {
        await addDoc(checkRequestsCol, { studentId: currentStudentId(), timestamp: Date.now() });
        showSuccessMessage("Check request sent.");
      } catch (error) {
        console.error("Error requesting check:", error);
      }
    });

    function currentStudentId() {
      const idInput = document.getElementById("student-id");
      return idInput ? idInput.value.trim() : null;
    }

    // Tabs
    document.querySelectorAll(".tab-button").forEach(btn => {
      btn.addEventListener("click", () => {
        const parent = btn.closest(".view");
        parent.querySelectorAll(".tab-content").forEach(tab => tab.classList.add("hidden"));
        parent.querySelectorAll(".tab-button").forEach(b => b.classList.remove("bg-blue-500", "text-white"));
        const tabId = "tab-" + btn.dataset.tab;
        document.getElementById(tabId).classList.remove("hidden");
        btn.classList.add("bg-blue-500", "text-white");
      });
    });

    // Open modals
    document.getElementById("add-student-btn").addEventListener("click", () => {
      document.getElementById("add-student-modal").classList.remove("hidden");
    });

    document.getElementById("bulk-upload-btn").addEventListener("click", () => {
      document.getElementById("bulk-upload-modal").classList.remove("hidden");
    });

    document.getElementById("add-assignment-btn").addEventListener("click", () => {
      document.getElementById("add-assignment-modal").classList.remove("hidden");
    });

    // Login forms
    document.getElementById("teacher-login-form").addEventListener("submit", (e) => {
      e.preventDefault();
      document.getElementById("teacher-login-view").classList.add("hidden");
      document.getElementById("teacher-dashboard").classList.remove("hidden");
    });

    document.getElementById("student-login-form").addEventListener("submit", (e) => {
      e.preventDefault();
      document.getElementById("student-login-view").classList.add("hidden");
      document.getElementById("student-dashboard").classList.remove("hidden");
    });
  </script>
</body>
</html>
