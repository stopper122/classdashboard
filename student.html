<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, collection, query, where, addDoc, deleteDoc, updateDoc, getDocs, runTransaction, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = {
  apiKey: "AIzaSyBX96xDY5ThDAZn-SckmsnfynMnQjvUc2I",
  authDomain: "helprequest-469c0.firebaseapp.com",
  projectId: "helprequest-469c0",
  storageBucket: "helprequest-469c0.firebasestorage.app",
  messagingSenderId: "1092775554304",
  appId: "1:1092775554304:web:e771c3ebac1e6ba4f597e5"
};
        setLogLevel('debug');

        let auth, db;
        let state = {
            student: null,
            assignments: [],
            requests: [],
            loading: true,
            loginFailed: false,
            loginMessage: '',
            sortOption: 'number',
            sortAscending: true
        };

        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                const params = new URLSearchParams(window.location.search);
                const studentIdFromUrl = params.get('studentId');
                if (studentIdFromUrl) {
                    await handleLogin({ studentId: studentIdFromUrl });
                }
                state.loading = false;
                renderUI();
            } else {
                await signInAnonymously(auth);
            }
        });

        const handleLogin = async ({ studentId, studentName }) => {
            const studentsRef = collection(db, `artifacts/${appId}/public/data/students`);
            let q = query(studentsRef, where('studentId', '==', studentId));

            try {
                const studentSnapshot = await getDocs(q);
                const studentDoc = studentSnapshot.docs[0];

                if (studentDoc) {
                    state.student = { id: studentDoc.id, ...studentDoc.data() };
                    state.loginMessage = '';
                    await startDataListeners();
                } else {
                    state.loginMessage = 'Invalid Student ID. Please try again.';
                }
            } catch (error) {
                console.error("Login failed:", error);
                state.loginMessage = 'Failed to connect. Please check your network connection.';
            }
            renderUI();
        };

        const startDataListeners = async () => {
            const publicDataPath = `artifacts/${appId}/public/data`;
            
            onSnapshot(query(collection(db, `${publicDataPath}/assignments`), where('periodId', '==', state.student.periodId)), (snapshot) => {
                state.assignments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                sortAssignments();
                renderUI();
            });

            onSnapshot(collection(db, `${publicDataPath}/requests`), (snapshot) => {
                state.requests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderUI();
            });

            state.loading = false;
            renderUI();
        };

        const sortAssignments = () => {
            const direction = state.sortAscending ? 1 : -1;
            if (state.sortOption === 'number') {
                state.assignments.sort((a, b) => direction * ((a.assignmentOrder || 0) - (b.assignmentOrder || 0)));
            } else if (state.sortOption === 'dueDate') {
                state.assignments.sort((a, b) => direction * ((new Date(a.dueDate) || 0) - (new Date(b.dueDate) || 0)));
            }
        };
        
        const refreshData = async () => {
            state.loading = true;
            renderUI();
            // Re-fetch student data
            const studentsRef = collection(db, `artifacts/${appId}/public/data/students`);
            const q = query(studentsRef, where('studentId', '==', state.student.studentId));
            const studentSnapshot = await getDocs(q);
            const studentDoc = studentSnapshot.docs[0];
            state.student = { id: studentDoc.id, ...studentDoc.data() };

            // Re-fetch assignments
            const assignmentsRef = collection(db, `artifacts/${appId}/public/data/assignments`);
            const assignmentsSnapshot = await getDocs(query(assignmentsRef, where('periodId', '==', state.student.periodId)));
            state.assignments = assignmentsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            // Re-fetch requests
            const requestsRef = collection(db, `artifacts/${appId}/public/data/requests`);
            const requestsSnapshot = await getDocs(requestsRef);
            state.requests = requestsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            state.loading = false;
            renderUI();
        };

        const renderUI = () => {
            const app = document.getElementById('app');

            if (state.loading) {
                app.innerHTML = `<div class="flex items-center justify-center h-screen"><div class="text-xl font-semibold">Loading...</div></div>`;
                return;
            }

            if (!state.student) {
                renderLogin();
                return;
            }

            app.innerHTML = `
                <div class="min-h-screen bg-gray-100 p-4 font-sans">
                    <div class="max-w-4xl mx-auto bg-white p-6 rounded-xl shadow-lg">
                        <div class="flex justify-between items-center mb-6">
                            <h1 class="text-3xl font-bold text-gray-800">Welcome, ${state.student.name}!</h1>
                            <button id="refresh-btn" class="bg-gray-300 px-4 py-2 rounded-lg text-gray-800 font-semibold hover:bg-gray-400 transition-colors duration-200">
                                Refresh
                            </button>
                        </div>
                        <p class="text-sm text-gray-500 mb-6">Student ID: ${state.student.studentId}</p>

                        <div class="mb-4">
                            <h2 class="text-xl font-bold text-gray-700 mb-2">My Assignments</h2>
                            <div class="flex items-center space-x-4 mb-4">
                                <span class="text-sm font-medium text-gray-700">Sort By:</span>
                                <div class="flex items-center space-x-2">
                                    <label class="inline-flex items-center">
                                        <input type="radio" name="sort-option" value="number" class="form-radio" ${state.sortOption === 'number' ? 'checked' : ''}>
                                        <span class="ml-2 text-gray-700">Number</span>
                                    </label>
                                    <label class="inline-flex items-center">
                                        <input type="radio" name="sort-option" value="dueDate" class="form-radio" ${state.sortOption === 'dueDate' ? 'checked' : ''}>
                                        <span class="ml-2 text-gray-700">Due Date</span>
                                    </label>
                                    <label class="inline-flex items-center ml-4">
                                        <input type="checkbox" id="sort-order-toggle" class="form-checkbox text-blue-600 rounded" ${state.sortAscending ? '' : 'checked'}>
                                        <span class="ml-2 text-gray-700">Descending</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="space-y-4">
                            ${state.assignments.map(a => {
                                const completion = a.completions.find(c => c.studentId === state.student.id);
                                const isExcused = completion ? completion.isExcused : false;
                                const isCompleted = completion && !isExcused;
                                const score = completion ? completion.score : null;
                                const helpRequest = state.requests.find(r => r.studentId === state.student.id && r.assignmentId === a.id && r.type === 'help');
                                const checkRequest = state.requests.find(r => r.studentId === state.student.id && r.assignmentId === a.id && r.type === 'check');
                                const helpQueuePosition = helpRequest ? state.requests.filter(r => r.type === 'help').sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp)).findIndex(r => r.studentId === state.student.id && r.assignmentId === a.id) + 1 : null;
                                const checkQueuePosition = checkRequest ? state.requests.filter(r => r.type === 'check').sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp)).findIndex(r => r.studentId === state.student.id && r.assignmentId === a.id) + 1 : null;

                                return `
                                    <div class="bg-gray-50 p-4 rounded-lg shadow-sm border border-gray-200">
                                        <div class="flex items-center justify-between mb-2">
                                            <h2 class="text-lg font-semibold text-gray-800">${a.assignmentOrder !== undefined ? `${a.assignmentOrder + 1}. ` : ''}${a.title}</h2>
                                            ${isExcused ? `<span class="bg-purple-600 text-white text-xs font-bold px-2 py-1 rounded-full">Excused</span>` : ''}
                                            ${score ? `<span class="text-sm font-bold text-blue-600">Score: ${score}/4</span>` : ''}
                                        </div>
                                        <p class="text-sm text-gray-500 mb-4">Due: ${a.dueDate ? new Date(a.dueDate).toLocaleDateString() : 'N/A'}</p>
                                        
                                        <div class="flex space-x-2">
                                            ${helpRequest ? `
                                                <button onclick="handleCancelRequest('${helpRequest.id}')" class="flex-1 bg-red-500 text-white font-bold py-2 rounded-lg hover:bg-red-600 transition-colors duration-200" ${isExcused ? 'disabled' : ''}>
                                                    Cancel Help (#${helpQueuePosition})
                                                </button>
                                            ` : `
                                                <button onclick="handleRequest('${a.id}', 'help')" class="flex-1 bg-gray-300 text-gray-800 font-bold py-2 rounded-lg hover:bg-gray-400 transition-colors duration-200" ${isExcused ? 'disabled' : ''}>
                                                    Request Help
                                                </button>
                                            `}

                                            ${checkRequest ? `
                                                <button onclick="handleCancelRequest('${checkRequest.id}')" class="flex-1 bg-blue-500 text-white font-bold py-2 rounded-lg hover:bg-blue-600 transition-colors duration-200" ${isExcused ? 'disabled' : ''}>
                                                    Cancel Check (#${checkQueuePosition})
                                                </button>
                                            ` : `
                                                <button onclick="handleRequest('${a.id}', 'check')" class="flex-1 bg-gray-300 text-gray-800 font-bold py-2 rounded-lg hover:bg-gray-400 transition-colors duration-200" ${isExcused ? 'disabled' : ''}>
                                                    Ready for Check
                                                </button>
                                            `}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('refresh-btn').addEventListener('click', refreshData);
            document.querySelectorAll('input[name="sort-option"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    state.sortOption = e.target.value;
                    sortAssignments();
                    renderUI();
                });
            });
            document.getElementById('sort-order-toggle').addEventListener('change', (e) => {
                state.sortAscending = !e.target.checked;
                sortAssignments();
                renderUI();
            });

            window.handleRequest = async (assignmentId, type) => {
                if (state.student) {
                    const requestsRef = collection(db, `artifacts/${appId}/public/data/requests`);
                    await addDoc(requestsRef, {
                        studentId: state.student.id,
                        assignmentId,
                        type,
                        timestamp: new Date().toISOString()
                    });
                }
            };

            window.handleCancelRequest = async (requestId) => {
                const requestRef = doc(db, `artifacts/${appId}/public/data/requests`, requestId);
                await deleteDoc(requestRef);
            };
        };

        const renderLogin = () => {
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="flex items-center justify-center min-h-screen bg-gray-100">
                    <div class="p-8 bg-white rounded-xl shadow-lg w-full max-w-lg text-center">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Student Login</h2>
                        <form id="student-login-form" class="flex flex-col space-y-4">
                            <input type="text" id="student-id" placeholder="Your Student ID"
                                class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <button type="submit" class="bg-blue-600 text-white font-bold py-2 rounded-lg hover:bg-blue-700 transition-colors duration-200">
                                Log In
                            </button>
                        </form>
                        <p id="login-message" class="mt-4 text-red-500">${state.loginMessage}</p>
                    </div>
                </div>
            `;
            document.getElementById('student-login-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const studentId = document.getElementById('student-id').value;
                await handleLogin({ studentId });
            });
        };

        document.addEventListener('DOMContentLoaded', () => {
            renderUI();
        });
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
    </style>
</head>
<body>
    <div id="app"></div>
</body>
</html>
