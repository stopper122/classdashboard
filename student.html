<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, updateDoc, collection, getDocs, where, query, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = {
  apiKey: "AIzaSyBX96xDY5ThDAZn-SckmsnfynMnQjvUc2I",
  authDomain: "helprequest-469c0.firebaseapp.com",
  projectId: "helprequest-469c0",
  storageBucket: "helprequest-469c0.firebasestorage.app",
  messagingSenderId: "1092775554304",
  appId: "1:1092775554304:web:e771c3ebac1e6ba4f597e5"
};

        setLogLevel('debug');

        let db;
        let state = {
            student: null,
            assignments: [],
            requests: [],
            message: '',
            isProcessing: false,
        };

        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);

        const urlParams = new URLSearchParams(window.location.search);
        const urlStudentId = urlParams.get('studentId');

        const renderUI = () => {
            const app = document.getElementById('app');
            app.innerHTML = '';
            if (state.student) {
                renderStudentDashboard();
            } else {
                renderLogin();
            }
        };

        const renderLogin = () => {
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="flex items-center justify-center min-h-screen bg-gray-100">
                    <div class="p-8 bg-white rounded-xl shadow-lg w-full max-w-md text-center">
                        <h2 class="text-3xl font-bold text-blue-800 mb-6">Student Login</h2>
                        <form id="login-form" class="space-y-4">
                            <div>
                                <input type="text" id="student-name" placeholder="Full Name" required
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <input type="text" id="student-id" placeholder="Student ID" required
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <button type="submit" class="w-full bg-blue-600 text-white font-bold py-2 rounded-lg hover:bg-blue-700 transition-colors duration-200">
                                Login
                            </button>
                        </form>
                        <p id="login-message" class="mt-4 text-sm text-red-500"></p>
                    </div>
                </div>
            `;
            document.getElementById('login-form').addEventListener('submit', handleLogin);
        };

        const renderStudentDashboard = () => {
            const app = document.getElementById('app');
            const studentName = state.student ? state.student.name : 'Student';
            app.innerHTML = `
                <div class="flex flex-col min-h-screen bg-gray-100 p-4">
                    <div class="bg-white p-6 rounded-xl shadow-lg mb-4">
                        <div class="flex justify-between items-center">
                            <h2 class="text-3xl font-extrabold text-blue-800">${studentName}'s Dashboard</h2>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-lg flex-grow">
                        <h3 class="text-2xl font-bold text-blue-800 mb-4">My Assignments</h3>
                        <div id="assignments-list" class="space-y-4">
                            <!-- Assignments will be rendered here -->
                        </div>
                    </div>
                </div>
            `;
            renderAssignments();
        };

        const renderAssignments = () => {
            const assignmentsList = document.getElementById('assignments-list');
            if (!assignmentsList) return;
            
            const helpRequests = state.requests.filter(r => r.type === 'help').sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            const checkRequests = state.requests.filter(r => r.type === 'check').sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

            assignmentsList.innerHTML = state.assignments.map(a => {
                const completion = a.completions.find(c => c.studentId === state.student.studentId);
                const score = completion ? (completion.score || 0) : null;
                const isCompleted = completion !== undefined;
                
                const helpRequest = state.requests.find(r => r.studentId === state.student.studentId && r.assignmentId === a.id && r.type === 'help');
                const checkRequest = state.requests.find(r => r.studentId === state.student.studentId && r.assignmentId === a.id && r.type === 'check');
                
                let buttonHtml = '';
                if (helpRequest) {
                     const position = helpRequests.findIndex(r => r.id === helpRequest.id) + 1;
                    buttonHtml = `
                        <button onclick="handleCancelRequest('${helpRequest.id}')" class="bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600 transition-colors duration-200 text-sm">
                            Cancel Help (#${position})
                        </button>
                    `;
                } else if (checkRequest) {
                    const position = checkRequests.findIndex(r => r.id === checkRequest.id) + 1;
                    buttonHtml = `
                        <button onclick="handleCancelRequest('${checkRequest.id}')" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors duration-200 text-sm">
                            Cancel Check (#${position})
                        </button>
                    `;
                } else {
                    buttonHtml = `
                        <button onclick="handleRequest('help', '${a.id}')" class="bg-red-200 text-red-800 font-bold py-2 px-4 rounded-lg hover:bg-red-300 transition-colors duration-200 text-sm">
                            Request Help
                        </button>
                        <button onclick="handleRequest('check', '${a.id}')" class="bg-blue-200 text-blue-800 font-bold py-2 px-4 rounded-lg hover:bg-blue-300 transition-colors duration-200 text-sm">
                            Ready for Check
                        </button>
                    `;
                }

                return `
                    <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 flex justify-between items-center">
                        <div>
                            <p class="font-semibold text-gray-700">${a.title}</p>
                            ${isCompleted ? `<p class="text-sm text-gray-500">Status: Completed - Score: ${score || 'N/A'}</p>` : `<p class="text-sm text-gray-500">Status: In Progress</p>`}
                        </div>
                        <div class="flex space-x-2">
                            ${buttonHtml}
                        </div>
                    </div>
                `;
            }).join('');
        };
        
        const handleLogin = async (event) => {
            event.preventDefault();
            const name = document.getElementById('student-name').value.trim();
            const studentId = document.getElementById('student-id').value.trim();
            const messageDiv = document.getElementById('login-message');

            if (!name || !studentId) {
                messageDiv.textContent = 'Please enter both name and student ID.';
                return;
            }

            const q = query(collection(db, `artifacts/${appId}/public/data/students`), where("name", "==", name), where("studentId", "==", studentId));
            const studentDocs = await getDocs(q);

            if (studentDocs.empty) {
                messageDiv.textContent = 'Invalid name or student ID. Please try again.';
            } else {
                state.student = studentDocs.docs[0].data();
                state.student.docId = studentDocs.docs[0].id; // Store doc ID for updates
                await startDataListeners();
                renderUI();
            }
        };

        const startDataListeners = async () => {
             // Listen for assignments
            const assignmentsRef = collection(db, `artifacts/${appId}/public/data/assignments`);
            onSnapshot(assignmentsRef, (snapshot) => {
                state.assignments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderUI();
            });

            // Listen for requests
            const requestsRef = collection(db, `artifacts/${appId}/public/data/requests`);
            onSnapshot(requestsRef, (snapshot) => {
                state.requests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderUI();
            });
        };

        const handleRequest = async (type, assignmentId) => {
            if (!state.student) return;

            const existingRequests = state.requests.filter(r => r.studentId === state.student.studentId);
            const isRequestExist = existingRequests.some(r => r.assignmentId === assignmentId && r.type === type);

            if (!isRequestExist) {
                 await addDoc(collection(db, `artifacts/${appId}/public/data/requests`), {
                    studentId: state.student.studentId,
                    assignmentId: assignmentId,
                    type: type,
                    timestamp: new Date().toISOString(),
                });
            }
        };
        
        const handleCancelRequest = async (requestId) => {
             await deleteDoc(doc(db, `artifacts/${appId}/public/data/requests`, requestId));
        };

        window.handleLogin = handleLogin;
        window.handleRequest = handleRequest;
        window.handleCancelRequest = handleCancelRequest;

        if (urlStudentId) {
            // Optional: Auto-login based on URL for a simpler flow if preferred
            // This part is currently not active in the UI, but the logic is here.
        }

        document.addEventListener('DOMContentLoaded', renderUI);
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
    </style>
</head>
<body>
    <div id="app"></div>
</body>
</html>
