<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Assignments</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, updateDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // IMPORTANT: These global variables are provided by the canvas environment.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        // const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

        setLogLevel('debug');

        // --- START: PASTE YOUR FIREBASE CONFIG HERE ---
        // You can find this by going to your Firebase project, clicking the gear icon
        // next to "Project overview," selecting "Project settings," and then scrolling down to
        // "Your apps."
        const firebaseConfig = {
  apiKey: "AIzaSyBX96xDY5ThDAZn-SckmsnfynMnQjvUc2I",
  authDomain: "helprequest-469c0.firebaseapp.com",
  projectId: "helprequest-469c0",
  storageBucket: "helprequest-469c0.firebasestorage.app",
  messagingSenderId: "1092775554304",
  appId: "1:1092775554304:web:e771c3ebac1e6ba4f597e5"
};
        // --- END: PASTE YOUR FIREBASE CONFIG HERE ---
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let state = {
            student: null,
            assignments: [],
            isProcessing: false,
            message: '',
            instructorUserId: null,
        };

        const renderUI = () => {
            const app = document.getElementById('app');
            app.innerHTML = '';
            renderHeader();
            renderMessage(state.message);
            if (state.student) {
                renderStudentDashboard();
            } else {
                renderLoginPage();
            }
        };

        const renderHeader = () => {
            const header = document.getElementById('header');
            header.innerHTML = `
                <div class="flex justify-between items-center py-4 px-6 bg-white shadow-md rounded-b-xl">
                    <h1 class="text-3xl font-extrabold text-blue-800 tracking-tight">My Assignments</h1>
                </div>
            `;
        };

        const renderLoading = () => {
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="flex flex-col items-center justify-center h-full">
                    <div class="w-16 h-16 border-4 border-blue-200 border-t-blue-500 rounded-full animate-spin"></div>
                    <p class="mt-4 text-gray-600">Loading your assignments...</p>
                </div>
            `;
        };
        
        const renderMessage = (message) => {
            const messageDiv = document.getElementById('message');
            messageDiv.innerHTML = '';
            if (message) {
                messageDiv.innerHTML = `
                    <div class="fixed top-20 left-1/2 -translate-x-1/2 bg-blue-500 text-white px-6 py-3 rounded-full shadow-lg z-50 transition-all duration-300 transform scale-100">
                        ${message}
                    </div>
                `;
                setTimeout(() => {
                    messageDiv.innerHTML = '';
                    state.message = '';
                }, 3000);
            }
        };
        
        const showMessage = (message) => {
            state.message = message;
            renderMessage(message);
        };
        
        const renderLoginPage = () => {
             const app = document.getElementById('app');
             app.innerHTML = `
                <div class="flex flex-col items-center justify-center h-full p-6">
                    <div class="bg-white p-8 rounded-2xl shadow-lg border border-gray-100 w-full max-w-md text-center">
                        <h2 class="text-2xl font-bold text-blue-800 mb-6">Student Login</h2>
                        <form onsubmit="handleLogin(event)">
                            <div class="mb-4">
                                <input type="text" id="studentName" name="studentName" placeholder="Enter your full name" required
                                       class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div class="mb-6">
                                <input type="text" id="studentId" name="studentId" placeholder="Enter your Student ID" required
                                       class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <button type="submit" 
                                class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold text-lg hover:bg-blue-700 transition-colors duration-200 shadow-lg ${state.isProcessing ? 'opacity-50 cursor-not-allowed' : ''}"
                                ${state.isProcessing ? 'disabled' : ''}>
                                ${state.isProcessing ? 'Logging in...' : 'Login'}
                            </button>
                        </form>
                    </div>
                </div>
            `;
        };

        const renderStudentDashboard = () => {
            const app = document.getElementById('app');
            const helpRequested = state.student?.helpRequested || false;
            
            const assignmentsList = state.assignments.map(a => {
                const completion = a.completions.find(c => c.studentId === state.student.studentId); // Use studentId for lookup
                const isCompleted = !!completion;
                const completionDate = isCompleted ? new Date(completion.completedAt).toLocaleDateString() : 'Not Completed';
                const score = isCompleted ? (completion.score || 0) : 0;
                
                return `
                    <div class="bg-gray-50 p-6 rounded-lg shadow-sm border border-gray-200 flex justify-between items-center">
                        <div>
                            <h3 class="font-bold text-lg text-blue-800">${a.title}</h3>
                            <p class="text-sm text-gray-500">Due: ${a.dueDate ? new Date(a.dueDate).toLocaleDateString() : 'N/A'}</p>
                            <div class="mt-2 flex items-center space-x-2">
                                <span class="text-sm font-semibold ${isCompleted ? 'text-green-600' : 'text-red-500'}">
                                    Status: ${isCompleted ? 'Completed' : 'Pending'}
                                </span>
                                ${isCompleted ? `<span class="text-xs text-gray-500">(${completionDate})</span>` : ''}
                                ${isCompleted ? `<span class="text-xs text-gray-500 font-bold">Score: ${score}/4</span>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            app.innerHTML = `
                <div class="space-y-6">
                    <div class="flex justify-between items-center bg-white p-8 rounded-2xl shadow-lg border border-gray-100">
                        <h2 class="text-2xl font-bold text-blue-800">Hello, ${state.student.name}!</h2>
                    </div>
                    <div class="bg-gray-50 p-6 rounded-lg shadow-sm border border-gray-200 text-center">
                        <h3 class="text-xl font-semibold mb-4 text-gray-700">Need Help?</h3>
                        <button onclick="handleRequestHelp()" class="bg-red-500 text-white py-3 px-6 rounded-lg font-bold text-lg hover:bg-red-600 transition-colors duration-200 shadow-lg ${helpRequested ? 'opacity-50 cursor-not-allowed' : ''}" ${helpRequested ? 'disabled' : ''}>
                            Request Help
                        </button>
                        <p class="mt-2 text-sm text-gray-500">${helpRequested ? 'Your request has been sent!' : ''}</p>
                    </div>
                    <div class="space-y-4">
                        ${state.assignments.length > 0 ? assignmentsList : `
                            <div class="text-center py-10 text-gray-500">
                                <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h2a2 2 0 012 2v4a2 2 0 002 2h4a2 2 0 002-2v-4a2 2 0 012-2h2a2 2 0 012 2v6m-12 5h14a2 2 0 002-2v-2a2 2 0 00-2-2h-2a2 2 0 01-2-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 01-2 2H5a2 2 0 00-2 2v2a2 2 0 002 2z" />
                                </svg>
                                <p class="mt-2 text-gray-500 font-medium">No assignments for you.</p>
                            </div>
                        `}
                    </div>
                </div>
            `;
        };
        
        const handleLogin = async (event) => {
            event.preventDefault();
            if (state.isProcessing) return;
            state.isProcessing = true;
            renderUI();

            const studentName = event.target.studentName.value;
            const studentId = event.target.studentId.value;
            
            try {
                // Find the instructor's user ID (this assumes a collaboration context)
                // In a real-world app, you'd need a way to look up the instructor.
                const instructorId = window.parent.__app_owner_id;

                const studentsRef = collection(db, `artifacts/${appId}/users/${instructorId}/students`);
                const q = query(studentsRef, where("studentId", "==", studentId), where("name", "==", studentName));
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    const studentDoc = querySnapshot.docs[0];
                    state.student = { id: studentDoc.id, ...studentDoc.data() };
                    state.instructorUserId = instructorId;
                    startStudentListeners();
                    showMessage("Login successful!");
                } else {
                    showMessage("Login failed. Please check your name and ID.");
                }
            } catch (error) {
                console.error("Login error:", error);
                showMessage("An error occurred during login.");
            } finally {
                state.isProcessing = false;
                renderUI();
            }
        };

        const startStudentListeners = () => {
            const assignmentsRef = collection(db, `artifacts/${appId}/users/${state.instructorUserId}/assignments`);
            onSnapshot(assignmentsRef, (snapshot) => {
                const assignments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                state.assignments = assignments;
                renderUI();
            });

            const studentsRef = doc(db, `artifacts/${appId}/users/${state.instructorUserId}/students`, state.student.id);
            onSnapshot(studentsRef, (docSnapshot) => {
                if (docSnapshot.exists()) {
                    state.student = { id: docSnapshot.id, ...docSnapshot.data() };
                    renderUI();
                }
            });
        };
        
        const handleRequestHelp = async () => {
            if (state.isProcessing) return;
            state.isProcessing = true;
            
            try {
                const studentsRef = collection(db, `artifacts/${appId}/users/${state.instructorUserId}/students`);
                const helpQueue = [];
                const querySnapshot = await getDocs(studentsRef);
                querySnapshot.forEach(doc => {
                    const student = doc.data();
                    if (student.helpRequested) {
                        helpQueue.push(student);
                    }
                });

                helpQueue.sort((a, b) => a.queuePosition - b.queuePosition);
                const newQueuePosition = helpQueue.length > 0 ? helpQueue[helpQueue.length - 1].queuePosition + 1 : 1;

                const studentDocRef = doc(db, `artifacts/${appId}/users/${state.instructorUserId}/students`, state.student.id);
                await updateDoc(studentDocRef, {
                    helpRequested: true,
                    queuePosition: newQueuePosition,
                });
                showMessage("Help request sent!");
            } catch (error) {
                console.error("Error requesting help:", error);
                showMessage("Error requesting help.");
            } finally {
                state.isProcessing = false;
            }
        };

        const init = () => {
            // Check if there's a logged-in user or a way to determine their identity.
            // For this app, we simply render the login page.
            renderUI();
        };

        window.handleLogin = handleLogin;
        window.handleRequestHelp = handleRequestHelp;
        document.addEventListener('DOMContentLoaded', init);
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
    </style>
</head>
<body class="p-6 md:p-10">
    <header id="header"></header>
    <div id="message"></div>
    <main id="app" class="mt-6 md:mt-10"></main>
</body>
</html>
