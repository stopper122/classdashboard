<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, collection, query, where, runTransaction, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = {
  apiKey: "AIzaSyBX96xDY5ThDAZn-SckmsnfynMnQjvUc2I",
  authDomain: "helprequest-469c0.firebaseapp.com",
  projectId: "helprequest-469c0",
  storageBucket: "helprequest-469c0.firebasestorage.app",
  messagingSenderId: "1092775554304",
  appId: "1:1092775554304:web:e771c3ebac1e6ba4f597e5"
};
        setLogLevel('debug');

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let studentState = {
            studentId: null,
            studentData: null,
            assignments: [],
            requests: [],
            loading: true,
            loginFailed: false,
        };

        const getStudentIdFromUrl = () => {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('studentId');
        };

        const renderUI = () => {
            const appDiv = document.getElementById('app');
            if (studentState.loading) {
                appDiv.innerHTML = `<div class="flex items-center justify-center h-screen"><div class="text-xl font-semibold">Loading...</div></div>`;
                return;
            }

            if (!studentState.studentData) {
                renderLogin();
                return;
            }
            
            const assignmentsList = studentState.assignments.map(a => {
                const completion = a.completions.find(c => c.studentId === studentState.studentId);
                const isExcused = completion ? completion.isExcused : false;
                const score = completion ? completion.score : null;
                const request = studentState.requests.find(r => r.studentId === studentState.studentId && r.assignmentId === a.id);
                const helpQueue = studentState.requests.filter(r => r.type === 'help').sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp));
                const checkQueue = studentState.requests.filter(r => r.type === 'check').sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp));
                const helpPosition = helpQueue.findIndex(r => r.studentId === studentState.studentId && r.assignmentId === a.id) + 1;
                const checkPosition = checkQueue.findIndex(r => r.studentId === studentState.studentId && r.assignmentId === a.id) + 1;

                return `
                    <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-800">${a.title}</h3>
                        <p class="text-sm text-gray-500">Due: ${a.dueDate ? new Date(a.dueDate).toLocaleDateString() : 'N/A'}</p>
                        <div class="mt-2 flex items-center space-x-2">
                            ${isExcused ? `<span class="px-2 py-1 text-xs font-semibold rounded-full bg-purple-600 text-white">Excused</span>` : ''}
                            ${score ? `<span class="px-2 py-1 text-xs font-semibold rounded-full bg-blue-600 text-white">Score: ${score}/4</span>` : ''}
                        </div>
                        <div class="mt-4 flex flex-col sm:flex-row sm:space-x-2 space-y-2 sm:space-y-0">
                            ${!isExcused && !completion ? `
                                <button onclick="handleRequest('${a.id}', 'help')" class="flex-1 bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600 transition-colors duration-200">
                                    ${request && request.type === 'help' ? `Cancel Help (#${helpPosition})` : 'Request Help'}
                                </button>
                                <button onclick="handleRequest('${a.id}', 'check')" class="flex-1 bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors duration-200">
                                    ${request && request.type === 'check' ? `Cancel Check (#${checkPosition})` : 'Ready for Check'}
                                </button>
                                <button onclick="clearMyProgress('${a.id}')" class="flex-1 bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors duration-200">
                                    Clear My Progress
                                </button>
                            ` : `
                                <button onclick="clearMyProgress('${a.id}')" class="flex-1 bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors duration-200">
                                    Clear My Progress
                                </button>
                            `}
                        </div>
                    </div>
                `;
            }).join('');

            appDiv.innerHTML = `
                <div class="min-h-screen bg-gray-100 p-4 font-sans">
                    <div class="max-w-4xl mx-auto bg-white p-6 rounded-xl shadow-lg">
                        <div class="flex justify-between items-center mb-6">
                            <h1 class="text-3xl font-bold text-gray-800">Hello, ${studentState.studentData.name}</h1>
                            <button id="clear-all-my-data-btn" class="text-sm bg-red-500 text-white px-3 py-1 rounded-lg hover:bg-red-600">Clear All My Data</button>
                        </div>
                        <div class="space-y-4">
                            ${assignmentsList}
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('clear-all-my-data-btn').addEventListener('click', clearAllMyData);
        };

        const renderLogin = (message = '') => {
            const appDiv = document.getElementById('app');
            appDiv.innerHTML = `
                <div class="flex items-center justify-center min-h-screen bg-gray-100">
                    <div class="p-8 bg-white rounded-xl shadow-lg w-full max-w-lg text-center">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Student Login</h2>
                        <form id="student-login-form" class="flex flex-col space-y-4">
                            <input type="text" id="name-input" placeholder="Your Name"
                                class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <input type="text" id="id-input" placeholder="Your ID Number"
                                class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <button type="submit" class="bg-blue-600 text-white font-bold py-2 rounded-lg hover:bg-blue-700 transition-colors duration-200">
                                Log In
                            </button>
                        </form>
                        <p id="login-message" class="mt-4 text-red-500">${message}</p>
                    </div>
                </div>
            `;
            document.getElementById('student-login-form').addEventListener('submit', handleLogin);
        };

        const handleLogin = async (e) => {
            e.preventDefault();
            const name = document.getElementById('name-input').value.trim();
            const id = document.getElementById('id-input').value.trim();
            const messageEl = document.getElementById('login-message');
            
            if (!name || !id) {
                messageEl.textContent = 'Please enter your name and ID.';
                return;
            }

            messageEl.textContent = 'Logging in...';

            const studentsRef = collection(db, `artifacts/${appId}/public/data/students`);
            const studentQuery = query(studentsRef, where('studentId', '==', id));
            
            try {
                const querySnapshot = await getDocs(studentQuery);
                if (querySnapshot.empty) {
                    messageEl.textContent = 'Login failed. Incorrect ID.';
                    return;
                }
                
                const studentDoc = querySnapshot.docs[0];
                const studentData = studentDoc.data();
                
                const normalizeName = (n) => n.toLowerCase().replace(/[\s,]/g, '');
                const enteredName = normalizeName(name);
                const storedName = normalizeName(studentData.name);

                if (enteredName === storedName) {
                    studentState.studentId = id;
                    studentState.studentData = studentData;
                    startDataListeners(studentData.periodId);
                } else {
                    messageEl.textContent = 'Login failed. Incorrect name or ID.';
                }
            } catch (error) {
                console.error("Login error:", error);
                messageEl.textContent = 'An error occurred. Please try again.';
            }
        };

        const startDataListeners = async (periodId) => {
            const publicDataPath = `artifacts/${appId}/public/data`;
            
            // Listen for assignments
            onSnapshot(query(collection(db, `${publicDataPath}/assignments`), where('periodId', '==', periodId)), (snapshot) => {
                studentState.assignments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderUI();
            });

            // Listen for requests
            onSnapshot(collection(db, `${publicDataPath}/requests`), (snapshot) => {
                studentState.requests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderUI();
            });
            studentState.loading = false;
            renderUI();
        };

        const handleRequest = async (assignmentId, type) => {
            const requestsRef = collection(db, `artifacts/${appId}/public/data/requests`);
            const existingRequests = studentState.requests.filter(r => r.studentId === studentState.studentId && r.assignmentId === assignmentId);
            const requestDoc = existingRequests.find(r => r.type === type);

            if (requestDoc) {
                await deleteDoc(doc(db, requestsRef.path, requestDoc.id));
            } else {
                for (const req of existingRequests) {
                    await deleteDoc(doc(db, requestsRef.path, req.id));
                }
                await addDoc(requestsRef, {
                    studentId: studentState.studentId,
                    assignmentId,
                    type,
                    timestamp: new Date().toISOString()
                });
            }
        };
        window.handleRequest = handleRequest;

        const clearMyProgress = async (assignmentId) => {
            const assignmentRef = doc(db, `artifacts/${appId}/public/data/assignments`, assignmentId);
            const studentId = studentState.studentId;

            const assignmentDoc = await getDoc(assignmentRef);
            if (!assignmentDoc.exists()) return;

            const completions = assignmentDoc.data().completions || [];
            const updatedCompletions = completions.filter(c => c.studentId !== studentId);
            
            await updateDoc(assignmentRef, { completions: updatedCompletions });
        };
        window.clearMyProgress = clearMyProgress;

        const clearAllMyData = async () => {
            if (!confirm('Are you sure you want to clear all your progress and requests?')) {
                return;
            }
            
            const publicDataPath = `artifacts/${appId}/public/data`;
            const studentId = studentState.studentId;

            try {
                // Clear all assignment completions for this student
                const assignmentsQuery = query(collection(db, `${publicDataPath}/assignments`), where('periodId', '==', studentState.studentData.periodId));
                const assignmentsSnapshot = await getDocs(assignmentsQuery);
                
                for (const assignmentDoc of assignmentsSnapshot.docs) {
                    const completions = assignmentDoc.data().completions || [];
                    const updatedCompletions = completions.filter(c => c.studentId !== studentId);
                    await updateDoc(doc(db, `${publicDataPath}/assignments`, assignmentDoc.id), { completions: updatedCompletions });
                }

                // Delete all requests for this student
                const requestsQuery = query(collection(db, `${publicDataPath}/requests`), where('studentId', '==', studentId));
                const requestsSnapshot = await getDocs(requestsQuery);
                for (const requestDoc of requestsSnapshot.docs) {
                    await deleteDoc(doc(db, `${publicDataPath}/requests`, requestDoc.id));
                }

                alert('All your data has been cleared successfully.');
            } catch (error) {
                console.error("Error clearing data:", error);
                alert('An error occurred while clearing your data. Please try again.');
            }
        };

        window.clearAllMyData = clearAllMyData;

        document.addEventListener('DOMContentLoaded', () => {
            studentState.loading = false;
            renderUI();
        });
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
    </style>
</head>
<body>
    <div id="app"></div>
</body>
</html>
