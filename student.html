<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, onSnapshot, collection, query, where, addDoc, deleteDoc, runTransaction, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = {
          apiKey: "AIzaSyBX96xDY5ThDAZn-SckmsnfynMnQjvUc2I",
          authDomain: "helprequest-469c0.firebaseapp.com",
          projectId: "helprequest-469c0",
          storageBucket: "helprequest-469c0.firebasestorage.app",
          messagingSenderId: "362143493922",
          appId: "1:362143493922:web:763262a5b658145a538260",
          measurementId: "G-L5S59L4JSP"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let state = {
            student: null,
            assignments: [],
            scores: [],
            requests: [],
            loading: true,
            sortBy: 'date' // 'date' or 'score'
        };

        let publicDataPath;
        let requestsRef;
        let studentUnsubscribe = null;
        let assignmentsUnsubscribe = null;
        let scoresUnsubscribe = null;
        let requestUnsubscribe = null;

        const requestHelp = async (assignmentId) => {
            await addDoc(requestsRef, {
                studentId: state.student.id,
                assignmentId: assignmentId,
                type: 'help',
                timestamp: serverTimestamp()
            });
        };

        const requestCheck = async (assignmentId) => {
            await addDoc(requestsRef, {
                studentId: state.student.id,
                assignmentId: assignmentId,
                type: 'check',
                timestamp: serverTimestamp()
            });
        };

        const clearRequest = async (assignmentId) => {
            const request = state.requests.find(r => r.assignmentId === assignmentId);
            if (request) {
                await deleteDoc(doc(requestsRef, request.id));
            }
        };

        window.App = {
            requestHelp,
            requestCheck,
            clearRequest,
            setSortBy: (sortBy) => {
                state.sortBy = sortBy;
                renderUI();
            }
        };

        const renderUI = () => {
            const appDiv = document.getElementById('app');
            if (!appDiv) return;

            if (state.loading) {
                appDiv.innerHTML = `<div class="p-4 text-center">Loading student data...</div>`;
                return;
            }

            if (!state.student) {
                appDiv.innerHTML = `<div class="p-4 text-center">Student not found. Please check the URL.</div>`;
                return;
            }
            
            let sortedAssignments = [...state.assignments];

            if (state.sortBy === 'date') {
                sortedAssignments.sort((a, b) => (a.assignmentNumber || 0) - (b.assignmentNumber || 0));
            } else if (state.sortBy === 'score') {
                sortedAssignments.sort((a, b) => {
                    const scoreA = state.scores.find(s => s.assignmentId === a.id);
                    const scoreB = state.scores.find(s => s.assignmentId === b.id);
                    const valA = scoreA ? (typeof scoreA.score === 'number' ? scoreA.score : -1) : -1;
                    const valB = scoreB ? (typeof scoreB.score === 'number' ? scoreB.score : -1) : -1;
                    return valB - valA;
                });
            }


            const helpQueue = state.requests.filter(r => r.type === 'help').sort((a, b) => a.timestamp.seconds - b.timestamp.seconds);
            const checkQueue = state.requests.filter(r => r.type === 'check').sort((a, b) => a.timestamp.seconds - b.timestamp.seconds);

            appDiv.innerHTML = `
                <div class="container mx-auto p-4">
                    <div class="flex justify-between items-center mb-4 flex-wrap">
                         <h1 class="text-3xl font-bold mb-2 sm:mb-0">Welcome, ${state.student.firstName} ${state.student.lastName}</h1>
                        <div>
                            <label for="sort" class="mr-2">Sort by:</label>
                            <select id="sort" onchange="App.setSortBy(this.value)" class="p-2 rounded border">
                                <option value="date" ${state.sortBy === 'date' ? 'selected' : ''}>Assignment Number</option>
                                <option value="score" ${state.sortBy === 'score' ? 'selected' : ''}>Score</option>
                            </select>
                        </div>
                    </div>
                   
                    <div class="space-y-4">
                        ${sortedAssignments.map(assignment => {
                            const score = state.scores.find(s => s.assignmentId === assignment.id);
                            const helpRequest = helpQueue.find(r => r.assignmentId === assignment.id);
                            const checkRequest = checkQueue.find(r => r.assignmentId === assignment.id);
                            const helpQueuePosition = helpQueue.findIndex(r => r.assignmentId === assignment.id) + 1;
                            const checkQueuePosition = checkQueue.findIndex(r => r.assignmentId === assignment.id) + 1;

                            let scoreDisplay = '<span class="text-gray-500">Not Graded</span>';
                            if (score) {
                                if (score.score === 'Excused') {
                                    scoreDisplay = `<span class="text-blue-500 font-semibold">${score.score}</span>`;
                                } else if (typeof score.score === 'number') {
                                    scoreDisplay = `<span class="font-bold text-lg">${score.score}%</span>`;
                                }
                            }
                            
                            return `
                                <div class="bg-white p-4 rounded-lg shadow-md flex justify-between items-center flex-wrap">
                                    <div class="mb-2 sm:mb-0">
                                        <h2 class="text-xl font-semibold">${assignment.assignmentNumber}. ${assignment.name}</h2>
                                        <p>${scoreDisplay}</p>
                                    </div>
                                    <div class="flex space-x-2">
                                        ${helpRequest ? `
                                            <button onclick="App.clearRequest('${assignment.id}')" class="bg-yellow-500 text-white font-bold py-2 px-4 rounded w-40 text-center">Help Requested (#${helpQueuePosition})</button>
                                        ` : `
                                            <button onclick="App.requestHelp('${assignment.id}')" class="bg-yellow-400 hover:bg-yellow-500 text-white font-bold py-2 px-4 rounded w-40 text-center">Request Help</button>
                                        `}
                                        ${checkRequest ? `
                                            <button onclick="App.clearRequest('${assignment.id}')" class="bg-green-600 text-white font-bold py-2 px-4 rounded w-40 text-center">Check Requested (#${checkQueuePosition})</button>
                                        ` : `
                                            <button onclick="App.requestCheck('${assignment.id}')" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded w-40 text-center">Request Check</button>
                                        `}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        };

        const startDataListeners = () => {
            const urlParams = new URLSearchParams(window.location.search);
            const studentIdFromUrl = urlParams.get('student');
            const periodIdFromUrl = urlParams.get('period');

            if (!studentIdFromUrl || !periodIdFromUrl) {
                state.loading = false;
                renderUI();
                return;
            }

            publicDataPath = `publicData/${appId}/${periodIdFromUrl}`;
            requestsRef = collection(db, `${publicDataPath}/requests`);
            const studentRef = doc(db, `${publicDataPath}/students/${studentIdFromUrl}`);
            
            let initialLoadCompleted = {
                student: false,
                assignments: false,
                scores: false,
                requests: false
            };

            const checkAllLoaded = () => {
                if (Object.values(initialLoadCompleted).every(v => v)) {
                    state.loading = false;
                    renderUI();
                }
            };

            studentUnsubscribe = onSnapshot(studentRef, (doc) => {
                if (doc.exists()) {
                    state.student = { id: doc.id, ...doc.data() };
                    
                    if (!assignmentsUnsubscribe) {
                        assignmentsUnsubscribe = onSnapshot(collection(db, `${publicDataPath}/assignments`), (snapshot) => {
                            state.assignments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            initialLoadCompleted.assignments = true;
                            checkAllLoaded();
                        }, (error) => console.error(error));
                    }

                    if (!scoresUnsubscribe) {
                        scoresUnsubscribe = onSnapshot(query(collection(db, `${publicDataPath}/scores`), where('studentId', '==', studentIdFromUrl)), (snapshot) => {
                            state.scores = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            initialLoadCompleted.scores = true;
                            checkAllLoaded();
                        }, (error) => console.error(error));
                    }

                    if (!requestUnsubscribe) {
                        requestUnsubscribe = onSnapshot(query(collection(db, `${publicDataPath}/requests`), where('studentId', '==', studentIdFromUrl)), (snapshot) => {
                            state.requests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            initialLoadCompleted.requests = true;
                            checkAllLoaded();
                        }, (error) => console.error(error));
                    }
                    
                    initialLoadCompleted.student = true;
                    checkAllLoaded();
                } else {
                    state.student = null;
                    initialLoadCompleted.student = true;
                    checkAllLoaded();
                }
            }, (error) => console.error(error));
        }

        const initializeAppAndData = async () => {
            try {
                await signInAnonymously(auth);
                startDataListeners();
            } catch (error) {
                console.error("Error signing in:", error);
                const appDiv = document.getElementById('app');
                if(appDiv) {
                     appDiv.innerHTML = `<div class="p-4 text-center text-red-500">Could not connect to the service.</div>`;
                }
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            initializeAppAndData();
        });
        
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
    </style>
</head>
<body>
    <div id="app"></div>
</body>
</html>
