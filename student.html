<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, updateDoc, query, where, getDocs, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // IMPORTANT: These global variables are provided by the canvas environment.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        setLogLevel('debug');

        // --- START: PASTE YOUR FIREBASE CONFIG HERE ---
        // You can find this by going to your Firebase project, clicking the gear icon
        // next to "Project overview," selecting "Project settings," and then scrolling down to
        // "Your apps."
        const firebaseConfig = {
  apiKey: "AIzaSyBX96xDY5ThDAZn-SckmsnfynMnQjvUc2I",
  authDomain: "helprequest-469c0.firebaseapp.com",
  projectId: "helprequest-469c0",
  storageBucket: "helprequest-469c0.firebasestorage.app",
  messagingSenderId: "1092775554304",
  appId: "1:1092775554304:web:e771c3ebac1e6ba4f597e5"
};
        // --- END: PASTE YOUR FIREBASE CONFIG HERE ---

        let auth, db;
        let state = {
            view: 'login',
            student: null,
            assignments: [],
            isProcessing: false,
            message: '',
        };

        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);

        const signIn = async () => {
            try {
                await signInAnonymously(auth);
            } catch (error) {
                console.error("Authentication error:", error);
                state.message = "Authentication failed. Please refresh the page.";
                renderUI();
            }
        };

        auth.onAuthStateChanged(async (user) => {
            if (user) {
                await checkLoginStatus();
            } else {
                await signIn();
            }
        });

        const checkLoginStatus = () => {
            const urlParams = new URLSearchParams(window.location.search);
            const studentId = urlParams.get('studentId');
            if (studentId) {
                // If a studentId is in the URL, this is the old shareable link.
                // Log them in automatically.
                state.view = 'loading';
                renderUI();
                listenToStudentData(studentId);
            } else {
                // If no studentId, show the login page
                state.view = 'login';
                renderUI();
            }
        };

        const handleLogin = async (event) => {
            event.preventDefault();
            if (state.isProcessing) return;
            state.isProcessing = true;
            renderUI();
            
            const form = event.target;
            const name = form.elements['studentName'].value.trim();
            const studentId = form.elements['studentId'].value.trim();

            if (!name || !studentId) {
                showMessage('Please enter both your name and ID.');
                state.isProcessing = false;
                renderUI();
                return;
            }

            try {
                const studentsRef = collection(db, `artifacts/${appId}/public/data/students`);
                const q = query(studentsRef, where("studentId", "==", studentId));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    showMessage('Invalid ID. Please check and try again.');
                } else {
                    const studentDoc = querySnapshot.docs[0];
                    if (studentDoc.data().name.toLowerCase() !== name.toLowerCase()) {
                        showMessage('Name and ID do not match. Please check and try again.');
                    } else {
                        state.student = { id: studentDoc.id, ...studentDoc.data() };
                        state.view = 'student_dashboard';
                        await startDataListeners();
                    }
                }
            } catch (error) {
                console.error("Login error:", error);
                showMessage('An error occurred during login. Please try again.');
            } finally {
                state.isProcessing = false;
                renderUI();
            }
        };

        const startDataListeners = async () => {
            if (!state.student) return;

            const assignmentsRef = collection(db, `artifacts/${appId}/public/data/assignments`);
            onSnapshot(assignmentsRef, (snapshot) => {
                const assignments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                state.assignments = assignments;
                renderUI();
            });

            const studentDocRef = doc(db, `artifacts/${appId}/public/data/students`, state.student.id);
            onSnapshot(studentDocRef, (doc) => {
                state.student = { id: doc.id, ...doc.data() };
                renderUI();
            });
        };

        const handleRequestHelp = async () => {
            if (state.isProcessing) return;
            state.isProcessing = true;
            renderUI();
            
            try {
                const studentsRef = collection(db, `artifacts/${appId}/public/data/students`);
                const q = query(studentsRef, where("helpRequested", "==", true));
                const querySnapshot = await getDocs(q);
                const currentQueueLength = querySnapshot.size;

                const studentDocRef = doc(db, `artifacts/${appId}/public/data/students`, state.student.id);
                await updateDoc(studentDocRef, {
                    helpRequested: true,
                    queuePosition: currentQueueLength + 1,
                });
                showMessage(`Help requested! Your position in queue: ${currentQueueLength + 1}`);
            } catch (error) {
                console.error("Error requesting help:", error);
                showMessage("Error requesting help.");
            } finally {
                state.isProcessing = false;
                renderUI();
            }
        };

        const renderUI = () => {
            const app = document.getElementById('app');
            app.innerHTML = '';
            renderHeader();
            renderMessage(state.message);
            if (state.view === 'login') {
                renderLogin();
            } else if (state.view === 'loading') {
                renderLoading();
            } else if (state.view === 'student_dashboard') {
                renderStudentDashboard();
            }
        };

        const renderHeader = () => {
            const header = document.getElementById('header');
            header.innerHTML = `
                <div class="flex justify-between items-center py-4 px-6 bg-white shadow-md rounded-b-xl">
                    <h1 class="text-3xl font-extrabold text-blue-800 tracking-tight">Student Portal</h1>
                </div>
            `;
        };

        const renderMessage = (message) => {
            const messageDiv = document.getElementById('message');
            messageDiv.innerHTML = '';
            if (message) {
                messageDiv.innerHTML = `
                    <div class="fixed top-20 left-1/2 -translate-x-1/2 bg-blue-500 text-white px-6 py-3 rounded-full shadow-lg z-50 transition-all duration-300 transform scale-100">
                        ${message}
                    </div>
                `;
                setTimeout(() => {
                    messageDiv.innerHTML = '';
                    state.message = '';
                }, 3000);
            }
        };
        
        const showMessage = (message) => {
            state.message = message;
            renderMessage(message);
        };

        const renderLoading = () => {
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="flex flex-col items-center justify-center h-full">
                    <div class="w-16 h-16 border-4 border-blue-200 border-t-blue-500 rounded-full animate-spin"></div>
                    <p class="mt-4 text-gray-600">Loading...</p>
                </div>
            `;
        };

        const renderLogin = () => {
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="flex items-center justify-center h-full p-6">
                    <div class="w-full max-w-md bg-white p-8 rounded-2xl shadow-lg border border-gray-100">
                        <h2 class="text-2xl font-bold text-blue-800 mb-6 text-center">Student Login</h2>
                        <form onsubmit="handleLogin(event)">
                            <div class="mb-4">
                                <label for="studentName" class="block text-gray-700 font-semibold mb-2">Full Name</label>
                                <input type="text" id="studentName" name="studentName" placeholder="e.g., Jane Doe" required
                                       class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div class="mb-6">
                                <label for="studentId" class="block text-gray-700 font-semibold mb-2">Student ID</label>
                                <input type="text" id="studentId" name="studentId" placeholder="e.g., 12345" required
                                       class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <button type="submit"
                                class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold text-lg hover:bg-blue-700 transition-colors duration-200 shadow-lg ${state.isProcessing ? 'opacity-50 cursor-not-allowed' : ''}"
                                ${state.isProcessing ? 'disabled' : ''}>
                                ${state.isProcessing ? 'Logging in...' : 'Login'}
                            </button>
                        </form>
                        <p class="mt-4 text-sm text-gray-500 text-center">
                            Your full name and ID must match your teacher's records exactly.
                        </p>
                    </div>
                </div>
            `;
        };
        
        const renderStudentDashboard = () => {
            const app = document.getElementById('app');
            const assignmentsList = state.assignments.map(a => {
                const completion = a.completions.find(c => c.studentId === state.student.studentId);
                const isCompleted = !!completion;
                const score = isCompleted ? (completion.score || 0) : 0;
                
                return `
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                        <h3 class="font-bold text-lg text-blue-800">${a.title}</h3>
                        <p class="text-sm text-gray-500 mb-2">Due: ${a.dueDate ? new Date(a.dueDate).toLocaleDateString() : 'N/A'}</p>
                        <div class="mt-2 flex items-center space-x-2">
                            <span class="text-sm font-semibold ${isCompleted ? 'text-green-600' : 'text-red-500'}">
                                Status: ${isCompleted ? 'Completed' : 'Pending'}
                            </span>
                            ${isCompleted ? `<span class="text-xs text-gray-500 font-bold">Score: ${score}/4</span>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            const helpButtonText = state.student.helpRequested ? `In Queue: ${state.student.queuePosition}` : 'Request Help';
            const isHelpDisabled = state.student.helpRequested;

            app.innerHTML = `
                <div class="max-w-3xl mx-auto p-6 space-y-6">
                    <div class="bg-blue-500 text-white p-6 rounded-2xl shadow-lg">
                        <h2 class="text-2xl font-bold">Hello, ${state.student.name}!</h2>
                        <p class="text-sm opacity-90 mt-1">Your ID: ${state.student.studentId}</p>
                    </div>
                    
                    <div class="bg-white p-8 rounded-2xl shadow-lg">
                        <h2 class="text-2xl font-bold text-blue-800 mb-6">Your Assignments</h2>
                        ${state.assignments.length > 0 ? `<div class="space-y-4">${assignmentsList}</div>` : `
                            <div class="text-center py-10 text-gray-500">
                                <p>No assignments to display.</p>
                            </div>
                        `}
                    </div>
                    
                    <button onclick="handleRequestHelp()"
                        class="w-full py-3 rounded-lg font-bold text-lg transition-colors duration-200 shadow-lg
                        ${isHelpDisabled ? 'bg-gray-400 text-gray-700 cursor-not-allowed' : 'bg-green-500 text-white hover:bg-green-600'}">
                        ${helpButtonText}
                    </button>
                </div>
            `;
        };

        window.handleLogin = handleLogin;
        window.handleRequestHelp = handleRequestHelp;
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
    </style>
</head>
<body class="p-6 md:p-10">
    <header id="header"></header>
    <div id="message"></div>
    <main id="app" class="mt-6 md:mt-10"></main>
</body>
</html>
