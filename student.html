<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, query, where, addDoc, updateDoc, deleteDoc, getDoc, arrayUnion, arrayRemove, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // IMPORTANT: These global variables are provided by the canvas environment.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = {
  apiKey: "AIzaSyBX96xDY5ThDAZn-SckmsnfynMnQjvUc2I",
  authDomain: "helprequest-469c0.firebaseapp.com",
  projectId: "helprequest-469c0",
  storageBucket: "helprequest-469c0.firebasestorage.app",
  messagingSenderId: "1092775554304",
  appId: "1:1092775554304:web:e771c3ebac1e6ba4f597e5"
};

        setLogLevel('debug');

        let auth, db;
        let state = {
            student: null,
            assignments: [],
            requests: [],
            message: '',
            isLoggedIn: false
        };

        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);

        auth.onAuthStateChanged(async (user) => {
            if (user) {
                renderUI();
            } else {
                await signInAnonymously(auth);
            }
        });

        const renderUI = () => {
            const app = document.getElementById('app');
            if (state.isLoggedIn) {
                renderDashboard();
            } else {
                renderLogin();
            }
        };

        const renderLogin = () => {
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="flex items-center justify-center min-h-screen bg-gray-100">
                    <div class="p-8 bg-white rounded-xl shadow-lg w-full max-w-lg text-center">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Student Login</h2>
                        <form id="login-form" class="flex flex-col space-y-4">
                            <input type="text" id="student-name" placeholder="Full Name"
                                class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <input type="text" id="student-id" placeholder="Student ID"
                                class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <button type="submit" class="bg-blue-600 text-white font-bold py-2 rounded-lg hover:bg-blue-700 transition-colors duration-200">
                                Log In
                            </button>
                        </form>
                        <p id="login-message" class="mt-4 text-red-500"></p>
                    </div>
                </div>
            `;
            document.getElementById('login-form').addEventListener('submit', handleLogin);
        };

        const renderDashboard = () => {
             const app = document.getElementById('app');
             app.innerHTML = `
                <div class="min-h-screen bg-gray-100 p-4">
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h1 class="text-3xl font-extrabold text-blue-800 tracking-tight mb-2">My Assignments</h1>
                        <p class="text-gray-600 text-lg mb-6">Welcome, ${state.student.name}.</p>
                        <div id="assignments-list" class="space-y-4"></div>
                    </div>
                </div>
            `;
            renderAssignments();
        };

        const renderAssignments = () => {
            const list = document.getElementById('assignments-list');
            if (!list) return;
            
            list.innerHTML = state.assignments.map(a => {
                const completion = a.completions.find(c => c.studentId === state.student.studentId);
                const isCompleted = !!completion && !completion.isExcused;
                const isExcused = !!completion && completion.isExcused;
                const score = completion ? completion.score : null;
                const dateCompleted = completion ? completion.dateCompleted : null;

                const helpRequest = state.requests.find(r => r.assignmentId === a.id && r.studentId === state.student.studentId && r.type === 'help');
                const checkRequest = state.requests.find(r => r.assignmentId === a.id && r.studentId === state.student.studentId && r.type === 'check');

                const helpQueue = state.requests.filter(r => r.type === 'help').sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                const checkQueue = state.requests.filter(r => r.type === 'check').sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                const helpPosition = helpQueue.findIndex(r => r.id === (helpRequest ? helpRequest.id : null)) + 1;
                const checkPosition = checkQueue.findIndex(r => r.id === (checkRequest ? checkRequest.id : null)) + 1;
                
                const helpButtonText = helpRequest ? `Cancel Help (#${helpPosition})` : 'Request Help';
                const checkButtonText = checkRequest ? `Cancel Check (#${checkPosition})` : 'Ready for Check';

                return `
                    <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="text-lg font-semibold text-gray-800">${a.title}</h3>
                            ${isCompleted ? `
                                <span class="bg-green-200 text-green-800 text-sm font-bold px-3 py-1 rounded-full">Score: ${score}</span>
                            ` : isExcused ? `
                                <span class="bg-purple-600 text-white text-sm font-bold px-3 py-1 rounded-full">Excused</span>
                            ` : ''}
                        </div>
                        <p class="text-sm text-gray-500 mb-4">Due: ${a.dueDate ? new Date(a.dueDate).toLocaleDateString() : 'N/A'}</p>
                        <div class="flex space-x-2">
                            <button onclick="handleHelpRequest('${a.id}', '${state.student.id}')"
                                ${isExcused || isCompleted ? 'disabled' : ''}
                                class="flex-1 bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600 transition-colors duration-200 disabled:bg-gray-400">
                                ${helpButtonText}
                            </button>
                            <button onclick="handleCheckRequest('${a.id}', '${state.student.id}')"
                                ${isExcused || isCompleted ? 'disabled' : ''}
                                class="flex-1 bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors duration-200 disabled:bg-gray-400">
                                ${checkButtonText}
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        };

        const normalizeName = (name) => {
            return name.trim().toLowerCase().replace(/[\W_]+/g, '').replace(/,/g, '');
        }

        const handleLogin = async (event) => {
            event.preventDefault();
            const name = document.getElementById('student-name').value.trim();
            const studentId = document.getElementById('student-id').value.trim();
            const messageEl = document.getElementById('login-message');

            if (!name || !studentId) {
                messageEl.textContent = 'Please enter both name and student ID.';
                return;
            }

            try {
                const studentsRef = collection(db, `artifacts/${appId}/public/data/students`);
                const q = query(studentsRef, where("studentId", "==", studentId));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    messageEl.textContent = 'Login failed. The ID you entered was not found.';
                } else {
                    const studentDoc = querySnapshot.docs[0];
                    const dbName = studentDoc.data().name;
                    if (normalizeName(dbName) === normalizeName(name)) {
                        state.student = { id: studentDoc.id, ...studentDoc.data() };
                        state.isLoggedIn = true;
                        startDataListeners();
                    } else {
                        messageEl.textContent = 'Login failed. The name does not match the provided ID.';
                    }
                }
            } catch (error) {
                console.error("Login error:", error);
                messageEl.textContent = 'An error occurred. Please try again.';
            }
        };

        const startDataListeners = async () => {
            if (!state.student) return;

            // Listen for assignments specific to the student's period
            const assignmentsRef = collection(db, `artifacts/${appId}/public/data/assignments`);
            const assignmentsQuery = query(assignmentsRef, where('periodId', '==', state.student.periodId));
            onSnapshot(assignmentsQuery, (snapshot) => {
                state.assignments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAssignments();
            });

            // Listen for requests
            const requestsRef = collection(db, `artifacts/${appId}/public/data/requests`);
            onSnapshot(requestsRef, (snapshot) => {
                state.requests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAssignments();
            });
        };

        const handleHelpRequest = async (assignmentId, studentId) => {
            const requestsRef = collection(db, `artifacts/${appId}/public/data/requests`);
            const existingRequest = state.requests.find(r => r.assignmentId === assignmentId && r.studentId === studentId && r.type === 'help');
            
            if (existingRequest) {
                await deleteDoc(doc(db, `artifacts/${appId}/public/data/requests`, existingRequest.id));
            } else {
                 await addDoc(requestsRef, {
                    studentId,
                    assignmentId,
                    type: 'help',
                    timestamp: new Date().toISOString()
                });
            }
        };

        const handleCheckRequest = async (assignmentId, studentId) => {
            const requestsRef = collection(db, `artifacts/${appId}/public/data/requests`);
            const existingRequest = state.requests.find(r => r.assignmentId === assignmentId && r.studentId === studentId && r.type === 'check');
            
            if (existingRequest) {
                await deleteDoc(doc(db, `artifacts/${appId}/public/data/requests`, existingRequest.id));
            } else {
                 await addDoc(requestsRef, {
                    studentId,
                    assignmentId,
                    type: 'check',
                    timestamp: new Date().toISOString()
                });
            }
        };

        document.addEventListener('DOMContentLoaded', renderUI);
        
        window.handleHelpRequest = handleHelpRequest;
        window.handleCheckRequest = handleCheckRequest;

    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
    </style>
</head>
<body>
    <div id="app"></div>
</body>
</html>
